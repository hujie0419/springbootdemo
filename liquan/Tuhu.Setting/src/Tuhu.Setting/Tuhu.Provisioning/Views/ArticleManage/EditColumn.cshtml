@using Tuhu.Provisioning.DataAccess.Entity.Discovery;
@model SpecialColumn
@{
    ViewBag.Title = "编辑专题";
}

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>编辑专题</h2>
        <ol class="breadcrumb">
            <li>
                <a href="@Url.Action("Index", "Home")">首页</a>
            </li>
            <li>
                <a href="@Url.Action("ColumnManage", "ArticleManage")">专题管理</a>
            </li>
            <li class="active">
                <strong>编辑专题</strong>
            </li>
        </ol>
    </div>
    <div class="col-lg-2">

    </div>
</div>
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>All form elements <small>With custom checbox and radion elements.</small></h5>
                </div>
                <div class="ibox-content">
                    <!----表单-->
                    <form method="post" class="form-horizontal" id="formAddColumn">
                        <input type="hidden" id="_hdArticleIDs" name="ArticleIds" value="" />
                        <div class="form-group">
                            <label class="col-sm-2 control-label">专题名称</label>
                            <div class="col-sm-10"><input type="text" class="form-control" name="ColumnName" id="formColumnName" placeholder="专题名称2~20个字" value="@Model.ColumnName"></div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">专题描述</label>
                            <div class="col-sm-10"><textarea name="ColumnDesc" class="form-control" style="width:100%;resize:vertical" placeholder="描述可为空">@Model.ColumnDesc</textarea></div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group" id="divCoverImage">
                            <label class="col-sm-2 control-label">专题图片</label>
                            <div class="col-sm-10">
                                <input id="_hdColumnImages" name="ColumnImage" type="hidden" value="@Model.ColumnImage" />
                                <input style="width:150px;" type="file" id="morePicture" name="morePicture" onchange="uploadPic('morePicture', HandlerPicResult);" />
                                <div id="morePictureVessel">
                                    @if (!string.IsNullOrEmpty(Model.ColumnImage))
                                    {
                                        <img src="@Model.ColumnImage" id="imgColumnPic" width="150" height="75" />
                                    }
                                    else
                                    {
                                        <img src="" id="imgColumnPic" width="75" height="75" style="display:none" />
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">是否显示</label>
                            <div class="col-sm-10" style="padding-top: 5px;">
                                @if (Model.IsShow)
                                {
                                    <label>
                                        <input type="radio" checked="checked" value="true" id="radioShow" name="IsShow"> 显示
                                    </label>
                                    <label>
                                        <input type="radio" value="false" id="radioDisShow" name="IsShow">不显示
                                    </label>
                                }
                                else
                                {
                                    <label>
                                        <input type="radio" value="true" id="radioShow" name="IsShow"> 显示
                                    </label>
                                    <label>
                                        <input type="radio"  checked="checked" value="false" id="radioDisShow" name="IsShow">不显示
                                    </label>
                                }                               
                            </div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">文字类目</label>
                            <div class="col-sm-10">
                                <div class="bootstrap-duallistbox-container row moveonselect">
                                    <div class="box1 col-md-6">
                                        <input class="filter form-control" type="text" id="txtFilterSearch" placeholder="搜索...">
                                        <select size="10" class="form-control" id="selArticleList">
                                            @{
                                                var list = ViewData["ArticleTemp"] as List<ArticleTemp>;
                                                if (list.Count > 0)
                                                {
                                                    foreach (var item in list)
                                                    {
                                                        <option value="@item.PKID">@item.SmallTitle</option>
                                                    }
                                                }
                                            }
                                        </select>
                                    </div>
                                    <div class="box2 col-md-6">
                                        <h3>已选文章</h3>
                                        <select size="10" class="form-control" id="selHavedArticle">
                                            @{
                                                var haveList = ViewData["ArticleHaved"] as List<ArticleTemp>;
                                                if (list.Count > 0)
                                                {
                                                    foreach (var item in haveList)
                                                    {
                                                        <option value="@item.PKID">@item.SmallTitle</option>
                                                    }
                                                }
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">
                                定时发布
                            </label>
                            <div class="col-sm-10">
                                <div class="col-md-2"><input type="text" placeholder="定时发布时间" onClick="WdatePicker({ dateFmt: 'yyyy/MM/dd HH:mm'})" class="form-control" name="PublishTime" style="width:200px" id="PublishDateTime" value="@Model.PublishTime"></div>
                            </div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group">
                            <div class="col-sm-4 col-sm-offset-2">
                                <input class="btn btn-primary" type="submit" value="保存" id="btnPublish" onclick="return checkForm()" />
                                <button class="btn btn-white" type="button" onclick="location.href = '/ArticleManage/ColumnManage'">取 消</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/Scripts/ajaxfileupload.js"></script>
    <script src="~/Scripts/CommentFile/jquery.page.js"></script>
<script src="~/Content/My97DatePicker/WdatePicker.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {


            //点击文章
            $("#selArticleList").on("click", "option", function () {
                var thisObj = $(this);
                var pkid = thisObj.val();
                var title = thisObj.text();
                var htm = '<option value="' + pkid + '">' + title + '</option>';
                var count = $("#selHavedArticle").children().length;
                if (count >= 20) {
                    alert("文章数量不能超过20篇"); return;
                } else {
                    if (!IsExistOption(pkid)) {
                        $("#selHavedArticle").append(htm);
                    }
                }

            });

            //点击已选文章
            $("#selHavedArticle").on("click", "option", function () {
                var thisObj = $(this);
                thisObj.remove();
            });

            //条件过滤查询
            $("#txtFilterSearch").keyup(function () {
                var keyword = $(this).val();
                //if (keyword == "") return;
                $.ajax({
                    type: 'get',
                    url: '/ArticleManage/GetArticleByWord?word=' + keyword,
                    success: function (data) {
                        var html = "";
                        for (var i = 0; i < data.length; i++) {
                            html += '<option value="' + data[i].PKID + '">' + data[i].SmallTitle + '</option>';
                        }
                        $("#selArticleList").html(html);
                    }
                });

            });

        });

        function checkForm() {
            var name = $("#formColumnName").val();
            if (name == "") { alert("专题名称不能为空"); return false; }
            if (name.length < 2 || name.length > 20) { alert("专题名称字数在2~15个字数"); return false; }
            var scImage = $("#_hdColumnImages").val();
            if (scImage == "") { alert("专题图片不能为空"); return false; }

            var count = $("#selHavedArticle").children().length;
            if (count < 3) { alert("文章数量不能少于3篇"); return false; }

            var pTime = $("#PublishDateTime").val();
            if (pTime == "") { alert("定时发布时间不能为空"); return false; }

            var ids = "";
            $("#selHavedArticle").children().each(function () {
                var id = $(this).val();
                ids += id + "|";
            });
            $("#_hdArticleIDs").val(ids);
            return true;
        }
        function IsExistOption(pkid) {
            var flag = false;
            var str = "";
            $("#selHavedArticle").children().each(function () {
                var pkid = $(this).val();
                str += pkid + "|";
            });
            if (str.indexOf(pkid) > -1) {
                flag = true;
            }
            return flag;
        }
        function uploadPic(_fileElementId, _callback) {
            $.ajaxFileUpload({
                url: '/ArticleManage/ImageUploadToAli',
                secureuri: false,
                fileElementId: _fileElementId || '',
                dataType: 'json',
                async: false,
                success: function (result) {
                    _callback(result, _fileElementId);
                }
            });
        }
        function HandlerPicResult(result, elementId) {
            if (elementId == "morePicture") {
                $("#imgColumnPic").attr("src", result.BImage);
                $("#imgColumnPic").show();
                $("#_hdColumnImages").val(result.BImage);
            } else {
                $("#imgAuthorPicUp").attr("src", result.BImage);
                $("#imgAuthorPicUp").show();
                $("#_hdAuthorShowImagesUp").val(result.BImage);
            }

        }
    </script>
}