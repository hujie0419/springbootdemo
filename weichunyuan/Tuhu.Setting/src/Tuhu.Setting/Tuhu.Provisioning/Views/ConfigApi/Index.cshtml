@model List<Tuhu.Provisioning.DataAccess.Entity.ConfigApi>
    @{
        ViewBag.Title = "Api开关";
    }

    <h2>Api开关</h2>
    <style>
        .ui-dialog {
            border-radius: 3px;
            padding: 0px;
            width: auto;
        }

        .ui-dialog-grid {
            width: 100%;
        }

        .ui-dialog-title {
            width: 75%;
            padding: 8px 15px 8px 15px;
        }

        .ui-dialog-close {
            top: 8px;
        }

        .ui-dialog-body {
            padding: 10px;
        }

        .ui-dialog-content {
            padding: 0;
        }

        .ui-dialog-footer {
            padding: 5px 10px 5px 5px;
            background: #ffffff;
            border-top: 1px solid #eee;
        }

            .ui-dialog-footer button {
                padding: 3px 15px;
                border-radius: 2px;
                box-shadow: 0 1px 1px rgba(0,0,0,.15);
                font-size: 12px;
            }

                .ui-dialog-footer button.ui-dialog-autofocus {
                    font-weight: 700;
                    text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
                }

        .button1 {
            margin-top: 20px;
            padding: 5px 25px;
            border: none;
            color: #F0F0F0;
            font-size: 12px;
            font-family: "Microsoft Yahei";
            outline: none;
            cursor: pointer;
            background: #0088cc;
            border-color: #0088cc;
        }

        table th {
            color: white;
            padding: 6px 5px;
            text-align: left;
            background-color: #0088cc;
            border: solid 1px #0088cc;
        }
    </style>
    <link rel="stylesheet" href="/Scripts/artDialog6.0.4/css/ui-dialog.css" />
    <script src="~/Scripts/artDialog6.0.4/dist/dialog-min.js"></script>
    <script src="~/Scripts/artDialog6.0.4/dist/dialog-plus-min.js"></script>
    <input type="button" class="button1" id="Insert" value="添加" />
    <a class="button1" href="/ConfigApi/Index?Type=1">全局配置</a>
    <a class="button1" href="/ConfigApi/Index?Type=2">全局开关</a>
    <a class="button1" href="/ConfigApi/Index?Type=3">立即生效开关</a>
    @*<a class="button1" href="http://api.tuhu.cn/Advertise/UpdateApiConfigure">清除缓存</a>*@
    <a class="button1" href="javascript:adClick('https://item.tuhu.cn/product/RefreshApiConfigCache.html', 'https://api.tuhu.cn/Advertise/UpdateApiConfigure');">清除缓存</a>
    <div style="margin-top:20px;">
        <table>
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Key</th>
                    <th>Value</th>
                    <th>CreateTime</th>
                    <th>Remark</th>
                    <th>Type</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
            {
                    <tr>
                        <td>@item.Id</td>
                        <td>@item.Key</td>
                        <td>@item.Value</td>
                        <td>@item.CreateTime</td>
                        <td>@item.Remark</td>
                        @if (item.Type == 1)
                        {
                            <td>全局配置</td>
                        }
                        else if (item.Type == 2)
                        {
                            <td>全局开关</td>
                        }
                        else if (item.Type == 3)
                        {
                            <td>立即生效开关</td>
                        }
                        else
                        {

                            <td></td>

                        }

                        <td>
                            <a href="javascript:;" onclick="Update(@item.Id)">编辑</a>
                            <a href="javascript:;" onclick="Delete(@item.Id)">删除</a>
                        </td>
                    </tr>
                }

            </tbody>
        </table>
    </div>
    <script>
        function adClick(ad, site) {
            window.open(ad);
            window.location = site;
        }
        function Delete(id) {
            if (window.confirm("确定要删除吗？")) {
                $.ajax({
                    method: "POST",
                    url: "/ConfigApi/Delete",
                    data: { "id": id },
                    dataType: "json"
                }).done(function (data) {

                }).fail(function (data) {
                })

                location.reload(true);
            }
        }

        function Update(id) {
            var dialgpResult = dialog({
                height:250,
                width: 300,
                fixed: true,
                title: "编辑",
                button: [
                {
                    value: "保存",
                    callback: function () {
                        var yanz = /^[0-9a-zA-Z]*$/g;
                        if (!$(".Value").val()) {
                            $(".Value").css("border", "1px solid red")
                            return false;
                        }
                        //if (yanz.test($(".Value").val())) {
                        $.ajax({
                            type: "POST",
                            url: "/ConfigApi/Update",
                            data: {
                                "Id": id,
                                "Value": $(".Value").val(),
                                "Remark": $(".Remark").val(),
                                "Type": $(".Type").val()
                            },
                            success: function (result) {
                                if (result) {
                                    UpdateApiConfigure();
                                    window.location.reload(true);
                                }
                                else {
                                    alert("保存失败！");
                                }
                            },
                            error: function (result) {
                                alert("失败!")
                            }
                        });
                        //} else {
                        //    alert("Value不能为汉字！");
                        //    return false;
                        //}
                    }
                },
                {
                    value: "关闭"
                }]
            });

            $.ajax({
                url: "/ConfigApi/Add",
                data: { "Id": id },
                type: "GET",
                success: function (result) {
                    dialgpResult.content(result);
                    dialgpResult.showModal();
                }
            });
        };


        $("#Insert").on("click", function () {
            var dialgpResult = dialog({
                height: 250,
                width: 300,
                fixed: true,
                title: "添加",
                button: [
                {
                    value: "保存",
                    callback: function () {
                        if (!$(".Key").val()) {
                            $(".Key").css("border", "1px solid red")
                            return false;
                        }
                        if (!$(".Value").val()) {
                            $(".Value").css("border", "1px solid red")
                            return false;
                        }
                        //var yanz = /^[0-9a-zA-Z]*$/g;
                        //if (!yanz.test($(".Key").val())) {
                        //    alert("Key不能是汉字");
                        //    return false;
                        //}
                        //var yanz1 = /^[0-9a-zA-Z]*$/g;
                        //if (!yanz1.test($(".Value").val())) {
                        //    alert("Value不能是汉字");
                        //    return false;
                        //}

                        $.ajax({
                            type: "POST",
                            url: "/ConfigApi/Insert",
                            data: {
                                "Key": $(".Key").val(),
                                "Value": $(".Value").val(),
                                "Remark": $(".Remark").val(),
                                "Type": $(".Type").val()
                            },
                            success: function (result) {
                                if (result == 1) {
                                    UpdateApiConfigure();
                                    window.location.reload(true);
                                }
                                else if (result == -1) {
                                    alert("Key已经存在！");
                                } else {
                                    alert("保存失败！");
                                }
                            },
                            error: function (result) {
                                alert("失败!")
                            }
                        });
                    }
                },
                {
                    value: "关闭"
                }]
            });

            $.ajax({
                url: "/ConfigApi/Add",
                data: {},
                type: "GET",
                success: function (result) {
                    dialgpResult.content(result);
                    dialgpResult.showModal();
                }
            });
        })

        function UpdateApiConfigure() {
            try {
                var e = new Image;
                e.id = "UpdateApiConfigure";
                e.src = "http://api.tuhu.cn/Advertise/UpdateApiConfigure";
            } catch (e) {
            }
        }
    </script>
