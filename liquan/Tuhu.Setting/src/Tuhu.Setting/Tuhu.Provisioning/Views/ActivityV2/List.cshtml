@using Tuhu.Component.Common.Extensions
@using Tuhu.Provisioning.Models
@model Tuhu.Component.Common.Models.ListModel<Tuhu.Provisioning.DataAccess.Entity.ActivityBuild>
@{
    ViewBag.Title = "活动列表";

}
<style>
    .ui-dialog {
        border-radius: 3px;
        padding: 0px;
        width: auto;
    }

    .ui-dialog-grid {
        width: 100%;
    }

    .ui-dialog-title {
        width: 75%;
        padding: 8px 15px 8px 15px;
    }

    .ui-dialog-close {
        top: 8px;
    }

    .ui-dialog-body {
        padding: 10px;
    }

    .ui-dialog-content {
        padding: 0px;
    }

    .ui-dialog-footer {
        padding: 5px 10px 5px 5px;
        background: #ffffff;
        border-top: 1px solid #eee;
    }

        .ui-dialog-footer button {
            padding: 3px 15px;
            border-radius: 2px;
            box-shadow: 0 1px 1px rgba(0,0,0,.15);
            font-size: 12px;
        }

            .ui-dialog-footer button.ui-dialog-autofocus {
                font-weight: 700;
                text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            }

    .button1 {
        margin-top: 20px;
        padding: 5px 25px;
        border: none;
        color: #F0F0F0;
        font-size: 12px;
        font-family: "Microsoft Yahei";
        outline: none;
        cursor: pointer;
        background: #0088cc;
        border-color: #0088cc;
    }

    table th {
        color: white;
        padding: 6px 5px;
        text-align: left;
        background-color: #0088cc;
        border: solid 1px #0088cc;
    }
</style>
<h2>活动列表</h2>
<script src="../../Scripts/ajaxfileupload.js" type="text/javascript"></script>
<link rel="stylesheet" href="/Scripts/artDialog6.0.4/css/ui-dialog.css" />
<script src="~/Scripts/artDialog6.0.4/dist/dialog-min.js"></script>
<script src="~/Scripts/artDialog6.0.4/dist/dialog-plus-min.js"></script>
<input type="button" class="button1" onclick="Insert()" value="添加" />

<div style="margin-top:20px;">
    <table>
        <tbody>
            <tr>
                <td>Id:</td>
                <td><input type="text" id="id" /></td>
                <td>活动Title:</td>
                <td><input type="text" id="titlename" /></td>
                <td><input type="button" value="查询" class="button1" onclick="Search()" /></td>
            </tr>
        </tbody>
    </table>
</div>
<div style="margin-top:20px;">

    <table style="width:100%;">
        <thead>
            <tr>
                <th>活动Id</th>
                <th>活动title</th>
                <th>活动url</th>
                @*<th>七牛url</th>*@
                <th>添加时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.id</td>
                    <td>@item.Title</td>
                    <td>
                        <a href="https://huodong.tuhu.cn/Activity/Index/@item.id" target="_blank"> https://huodong.tuhu.cn/Activity/Index/@item.id</a>
                    </td>

                    <td>@item.CreateTime</td>
                    <td>
                        <a href="/Activity/Update?id=@item.id" target="_blank">编辑</a>
                        <a href="javascript:;" pkid="@item.id" onclick="DeleteClick(this)">删除</a>
                    </td>
                </tr>
            }

        </tbody>
    </table>
</div>
<div>
    @Html.Pager(Model.Pager, pageIndex => Url.RouteUrl(new { pageIndex }))
</div>
<script>

    function Search() {

        var id = 0;
        if ($("#id").val()) {
            id = $("#id").val();
        }
        window.location.href = "/Activity/List?id=" + id + "&title=" + $("#titlename").val()
        //$.ajax({
        //    type: "POST",
        //    url: "/Activity/List",
        //    data: {
        //        "title": $("#title").val(),
        //        "id": $("#id").val(),
        //    },
        //    success: function (result) {
        //        if (result) {

        //        }
        //    },
        //    error: function (result) {
        //        alert("失败!")
        //    }
        //});
    }

    function Insert() {
        var dialgpResult = dialog({
            height: 500,
            width: 1000,
            fixed: true,
            title: "活动页面添加",
            button: [
            {
                value: "保存",
                callback: function () {
                    if ($("#Atitle").val() == "") {
                        alert("标题不能为空！")
                        return false;
                    }
                    var allowInsert = true;
                    var dataArray = new Array();
                    $('.table1 >tbody> tr').each(function (i) {
                        if (i >= 0) {
                            var columns = $(this).children();
                            var jsonData = { "PID": "", "VID": "", "SmallImage": "", "Image": "", "BigImg": "", "Type": "", "OrderBy": "", "LinkUrl": "", "ActivityId": "" };
                            var pvid = columns.eq(0).find("input[type='text']").val().split("|");
                            jsonData.PID = pvid[0];
                            jsonData.VID = pvid[1];
                            jsonData.ActivityId = columns.eq(1).find("input[type='text']").val();
                            jsonData.SmallImage = columns.eq(2).find("input[class='smallImage']").val();
                            jsonData.Image = columns.eq(2).find("input[class='image']").val();
                            jsonData.BigImg = columns.eq(2).find("input[type='file']").attr("bigImg")
                            if (columns.eq(3).find("select").val() == "-1") {
                                allowInsert = false;

                            } else {
                                jsonData.Type = columns.eq(3).find("select").val();
                            }
                            jsonData.OrderBy = columns.eq(4).find("input[type='number']").val();
                            jsonData.LinkUrl = columns.eq(5).find("input[type='text']").val();
                            dataArray[i] = jsonData;
                        }
                    });

                    var dataList = JSON.stringify(dataArray);
                    if (allowInsert == 1) {
                        $.ajax({
                            type: "POST",
                            url: "/Activity/AddActivity",
                            data: {
                                "Title": $("#Atitle").val(),
                                "Content": dataList,
                            },
                            success: function (result) {
                                if (result) {
                                    window.location.reload(true);
                                }
                                else {
                                    alert("保存失败！");

                                }
                            },
                            error: function (result) {
                                alert("失败!")
                            }
                        });
                    } else {
                        alert("请选择类型！")
                        return false;
                    }

                }
            },
            {
                value: "预览",
                callback: function () {
                    var dataArray = new Array();
                    $('.table1 >tbody> tr').each(function (i) {
                        if (i >= 0) {
                            var columns = $(this).children();
                            var jsonData = { "PID": "", "VID": "", "SmallImage": "", "Image": "", "BigImg": "", "Type": "", "OrderBy": "" };

                            jsonData.PID = columns.eq(0).find("input[type='text']").val();
                            jsonData.VID = columns.eq(1).find("input[type='text']").val();
                            jsonData.SmallImage = columns.eq(2).find("input[class='smallImage']").val();
                            jsonData.Image = columns.eq(2).find("input[class='image']").val();
                            jsonData.BigImg = columns.eq(2).find("input[type='file']").attr("bigImg")
                            jsonData.Type = columns.eq(3).find("select").val();
                            jsonData.OrderBy = columns.eq(4).find("input[type='number']").val();
                            dataArray[i] = jsonData;
                        }
                    });

                    var dataList = JSON.stringify(dataArray);

                    $.ajax({
                        type: "POST",
                        url: "/Activity/ViewActivity",
                        data: {
                            "Title": $("#Atitle").val(),
                            "Content": dataList,
                        },
                        success: function (result) {
                            if (result) {
                                window.open("/Activity/Preview");
                            }
                        },
                        error: function (result) {
                            alert("失败!")
                        }
                    });

                    return false;
                }
            },
            {
                value: "关闭"
            }]
        });

        $.ajax({
            url: "/Activity/Add",
            data: {},
            type: "GET",
            success: function (result) {

                dialgpResult.content(result);
                dialgpResult.showModal();

            }
        });
    };
    function DeleteClick(e) {

        if (window.confirm("你确定要删除吗？")) {
            $.ajax({
                type: "POST",
                url: "/Activity/DeleteActivity",
                data: {
                    "id": $(e).attr("pkid")
                },
                success: function (result) {
                    window.location.reload(true);
                },
                error: function (result) {
                    alert("失败!")
                }
            });

        }
    };
</script>
