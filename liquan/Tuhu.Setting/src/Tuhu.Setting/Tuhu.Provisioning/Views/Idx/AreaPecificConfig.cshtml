@{
    ViewBag.Title = "特定入口区域配置";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="//res.tuhu.cn/Css/easyuiCss/themes/default/easyui.css" rel="stylesheet" />
<link href="//res.tuhu.cn/Css/easyuiCss/themes/icon.css" rel="stylesheet" />
<script src="//res.tuhu.cn/Scripts/easyui/jquery.easyui.min.js"></script>
<script src="//res.tuhu.cn/Scripts/easyui/easyui-lang-zh_CN.js"></script>
<script type="text/javascript">
    $(function () {
        var mid = '@ViewBag.mid';
        $("#modelid").val(mid);
        //alert(mid);
        $('#dg').datagrid({
            url: "/Idx/Get_AreaPec?mid=" + mid,
            toolbar: [{
                iconCls: 'icon-add',
                text: "添加",
                handler: function () {
                    clear();
                    $("#dlg").dialog("open").dialog('setTitle', '添加模块');
                    $("#dlg").css("visibility", "visible");
                    $("#addoredit").val(1);
                    $("input[name='status'][value='statusOn']").attr("checked", true);
                }
            }],
            columns: [[
                    { field: 'id', title: '编号', width: 100 },
                    { field: 'province', title: '省', width: 100 },
                    { field: 'city', title: '市', width: 100 },
                    { field: 'area', title: '区', width: 100, align: 'right' },
                    {
                        field: 'imageurl', title: '入口图片', width: 150, formatter: function (index, rowData) {
                            return "<img  width=120px; height=80px; src=" + rowData.imageurl + " />"
                        }
                    },
                    { field: 'linkurl', title: 'h5连接', width: 250 },
                    {
                        field: 'status', title: '状态', width: 100, formatter: function (index, rowData) {
                            if(rowData.status="true")
                            {
                                return "启用";
                            }
                            else {
                                return "禁用";
                            }
                        }
                    },
                     {
                         title: '控制列', field: ' ', width: 250,
                         formatter: function (index, rowData) {
                             return "<button onclick='edit(" + JSON.stringify(rowData) + ")'>编辑</button>" + "<button onclick='deletenode(" + rowData.id + ")'>删除</button>" + "<button onclick='delist()'>产品配置</button>";
                         }
                     }
            ]]
        });
    });

    function clear() {
        $("#preview").attr("src", '');
        $("#hiddenimageurl").attr("value", '');
        $("#province").attr("value", '');
        $("#city").attr("value", '');
        $("#linkurl").attr("value", '');
    }

    //删除节点
    function deletenode(id) {
        $.messager.confirm("确定", "确定要删除吗", function (r) {
            if (r) {
                $("#dg").treegrid('remove', id);
                $.ajax({
                    url: '/Module/Remove?id=' + id,
                }).done(function (data) {
                    var jsonresult = JSON.parse(data);
                    if (jsonresult.resultCode == "1") {
                        $.messager.alert("提示信息", "操作成功");
                        $("#dlg").dialog("close");
                        $('#dg').treegrid('reload');
                    }
                    else {
                        $.messager.alert("提示信息", "操作失败");
                    }
                })
            }
        });

    }

    //修改
    function edit(rowData) {
        if (rowData != null) {
            $("#dlg").dialog("open").dialog('setTitle', '模块编辑');
            $("#dlg").css("visibility", "visible");
            $("#fm").form("load", rowData);
            $("#addoredit").val(0);
            $("#hiddenimageurl").val(rowData.imageurl);
            if(rowData.status=="true")
            {
                $("input[name='status'][value='statusOn']").attr("checked", true);
            }
            else
            {
                $("input[name='status'][value='statusOff']").attr("checked", true);
            }
        }

    }

    //保存事件图片随这个form一起到后台
    function save() {
        var addoredit = $("#addoredit").val();//1:添加0：修改
        alert(addoredit);
        $("#fm").form("submit", {
            url: "/Idx/Save_AreaPec?a=" + addoredit,
            onsubmit: function () {
                return $(this).form("validate");
            },
            success: function (data) {
                var jsonresult = JSON.parse(data);
                if (jsonresult.resultCode == "1") {
                    $.messager.alert("提示信息", "操作成功");
                    $("#dlg").dialog("close");
                    $('#tt').treegrid('reload');
                }
                else if (jsonresult.resultCode == "2") {
                    $.messager.alert("提示信息", "已存在此名称请重新填写");
                }
                else {
                    $.messager.alert("提示信息", "操作失败");
                }
            }
        });
    }

    //上传图片和预览
    //检查图片的格式是否正确,同时实现预览
    function setImagePreview(obj, localImagId, imgObjPreview) {
        var array = new Array('gif', 'jpeg', 'png', 'jpg', 'bmp'); //可以上传的文件类型
        if (obj.value == '') {
            $.messager.alert("让选择要上传的图片!");
            return false;
        }
        else {
            var fileContentType = obj.value.match(/^(.*)(\.)(.{1,8})$/)[3]; //这个文件类型正则很有用
            ////布尔型变量
            var isExists = false;
            //循环判断图片的格式是否正确
            for (var i in array) {
                if (fileContentType.toLowerCase() == array[i].toLowerCase()) {
                    //图片格式正确之后，根据浏览器的不同设置图片的大小
                    if (obj.files && obj.files[0]) {
                        //火狐下，直接设img属性
                        imgObjPreview.style.display = 'block';
                        imgObjPreview.style.width = '400px';
                        imgObjPreview.style.height = '300';
                        //火狐7以上版本不能用上面的getAsDataURL()方式获取，需要一下方式
                        imgObjPreview.src = window.URL.createObjectURL(obj.files[0]);
                    }
                    else {
                        //IE下，使用滤镜
                        obj.select();
                        var imgSrc = document.selection.createRange().text;
                        //必须设置初始大小
                        localImagId.style.width = "400px";
                        localImagId.style.height = "300";
                        //图片异常的捕捉，防止用户修改后缀来伪造图片
                        try {
                            localImagId.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
                            localImagId.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = imgSrc;
                        }
                        catch (e) {
                            $.messager.alert("您上传的图片格式不正确，请重新选择!");
                            return false;
                        }
                        imgObjPreview.style.display = 'none';
                        document.selection.empty();
                    }
                    isExists = true;
                    return true;
                }
            }
            if (isExists == false) {
                $.messager.alert("上传图片类型不正确!");
                return false;
            }
            return false;
        }
    }

    function over(imgid, obj, imgbig) {
        //大图显示的最大尺寸  4比3的大小  400 300
        maxwidth = 400;
        maxheight = 300;

        //显示
        obj.style.display = "";
        imgbig.src = imgid.src;

        //1、宽和高都超过了，看谁超过的多，谁超的多就将谁设置为最大值，其余策略按照2、3
        //2、如果宽超过了并且高没有超，设置宽为最大值
        //3、如果宽没超过并且高超过了，设置高为最大值

        if (img.width > maxwidth && img.height > maxheight) {
            pare = (img.width - maxwidth) - (img.height - maxheight);
            if (pare >= 0)
                img.width = maxwidth;
            else
                img.height = maxheight;
        }
        else if (img.width > maxwidth && img.height <= maxheight) {
            img.width = maxwidth;
        }
        else if (img.width <= maxwidth && img.height > maxheight) {
            img.height = maxheight;
        }
    }
</script>

<div style="width:100%; height:auto">
    <table id="dg" style="width:100%;height:auto;margin:0 auto;"></table>
</div>

<div id="dlg" class="easyui-dialog" style="width: 460px; height: 430px; padding: 10px 20px;visibility: hidden;"
     closed="true" buttons="#dlg-buttons">
    <form id="fm" method="post" enctype="multipart/form-data">
        <table>
            <tr>
                <td>省份:</td>
                <td><input name="province" id="province" class="easyui-validatebox" required="true" /> </td>
            </tr>
            <tr>
                <td>城市: </td>
                <td><input name="city" id="city" class="easyui-validatebox" required="true" /> </td>
            </tr>
            <tr>
                <td>入口图片</td>
                <td><input id="idFile" style="width:224px" name="idFile" onchange="javascript:setImagePreview(this,localImag,preview);" type="file"></td>
            </tr>
            <tr>
                <td>  预览:</td>
                <td>
                    <div id="localImag" style="width: 200px; height: 150px;">
                        <img id="preview" alt="预览图片" width="200" height="150" />
                    </div>
                </td>
            </tr>
            <tr>
                <td>h5跳转地址 </td>
                <td><input name="linkurl" id="linkurl" class="easyui-validatebox" required="true" /> </td>
            </tr>
            <tr>
                <td>状态:</td>
                <td><input name="status" id="statusOn" type="radio" value="statusOn" /> 开启</td>
                <td><input name="status" id="statusOff" type="radio" value="statusOff" />禁止</td>
            </tr>
            <input type="hidden" name="id" id="id" />
            <input type="hidden" name="hiddenimageurl" id="hiddenimageurl" />
            <input type="hidden" name="addoredit" id="addoredit" />
            <input type="hidden" name="modelid" id="modelid" />
        </table>
    </form>
</div>
<div id="dlg-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="save()" iconcls="icon-save" id="aSave">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg').dialog('close')"
       iconcls="icon-cancel">取消</a>
</div> 