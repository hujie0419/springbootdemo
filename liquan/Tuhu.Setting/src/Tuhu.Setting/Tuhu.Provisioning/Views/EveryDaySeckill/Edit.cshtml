@{
    ViewBag.Title = "新增天天秒杀";
    Layout = "~/Views/Shared/_Layout_Seckill.cshtml";
}
@model Tuhu.Provisioning.DataAccess.Entity.SE_EveryDaySeckill

@section Styles{
    <style type="text/css">
        input[type=file] {
            display: inline !important;
        }
    </style>
}

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-9">
        <h2>天天秒杀</h2>
    </div>

</div>
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-content">
                   
                    <div class="row" style="margin-top:20px;">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <td>活动名称：</td>
                                    <td>
                                        <input type="text" name="ActivityName" id="ActivityName" style="width:260px;" />
                                    </td>
                                    <td>开始时间:</td>
                                    <td>
                                        <input type="text" id="StartDate" disabled="disabled" name="StartDate" placeholder="开始时间" style="width:200px" onclick="WdatePicker({ dateFmt :'yyyy-MM-dd HH:mm:ss'})"  />
                                    </td>
                                    <td>
                                        结束时间：
                                    </td>
                                    <td>
                                        <input type="text" id="EndDate" name="EndDate" disabled="disabled"  placeholder="开始时间" style="width:200px" onclick="WdatePicker({ dateFmt :'yyyy-MM-dd HH:mm:ss'})"  />
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                    </div>

                    <div class="row">
                        @*<ul id="myTab" class="nav nav-tabs">
                            <li class="active">
                                <a href="#ActivityContent" data-toggle="tab">
                                    活动区
                                </a>

                            </li>
                            <li style="float: right;">
                                <div class="input-group">
                                    <span>顶部活动</span>

                                    <select id="topType" name="topType">
                                        <option value="1">活动</option>
                                        <option value="2">优惠券</option>
                                    </select>

                                    <select id="topStyle" name="topStyle">
                                        <option value="1">通知栏</option>
                                        <option value="3">三列</option>
                                    </select>
                                    <input type="button" id="btnAddActivity" class="btn btn-primary btn-sm" value="添 加" style="line-height: 1.0; margin:0px 5px;" />
                                    <input type="button" id="btnDelActivity" class="btn btn-danger btn-sm" value="删 除" style="line-height:1.0; margin:0px 5px;" />
                                </div>
                            </li>
                        </ul>*@
                        <div id="myTabContent" class="tab-content">
                            <div class="tab-pane fade in active" id="ActivityContent">
                                <table class="table tab-content">
                                    <thead>
                                        <tr>
                                            <th>排 序</th>
                                            <th>类型</th>
                                            <th>活动链接(或者优惠券GUID)</th>
                                            <th>背景图片</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <input type="number" id="OrderBy" name="OrderBy" value="1" />
                                            </td>
                                            <td>
                                               <select id="ActivityType" name="ActivityType">
                                                   <option value="1">活动</option>
                                                   <option value="2">优惠券</option>
                                               </select>
                                            </td>
                                            <td>
                                                <input type="text" id="Activity"  onchange="GetCoupon(this)" name="Activity" style="width:260px;" />
                                            </td>
                                            <td>
                                                <img id="imgac1" width="30" height="30" />
                                                <input type="file" id="acFile1" name="acFile1" onchange="UploadBgImg(this, 'imgac1', 'BgUrl1')" />
                                                <input type="hidden" id="BgUrl1" name="BgUrl" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <input type="number" id="OrderBy" name="OrderBy" value="2" />
                                            </td>
                                            <td>
                                                <select id="ActivityType" name="ActivityType">
                                                    <option value="1">活动</option>
                                                    <option value="2">优惠券</option>
                                                </select>
                                            </td>
                                            <td>
                                                <input type="text" id="Activity" onchange="GetCoupon(this)" name="Activity" style="width:260px;" />
                                            </td>
                                            <td>
                                                <img id="imgac2" width="30" height="30" />
                                                <input type="file" id="acFile2" name="acFile1" onchange="UploadBgImg(this, 'imgac2', 'BgUrl2')" />
                                                <input type="hidden" id="BgUrl2" name="BgUrl" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <input type="number" id="OrderBy" name="OrderBy" value="3" />
                                            </td>
                                            <td>
                                                <select id="ActivityType" name="ActivityType">
                                                    <option value="1">活动</option>
                                                    <option value="2">优惠券</option>
                                                </select>
                                            </td>
                                            <td>
                                                <input type="text" id="Activity" onchange="GetCoupon(this)" name="Activity" style="width:260px;" />
                                            </td>
                                            <td>
                                                <img id="imgac3" width="30" height="30" />
                                                <input type="file" id="acFile3" name="acFile1" onchange="UploadBgImg(this, 'imgac3', 'BgUrl3')" />
                                                <input type="hidden" id="BgUrl3" name="BgUrl" />
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <ul id="specialTabs" class="nav nav-tabs">
                            <li class="active">
                                <a href="#specialTab" data-toggle="tab">
                                    特惠专区
                                </a>
                            </li>
                        </ul>
                        <div id="specialTab" class="tab-content">
                            <div class="tab-pane fade in active" id="specialTab">
                                <table class="table table-container">
                                    <tbody>
                                        <tr>
                                            <td>特惠页:</td>
                                            <td>
                                                <input type="text" id="SpecialUrl" name="SpecialUrl" style="width:300px;" />
                                            </td>
                                            <td>
                                                展示图:
                                            </td>
                                            <td>
                                                <img id="imgspFile" width="30" height="30" />
                                                <input type="file" id="spFile" name="spFile" onchange="UploadBgImg(this, 'imgspFile', 'SpecialPicture')" />
                                                <input type="hidden" id="SpecialPicture" name="SpecialPicture" />
                                            </td>
                                            <td>样式:</td>
                                            <td>
                                                <select id="SpecialStyle" name="SpecialStyle">
                                                    <option value="1">通知栏</option>
                                                    <option value="3">三列</option>
                                                </select>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <ul id="seckillTabs" class="nav nav-tabs">
                            <li class="active">
                                <a href="#seckillTab" data-toggle="tab">商品区</a>
                            </li>
                        </ul>
                        <div id="seckillTab" class="tab-content">
                            <div class="tab-pane fade in active" id="seckillTabContent">
                                <table class="table">
                                    <tbody>
                                        <tr>
                                            <td>活动ID：</td>
                                            <td>
                                                <input type="text" id="FlashActivityGuid" name="FlashActivityGuid" style="width:300px;" />
                                            </td>
                                            <td>
                                                名称:
                                            </td>
                                            <td>
                                                <input type="text" id="FlashActivityName" name="FlashActivityName" style="width:300px;" readonly="readonly" />
                                            </td>
                                            <td>
                                                开始时间:
                                            </td>
                                            <td>
                                                <input type="text" id="FlashStartDate" name="FlashStartDate" style="width:200px;" readonly="readonly" />
                                            </td>
                                            <td>
                                                结束时间:
                                            </td>
                                            <td>
                                                <input type="text" id="FlashEndDate" name="FlashEndDate" style="width:300px;" readonly="readonly" />
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>


                              

                            </div>
                        </div>
                    </div>
                    <div class="row" style="overflow: auto;" id="flashTable">
                       
                    </div>


                    <div class="row" style="text-align:center">
                        <input type="button" class="btn btn-primary btn-medium" id="btnSave"  value="保 存"/>
                        <input type="button" class="btn btn-danger btn-medium" id="btnCancel" value="取 消" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<input type="hidden" id="ActivityGuid" name="ActivityGuid" value="@ViewBag.ActivityGuid" />

@section scripts{
<script type="text/javascript" src="~/Content/My97DatePicker/WdatePicker.js"></script>
    <script src="/Scripts/ajaxfileupload.js" type="text/javascript"></script>
    <script type="text/javascript">
        function UploadBgImg(obj, showImg, showSImg) {
            var pobj = $(obj);
            var rd = Math.ceil(Math.random() * 9999) + 1;
            var fileElId = $(obj).attr("id");
            console.log(fileElId);
            $.ajaxFileUpload({
                url: '/Article/ImageUploadToAli?rd=' + rd,
                secureuri: false,
                fileElementId: fileElId,
                dataType: 'json',
                async: false,
                success: function (result) {
                    if (result.BImage != "" && result.SImage != "") {

                        $("#" + showImg).attr("src", result.SImage).show();
                        //  $("#" + showUrl).val(result.BImage);
                        $('#' + showSImg).val(result.BImage);
                    } else {
                        alert("上传失败！");
                    }
                },
                error: function (data, status, e)//服务器响应失败处理函数
                {
                    alert(e);
                }
            });
        }

        function GetCoupon(obj) {
           
            var type = $(obj).parent().parent().find('#ActivityType').val();
            if (type == 1)
                return false;

            var value = $(obj).val();
            var coupon = $(obj);
            //alert('1');
            if (value != null && value != undefined) {
                $.ajax({
                    async:false,
                    type: 'post',
                    url: '/PromotionActivity/GetCouponValidate',
                    data: { guid: value }
                }).done(function (result) {
                    result = JSON.parse(result);
                    console.log(result);
                    $(obj).parent().append(result.Description + "  " + (result.UserType == 0 ? '全部' : result.UserType == 1 ? '新用户' : '老用户'));
                });
            } else {
                $(obj).val('');
            }
        }

        //$('#btnAddActivity').on('click', function () {
        //    var topType = $('#topType').val();
        //    var topStyle = $('#topStyle').val();
        //    var ActivityContent = $('#ActivityContent');
        //    $('#ActivityContent').empty();
        //    if (topType == 1) {
        //        //活动
        //        if (topStyle == 1) {
        //            $('#ActivityContent').load('/EveryDaySeckill/ActivityOne');
        //        } else {
        //            $('#ActivityContent').load('/EveryDaySeckill/ActivityThread');
        //        }
        //    } else if (topType == 2) {
        //        //
        //        if (topStyle == 1) {
        //            $('#ActivityContent').load('/EveryDaySeckill/CouponOne');
        //        } else {
        //            $('#ActivityContent').load('/EveryDaySeckill/CouponThread');
        //        }
                
        //    }


        //});
        //$('#btnDelActivity').on('click', function () {
        //    $('#ActivityContent').empty();
        //});

       

        $('#FlashActivityGuid').on('change', function () {
            var value = $(this).val();
            if (value != null && value != '') {
                $.ajax({
                    url: '/EveryDaySeckill/GetSeckillEntity',
                    type: 'post',
                    data: { activity: value }
                }).done(function (result) {
                    if (result != null) {
                        $('#FlashActivityName').val(result.ActivityName);
                        $('#FlashStartDate').val(result.StartDateTime);
                        $('#FlashEndDate').val(result.EndDateTime);
                        $('#StartDate').val(result.StartDateTime);
                        $('#EndDate').val(result.EndDateTime);
                        $.ajax({
                            url: '/EveryDaySeckill/SeckillProductList',
                            type: 'post',
                            data: { aid: value }
                        }).done(function (result) {
                            $('#flashTable').empty();
                            $('#flashTable').append(result);
                        });
                    }

                });
            } else {

            }
        });

       


        $('#btnCancel').on('click', function () {
            location.href = "/EveryDaySeckill/Index";
        });

        $('#btnSave').on('click', function () {
            //debugger;
            var ActivityContent = [];
            var activityTable = $('#ActivityContent').children();
            activityTable.find('tbody tr').each(function () {
                    //活动
                    $(this).each(function (e) {
                        var OrderBy = $('#OrderBy', this).val()
                        var ActivityType = $('#ActivityType', this).val();
                        var Activity = $('#Activity', this).val();
                        var BgUrl = $('input[name=BgUrl]', this).val();
                        var item = {};
                        item.OrderBy = OrderBy;
                        item.ActivityType = ActivityType;
                        item.Activity = Activity;
                        item.BgUrl = BgUrl;
                        if (item.Activity != '' && item.BgUrl != '')
                            ActivityContent.push(item);
                        // console.log(OrderBy);
                    });
            });
           // console.log(ActivityCoupon);
            // console.log(ActivityContent);
            var SpecialUrl = $('#SpecialUrl').val();
            var SpecialPicture = $('#SpecialPicture').val();
            var SpecialStyle = $('#SpecialStyle').val();
            var FlashActivityGuid = $('#FlashActivityGuid').val();
            var ActivityName = $('#ActivityName').val();
            var StartDate = $('#StartDate').val();
            var EndDate = $('#EndDate').val();
            var ActivityGuid = $('#ActivityGuid').val();
            var EveryDay=JSON.stringify( {
                SpecialUrl: SpecialUrl,
                SpecialPicture: SpecialPicture,
                SpecialStyle: SpecialStyle,
                ActivityContent: JSON.stringify( ActivityContent),
                FlashActivityGuid: FlashActivityGuid
            });
           
            var content = JSON.stringify({
                ActivityName: ActivityName,
                ActivityGuid: ActivityGuid,
                StartDate: StartDate,
                EndDate: EndDate,
                EveryDaySeckillInfo: null
            });
            console.log(EveryDay);
            console.log(content);
            $.ajax({
                async: false,
                url: '/EveryDaySeckill/Submit',
                type: 'post',
                data: {
                    everyDaySeckill: content,
                    items:EveryDay
                }
            }).done(function (result) {
                if (result == 1) {
                    alert("保存成功!");
                    location.href = "/EveryDaySeckill/Index";
                   
                } else {
                    alert("保存失败");
                }
            }).fail(function (r, e, status) {
                console.log(e);
                console.log("保存失败");
            });
        });

       

        $(function () {
            var hidActivityGuid = $('#ActivityGuid').val();
            if (hidActivityGuid != null && hidActivityGuid != undefined && hidActivityGuid != '') {
                $.ajax({
                    async: false,
                    type: 'post',
                    url: '/EveryDaySeckill/GetEntity',
                    data: {
                        activiity:hidActivityGuid
                    }
                }).done(function (result) {
                    result = JSON.parse(result);
                    console.log(result);
                    $('#ActivityName').val(result.ActivityName);
                    $('#StartDate').val(result.StartDate);
                    $('#EndDate').val(result.EndDate);
                    var item = result.EveryDaySeckillInfo;
                    item.ActivityContent = JSON.parse(item.ActivityContent);
                    if (item.ActivityContent != '[]' && item.ActivityContent.length > 0) {
                        var number = 0;
                        var activityTable = $('#ActivityContent').children();
                        var activityContent = item.ActivityContent;
                        activityTable.find('tbody tr').each(function () {
                            //活动
                            //activityContent[number].BgUrl != '' && activityContent[number].Activity != ''
                            if (activityContent[number] != null) {
                               // console.log(activityContent[number]);
                                $(this).each(function (e) {
                                    $('#OrderBy', this).val(activityContent[number].OrderBy)
                                    $('#ActivityType', this).val(activityContent[number].ActivityType);
                                    $('#Activity', this).val(activityContent[number].Activity);
                                    $('input[name=BgUrl]', this).val(activityContent[number].BgUrl);
                                    $('img', this).attr('src', activityContent[number].BgUrl);
                                });
                            }
                            number++;
                        });
                       // console.log(number);
                    }  else {

                    }

                    $('#SpecialUrl').val(item.SpecialUrl);
                    $('#SpecialPicture').val(item.SpecialPicture);
                    $('#SpecialStyle').val(item.SpecialStyle);
                    $('#imgspFile').attr('src', item.SpecialPicture);
                    $('#FlashActivityGuid').val(item.FlashActivityGuid);
                    $('#FlashActivityGuid').trigger('change');

                }).fail(function () {
                    console.log("失败");
                });
            }

        });

    </script>
}