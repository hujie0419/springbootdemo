
@{
    ViewBag.Title = "编辑测试";
    Layout = null;
}
@model Tuhu.Service.Config.Models.ABTestDetail

<form id="FormEditABTest" method="post" action="">
    <div>
        <input type="hidden" id="InputTestGuid" value="@Model.TestGuid" />
        <span>总流量分配</span>
        <input id="InputTestScale" type='text' name="TestScale" style='border:none;border-bottom:black solid 1px;width:50px' value="@Model.TestScale" /><label>%</label>
    </div>
    </p>
    <div>
        <table id="viewTabs" style="background: #ffffff; font-size: 12px; width: 100%; text-align: center" border="1" class="table">
            <thead>
                <tr>
                    <th style="text-align: center">分组</th>
                    <th style="text-align: center">分组名称</th>
                    <th style="text-align: center">流量分配</th>
                    <th style="text-align: center">指定用户(DeviceId按,分开)</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.GroupList != null)
                {
                    foreach (var item in Model.GroupList)
                    {
                        <tr>
                            <td style="text-align: center; vertical-align:middle">
                                <span name="GroupId" type="text">@item.GroupId</span>
                            </td>
                            <td style="text-align: center; vertical-align:middle">
                                <span name="GroupName" type="text">@item.GroupName</span>
                            </td>
                            <td style="text-align: center; vertical-align:middle">
                                <span name="GroupScale" type="text">
                                    @(Math.Round(100.0 / Model.GroupNum))%
                                </span>
                            </td>
                            <td style="text-align: center; vertical-align:middle">
                                <input name="ExceptData" type="text" style="width:100%" value="@item.ExceptData" />
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</form>
<script type="text/javascript">
    function EditABTest(target) {
        var testGuid = $("#InputTestGuid").val();
        var testScale = $("#InputTestScale").val();
        if (testScale == "") {
            alert("总流量分配不能为空!");
            return;
        }
        var re = /^[0-9]+$/;
        if (!re.test(testScale)) {
            alert("总流量分配必须是正整数!");
            return;
        }

        if (parseInt(testScale) > 100) {
            alert("总流量分配必须是0到100之间整数!");
            return;
        }

        var groupList = [];
        var groupNum = document.getElementsByName("GroupId").length;
        for (var i = 0; i < groupNum; i++) {
            groupList.push({ 'GroupId': document.getElementsByName("GroupId")[i].innerText, "ExceptData": document.getElementsByName("ExceptData")[i].value })
        }
        jsonstr = JSON.stringify(groupList);

        $.ajax({
            url: "/ABTestPlatform/EditABTest",
            type: "Post",
            data: {
                jsonstr: jsonstr,
                testGuid: testGuid,
                testScale: testScale
            },
            dataType: "json",
            async: false,
            success: function (data) {
                if (data == true) {
                    alert('保存成功！');
                    $(target).dialog("close");
                    window.location.reload();
                }
                else {
                    alert('保存失败！');
                }
            },
            error: function () {
                alert('提交失败！');
            },
        })
    }
</script>