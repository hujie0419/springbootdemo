
@{
    ViewBag.Title = "Form";
    Layout = "~/Views/Shared/_Form.cshtml";
}
<script src="~/Content/nfine/js/jqgrid/jqgrid.min.js"></script>
<link href="~/Content/nfine/js/jqgrid/jqgrid.css" rel="stylesheet" />
<script src="~/Content/nfine/js/jqgrid/grid.locale-cn.js"></script>
<div>
    <form id="form1">
        <table class="form">
            <tr>
                <th class="formTitle">名 称:</th>
                <td class="formValue">
                    <input type="text" id="Title" name="Title"  class="form-control" />
                </td>
                <th class="formTitle">排 序:</th>
                <td class="formValue">
                    <input type="number" id="OrderBy" name="OrderBy" class="form-control" />
                </td>
                <th class="formTitle">状 态：</th>
                <td class="formValue">
                    <div class="ckbox">
                        <input id="Status" name="Status" checked="checked" type="checkbox"><label for="Status">有 效</label>
                    </div>
                </td>
            </tr>
        </table>
        <input type="hidden" id="PKID" name="PKID" />
    </form>
</div>
<div class="topPanel">
    <div class="toolbar">
        <div class="btn-group">
            <a id="NF-add" class="btn btn-primary dropdown-text" onclick="btn_add()"><i class="fa fa-plus"></i>新 增</a>
        </div>
        <div class="operate">
            <ul class="nav nav-pills">
                <li class="first">已选中<span>1</span>项</li>
                <li><a id="NF-edit" authorize="yes" onclick="btn_update()"><i class="fa fa-pencil-square-o"></i>修 改</a></li>
                <li><a id="NF-delete" onclick="btn_delete()"><i class="fa fa-pencil-square-o"></i>删 除</a></li>
            </ul>
            <a href="javascript:;" class="close"></a>
        </div>
    </div>
</div>
<div class="gridPanel">
    <table id="gridList"></table>
</div>

<script type="text/javascript">
    var keyValue = $.request("keyValue");
    function gridList() {
        var $gridList = $('#gridList');
        $gridList.dataGrid({
            height: $(window).height() - 135,
            url: '/OwnBusiness/GetGridDeatilJson?keyValue=' + (keyValue == (null|"") ? $("#PKID").val() : keyValue),
            colModel: [
                { label: "PKID", name: "PKID", width: 80, align: "center",hidden:true},
                { label: "名 称", name: "Name", width: 160, align: 'left' },
                {
                    label: "图 标", name: "IconUri", width: 160, align: "left",
                    formatter: function (cellValue) {
                        if (cellValue) {
                            return '<img src="' + cellValue + '" width="30" height="30" />';
                        } else {
                            return "";
                        }
                    }
                },
                {
                    label: "是否启用", name: "Status", width: 160, align: "center",
                    formatter: function (cellvalue) {
                        return cellvalue == 1 ? "<i class=\"fa fa-toggle-on\"></i>" : "<i class=\"fa fa-toggle-off\"></i>";
                    }
                },
                { label: "排 序", name: "OrderBy", width: 100, align: "left" }
            ],
            viewrecords: true
        });
    }

    function btn_add() {
        $.modalOpen({
            id: "OwnFormDeatil",
            url: "/OwnBusiness/FormDeatil?fkValue="+ (keyValue ==null? $("#PKID").val():keyValue),
            width: "450px",
            height: "400px",
            title: "新增内容",
            callBack: function (iframeId) {
                var iframe = $.currentWindow();
                top.frames[iframeId].submitForm(iframe);
            }
        });
    }

    function btn_update() {
        var PKID = $("#gridList").jqGridRowValue().PKID;
        if (PKID) {
            $.modalOpen({
                id: "OwnFormDeatil",
                url: "/OwnBusiness/FormDeatil?fkValue=" + (keyValue == null ? $("#PKID").val() : keyValue)+"&keyValue="+PKID,
                width: "450px",
                height: "400px",
                title: "编辑内容",
                callBack: function (iframeId) {
                    var iframe = $.currentWindow();
                    top.frames[iframeId].submitForm(iframe);
                }
            });
        }
    }

    function btn_delete() {
        var PKID = $("#gridList").jqGridRowValue().PKID;
        if (PKID) {
            $.deleteForm({
                url: "/OwnBusiness/DeleteFormDeatil",
                param: { keyValue: PKID },
                success: function () {
                    $("#gridList").trigger("reloadGrid");
                }
            })
        }
    }

    function submitForm(iframe) {
        if (!$('#form1').formValid()) {
            return false;
        }
        var formData = $("#form1").formSerialize();
    
        $.submitForm({
            url: "/OwnBusiness/SubmitForm?keyValue=" + keyValue,
            param: $("#form1").formSerialize(),
            success: function (res) {
                $.currentWindow().$("#gridList").trigger("reloadGrid");
            }
        })
    }

    function init() {
        gridList();
        if (keyValue) {
            $.ajax({
                url: "/OwnBusiness/GetFormJson",
                type: "post",
                dataType: "json",
                data: {
                    keyValue: keyValue
                },
                success: function (res) {
                    if (res) {
                        $("#form1").formSerialize(res);
                    }
                }
            })
        }
    }
    
    $(function () {
        init();
    });
</script>

