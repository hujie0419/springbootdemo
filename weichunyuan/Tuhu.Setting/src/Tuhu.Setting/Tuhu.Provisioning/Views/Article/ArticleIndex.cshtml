@{
    ViewBag.Title = "文章统计";
    Layout = "../Shared/_Layout.cshtml";
}
<script type="text/javascript" src="/Scripts/KindEditor/kindeditor.js"></script>

<style>
    .button1 {
        border-radius: 0;
        padding: 5px 25px;
        border: none;
        color: #F0F0F0;
        font-size: 12px;
        font-family: "Microsoft Yahei";
        outline: none;
        cursor: pointer;
        background: #0088cc;
        border-color: #0088cc;
    }
</style>
<div style="margin-top:20px;">

    <a class="button1" href="/Article/ArticleManage" target="_blank">文章管理</a>
    @*<a class="button1" href="/Article/Theme" target="_blank">特推主题</a>
    <a class="button1" href="/Article/Hot" target="_blank">热门管理</a>
    <input class="button1" type="button" value="文章类目管理" onclick="btnEdit()" />*@   
</div>
<script>
    var kdsimple = {
        resizeType: 1,
        allowPreviewEmoticons: false,
        uploadJson: '/Article/ImageUploadToAli?from=content',
        items: [
			'bold', 'italic', 'forecolor', 'underline', 'removeformat', 'link', 'source', 'image'],
        afterChange: function () {
            this.sync();//这个是必须的,如果你要覆盖afterChange事件的话,请记得最好把这句加上.
        }
    };

    $(function () {
        LoadList(1);
        document.onkeydown = function (e) {
            var ev = document.all ? window.event : e;
            if (ev.keyCode == 13) {
                LoadList(1);
            }
        };
    });

    function switchType(type) {
        var list = { 1: "文章", 2: "专题", 3: "问题" };
        return list[type] || "文章";
    }

    function LoadList(pageindex) {
        $.ajax({
            type: "POST",
            timeout: 10000,
            url: "/Article/ArticleManage",
            data: {
                "PageIndex": pageindex,
                "KeyStr": $("#KeyStr").val(),
                "type": $(".type").find("option:selected").val()
            },
            success: function (result) {
                $(".LoadingObj").remove();
                if (result.ArticleList != "" && result.ArticleList.length > 0) {
                    var kstr = "";
                    var sum = "";
                    $.each(result.ArticleList, function (idx, item) {
                        kstr += '<tr>' +
							'<td p-type=\'' + item.Type + '\'>' + '<span style=\'color:#e74c3c;font-weight:bold;\'>【' + switchType(item.Type) + '】</span>' + item.CategoryName + '</td>' +
							'<td>' + item.SmallTitle + '<br/>' + item.BigTitle + '<br/>H5界面：' + item.ContentUrl + '</br>' +
                                 (item.Type == 3 ? '' + item.Content + '' : '') + '</td>' +
                             
							'<td align="center"><img src="' + item.SmallImage + '" height="80" width="80"/></td>' +
							'<td align="center">' + item.ClickCount + '</td>' +
                            '<td align="center"><a target="_blank" href="/ArticleCurrentComment/">' + item.YesterdayClickCount + '</td>' +
                            //'<td>' + item.SkipLocalUrlCount + '</td>' +
							//'<td>' + item.SkipTaoBaoUrlCount + '</td>' +
							'<td style="display:none;">' + item.TitleColor + '</td>' +
							'<td style="display:none;">' + item.Source + '</td>' +
                            '<td>' + item.Vote + '</td>' +
							'<td><a target="_blank" href="/ArticleComment/?ID=' + item.PKID + '">' + item.CommentCount + '</a></td>' +
                            //'<td>' + item.ShareWX + '</td>' +
                            //'<td>' + item.SharePYQ + '</td>' +
                            '<td>' + item.PublishDateTime + '</td>' +
							'<td>' +
                            '<a href="javascript:void(0)" onclick="btnAdd(' + item.PKID + ',' + item.Type + ')">编辑</a><br/>' +
                            '<a href="javascript:void(0)" style="display:none" onclick="Delete(' + item.PKID + ')">删除</a><br/>' +
                            (item.Type == 3 ? '<a href="javascript:void(0)" onclick="ReplyManage.AddReply(' + item.PKID + ')">回答</a>' : '') +
                            '</td></tr>';
                        //sum = item.YesterdaySumCount;
                    });
                    $("#currentCount").html("昨日阅读总次数  <a target='_blank' href='/ArticleCurrentComment/' style='color:#00FFFF;'>" + @ViewData["YesterdaySumCount"] + "</p>");
                    if (pageindex == 1) {
                        $("#DataList").html(kstr);
                    }
                    else {
                        $("#DataList").append(kstr);
                    }
                    if (result.ArticleList.length < 20) {
                        $("#DataList").append('<tr class="LoadingObj"><td colspan="6" align="center" style="color:#cccccc;">没有更多数据了...</td></tr>');
                    }
                    else {
                        $("#DataList").append('<tr class="LoadingObj"><td colspan="6" align="center"><a href="javascript:void(0);" onclick="LoadList(' + (pageindex + 1) + ')">加载更多数据...</a></td></tr>');
                    }
                }
                else {
                    if (pageindex == 1) {
                        $("#DataList").html('<tr class="LoadingObj"><td colspan="6" align="center" style="color:#cccccc;">没有更多数据了...</td></tr>');
                    }
                    else {
                        $("#DataList").append('<tr class="LoadingObj"><td colspan="6" align="center" style="color:#cccccc;">没有更多数据了...</td></tr>');
                    }
                }
            },
            beforeSend: function () {
                if (pageindex == 1) {
                    $("#DataList").html('<tr class="LoadingObj"><td colspan="9" align="center"><img src="/Content/images/loading.gif"/> 正在努力为您加载，请稍后...</td></tr>');
                }
                else {
                    $("#DataList").append('<tr class="LoadingObj"><td colspan="9" align="center"><img src="/Content/images/loading.gif"/> 正在努力为您加载，请稍后...</td></tr>');
                }
            }
        });
    }
    function Delete(PKID) {
        if (confirm("确认要删除该条数据吗？")) {
            $.ajax({
                type: "POST",
                timeout: 10000,
                url: "/Article/DeleteArticle",
                data: {
                    "PKID": PKID
                },
                success: function (result) {
                    if (result) {
                        LoadList(1);
                        return false;
                    }
                    else {
                        alert("删除失败");
                        return false;
                    }
                }
            });
        }
    }
    function btnAdd(PKID, Type) {
        $("#AddItem").load('/Article/AddArticle?PKID=' + PKID + "&type=" + Type, function () {
            KindEditor.create('#Content', kdsimple);
        });
        $("#AddItem").dialog({
            title: "文章管理",
            width: 900,
            height: 810,
            modal: true
        });
    }

    var ReplyManage = {
        AddReply: function (pkid) {
            this.Clear();
            $("#ReplyPKID").val(pkid);
            $("#AddReply").dialog({
                title: "回答",
                width: 500,
                height: 300,
                modal: true
            });
        },
        Clear: function () {
            $("#ReplyPKID").val("");
            $("#ReplyPhone").val("");
            $("#ReplyContent").val("");
            $("#ReplyPraise").val("");
        },
        Save: function (_replyType) {
            var _ReplyPhone = $("#ReplyPhone").val(),
                _ReplyContent = $("#ReplyContent").val(),
                _ReplyPraise = $("#ReplyPraise").val(),
                _ReplyPKID = $("#ReplyPKID").val();

            if (isNaN(_ReplyPraise) == false && this.IsMobile(_ReplyPhone)) {
                $.ajax({
                    type: "POST",
                    timeout: 10000,
                    url: "/Article/SaveReply",
                    data: {
                        "replyPhone": _ReplyPhone,
                        "replyContent": _ReplyContent,
                        "replyPraise": _ReplyPraise,
                        "replyPKID": _ReplyPKID,
                        "replyType": _replyType
                    },
                    success: function (result) {
                        if (result == 1) {
                            $("#AddReply").dialog("close");
                            alert("操作成功!");
                        }
                        else if (result == -1) {
                            alert("手机号用户不存在!");
                        }
                        else {
                            alert("操作失败!");
                        }
                    }
                });
            }
            else {
                alert("输入信息有误!");
            }
        },
        IsMobile: function (val) {
            ///<summary>验证是否为手机号</summary>
            if (val.match(/^[1][3|5|7|8]{1}[0-9]{9}$/) != null) {
                return true;
            }
            else {
                return false;
            }
        }
    }

    //文章类目管理
    function btnEdit() {
        $("#EditItem").load('/Article/EditCategory')
        $("#EditItem").dialog({
            title: "文章类目管理",
            width: 450,
            height: 450,
            modal: true,
            draggable: false,
            resizable: false,
            buttons: {
                "保存": function () {
                    //console.log(JSON.stringify(GetTableData()));
                    //return false;
                    $.ajax({
                        type: "POST",
                        url: "/Article/EditCategoryData",
                        data: "categoryStr=" + JSON.stringify(GetTableData()),
                        success: function (msg) {
                            if (msg == '0')
                                alert("保存失败！");
                            else {
                                alert("保存成功！");
                                location = 'ArticleManage';
                            }
                        }
                    });
                    $(this).dialog("close");
                },
                "取消": function () {
                    $(this).dialog("close");
                }
            }
        });
    }
</script>
<style>
    .faqlist {
        width: 100%;
    }

        .faqlist p {
            padding: 0;
            margin: 0;
        }

    table th {
        color: white;
        padding: 6px 5px;
        text-align: left;
        background-color: #0088cc;
        border: solid 1px #0088cc;
    }
</style>
<table style="margin-top:20px;">
    <tbody>
        <tr>
            <td>关键字：</td>
            <td>@Html.TextBox("KeyStr")</td>
            <td></td>
            <td>文章类目：</td>
            <td>
                <select class="type">
                    <option value="-1">所有</option>
                    <option value="0">老文章</option>
                    <option value="1">新文章</option>
                    <option value="2">专题</option>
                    <option value="3">问题</option>
                </select>
            </td>
            <td><input class="button1" type="button" value="搜索" onclick="LoadList(1)" /></td>
        </tr>
    </tbody>
</table>
<br /><br />
<div style="clear:both;"></div>
<table class="faqlist">
    <thead>
        <tr style="background-color: #5c87b2; color: #ffffff;">
            <th>文章类目</th>
            <th width="30%">文章标题</th>
            <th>文章图</th>
            <th>阅读总次数</th>
            <th id="currentCount">昨日阅读总次数</th>
            @*<th>跳转本地次数</th>
            <th>跳转淘宝次数</th>*@
            <th style="display:none;">标题颜色</th>
            <th style="display:none;">文章来源</th>
            <th>点赞数</th>
            <th>评论数</th>
            @*<th>分享微信数</th>
            <th>分享朋友圈数</th>*@
            <th>显示发布时间</th>
            <th>管理</th>
        </tr>
    </thead>
    <tbody id="DataList"></tbody>
</table>
<div id="AddItem" style="display: none"></div>
<div id="EditItem" style="display:none;"></div>
<div id="AddReply" style="display:none;">
    <table align="center">
        <tr>
            <input type="hidden" id="ReplyPKID" />
            <td>手机号:</td>
            <td>
                <input type="text" id="ReplyPhone" />
                <span style="color:red;">请输入11位有效手机号码</span>
            </td>
        </tr>
        <tr>
            <td>回答:</td>
            <td>
                <textarea cols="60" rows="5" id="ReplyContent"></textarea>
            </td>
        </tr>
        <tr>
            <td>感谢数:</td>
            <td>
                <input type="text" id="ReplyPraise" />
                <span style="color:red;">请输入数字</span>
            </td>
        </tr>
        <tr>
            <td colspan="2" align="right">
                <a class="button1" href="javascript:void(0);" onclick="ReplyManage.Save(3);">确认</a>
            </td>
        </tr>
    </table>
</div>
