
@{
    ViewBag.Title = "SubNumberList";
    Layout = "~/Views/Shared/_Index.cshtml";
}
<div class="topPanel">
    <div class="search">
        <table>
            <tr>
                <th class="formTitle">选择公众号</th>
                <td class="formValue" style="padding-left:10px;">
                    <div class="input-group">
                        <select id="WeChatOfficialAccounts" name="WeChatOfficialAccounts" class="form-control" style="width:200px;"></select>
                    </div>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="topPanel">
    <div class="toolbar">
        <div class="btn-group">
            <a class="btn btn-primary" onclick="$.reload()"><span class="glyphicon glyphicon-refresh"></span></a>
        </div>
        <div class="btn-group">
            <a class="btn btn-primary" style="margin-right:10px;" onclick="btn_add()"><span class="fa fa-pencil-square-o">新 增</span></a>
            <a class="btn btn-primary" style="margin-right:10px;" onclick="reload()"><span class="fa fa-pencil-square-o">更新公众号菜单</span></a>
        </div>
        <div class="operate">
            <ul class="nav nav-pills">
                <li class="first">已选中<span>1</span>项</li>
                <li><a id="NF-edit" onclick="btn_update()"><i class="fa fa-pencil-square-o"></i>修 改</a></li>
                <li><a id="NF-delete" onclick="btn_delete()"><i class="fa fa-trash-o"></i>启用/禁用</a></li>
            </ul>
            <a href="javascript:;" class="close"></a>
        </div>
    </div>
</div>
<div class="gridPanel">
    <table id="gridList"></table>
    <div id="gridPager"></div>
</div>
<script type="text/javascript">
    function gridList() {
        var $gridList = $('#gridList');
        var originalId = $("#WeChatOfficialAccounts").val();
        $gridList.dataGrid({
            treeGrid: true,
            treeGridModel: "adjacency",
            ExpandColumn: "Name",
            height: $(window).height() - 128,
            url: "/WechatHome/GetSubNumberGrid",
            postData: { originalId, originalId },
            colModel: [
                { label: "PKID", name: "PKID", width: 50, key: true, },
                { label: "父级PKID", name: "ParentPKID", width: 60, align: "center", hidden: true },
                { label: "组号", name: "Group", width: 80, align: "center" },
                {
                    label: "名 称", name: "Name", width: 120, align: "left"
                },
                {
                    label: "类型", name: "Type", width: 60, align: "left",
                    formatter: function (cellValue) {
                        if (cellValue == "view")
                            return "网 页"
                        else if (cellValue == "click")
                            return "点 击";
                        else if (cellValue == "miniprogram")
                            return "小程序"
                        else
                            return "";
                    }
                },
                { label: "Url", name: "Url", width: 120, align: "left" },
                { label: "小程序", name: "Appid", width: 50, align: "left" },
                { label: "路 径", name: "Pagepath", width: 80, align: "center" },
                {
                    label: "有效性", name: "IsEnabled", width: 80, align: "center",
                    formatter: function (cellvalue) {
                        return cellvalue == true ? "<i class=\"fa fa-toggle-on\"></i>" : "<i class=\"fa fa-toggle-off\"></i>";
                    }
                },
                { label: "排 序", name: "OrderBy", width: 50, align: "center" },
                {
                    label: "创建时间", name: "CreateDateTime", width: 120, align: "left",
                    formatter: "date", formatoptions: { srcformat: 'Y-m-d H:i:s', newformat: 'Y-m-d H:i:s' }
                }
            ],
            rowNum: 1000
        });
        //切换公众号
        $("#WeChatOfficialAccounts").change(function () {
            var originalId = $("#WeChatOfficialAccounts").val();
            $gridList.jqGrid('setGridParam', {
                postData: { originalId: originalId },
            }).trigger('reloadGrid');
        });
    }

    function btn_add() {
        var originalId = $("#WeChatOfficialAccounts").val();
        $.modalOpen({
            id: "SubNumberForm",
            title: "编辑公众号菜单",
            url: "/WechatHome/SubNumberForm?originalId=" + originalId,
            width: "800px",
            height: "800px",
            callBack: function (iframeId) {
                top.frames[iframeId].submitForm();
            }
        });
    }

    function btn_update() {
        var keyValue = $("#gridList").jqGridRowValue().PKID;
        var originalId = $("#WeChatOfficialAccounts").val();
        if (keyValue) {
            $.modalOpen({
                id: "SubNumberForm",
                title: "编辑公众号菜单",
                url: "/WechatHome/SubNumberForm?keyValue=" + keyValue + "&originalId=" + originalId,
                width: "800px",
                height: "800px",
                callBack: function (iframeId) {
                    top.frames[iframeId].submitForm();
                }
            });
        }
    }
    //启用或禁用
    function btn_delete() {
        var keyValue = $("#gridList").jqGridRowValue().PKID;
        if (keyValue) {
            $.confirmForm({
                prompt: "您确定启用/禁用公众号菜单吗？",
                loading: "正在更新请稍后......",
                url: "/WechatHome/DeleteSubNumber",
                param: { pkid: keyValue },
                success: function () {
                    //self.parent.window.frames[0].location.reload();
                    $("#gridList").trigger("reloadGrid");
                }
            });
        }
    }
    //同步公众号菜单到微信平台
    function reload() {
        var originalId = $("#WeChatOfficialAccounts").val();
        $.confirmForm({
            prompt: "您确定更新公众号菜单吗？",
            loading: "正在更新请稍后......",
            url: "/WechatHome/ReloadWechatMenu?originalId=" + originalId,
            success: function () {
            }
        })
    }

    //获取所有公众号
    function getWeChatOfficialAccounts() {
        var weChatOfficialAccounts = '';
        $.ajax({
            async: false,
            url: "/WechatHome/GetWeChatOfficialAccounts",
            dataType: 'json',
            success: function (res) {
                $.map(res, function (key) {
                    weChatOfficialAccounts += '<option value=' + key.OriginalId + '>' + key.name + '</option>';
                })
                $("#WeChatOfficialAccounts").empty().append(weChatOfficialAccounts);
            }
        });
    }

    $(function () {
        //获取公众号
        getWeChatOfficialAccounts();
        //加载列表数据
        gridList();
    });
</script>
