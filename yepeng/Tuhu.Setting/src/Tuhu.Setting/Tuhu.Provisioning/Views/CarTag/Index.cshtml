@{
    ViewBag.Title = "车型优惠券配置";
}

@model IEnumerable<Tuhu.Provisioning.DataAccess.Entity.SE_CarTagCouponConfig>

@section head{

    <link href="~/Scripts/jQuery-EasyUI/themes/default/easyui.css" type="text/css" rel="stylesheet" />
    <link href="~/Scripts/jQuery-EasyUI/themes/icon.css" type="text/css" rel="stylesheet" />
}
@section scripts{
<script src="/Scripts/ajaxfileupload.js" type="text/javascript"></script>
    <script type="text/javascript" src="~/Scripts/My97DatePicker/WdatePicker.js"></script>
    <script type="text/javascript" src="~/Scripts/jQuery-EasyUI/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="~/Scripts/jQuery-EasyUI/locale/easyui-lang-zh_CN.js"></script>
}
<div style="text-align:center;width:100%">
    <h3>车型优惠券配置</h3>
</div>

<table width="100%">
    <tbody>
       
        <tr>
            <td>
                名称:
            </td>
            <td>
                <input type="text" id="Name" name="Name" style="width:260px;" value="@(Model != null ? Model.FirstOrDefault().Name:"")"  />
            </td>
            <td>开始时间:</td>
            <td>
                <input type="text" class="Wdate" id="StartDateTime" name="StartDateTime" onclick="WdatePicker({ dateFmt :'yyyy-MM-dd HH:mm:ss'})" value="@(Model != null?Model.FirstOrDefault().StartDateTime.ToString("yyyy-MM-dd HH:mm:ss"):"")" />
            </td>
            <td>
                结束时间：
            </td>
            <td>
                <input type="text" class="Wdate" id="EndDateTime" name="EndDateTime" onclick="WdatePicker({ dateFmt :'yyyy-MM-dd HH:mm:ss'})" value="@(Model != null?Model.FirstOrDefault().EndDateTime.ToString("yyyy-MM-dd HH:mm:ss"):"")" />
            </td>
            <td style="text-align:center;">
                <input type="button" value="保 存"  id="btnSave" name="btnSave" style="width:200px;"/>
            </td>
        </tr>
        <tr>
            <td colspan="7">
                <div id="toolbar" style="text-align: right;">
                    <a href="javascript:void(0)" id="btnAdd" name="btnAdd" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true">添加优惠券</a>
                    <a href="javascript:void(0)" id="btnStart" name="btnStart" class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true">启 用</a>
                    <a href="javascript:void(0)" id="btnStop" name="btnStop" class="easyui-linkbutton" data-options="iconCls:'icon-cancel',plain:true">禁 用</a>
                </div>
                <table id="couponTable" class="easyui-datagrid">
                    <tbody>
                        @if (Model != null)
                        {
                            foreach (var item in Model)
                            {
                            <tr>
                                <td>@item.ID</td>
                                <td>@item.CouponGuid</td>
                                <td>@item.Discount</td>
                                <td>@item.Description</td>
                                <td>@item.MinMoney</td>
                                <td>@(item.Status == true ? "启用" : "禁用")</td>
                                <td>@item.CreateDate.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                <td>
                                    @if (string.IsNullOrWhiteSpace(item.ImageUrl))
                                    {
                                        <img id="img@(item.ID)" width="30" height="30" />
                                    }
                                    else
                                    {
                                        <img id="img@(item.ID)" width="30" height="30" src="@item.ImageUrl" />
                                    }

                                    <input type="file" id="upload@(item.ID)" name="upload@(item.ID)" onchange="UploadBgImg(this, 'img@(item.ID)','@item.ID')" />
                                </td>
                            </tr>
                            }
                        }
                    </tbody>
                </table>
            </td>
        </tr>
    </tbody>
</table>
<script type="text/javascript">
    $(function () {
        $('#couponTable').datagrid({
            title: '车型优惠券列表',
            rownumbers: true,
            toolbar: '#toolbar',
            singleSelect: true,
            columns: [[
                 { field: 'ID', title: 'ID', hidden: true },
                 { field: 'CouponGuid', title: '优惠券GUID', width:'20%' },
                 { field: 'Discount', title: '面 额',  width: '10%' },
                 { field: 'Description', title: '描 述',  width: '20%' },
                 { field: 'MinMoney', title: '使用条件',  width: '10%' },
                 { field: 'Status', title: '状态',  width: '10%' },
                 { field: 'CreateDate', title: '创建时间', width: '10%' },
                  { field: 'ImageUrl', title: '上次图片', width: '10%' }
            ]]
        });
    });

    Date.prototype.format = function (format) {
        var date = {
            "M+": this.getMonth() + 1,
            "d+": this.getDate(),
            "h+": this.getHours(),
            "m+": this.getMinutes(),
            "s+": this.getSeconds(),
            "q+": Math.floor((this.getMonth() + 3) / 3),
            "S+": this.getMilliseconds()
        };
        if (/(y+)/i.test(format)) {
            format = format.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length));
        }
        for (var k in date) {
            if (new RegExp("(" + k + ")").test(format)) {
                format = format.replace(RegExp.$1, RegExp.$1.length == 1
                       ? date[k] : ("00" + date[k]).substr(("" + date[k]).length));
            }
        }
        return format;
    };

    $('#btnAdd').on('click', function () {
        $.messager.prompt("优惠券","请输入优惠券的GUID", function (input) {
            $.ajax({
                type: 'post',
                url: '/CarTag/GetCouponValidate',
                data: { GUID: input, startDateTime: $('#StartDateTime').val(), endDateTime: $('#EndDateTime').val() }
            }).done(function (result) {
                if (!result) {
                    $.messager.alert("系统提示","优惠券不存在");
                }
                if (result == 0) {
                    $.messager.alert("系统提示", "优惠券保存失败");
                    return false;
                }

                window.location.reload();

                //var row = {};
                //row.CouponGuid = result.CouponGuid;
                //row.Discount = result.Discount;
                //row.Description = result.Description;
                //row.MinMoney = result.MinMoney;
                //row.Status = true;
                //row.CreateDate = new Date().format("yyyy-MM-dd h:m:s");
                //$('#couponTable').datagrid('appendRow',row);
            });
        },"");
    });

    $('#btnStart').on('click', function () {
        var row = $('#couponTable').datagrid('getSelected');
        if (row) {
            $.messager.confirm("系统提示", "您确定禁用" + row.Description + "?", function (r) {

                if (r) {
                    $.ajax({
                        url: '/CarTag/UpdateStatus',
                        type: 'post',
                        data: { id: row.ID, status: 1 }
                    }).done(function (result) {
                        if (result == 1) {
                            $.messager.alert("系统提示", row.Description + " 启用");
                            var index = $('#couponTable').datagrid('getRowIndex', row);
                            row.Status = "启用";
                            $('#couponTable').datagrid('updateRow', {
                                index: index,
                                row: row
                            });
                            $('#couponTable').datagrid('clearSelections');
                        } else {
                            $.messager.alert("系统提示", "设置状态失败");
                        }
                    });
                }
            });
           
        } else {
            $.messager.alert("系统提示", "请编辑要选择的行");
        }
    });

    $('#btnStop').on('click', function () {
        var row = $('#couponTable').datagrid('getSelected');
        if (row) {
            $.messager.confirm("系统提示", "您确定禁用" + row.Description + "?", function (r) {
                if (r) {
                    $.ajax({
                        url: '/CarTag/UpdateStatus',
                        type: 'post',
                        data: { id: row.ID, status: 0 }
                    }).done(function (result) {
                        if (result == 1) {
                            $.messager.alert("系统提示", row.Description + " 禁用");
                            var index = $('#couponTable').datagrid('getRowIndex', row);
                            row.Status = "禁用";
                            $('#couponTable').datagrid('updateRow', {
                                index: index,
                                row: row
                            });
                            $('#couponTable').datagrid('clearSelections');
                        } else {
                            $.messager.alert("系统提示", "设置状态失败");
                        }
                    });
                }
            });

           
        } else {
            $.messager.alert("系统提示", "请编辑要选择的行");
        }
    });

    $('#btnSave').on('click', function () {
        $.ajax({
            url: '/CarTag/UpdateDateTime',
            type: 'post',
            data: { startDateTime: $('#StartDateTime').val(), endDateTime: $('#EndDateTime').val(), name:$('#Name').val() }
        }).done(function (result) {
            if (result == 1) {
                $.messager.alert("系统提示", "保存成功");
                window.location.reload();
            } else {
                console.log("保存失败");
            }
        });
    });

    function UploadBgImg(obj, showImg, id) {
      
        var pobj = $(obj);
        var rd = Math.ceil(Math.random() * 9999) + 1;
        var fileElId = $(obj).attr("id");
        console.log(fileElId);
        $.ajaxFileUpload({
            url: '/Article/ImageUploadToAli?rd=' + rd,
            secureuri: false,
            fileElementId: fileElId,
            dataType: 'json',
            async: false,
            success: function (result) {
                if (result.BImage != "" && result.SImage != "") {
                    $.ajax({
                        url: '/CarTag/UpdateImageUrl',
                        type:'post',
                        data: { id: id, url: result.BImage }
                    }).done(function (r) {
                        if (r == 1) {
                            $("#" + showImg).attr("src", result.SImage).show();
                        } else {
                            alert("上传失败");
                        }
                    })
                  
                    //$("#" + showUrl).val(result.BImage);
                } else {
                    alert("上传失败！");
                }
            },
            error: function (data, status, e)//服务器响应失败处理函数
            {
                alert(e);
            }
        });
    }


</script>
