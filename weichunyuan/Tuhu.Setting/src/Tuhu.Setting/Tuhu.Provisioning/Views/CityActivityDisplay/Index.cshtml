@{
    ViewBag.Title = "分城市显示活动页";
}
@using Tuhu.Provisioning.DataAccess.Entity;

<style type="text/css">
    .main {
        margin: 20px;
    }

    .searchForm {
        margin-top: 20px;
    }

    .input-group input {
        height: 30px;
    }

    .input-group span {
        background-color: #5c87b2;
        color: white;
        height: 30px;
    }

    .input-group select {
        height: 30px;
    }

    button {
        height: 30px;
    }

    #createActivityBtn {
        margin-bottom: 10px;
    }

    table th {
        text-align: center;
    }

    table td {
        text-align: center;
    }

    #CreateActivityDialog {
        font-size: 13px;
    }

    #activityUrlDialog {
        font-size: 13px;
    }

        #activityUrlDialog select {
            width: 150px;
            height: 30px;
        }
</style>
<link href="~/Scripts/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet" />
<script scr="~/Scripts/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
<script src="~/Scripts/ActivityPage/CityActivityDisplayConfig.js?v=7"></script>
<script src="~/Scripts/jquery.cookie.js"></script>
<script src="~/Scripts/kkpager/kkpager.min.js"></script>
<link href="~/Scripts/kkpager/kkpager_blue.css" rel="stylesheet" />

<link href="~/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.min.css" rel="stylesheet" />
<script src="~/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.min.js"></script>
<script src="https://file-tuhu-cn.alikunlun.com/yewu/oms/scripts/md503.js" type="text/javascript"></script>
<script src="https://file-tuhu-cn.alikunlun.com/yewu/oms/scripts/verifyBtn.js" type="text/javascript"></script>
<h3>分类型显示链接生成工具</h3>
<div class="main">
    <div class="searchForm">
        <form id="searchForm">
            <div class="row">
                <div style="float:left; width:200px;">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon">名称</span>
                            <input type="text" class="form-control" name="activityName">
                        </div>
                    </div>
                </div>
                <div style="float:left;width:300px; margin-left:20px;">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon">开始时间</span>
                            <input id="startTime1" type="text" class="form-control" name="startTime">
                        </div>
                    </div>
                </div>
                <div style="float:left;width:300px; margin-left:20px;">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon">结束时间</span>
                            <input id="endTime1" type="text" class="form-control" name="endTime">
                        </div>
                    </div>
                </div>

                <div style="float:left;width:200px; margin-left:20px;">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon">创建人</span>
                            <input type="text" class="form-control" name="createUser">
                        </div>
                    </div>
                </div>

                <div style="float:left;width:200px;margin-left:20px;">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon">更新人</span>
                            <input type="text" class="form-control" name="updateUser">
                        </div>
                    </div>
                </div>

                <div style="float:left;width:150px;margin-left:20px;">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon">状态</span>
                            <select name="status">
                                <option value="所有" selected>所有</option>
                                <option value="未开始">未开始</option>
                                <option value="进行中">进行中</option>
                                <option value="已结束">已结束</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="float:left;margin-left:20px;">
                    <div class="form-group">
                        <button id="searchBtn" type="button" class="btn btn-primary" onclick="search()">
                            <span class="glyphicon glyphicon-search" aria-hidden="true"></span> 搜索
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div>
        <input type="button" style="display:none;" value="创建活动" id="createActivityBtn" class="btn btn-primary" onclick="createActivity()" btnkey="CreateActivity" istuhuverify="1" />
    </div>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th width="3%"> PKID</th>
                <th width="8%">名称</th>
                <th width="31%">活动地址</th>
                <th width="3%">类型</th>
                <th width="10%">开始时间</th>
                <th width="10%">结束时间</th>
                <th width="7%">状态</th>
                <th width="8%">创建人</th>
                <th width="8%">更新人</th>
                <th width="15%">操作</th>
            </tr>
        </thead>
        <tbody>
            @{
                foreach (var item in ViewBag.activityList as List<RegionVehicleIdActivityConfig>)
                {
                    <tr>
                        <td data-PKID="@item.PKID">@item.PKID</td>
                        <td>@item.ActivityName</td>
                        @{
                            var h5Url = "https://wx.tuhu.cn/react/transitPage/#!/page=home?activity=" + item.ActivityId;
                            var wxUrl = "/pages/transitPage/transitPage?activity=" + item.ActivityId;
                        }
                        <td data-activityId="@item.ActivityId">
                            <p>
                                H5链接:<a href="@h5Url" , target="_blank">@h5Url</a>
                            </p>
                            <p>
                                小程序链接:@wxUrl
                            </p>
                        </td>
                        @if (@item.ActivityType == "Region")
                        {
                            <td>地区</td>
                        }
                        else
                        {
                            <td>车型</td>
                        }

                        <td>@item.StartTime.Value.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        <td>@item.EndTime.Value.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        @if (item.IsEnabled == 1 && item.StartTime > DateTime.Now)
                        {
                            <td style="color:green" data-isEnabled="1">启用 尚未开始</td>
                        }
                        else if (item.IsEnabled == 1 && item.StartTime < DateTime.Now && item.EndTime > DateTime.Now)
                        {
                            <td style="color:green" data-isEnabled="1">启用 进行中</td>
                        }
                        else if (item.IsEnabled == 1 && item.EndTime < DateTime.Now)
                        {
                            <td style="color:red" data-isEnabled="1">启用 已结束</td>
                        }
                        else if (item.IsEnabled == 0 && item.StartTime > DateTime.Now)
                        {
                            <td style="color:red" data-isEnabled="0">禁用 尚未开始</td>
                        }
                        else if (item.IsEnabled == 0 && item.StartTime < DateTime.Now && item.EndTime > DateTime.Now)
                        {
                            <td style="color:red" data-isEnabled="0">禁用 进行中</td>
                        }
                        else if (item.IsEnabled == 0 && item.EndTime < DateTime.Now)
                        {
                            <td style="color:red" data-isEnabled="0">禁用 已结束</td>
                        }

                        <td>@item.CreateUser</td>
                        <td>@item.UpdateUser</td>
                        <td>
                            <a btnkey="UpdateActivity" istuhuverify="1" style="cursor: pointer; display:none;" onclick="editActivity(this)">编辑</a>&nbsp;
                            <a btnkey="DeleteActivity" istuhuverify="1" style="cursor: pointer; display:none;" onclick="deleteActivity(this)">删除</a>&nbsp;
                            <a style="cursor: pointer" onclick="lookOpLog(this)">操作日志</a>
                        </td>

                    </tr>
                }
            }
            <tr>
                <td id="kkpager" colspan="11"></td>
            </tr>
        </tbody>
    </table>
</div>

<!--二次确认及提示对话框-->
<div id="confirmDialog"></div>


<!--添加活动dialog-->
<div id="CreateActivityDialog" style="display:none; overflow:hidden">
    <form id="activityBaseInfoForm" class="form-horizontal">
        <div class="form-group">
            <input id="pkid" name="pkid" type="number" value="" style="display:none" />
            <div class="col-sm-4">
                <div class="input-group">
                    <span class="input-group-addon">名称</span>
                    <input id="activityName" name="activityName" type="text">
                </div>
            </div>
            <div class="col-sm-4">
                <div class="input-group">
                    <span class="input-group-addon">类型</span>
                    <select style="width:100px;" id="typeSelect" name="activityType">
                        <option value="" selected>请选择</option>
                        <option value="Vehicle">车型</option>
                        <option value="Region">地区</option>
                    </select>
                </div>
            </div>
            <div class="col-sm-4">
                <input id="isEnabled" type="number" name="isEnabled" value="1" hidden />
                <div class="btn-group btn-group-sm">
                    <button id="btnEnable" type="button" class="btn btn-info" onclick="$(this).next().removeClass('btn-info'); $(this).next().addClass('btn-default'); $(this).addClass('btn-info'); $(this).parent().prev().val('1');">启用</button>
                    <button id="btnDisEnable" type="button" class="btn btn-default" onclick="$(this).prev().removeClass('btn-info'); $(this).prev().addClass('btn-default'); $(this).addClass('btn-info'); $(this).parent().prev().val('0');">禁用</button>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-4" style="display:none">
                <div class="input-group">
                    <span class="input-group-addon">活动ID</span>
                    <input id="activityId" type="text" name="activityId" class="form-control">
                </div>
            </div>
            <div class="col-sm-4">
                <div class="input-group">
                    <span class="input-group-addon">开始时间</span>
                    <input type="text" id="startTime" class="form-control" name="startTime" style="z-index:10000;position:relative;">
                </div>
            </div>
            <div class="col-sm-4">
                <div class="input-group">
                    <span class="input-group-addon">结束时间</span>
                    <input type="text" id="endTime" class="form-control" name="endTime" style="z-index:10000;position:relative;">
                </div>
            </div>
        </div>
    </form>


    <div style="margin-left:20px; margin-top:30px; margin-bottom:30px;">
        <button type="button" class="btn btn-default" onclick="addActivityUrl()">添加活动页</button>
    </div>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th width="10%">页面类型</th>
                <th width="40%">URL</th>
                <th width="30%">名称</th>
                <th width="20%">操作</th>
            </tr>
        </thead>
        <tbody id="urlTableBody"></tbody>
    </table>

    <div style="width:100%; text-align:center;">
        <button type="button" id="saveActivityBtn" class="btn btn-primary">保存</button>
    </div>
</div>

<!--添加车型/地区配置-->
<div id="activityUrlDialog" style="display:none;overflow:hidden">
    <form class="form-horizontal" id="UrlForm">
        <input type="number" name="isDefault" value="0" id="isDefault" hidden="hidden" />
        <input type="text" name="activityId" id="activityId" value="" hidden="hidden" />
        <div class="form-group">
            <label class="col-sm-3 control-label">H5Url</label>
            <div class="col-sm-9">
                <input id="targetUrl" name="targetUrl" type="text" class="form-control" style="height:30px;">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-4 control-label">H5活动页名称</label>
            <div class="col-sm-6">
                <input type="text" id="h5UrlName" class="form-control" style="height:30px;" disabled="disabled">
            </div>
            <div class="col-sm-2">
                <button type="button" class="btn btn-primary" onclick="findTitle()">匹配</button>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-3 control-label">WxappURL</label>
            <div class="col-sm-9">
                <input id="wxappUrl" name="wxappUrl" type="text" class="form-control" style="height:30px;">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-4 control-label">小程序活动页名称</label>
            <div class="col-sm-6">
                <input type="text" id="wxUrlName" class="form-control" style="height:30px;" disabled="disabled">
            </div>
            <div class="col-sm-2">
                <button type="button" class="btn btn-primary" onclick="findWxTitle()">匹配</button>
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-4">
                <button id="addRegionVehicleBtn" type="button" class="btn btn-primary" onclick="addregion(this)">添加地区</button>
            </div>
            <div class="col-sm-6 col-sm-offset-2">
                <input id="setDefaultPageCheckBox" type="checkbox" onchange="setDefaultPage(this)" />
                <label class="label label-default" style="font-size:12px">指定该页面是否为默认页面</label>
            </div>
        </div>
    </form>
    <div style="width:100%;text-align:center">
        <button type="button" id="saveUrlBtn" class="btn btn-primary" onclick="saveUrl()">保存</button>
    </div>
</div>

<div id="opLogDialog" style="display:none;font-size:13px">
    <input id="opLogPkid" hidden />
    <button class="btn btn-primary btn-sm" type="button" autofocus>开始时间:</button>
    <input id="opLogStartTime" type="text" style="height:25px; margin-left:10px; width:150px" />
    <button class="btn btn-primary btn-sm" type="button">结束时间:</button>
    <input id="opLogEndTime" type="text" style="height:25px;margin-left:10px; width:150px" />
    <button id="searchLogBtn" class="btn btn-info btn-sm" style="margin-left:30px" type="button" onclick="searchOpLog()">搜索</button>
    <table class="table table-bordered" style="margin-top:20px">
        <thead>
            <tr>
                <th width="20%">操作人</th>
                <th width="20%">操作时间</th>
                <th width="60%">操作内容</th>
            </tr>
        </thead>
        <tbody id="opLogTbody"></tbody>
    </table>
</div>


<script type="text/javascript">
    $(function () {
        $("#opLogStartTime").datetimepicker({
            timeFormat: "HH:mm:ss",
            dateFormat: "yy-mm-dd"
        });
        $("#opLogEndTime").datetimepicker({
            timeFormat: "HH:mm:ss",
            dateFormat: "yy-mm-dd"
        });
        $("#searchForm #startTime1").datetimepicker({
            timeFormat: "HH:mm:ss",
            dateFormat: "yy-mm-dd"
        });
        $("#searchForm #endTime1").datetimepicker({
            timeFormat: "HH:mm:ss",
            dateFormat: "yy-mm-dd"
        });

        $("#CreateActivityDialog #startTime").datetimepicker({
            timeFormat: "HH:mm:ss",
            dateFormat: "yy-mm-dd"
        });
        $("#CreateActivityDialog #endTime").datetimepicker({
            timeFormat: "HH:mm:ss",
            dateFormat: "yy-mm-dd"
        });

    });

    var totalPage = @(ViewBag.totalPage),
        totalRecords = @(ViewBag.totalRecords),
        _pageIndex = @(ViewBag.pageIndex),
        pageNo = _pageIndex || 1;

    //生成分页
    kkpager.generPageHtml({
        pno: pageNo,
        //总页码
        total: totalPage,
        //总数据条数
        totalRecords: totalRecords,
        mode:'click',
        click: function (pageIndex) {
            var url = window.location.href;
            if (url.indexOf("pageIndex") == -1)
                url += "?pageIndex=" + (pageIndex || 1);
            else {
                var index = url.indexOf("pageIndex=");
                url = url.substr(0, index) + "pageIndex=" + (pageIndex || 1);
            }
            window.location.href = url;
        },
        isGoPage: false,
        getLink: function (n) {
            return 'javascript:void(0);';
        }
    });
    kkpager.selectPage(_pageIndex);
</script>
