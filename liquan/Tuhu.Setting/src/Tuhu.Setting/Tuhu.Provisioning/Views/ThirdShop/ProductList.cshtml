@using System.Globalization
@using Tuhu.Provisioning.DataAccess.Entity;
@using Tuhu.Provisioning;
@model Tuhu.Component.Common.Models.ListModel<ProductPriceModel>
@{
    Layout = null;
    var Request = ViewBag.Request as ProductListRequest;
}

@helper ShowPrice(decimal? price, int Type, string ShopName, decimal? OriginalPrice = 0M, string pid = "", string type = "")
{

    var href = string.Empty;

    //增加商品详情地址拼接
    if (!string.IsNullOrWhiteSpace(type) && !string.IsNullOrWhiteSpace(pid))
    {

        var ziPid = string.Empty;

        if (type == "ZY") //自营跳转官网时需要处理PID
        {
            if (!string.IsNullOrWhiteSpace(pid.Split('|')[1]))
            {
                ziPid = pid.Replace("|", "/");
            }
            else
            {
                ziPid = pid.Replace("|", "");
            }
        }

        var tempPid = pid.Split(',');
        if (tempPid.Length == 2 && !string.IsNullOrWhiteSpace(tempPid[1]) && Convert.ToUInt64(tempPid[1]) > 0)
        {
            switch (type)
            {
                case "TB":
                    href = "https://item.taobao.com/item.htm?id=" + tempPid[0] + "&skuid=" + tempPid[1]; break;
                case "TM":
                    href = "https://detail.tmall.com/item.htm?id=" + tempPid[0] + "&skuid=" + tempPid[1]; break;
                case "JD":
                    href = "http://item.jd.com/" + tempPid[0] + ".html"; break;
                case "ZY":
                    href = "https://item.tuhu.cn/Products/" + ziPid + ".html"; break;
            }
        }
        else
        {
            switch (type)
            {
                case "TB":
                    href = "https://item.taobao.com/item.htm?id=" + tempPid[0]; break;
                case "TM":
                    href = "https://detail.tmall.com/item.htm?id=" + tempPid[0]; break;
                case "JD":
                    href = "http://item.jd.com/" + tempPid[0] + ".html"; break;
                case "ZY":
                    href = "https://item.tuhu.cn/Products/" + ziPid + ".html"; break;
            }
        }

    }

    if (price == null)
    {
        if (Type == 0)
        {
            <span><a href="javascript:void(0)" onclick="ThirdFunc.TryFetchLowestPrice('@ShopName',@price,'@href')">-</a></span>
        }
        else
        {
            <span>-</span>;
        }
    }
    else
    {
        if (Type == 0)
        {
            <span><a href="javascript:void(0)" onclick="ThirdFunc.TryFetchLowestPrice('@ShopName',@price,'@href')">@(price.Value.ToString("0")) </a></span>;
        }
        else if (Type == 1)
        {
            <span><a href="javascript:void(0)" onclick="ThirdFunc.CouponDetail('@ShopName',@price,@OriginalPrice)">@(Math.Round(price.Value).ToString("0")) </a></span>;
        }
        else
        {
            <span>@(Math.Round(price.Value).ToString("0"))</span>;
        }
    }
}
@if (Model.Source.Any())
{
    <table data-count="@Model.Pager.TotalItem" class="table" width="100%" style="text-align:center;">
        <tr>
            <th>
                <input type="checkbox" name="SelectAll" value="" />全选
            </th>
            <th>品牌</th>
            <th>PID</th>
            <th>产品名称</th>
            <th>进货价</th>
            @*<th>最低限价</th>*@
            <th>最低面价(平时)</th>
            <th>最低面价(大促)</th>
            <th>最低券后价(平时)</th>
            <th>最低券后价(大促)</th>
            <th>最小毛利</th>
            <th>可用券</th>
            <th>官网价格</th>
            <th>途虎淘宝</th>
            <th>途虎淘宝2</th>
            <th>途虎天猫1</th>
            <th>途虎天猫2</th>
            <th>途虎天猫3</th>
            <th>途虎天猫4</th>
            <th>途虎京东2</th>
            <th>途虎京东旗舰</th>
            <th>编辑</th>
        </tr>
        @foreach (var item in Model.Source)
        {
            <tr>
                <td><input type="checkbox" name="selectSingle" value="@item.PID" data-pid="@item.PID" /></td>
                <td>@(item.Brand ?? "-")</td>
                <td>@item.PID</td>
                <td>@item.ProductName</td>
                <td>@ShowPrice(item.Cost, 2, "")</td>
                @*<td><a class="pointer" href="javascript:void(0)" onclick="ThirdFunc.EditLowestLimit('@item.PID', '@(item.LowestLimit == null ? "-" : item.LowestLimit.Value.ToString())')">@ShowPrice(item.LowestLimit, 2, "")</a></td>*@
                <td><a class="pointer" href="javascript:void(0)" onclick="ThirdFunc.EditLowestLimit('LowestPrice_Normal','@item.PID', '@(item.LowestPrice_Normal == null ? "-" : item.LowestPrice_Normal.Value.ToString())')">@ShowPrice(item.LowestPrice_Normal, 2, "")</a></td>
                <td><a class="pointer" href="javascript:void(0)" onclick="ThirdFunc.EditLowestLimit('LowestPrice_Promotion','@item.PID', '@(item.LowestPrice_Promotion == null ? "-" : item.LowestPrice_Promotion.Value.ToString())')">@ShowPrice(item.LowestPrice_Promotion, 2, "")</a></td>
                <td><a class="pointer" href="javascript:void(0)" onclick="ThirdFunc.EditLowestLimit('CouponPrice_Normal','@item.PID', '@(item.CouponPrice_Normal == null ? "-" : item.CouponPrice_Normal.Value.ToString())')">@ShowPrice(item.CouponPrice_Normal, 2, "")</a></td>
                <td><a class="pointer" href="javascript:void(0)" onclick="ThirdFunc.EditLowestLimit('CouponPrice_Promotion','@item.PID', '@(item.CouponPrice_Promotion == null ? "-" : item.CouponPrice_Promotion.Value.ToString())')">@ShowPrice(item.CouponPrice_Promotion, 2, "")</a></td>
                <td>@ShowPrice(item.Min_maoliValue, 2, "")</td>
                <td>@(item.CanUseCoupon.HasValue ? (item.CanUseCoupon.Value ? "是" : "否") : "是")</td>
                <td>@ShowPrice(item.Price, 0, "自有平台", 0M, item.PID, "ZY")<hr />@ShowPrice(item.LowestPrice, 1, "自有平台", item.Price)</td>
                <td>@ShowPrice(item.TBPrice, 0, "途虎淘宝", 0M, item.TBPID, "TB")<hr />@ShowPrice(item.TBLowestPrice, 1, "途虎淘宝", item.TBPrice)</td>
                <td>@ShowPrice(item.TB2Price, 0, "途虎淘宝2", 0M, item.TB2PID, "TB")<hr />@ShowPrice(item.TB2LowestPrice, 1, "途虎淘宝2", item.TB2Price)</td>
                <td>@ShowPrice(item.TM1Price, 0, "途虎天猫1", 0M, item.TM1PID, "TM")<hr />@ShowPrice(item.TM1LowestPrice, 1, "途虎天猫1", item.TM1Price)</td>
                <td>@ShowPrice(item.TM2Price, 0, "途虎天猫2", 0M, item.TM2PID, "TM")<hr />@ShowPrice(item.TM2LowestPrice, 1, "途虎天猫2", item.TM2Price)</td>
                <td>@ShowPrice(item.TM3Price, 0, "途虎天猫3", 0M, item.TM3PID, "TM")<hr />@ShowPrice(item.TM3LowestPrice, 1, "途虎天猫3", item.TM3Price)</td>
                <td>@ShowPrice(item.TM4Price, 0, "途虎天猫4", 0M, item.TM4PID, "TM")<hr />@ShowPrice(item.TM4LowestPrice, 1, "途虎天猫4", item.TM4Price)</td>
                <td>@ShowPrice(item.JDPrice, 0, "途虎京东2", 0M, item.JDPID, "JD")<hr />@ShowPrice(item.JDLowestPrice, 1, "途虎京东2", item.JDPrice)</td>
                <td>@ShowPrice(item.JDFlagShipPrice, 0, "途虎京东旗舰", 0M, item.JDFlagShipPID, "JD")<hr />@ShowPrice(item.JDFlagShipLowestPrice, 1, "途虎京东旗舰", item.JDFlagShipPrice)</td>
                <td>
                    <a href="javascript:void(0)" onclick="ThirdFunc.BatchEdit('@item.PID', '@(item.CanUseCoupon.HasValue?(item.CanUseCoupon.Value?"true":"false"):"true")')">编辑</a>
                    <a href="/Tire/ShowTireModifyLogs?pid=@(item.PID)&type=CanUseCoupon" target="_blank">查看日志</a>
                </td>
            </tr>
        }
    </table>
    @Html.Pager(Model.Pager, true, id => Url.Action("ProductList", new
{
    ProductName = Request.ProductName,
    PID = Request.PID,
    Brand = Request.Brand,
    OnSale = Request.OnSale,
    Type = Request.Type,
    LowestPriceStatus = Request.LowestPriceStatus,
    LowestPriceValue = Request.LowestPriceValue,
    CanUseCouponStatus = Request.CanUseCouponStatus,
    CouponPriceStatus = Request.CouponPriceStatus,
    CouponPriceValue = Request.CouponPriceValue,
    ManyCustomPrice = Request.ManyCustomPrice,
    Contrast = Request.Contrast,
    SingleCustomPrice = Request.SingleCustomPrice,
    Proportion = Request.Proportion,
    PageIndex = id,
    PageSize = Request.PageSize,
    MaxTireCount = Request.MaxTireCount,
    Min_maoliValue = Request.Min_maoliValue,
    Min_maoliStatus = Request.Min_maoliStatus,
    Website_maoliStatus = Request.Website_maoliStatus,
    Website_maoliValue = Request.Website_maoliValue,

}))
}

<script>
    $("[name=SelectAll]").change(function () {
        $("[name=selectSingle]").prop("checked", $(this).prop("checked"));
    })
</script>