@using Tuhu.Provisioning.DataAccess.Entity;
@using Tuhu.Provisioning.Business;
@using System.Web.Script.Serialization;
@using Newtonsoft.Json;
@model  ActivityPageConfig
@{
    Layout = null;
}
<script src="/Scripts/ajaxfileupload.js" type="text/javascript"></script>
<style>
    .btn {
        margin-top: 20px;
        padding: 5px 25px;
        border: none;
        color: #F0F0F0;
        font-size: 12px;
        outline: none;
        cursor: pointer;
        background: cornflowerblue;
        border-color: cornflowerblue;
    }

    .table td {
        padding: 0;
        text-align: center;
    }

    a {
        color: cornflowerblue;
    }
</style>
<form action="" method="post">
    <input type="hidden" value="@Model.Id" name="DefaultID" />
    <input type="hidden" value="@Model.DefaultUrlId" name="DefaultUrlId" />
    <div>
        <fieldset>
            <legend>活动数据</legend>
            <table id="table1" style="width:100%">
                <tr>
                    <td>名称</td>
                    <td>
                        <input type="hidden" value="@Model.Id" name="Id" />
                        <input type="text" value="@Model.Name" name="Name" />
                        <label style="color:red">*</label>
                    </td>

                </tr>
                <tr>
                    <td>开始时间</td>
                    <td>
                        <input type="datetime-local" value="@Model.StartTime.ToString("yyyy-MM-ddTHH:mm")" name="StartTime" />
                        <label style="color:red">*</label>
                    </td>
                </tr>
                <tr>
                    <td>结束时间</td>
                    <td>
                        <input type="datetime-local" value="@Model.EndTime.ToString("yyyy-MM-ddTHH:mm")" name="EndTime" />
                        <label style="color:red">*</label>
                    </td>
                </tr>

            </table>
        </fieldset>
        <fieldset>
            <legend>分  享</legend>
            <table>
                <tbody>
                    @{
                        ShareParams share = new ShareParams();
                        if (!string.IsNullOrWhiteSpace(Model.ShareParameters))
                        {
                            share = JsonConvert.DeserializeObject<ShareParams>(Model.ShareParameters);
                            share.shareUrl = share.shareUrl.Substring(0, share.shareUrl.IndexOf("&type=2&utm_source=1"));
                        }

                    }
                    <tr>
                        <td>
                            微信URL：
                        </td>
                        <td>
                            <input type="text" style="width:600px;" value="@share.shareUrl" id="wxURL" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            APP内URL：
                        </td>
                        <td>
                            <input type="text" style="width:600px;" value="@share.URL" id="appURL" />
                        </td>
                    </tr>
                    <tr>
                        <td>分享图：</td>
                        <td>
                            <img id="imgPic" src="@share.shareImage" style="width:30px;height:30px;" />
                            <input type="file" id="filePic" name="filePic" /><br />
                            <input type="text" style="width:600px;" value="@share.shareImage" id="txtDSPicture" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            分享标题:
                        </td>
                        <td>
                            <input type="text" style="width:600px;" value="@share.shareTitle" id="Title" />
                        </td>
                    </tr>
                    <tr>
                        <td>分享描述:</td>
                        <td>
                            <textarea style="width:600px;" id="DSDescribe">@share.shareDescrip</textarea>
                        </td>
                    </tr>
                </tbody>
            </table>
        </fieldset>
        <fieldset>
            <legend>跳转活动页</legend>
            <p><a style="color: blue" href="javascript:void(0)" onclick="Add()">添加</a></p>
            <table id="table2" style="width:100%">
                <thead>
                    <tr>
                        <th>默认页 <label style="color:red">*</label></th>
                        <th style="width:400px;">url</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in ViewBag.ActivityPageUrlConfig)
                    {
                        RegionActivityPageConfigManager manager = new RegionActivityPageConfigManager();
                        JavaScriptSerializer java = new JavaScriptSerializer();
                        var list = java.Serialize(manager.GetRegionRelation(item.Id));
                        <tr id="@item.Id" pkid="@item.Id" RegionList="@list" ActivityPageId="@item.ActivityPageId">
                            <td>
                                <input type="checkbox" @(Model.DefaultUrlId == @item.Id ? "checked" : "") class="IsDefault" onclick="CheckBox(this)" />
                            </td>
                            <td><input type="text" class="Url" style="width:500px;" value="@item.Url" /></td>
                            <td>
                                <a style="color:blue" href="javascript:void(0)" onclick="AddRegionON(this,@item.Id)">地区</a>

                                <a style="color:blue" href="javascript:void(0)" onclick="CheckRegion(this)">已选地区</a>

                                <a style="color:blue" href="javascript:void(0)" id="@item.Id" onclick="Delete(this)">删除</a>
                            </td>
                        </tr>
                    }

                </tbody>
            </table>
            <div id="attrs">
            </div>
        </fieldset>

        <table id="ActTable" style="display:none">
            <tr class="region" id="0" pkid="0" ActivityPageId="@Model.Id">
                <td><input type="checkbox" class="IsDefault" onclick="CheckBox(this)" /></td>
                <td><input type="text" class="Url" style="width:500px;" /></td>
                <td>
                    <a style="color:blue" href="javascript:void(0)" onclick="AddRegionON(this,0)">地区</a>
                    <a style="color:blue" href="javascript:void(0)" onclick="CheckRegion(this)">已选地区</a>
                    <a style="color:blue" href="javascript:void(0)" id="0" onclick="Delete(this)">删除</a>
                </td>
            </tr>
        </table>

    </div>
</form>

<script>
    function SaveModels() {
        if (!$("input[name='Name']").val()) {
            alert("名称不能为空")
            return false;
        }
        var isDefault = false;
        $(".IsDefault").each(function (l) {
            if ($(this).is(':checked')) {
                isDefault = true;
            }
        })
        if (!isDefault) {
            alert("添加或勾选默认页")
            return false;
        }
        var jsonDefault = {
            "Id": "",
            "Name": "",
            "StartTime": "",
            "EndTime": "",
            "DefaultUrlId": true,
            "ShareParameters": ""
        };

        var img = $('#txtDSPicture').val();
        var title = $('#Title').val();
        var dec = $('#DSDescribe').val();
        var url = $('#wxURL').val();
        var appurl = $('#appURL').val();
        var jsonstring = {};
        jsonstring.Type = 2;
        jsonstring.URL = appurl;
        jsonstring.shareImage = img;
        jsonstring.shareTitle = title;
        jsonstring.shareDescrip = dec;
        jsonstring.shareUrl = url + "&type=2&utm_source=1";

        console.log(JSON.stringify(jsonstring))
        jsonDefault.ShareParameters = JSON.stringify(jsonstring);
        jsonDefault.DefaultUrlId = $("input[name='DefaultUrlId']").val();
        jsonDefault.Id = $("input[name='DefaultID']").val();
        jsonDefault.Name = $("input[name='Name']").val();
        jsonDefault.StartTime = $("input[name='StartTime']").val();
        jsonDefault.EndTime = $("input[name='EndTime']").val();
        console.log(JSON.stringify(jsonDefault));
        var data = new Array();
        $('#table2 >tbody> tr').each(function () {
            var columns = $(this).children();
            var jsonData = {
                "Id": "",
                "ActivityPageId": "",
                "Name": "",
                "Url": "",
                "RegionString": "",
                "IsDefault": ""
            };

            jsonData.IsDefault = columns.eq(0).find(".IsDefault").is(':checked');
            jsonData.Id = $(this).attr("pkid");
            jsonData.ActivityPageId = $(this).attr("ActivityPageId");
            jsonData.RegionString = $(this).attr("RegionList");

            if (!columns.eq(1).find(".Url").val()) {
                alert("跳转页面的地址不能为空！")
                return false;
            }
            jsonData.Name = columns.eq(2).find(".Name").val();
            jsonData.Url = columns.eq(1).find(".Url").val();
            data.push(jsonData);
        });
        console.log(JSON.stringify(data));

        $.ajax({
            type: "POST",
            url: "/RegionActivityPageConfig/Edit",
            data: {
                "data2": JSON.stringify(data),
                "data1": JSON.stringify(jsonDefault),
            },
            success: function (result) {
                if (result) {
                    window.location.href = "/RegionActivityPageConfig/Index";
                } else {
                    alert("保存失败!")
                }
            },
            error: function (result) {
                alert("失败!")
            }
        });


        $("#AddItem").dialog('close');
    }

    function CheckBox(e) {
        $(".IsDefault").attr("checked", false);
        $(e).attr("checked", true);
    }

    function Delete(target) {
        var id = $(target).attr("id");
        if (id == 0) {
            $(target).closest('tr').remove();
        } else {
            $.ajax({
                type: "POST",
                url: "/RegionActivityPageConfig/DeleteActivityPageUrlConfig",
                data: {
                    "id": id
                },
                success: function (result) {
                    if (result) {
                        $(target).closest('tr').remove();
                    } else {
                        alert("删除失败!")
                    }
                },
                error: function (result) {
                    alert("失败!")
                }
            });
        }
    }
    var num = 0;
    function Add() {
        num--;
        var tr = $("#ActTable tr").attr("id", num).clone();
        tr.appendTo("#table2");
    }

    function AddRegionON(e, id) {
        var t = $(e);
        $(".divRegion").load('/RegionActivityPageConfig/Region?num=' + num + '&id=' + id).dialog({
            title: "地区",
            width: 700,
            height: 600,
            modal: true,
            buttons: {
                "保存": function () {
                    var dataRegion = new Array();
                    $('#table3 >tbody> tr').each(function () {

                        if ($(this).attr("class") == "region") {
                            var columns = $(this).children();
                            if (columns.eq(0).find(".province").find("option:selected").text() != "请选择") {
                                columns.eq(1).find(":checkbox").each(function (j) {
                                    var jsonData = { "Province": "", "City": "", };
                                    if ($(this).attr("checked")) {
                                        if ($(this).attr("value1") != "全部") {
                                            jsonData.Province = columns.eq(0).find(".province").find("option:selected").text();
                                            jsonData.City = $(this).attr("value1");
                                            if (jsonData.Province && jsonData.City) {
                                                dataRegion.push(jsonData);
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    });
                    console.log(JSON.stringify(dataRegion));
                    $("#" + t.parents("tr").attr("id")).attr("RegionList", JSON.stringify(dataRegion));
                    $(".divRegion").dialog('close');
                }
            }
        })
    }

    function CheckRegion(e) {
        $("#attrs").html("");
        var data = JSON.parse($(e).parents("tr").attr("regionlist"));
        var show = "";
        for (var i = 0; i < data.length; i++) {
            show += data[i].Province + "," + data[i].City + "<br/>"
        }
        $("#attrs").html(show);
    }

    $('#filePic').change(function () {
        var pobj = $(this);

        var fileSize = pobj[0].files[0].size / 1024 * 1.0;
        if (fileSize.toFixed(2) > 400) {
            $.messager.alert("提示", "上传图片失败！图片不能超过400K");
            return;
        }
        var rd = Math.ceil(Math.random() * 9999) + 1;
        var fileElId = $(this).attr("id");
        console.log(fileElId);
        $.ajaxFileUpload({
            url: '/Article/ImageUploadToAli?rd=' + rd,
            secureuri: false,
            fileElementId: fileElId,
            dataType: 'json',
            async: false,
            success: function (result) {
                if (result.BImage != "" && result.SImage != "") {
                    $("#imgPic").attr("src", result.SImage);
                    $("#txtDSPicture").val(result.BImage);
                    console.log(result);
                } else {
                    alert("上传失败！");
                }
            },
            error: function (data, status, e)//服务器响应失败处理函数
            {
                alert(e);
            }
        });
    });
</script>