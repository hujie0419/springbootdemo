@{
    ViewBag.Title = "活动列表";
    
}
@model  IList<Tuhu.Provisioning.DataAccess.Entity.SE_Activity>

@section head{

    <link href="~/Scripts/jQuery-EasyUI/themes/default/easyui.css" type="text/css" rel="stylesheet" />
    <link href="~/Scripts/jQuery-EasyUI/themes/icon.css" type="text/css" rel="stylesheet" />
    <style type="text/css">
        input[type=file] {
            width:65px;
        }
    </style>

}
@section scripts{
   <script type="text/javascript" src="~/Scripts/My97DatePicker/WdatePicker.js"></script>
}

    <script type="text/javascript" src="~/Scripts/jQuery-EasyUI/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="~/Scripts/jQuery-EasyUI/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="~/Scripts/layer/layer.js"></script>

    <table id="dg" class="easyui-datagrid" title="活动信息列表" style="width:100%;height:800px"
           data-options="singleSelect:true,rownumbers:true,idField:'id',pagination:true">
        <thead>
            <tr>
                <th  data-options="field:'id',resizable:false" width="30%">ID</th>
                <th  data-options="field:'Title',resizable:false" width="30%">标题</th>
                <th  data-options="field:'CreateDT',align:'left',resizable:false" width="20%">创建时间</th>
                <th  data-options="field:'CreateTime',align:'left',resizable:false" width="20%">创建时间</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null)
        {
            foreach (var item in Model)
            {
                    <tr>
                        <td>@item.ID.ToString()</td>
                        <td>@(item != null?item.Title:"")</td>
                        <td>
                            @Convert.ToDateTime(item.UpdateDT.ToString()).ToString("yyyy-MM-dd HH:mm:ss")
                        </td>
                        <td>
                            @Convert.ToDateTime(item.CreateDT.ToString()).ToString("yyyy-MM-dd HH:mm:ss")
                        </td>

                    </tr>
            }

        }
        </tbody>
    </table>
    <div id="edit"></div>
<div id="LookOplog"></div>
<div id="dgToolbar">
    &nbsp;
    <span>ID:</span>
    <span>
        <input type="text" id="SelActivityID" name="SelActivityID" style="width:120px; " />
    </span>
    &nbsp;&nbsp;
    <span>活动名称:</span>
    <input type="text" id="SelActivityName" name="SelActivityName" style="width:200px" />
    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-search',plain:true,onClick:function(){ SelectTable()}">查 询</a>
    <br/>
    <br/>
    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true,onClick:function(){dgAdd(); $('#edit').dialog('center')}"> 添 加</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true,onClick:function(){dgEdit();$('#edit').dialog('center')}">编 辑</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true,onClick:function(){LookOplog();$('#LookOplog').dialog('center')}" >查看日志</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" style="position:absolute; right:0;margin-right:20px" data-options="iconCls:'icon-cancel',plain:true,onClick:function(){dgDel();}">删 除</a>
</div>
<input type="hidden" id="hidObjectType" value="SPACF"/>
    <script type="text/javascript">

        function GetQueryString(name) {
            ///<summary>获取页面参数</summary>
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]); return null;
        }

        function SaveValidate(){
            var id=$('#id').val();
            if(location.hostname.indexOf(".cn")>0){
                if(id<1500){
                    alert("请使用最新配置重新配置活动，最新模板不支持旧活动配置信息");
                    return false;
                }else{
                    return true;
                }
            }else{
                return true;
            }
        }


        function dgAdd(){



            $('#edit').dialog({
                title:'新增活动信息',
                width:1300,
                height:700,
                resizable:true,
                modal:true,
                top:100,
                left:100,
                href: '/SimpleActivity/ActivityEdit',
                buttons:[{
                    text:'保存',
                    iconCls:'icon-ok',
                    handler:function(){

                        var rows =$('#cp').datagrid('getData');

                        if(rows){
                            var index = layer.load(2, { shade: 0.3 });
                            var data = {};
                            data.Title=$('#Title').val() || '';
                            data.BgImageUrl=$('#hidBgImageUrl').val() || '';
                            data.BgColor=$("#BgColor").val() || '';
                            data.Items =rows.rows;
                            $.ajax({
                                type:'post',
                                url: '/SimpleActivity/Save',
                                dataType:'json',
                                data: { data: JSON.stringify(data) },
                                success:function(result){
                                    if(result){
                                        $('#edit').dialog('close');
                                        layer.close(index);
                                        window.location.reload(true);
                                    }else{
                                        alert('添加失败');
                                    }
                                }
                            });
                        }

                    }
                },{
                    text:'取消',
                    iconCls:'icon-cancel',
                    handler:function(){
                        $('#edit').dialog('close');
                    }
                }],
                onResize:function(width, height){
                    $('#cp').datagrid({
                        width:width,
                        height:height
                    });
                }
            });
        }

        function dgEdit(){
            var row = $('#dg').datagrid('getSelected');
            if(row){
                $('#edit').dialog({
                    title:'编辑活动信息',
                    width:1300,
                    height:700,
                    top:100,
                    resizable:true,
                    left:100,
                    modal:true,
                    href: '/SimpleActivity/ActivityEdit?id=' + row.id,
                    buttons:[{
                        text:'保存',
                        iconCls:'icon-ok',
                        handler:function(){
                            if(!SaveValidate()){
                                return false;
                            }

                            var rows =$('#cp').datagrid('getData');
                            
                            if(rows){
                                var index = layer.load(2, { shade: 0.3 });
                                var data = {};
                                data.ID=row.id;
                                data.Title = $('#Title').val() || '';
                                data.BgImageUrl = $('#hidBgImageUrl').val() || '';
                                data.BgColor = $("#BgColor").val() || '';
                                data.Items = rows.rows;
                                $.ajax({
                                    type:'post',
                                    url: '/SimpleActivity/Save',
                                    dataType:'json',
                                    data: { data: JSON.stringify(data) },
                                    success:function(result){
                                        if(result){
                                            $('#edit').dialog('close');
                                            layer.close(index);
                                            window.location.reload(true);
                                        }else{
                                            alert('添加失败');
                                        }
                                    }
                                });
                            }

                        }
                    },{
                        text:'取消',
                        iconCls:'icon-cancel',
                        handler:function(){
                            $('#edit').dialog('close');
                        }
                    }],
                    onResize:function(width, height){
                        $('#cp').datagrid({
                            width:width,
                            height:height
                        });
                    }
                });
            }
        }

        function dgDel(){
            $.messager.confirm('提示', '您确定删除吗?', function(r){
                if (r){
                    var row = $('#dg').datagrid('getSelected');
                    $.ajax({
                        type:'post',
                        url:'/SimpleActivity/Delete',
                        data:{id:row.id},
                        success:function(data){
                            window.location.reload(true);
                        }
                    });
                }
            });
        }

        function LookOplog() {
            $("#LookOplog").html("").load('/Logger/list?objectType=SPACF');
            $("#LookOplog").dialog({
                title: "查看日志",
                width: 850,
                height: 450,
                modal: true,
                resizable: false,
                buttons: {
                    "取消": function () {
                        $(this).dialog("close");
                    }
                }
            });
        }

    var array = [];

    $(function () {

        //设置活动信息列表的功能按钮
        $('#dg').datagrid({
            toolbar:"#dgToolbar"
        });


        var pager = $('#dg').datagrid().datagrid('getPager');
        
        pager.pagination({
            pageNumber:@ViewBag.pageNumber,
            pageSize:@ViewBag.pageSize,
            total:@ViewBag.Total,
            onSelectPage: function (pageNumber, pageSize) {
                $("body").html("").load('/SimpleActivity/ActivityList?pageIndex=' + (pageNumber || "") + '&pageSize='+pageSize);
            }

        });

        


    });

        function SelectTable(){
            var name =$('#SelActivityName').val()||'';
            var id =$('#SelActivityID').val()||'';
            //alert(id);
            $("body").html("").load('/SimpleActivity/ActivityList?pageIndex=1&pageSize=50&ActivityName='+name+'&SelActivityID='+id);
        }
    </script>
