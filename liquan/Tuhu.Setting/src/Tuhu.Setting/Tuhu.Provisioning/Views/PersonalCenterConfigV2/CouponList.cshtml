@{
    ViewBag.Title = ViewBag.ModuleName;
}
@model List<Tuhu.Provisioning.DataAccess.Entity.ExchangeCenterConfig>

<div class="ibox ibox-content">
    <div class="modal-header">
        <h4 class="modal-title">
            优惠券列表
        </h4>
        <div class="row" style="text-align:right;margin-bottom:5px;">
            <a href="javascript:void(0)" class="btn btn-danger btn-small " id="btnAdd" style="width: 150px;" data-toggle="modal" data-target="#edit">新 增</a>
        </div>
    </div>

    <table class="table table-bordered" style="text-align:center;">
        <thead>
            <tr>
                <th>Id</th>
                <th>优惠券Id</th>
                <th>优惠券名称</th>
                <th>兑换周期（天）</th>
                <th>兑换积分值</th>
                <th>兑换截至时间</th>
                <th>优惠券总量</th>
                <th>优惠券剩余数量</th>
                <th>配置位置</th>
                <th>PID</th>
                <th>用户等级</th>
                <th>兑换类型</th>
                <th>中奖概率</th>
                <th>状态</th>
                <th>顺序</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>


            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.Id</td>
                    <td>@item.CouponId</td>
                    <td>@item.CouponName</td>
                    <td>@item.Period</td>
                    <td>@item.PointsValue</td>
                    <td>@item.EndTime</td>
                    <td>@item.CouponSum</td>
                    <td>@item.CouponSurplus</td>
                    <td>@item.Postion</td>
                    <td>@item.PID</td>
                    <td>@item.UserRank</td>
                    <td>@(item.ExchangeCenterType == null ? "" : item.ExchangeCenterType == true ? "抽奖" : "兑换")</td>
                    <td>@(item.Chance != null ? item.Chance + "%" : "")</td>
                    <td>@(item.Status ? "启用" : "禁用")</td>
                    <td>@item.Sort</td>
                    <td>
                        <p>
                            <a href="javascript:;" class="btn btn-default" data-toggle="modal" data-target="#edit" onclick="UpdateSort(@item.Id,@item.Sort)">编辑顺序</a>
                            <a href="javascript:;" class="btn btn-default" onclick="Delete(@item.Id)">删除</a>
                        </p>
                        <input type="hidden" id="count" value="@Model.Count()" />
                        <input type="hidden" id="lastSort" value="@(Model.LastOrDefault().Sort)" />
                    </td>
                </tr>
            }
        </tbody>
    </table>

</div>

<input type="hidden" id="hiddenModuleID" name="hiddenModuleID" value="@ViewBag.moduleID" />
<input type="hidden" id="hiddenModuleHelperID" name="hiddenModuleHelperID" value="@ViewBag.moduleHelperID" />
<div id="edit" class="modal fade" aria-hidden="true" role="dialog" tabindex="-1">

</div>
@section scripts{

    <script type="text/javascript">

        $('#btnAdd').on('click', function () {
            var sort = 0;        
            if ($("#count").val() > 0) {
                sort = $("#lastSort").val();
            }
            var url = "/PersonalCenterConfigV2/CouponEdit?sort=" + sort;
            // dialogOpen("新增首页", url, "edit");
            var dialog = $('#edit');
            dialog.empty();
            dialog.html(dialog.load(url));
        });

        $('a[name="btnEdit"]').on('click', function () {
            var id = $(this).data("id");
            if (id) {
                var url = "/PersonalCenterConfigV2/HomePageModuleContent?id=" + id + "&moduleID=" + $('#hiddenModuleID').val() + "&moduleHelperID=" + $('#hiddenModuleHelperID').val();
                // dialogOpen("新增首页", url, "edit");
                var dialog = $('#edit');
                dialog.empty();
                dialog.html(dialog.load(url));
            }
        });

        function UpdateSort(id, sort) {
            var url = "/PersonalCenterConfigV2/EidtSort?Id=" + id + "&Sort=" + sort;
            // dialogOpen("新增首页", url, "edit");
            var dialog = $('#edit');
            dialog.empty();
            dialog.html(dialog.load(url));
        }
        function Delete(e) {

            if (confirm("您确定删除吗?")) {
                $.ajax({
                    url: '/PersonalCenterConfigV2/DeletePersonalCenterCouponConfig',
                    type: 'post',
                    data: { id: e },
                    dataType: 'json'
                }).done(function (result) {
                    if (result == 1) {
                        location.reload();
                    } else {
                        alert("删除失败");
                    }
                });
            }

        }
        ///showImg：上传时Image显示的标签ID
        //showUrl:真正显示的
        function UploadBgImg(obj, showImg, showUrl) {

            var pobj = $(obj);
            var rd = Math.ceil(Math.random() * 9999) + 1;
            var fileElId = $(obj).attr("id");
            console.log(fileElId);
            $.ajaxFileUpload({
                url: '/Article/ImageUploadToAli?rd=' + rd,
                secureuri: false,
                fileElementId: fileElId,
                dataType: 'json',
                async: false,
                success: function (result) {
                    if (result.BImage != "" && result.SImage != "") {
                        $("#" + showImg).attr("src", result.SImage).show();
                        $("#" + showUrl).val(result.BImage);
                    } else {
                        alert("上传失败！");
                    }
                },
                error: function (data, status, e)//服务器响应失败处理函数
                {
                    alert(e);
                }
            });
        }


    </script>
}