@model Tuhu.Provisioning.DataAccess.Entity.BaoYangYearCardConfigs
@{
    ViewBag.Title = "保养年卡优惠券修改机油PID";
}
<h2>保养年卡优惠券修改机油PID</h2>
<div>
    <form>
        <label>订单号：</label>
        <input type="text" id="orderId" />
        <button type="button" onclick="Search(1)" style="cursor: pointer;">查询</button>
        <button type="button" onclick="Create()" style="cursor: pointer;">补发码</button>
    </form>
    <div id="YearCardTable">
        <table class="tableContainer"></table>
    </div>
</div>

@foreach (var item in Model.BaoYangYearCardConfig)
{
    string color1;
    switch (item.Type)
    {
        default:
            color1 = "#FFFFFF";
            break;
    }
    <input label="@item.Type" name="@item.Name" style="display: none;" color="@color1">
    foreach (var content in item.Content)
    {
        if (!content.Type.Equals(item.Type))
        {
            string color2;
            switch (content.Type)
            {
                case "jiyou":
                    color2 = "#93FF93";
                    break;
                default:
                    color2 = "#FFFFFF";
                    break;
            }

            <input label="@content.Type" name="@content.Name" style="display: none;" color="@color2">
        }
    }
}

@section head{
<style type="text/css">
    .icon-edit {
        cursor: pointer;
        content: "";
        margin-left: 10px;
        padding-left: 12px;
        background-repeat: no-repeat;
        background-image: url(/Content/images/Editing-Edit-icon12.png);
    }

    table.tableContainer {
        width: 100%;
    }

    table.tableContainer th {
        /*height: 32px;*/
        background: #66ABEF;
        color: #F3F7FA;
        border: 1px solid #559BD0;
        font-weight: 600;
        font-family: "Microsoft YaHei";
        text-align: center;
    }

    table.tableContainer td {
        font-size: 75%;
        padding: 8px 3px 8px 3px;
        font-family: 'Microsoft YaHei';
        text-align: center;
        border: 1px solid #eee;
    }

    form > label {
        height: 25px;
        display: block;
        float: left;
        text-align: right;
        padding-right: 15px;
        margin-top: 10px;
        font-weight: bold;
        font-size:125%;
    }

    form > input[type="text"], form > input[type="number"],
    form > select, form > textarea {
        width: 20%;
        padding: 0px 0px 0px 5px;
        border: 1px solid #84a7ca;
        background: #FBFBFB;
        outline: 0;
        -webkit-box-shadow: inset 0px 1px 6px #ECF3F5;
        box-shadow: inset 0px 1px 6px #ECF3F5;
        font: 200 12px/25px Arial, Helvetica, sans-serif;
        height: 25px;
        line-height: 15px;
        margin: 2px 6px 3px 0px;
    }
    form > button {

    }
</style>
}

@section scripts{
<script>
    var nowLoading = "<tr><td colspan='16'><img src='/Images/loading.gif' />玩命加载中，请稍候...</td></tr>";
    var errorMsg = "<tr><td colspan='16'>查询失败</td></tr>";
    var noData = "<tr><td colspan='16'>暂无数据</td></tr>";

    var column = "<thead><tr>" +
        "<th>订单号</th>" +
        "<th>年卡PID</th>" +
        "<th>年卡名称</th>" +
        "<th>年卡类型</th>" +
        "<th>年卡价格</th>" +
        "<th>所属优惠券</th>" +
        "<th>保养项目</th>" +
        "<th>配件</th>" +
        "<th>PID</th>" +
        "</tr></thead>";

    function Search(page) {
        var orderId = $("#orderId").val();
        if (orderId === "") {
            alert("订单号不能为空");
            return;
        }
        $(".tableContainer").empty();
        $(".tableContainer").append(column);
        $(".tableContainer").append(nowLoading);
        $.get("GetYearCardInfo", { orderId: orderId }, function (data) {
            BindData(data);
        });
    }

    function BindData(data) {
        $(".tableContainer>tbody").remove();
        console.log(data);
        if (data.Status) {
            if (data.Data !== null) {
                var html = $("<tbody></tbody>");
                var trArr = [];
                var value = data.Data;
                $.each(value.Items, function (index, value) {
                    trArr = trArr.concat(value.CardItems.filter(function (x) {
                        return x.hasOwnProperty("PID");
                    }).map(function (x) {
                        var tr = $("<tr></tr");
                        tr.append("<td>" + x.PromotionIndex + "</td><td>" +
                            $("[label='" + x.PackageType + "'").attr("name") +
                            "</td><td>" + $("[label='" + x.BaoYangType + "'").attr("name") +
                            "</td>");
                        var td = EditJiYou(value, x);
                        tr.append(td);
                        return tr;
                    }));
                });
                //console.log(trArr);
                var totalCount = trArr.length + 1;
                if (totalCount === 1) return true;
                var temp = "<tr><td rowspan='" + totalCount + "'>" + value.OrderID + "</td><td rowspan='" + totalCount + "'>" + value.YearCardPid +
                    "</td><td rowspan='" + totalCount + "'>" + value.YearCardName + "</td><td rowspan='" + totalCount + "'>" + value.YearCardType +
                    "</td><td rowspan='" + totalCount + "'>" + value.CardValue + "</td></tr>";
                html.append(temp);
                $.each(trArr, function (index, value) {
                    html.append(value);
                });
                $(".tableContainer").append(html);
                $(".tableContainer").find("tr").mouseover(function () {
                    $(this).addClass("mouseOn");
                });
                $(".tableContainer").find("tr").mouseout(function () {
                    $(this).removeClass("mouseOn");
                });
            } else {
                $(".tableContainer").append(noData);
            }
        } else {
            $(".tableContainer").append(errorMsg);
        }
    }

    function EditJiYou(promotionData, item) {
        var td = $("<td></td>");
        if (!item.hasOwnProperty("PID")) {
            td.html(item.PID);
            return td;
        }
        var span_display = $("<span></span>", { "label": "display", "text": item.PID });
        var input = $("<input />", {
            "type": "text", "value": item.PID, "blur": function () {
                //console.log(this);
                InputBlur(this);
            }, keydown: function () {
                //console.log(this);
                SubmitEditJiYouPID(this);
            }, "data": item
        });
        var span_input = $("<span></span>", { "label": "input", "style": "display:none;", data: promotionData });
        span_input.append(input);
        var span_edit = $("<span></span>", {
            "class": "icon-edit", "click": function () {
                //console.log(this);
                Edit(this);
            }
        });
        td.append(span_display);
        td.append(span_input);
        td.append(span_edit);
        return td;
    }

    function Edit(obj) {
        var $obj = $(obj);
        $obj.hide();
        $obj.parent().find("[label=input]").show();
        $obj.parent().find("[label=display]").hide();
        $obj.parent().find("[label=input]").find("input").focus();
    }

    function InputBlur(obj) {
        var $obj = $(obj);
        $obj.parent().hide();
        $obj.parent().parent().find(".icon-edit").show();
        $obj.parent().parent().find("[label=display]").show();
    }

    function SubmitEditJiYouPID(obj) {
        if (event.keyCode !== 13) {
            return;
        }
        var $obj = $(obj);
        var originData = $obj.data();
        var promotionData = $obj.parent().data();
        console.log(promotionData);
        //var updateData = promotionData.CardItems.find(function (x) {
        //    return x.BaoYangType === originData.BaoYangType &&
        //        x.PID === originData.PID &&
        //        x.PackageType === originData.PackageType &&
        //        x.ProductCount === originData.ProductCount &&
        //        x.PromotionIndex === originData.PromotionIndex &&
        //        x.YearCardId === originData.YearCardId;
        //});
        var PID = $obj.val();
        $.post("EditYearCardInfo", {
            promotionCode: promotionData.PromotionCode,
            cardItemStr: JSON.stringify(originData),
            PID: PID
        }, function (result) {
            if (result.Status) {
                alert("修改成功");
                Search(1);
            } else {
                alert("修改失败");
            }
        });
    }

    function Create() {
        var orderId = $("#orderId").val();
        if (orderId === "") {
            alert("订单号不能为空");
            return;
        }
        $.post("CreateYearCardPromotionCode", { orderId: orderId }, function (result) {
            if (result === -1) {
                alert("已经存在");
                Search(1);
            }
            else if (result === -2) {
                alert("订单不存在");
            }
            else if (result === 1) {
                alert("创建成功");
                Search(1);
            }
            else {
                alert("创建失败");
            }
        });
    }
</script>
}