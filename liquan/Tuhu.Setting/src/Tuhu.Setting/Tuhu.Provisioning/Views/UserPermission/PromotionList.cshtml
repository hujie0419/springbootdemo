@{
    ViewBag.Title = "会员升级奖励配置";
    Layout = "~/Views/Shared/_PersonalCenterLeft.cshtml";
}

@model IEnumerable<Tuhu.Provisioning.DataAccess.Entity.tbl_UserPromotionCode>
<h2>会员升级奖励配置</h2>
<style type="text/css"> 

    .toolar {
        margin-bottom: 5px;
        margin-top: 5px;
    }

    input[type=text] {
        width: 200px;
    }

    textarea {
        width: 300px;
        height: 60px;
    }
</style>

<script type="text/javascript" src="~/Scripts/layer/layer.js"></script>
<script src="/Scripts/ajaxfileupload.js" type="text/javascript"></script>
<script src="~/Scripts/jquery.validate-1.8.1.min.js" type="text/javascript"></script>

<div class="toolar">
    <span>用户等级:</span>
    <select id="selRank" style="width:120px; margin-right:20px;">
        <option value="LV1">LV1</option>
        <option value="LV2">LV2</option>
        <option value="LV3">LV3</option>
        <option value="LV4">LV4</option>
    </select>
    <input type="button" value="添加" class="btn" name="add" />
    <input type="button" value="编辑" class="btn" name="edit" />
    <input type="button" value="删除" class="btn" name="delete" />
</div>
<table>
    <thead>
        <tr>
            <th>选择</th>
            <th>ID</th>
            <th>
                用户等级
            </th>
            <th>
                图片
            </th>
            <th>
                优惠券规则ID
            </th>
            <th>
                优惠券规则Guid
            </th>
            <th>优惠券名称</th>
            <th>优惠券描述</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td> <input type="checkbox" value="@item.ID" /> </td>
                <td>@item.ID</td>
                <td>@item.UserRank</td>
                <td>
                    <img src="@item.SImage" style="width:30px; height:30px;" />
                </td>
                <td>@item.RuleID</td>
                <td>@item.RuleGuid</td>
                <td>@item.CouponName</td>
                <td>@item.CouponDescription</td>
            </tr>
        }
    </tbody>
</table>
<div id="edit"></div>
<script type="text/javascript">


    $('input[type=checkbox]').click(function () {
        if ($(this).attr("checked") == undefined) {
            $(this).attr("checked", "checked");
            console.log("没有选中");
        } else {
            $(this).removeAttr("checked");
            console.log("选中");
        }

        return true;
    });


    $('table tbody tr').click(function () {
        $('table tbody tr').each(function (i) {
            $(this).find('input[type=checkbox]').removeAttr('checked')
        });

        if ($(this).find('input[type=checkbox]').attr("checked") == undefined) {
            $(this).find('input[type=checkbox]').attr("checked", "checked");

        } else {
            $(this).find('input[type=checkbox]').removeAttr("checked");
        }

    });


    var SaleTable = {
        getCheckRow: function () {
            var row = undefined;
            $('table tbody tr').each(function (i) {

                if ($(this).find('input[type=checkbox]').attr('checked') != undefined) {
                    //  console.log($(this).find('input[type=checkbox]').val());
                    row = $(this).find('input[type=checkbox]').val();
                }
            });
            return row;
        }
    };


    $('input[name=add]').click(function () {
        var userRankValue = $('#selRank').val();
        $("#edit").html("").load('/UserPermission/PromotionEdit?userRank=' + userRankValue);
        $('#edit').dialog({
            title: '编辑',
            width: 417,
            height: 400,
            modal: true,
            resizable: false,
            buttons: {
                "保存": function () {
                    var result = $('#form1').valid();
                    if (result) {
                        var data = GetForm();
                        if (data.RuleID == '' || data.CouponName == '' || data.CouponDescription == '') {
                            alert("优惠券规则ID未校验，请输入ID以后点击其它区域以后，显示出名称再保存！");
                            return;
                        }
                        $.ajax({
                            type: 'post',
                            url: '/UserPermission/SavePromotion',
                            data: data,
                            dataType: 'json',
                            success: function (result) {
                                console.log(result);

                                if (result.status == 1) {
                                    $('#edit').dialog("close");
                                    alert("保存成功!");
                                    location.reload();


                                } else {
                                    alert("保存失败！");
                                }

                            },
                            error: function () {
                                alert("失败");
                            }
                        });
                    }
                },
                "取 消": function () {
                    $(this).dialog("close");
                }
            }
        });
    });


    $('input[name=edit]').click(function () {

        // console.log(  SaleTable.getCheckRow());
        if (SaleTable.getCheckRow() == undefined || SaleTable.getCheckRow() == "") {
            alert("请选择编辑的行");
            return;
        }
        $("#edit").html("").load('/UserPermission/PromotionEdit?id=' + SaleTable.getCheckRow());
        $('#edit').dialog({
            title: '编辑',
            width: 417,
            height: 400,
            modal: true,
            resizable: false,

            buttons: {
                "保存": function () {
                    var result = $('#form1').valid();
                    if (result) {
                        var data = GetForm();
                        if (data.RuleID == '' || data.CouponName == '' || data.CouponDescription == '') {
                            alert("优惠券规则ID未校验，请输入ID以后点击其它区域以后，显示出名称再保存！");
                            return;
                        }
                        $.ajax({
                            type: 'post',
                            url: '/UserPermission/SavePromotion',
                            data: data,
                            dataType: 'json',
                            success: function (result) {

                                if (result.status == 1) {
                                    $('#edit').dialog("close");
                                    alert("保存成功!");
                                    location.reload();

                                } else {
                                    alert("保存失败！");
                                }

                            },
                            error: function () {
                                alert("失败");
                            }
                        });
                    }

                },
                "取 消": function () {
                    $(this).dialog("close");
                }
            }
        });
    });


    $(function () {
        $('table tbody tr').each(function (i) {
            $(this).find('input[type=checkbox]').removeAttr('checked')
        });  //不选中任何行

        var sel = location.search.split('=')[1];
        if (sel != undefined) {
            $('#selRank').val(sel);
        }
    });

    $('#selRank').change(function () {
        location.href = "/UserPermission/PromotionList?userRank=" + $(this).val();
    });

    $('input[name=delete]').click(function () {
        if (SaleTable.getCheckRow() == undefined || SaleTable.getCheckRow() == "") {
            alert("请选择编辑的行");
            return;
        }
        var is = confirm("您确定删除吗?");
        if (is) {
            $.ajax({
                url: '/UserPermission/DeletePromotion',
                type: 'post',
                data: { id: SaleTable.getCheckRow() },
                dataType: 'json',
                success: function (result) {
                    if (result.status == 1) {
                        location.reload();
                    } else {
                        alert('删除失败');
                    }
                }

            });
        }
    });
</script>
