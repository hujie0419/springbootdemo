@using Newtonsoft.Json
@using Tuhu.Provisioning.Models
@model List<Tuhu.Provisioning.DataAccess.Entity.BannerConfig>
@{
    ViewBag.Title = "广告位管理后台";
    Layout = "../Shared/_Layout.cshtml";
    List<Tuhu.Provisioning.DataAccess.Entity.VIPAuthorizationRuleConfig> rulelist = ViewBag.RuleList;
    var LocationDLL = ViewBag.LocationDLL as List<DropDownListViewModel>;
}
@section head{
    <link href="~/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.css" rel="stylesheet" />
    <link href="~/Content/nfine/js/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <style>
        .titleInEditor {
            font-weight: bold;
        }

        .addBanner {
            width: 103.6px;
        }

        input::-webkit-input-placeholder {
            text-align: center;
            color: #C0C0C0;
        }

        .list {
            border: 0;
            width: 99%;
        }

        .pagejumphint {
            display: none;
            color: red;
            font-weight: bold;
        }

        .searchtimehint {
            display: none;
            color: red;
            font-weight: bold;
        }

        .singleBannerBtn {
            text-align: center;
        }

        .inputForDate {
            width: 155px;
        }

        option {
            text-align: center;
        }

        #hintsInEditor {
            display: none;
            color: red;
            font-weight: bold;
        }

        .almightyLinkConfig {
            display: none;
        }

        .hide {
            display: none;
        }
    </style>
}
<div>
    <h1>广告位管理后台</h1><br />
    <form method="post" name="submitBannerConfigQuery" id="submitBannerConfigQuery" enctype="multipart/form-data" action=@Url.Action("Index")>
        <span class="titleInEditor">筛选条件</span>
        <span>&nbsp;&nbsp;ID</span>
        <input type="text" style="width: 90px" name="IDCriterion" id="IDCriterion" maxlength="8" placeholder="填写ID" oninput="this.value = this.value.replace(/\D/g, '')" />
        <span>&nbsp;&nbsp;描述</span>
        <input type="text" style="width: 270px" name="DescriptionCriterion" id="DescriptionCriterion" maxlength="200" placeholder="填写描述" />
        <span>&nbsp;&nbsp;平台</span>
        <select id="ChannelCriterion" name="ChannelCriterion" style="width:115px;text-align:center;">
            @foreach (var ddl in ViewBag.ChannelDLL as List<DropDownListViewModel>)
            {
                var seleected = ddl.IsSelect ? "selected=\"selected\"" : "";
                <option @seleected value="@ddl.Id">@ddl.Name</option>
            }
        </select>
        <span>&nbsp;&nbsp;位置</span>
        <select id="LocationCriterion" name="LocationCriterion" style="width:115px;text-align:center;">
            @foreach (var ddl in LocationDLL)
            {
                var seleected = ddl.IsSelect ? "selected=\"selected\"" : "";
                <option @seleected value="@ddl.Id">@ddl.Name</option>
            }
        </select>
        <span>&nbsp;&nbsp;状态</span>
        <select id="StatusCriterion" name="StatusCriterion" style="width:95px;text-align:center;">
            <option value="" selected="selected">全部</option>
            <option value="true">启用</option>
            <option value="false">禁用</option>
        </select>

        <span>&nbsp;&nbsp;有效版本</span>
        <input type="text" maxlength="20" style="width: 120px" name="StartVersionCriterion" id="StartVersionCriterion" placeholder="开始版本" />
        <input type="text" maxlength="20" style="width: 120px" name="EndVersionCriterion" id="EndVersionCriterion" placeholder="结束版本" />
        <br />
        <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;目标小程序</span>
        <select id="TargetSmallAppIdCriterion" name="TargetSmallAppIdCriterion" style="width:135px;text-align:center;">
            @foreach (var ddl in ViewBag.TargetSmallAppIdDLL as List<DropDownListViewModel>)
            {
                var seleected = ddl.IsSelect ? "selected=\"selected\"" : "";
                <option @seleected value="@ddl.Id">@ddl.Name</option>
            }
        </select>

        <span>目标群体</span>
        <select id="TargetGroupsCriterion" name="TargetGroupsCriterion" style="width:135px;text-align:center;">
            @{
                var targetGroupDic = (Dictionary<string, string>)ViewBag.AllTargetGroups;
                if (targetGroupDic != null && targetGroupDic.Any())
                {
                    foreach (var tg in targetGroupDic)
                    {
                        <option value="@tg.Key">@tg.Value</option>
                    }

                }
            }
        </select>
        <span>&nbsp;&nbsp;轮播顺序</span>
        <input type="text" maxlength="10" style="width: 120px" name="SortCriterion" id="SortCriterion" placeholder="填写顺序" oninput="this.value = this.value.replace(/\D/g, '')" />
        <span>&nbsp;&nbsp;创建日期</span>
        <input type="text" class="inputForDate" style="width: 150px;CURSOR: pointer;" name="StartDateCriterion" id="StartDateCriterion" placeholder="上限时间">
        <input type="text" class="inputForDate" style="width: 150px;CURSOR: pointer;" name="EndDateCriterion" id="EndDateCriterion" placeholder="下限时间">
        <span>&nbsp;&nbsp;创建人</span>
        <input type="text" maxlength="50" style="width: 150px" name="CreatorCriterion" id="CreatorCriterion" placeholder="填写创建人">
        <input type="button" class="btn btn-primary" name="search" id="search" value="搜索" style="width:100px" />
        <label class="searchtimehint" id="searchtimehint">结束时间不得早于开始时间！</label>
        <br />
        <br />
        <input type="button" class="btn btn-info addBanner" value="+新建" onclick="CreateNewBanner();" />
        <input type="button" class="btn btn-info addBanner" value="刷新缓存" onclick="CacheUpdate()" />
        <br />
        <br />
        <table id="bannerInformation" class="list">
            <tr>
                <th style="text-align: center; width: 95px">ID</th>
                <th style="text-align: center">描述（内部使用）</th>
                <th style="text-align: center">平台</th>
                <th style="text-align: center">状态</th>
                <th style="text-align: center">位置</th>
                <th style="text-align: center">创建日期</th>
                <th style="text-align: center">创建人</th>
                <th style="text-align: center" colspan="4">操作</th>
            </tr>

            @if (Model != null && Model.Any())
            {
                foreach (var banner in Model)
                {
                    var locationModel = LocationDLL.Find(t => t.Id == banner.Location.ToString());
                    var locationText = locationModel != null ? locationModel.Name : "";
                    <tr>
                        <td style="text-align: center" name="bannersId" id="bannersId_@(banner.Id)">@banner.Id</td>
                        <td style="text-align: center" name="bannersDescription" data-value="@banner.Description">@((banner.Description != null && banner.Description.Length > 25) ? banner.Description.Substring(0, 25) + "..." : banner.Description)</td>
                        <td style="text-align: center" name="bannersChannel" data-value="@banner.Channel">@(banner.Channel == 1 ? "Android" : (banner.Channel == 2 ? "IOS" : "全部"))</td>
                        <td style="text-align: center" name="bannersStatus" data-value="@banner.Status">@(banner.Status ? "启用" : "禁用")</td>
                        <td style="text-align: center" name="bannersLocation" data-value="@banner.Location" data-name="@locationText">@locationText</td>
                        <td class="hide" style="text-align: center" name="bannersStartVersion">@banner.StartVersion</td>
                        <td class="hide" style="text-align: center" name="bannersEndVersion">@banner.EndVersion</td>
                        <td class="hide" style="text-align: center" name="bannersTargetGroups" data-value="@banner.TargetGroups"></td>
                        <td class="hide" style="text-align: center" name="bannersSort">@banner.Sort</td>
                        <td class="hide" style="text-align: center" name="bannersNoticeChannels" data-value="@banner.NoticeChannels">@((string.IsNullOrWhiteSpace(banner.NoticeChannels) || string.Equals(banner.NoticeChannels, "all")) ? "全部" : (banner.NoticeChannels.Length > 20 ? banner.NoticeChannels.Substring(0, 20) + "..." : banner.NoticeChannels))</td>

                        <td class="hide" style="text-align: center" name="bannersTargetSmallAppUrl" data-value="@banner.TargetSmallAppUrl">@banner.TargetSmallAppUrl</td>

                        <td style="text-align: center">@banner.CreateTime</td>
                        <td style="text-align: center" name="bannersCreator">@banner.Creator</td>
                        <td align="center"><input type="button" class="btn btn-primary singleBannerBtn" value="编辑" onclick="UpdateExistingBanner(this);" /></td>
                        <td align="center"><input type="button" class="btn btn-primary singleBannerBtn" value="复制" onclick="CopyBanner(this);" /></td>
                        <td align="center"><input type="button" class="btn btn-primary singleBannerBtn" value="删除" onclick="DeleteBanner(@banner.Id);" /></td>
                        <td name="bannerHistory" align="center">
                            <input type="button" class="btn btn-primary singleBannerBtn" value="历史" onclick="CheckBannersHistory(@banner.Id);" />
                            <input type="hidden" name="bannersRoute" value="@(banner.Route)" />
                            <input type="hidden" name="imagePath" value="@(banner.Image)" />
                            <input type="hidden" name="bannerStartTime" value="@(banner.StartDateTime == null ? "" : banner.StartDateTime.Value.ToString("yyyy-MM-dd HH:mm:ss"))" />
                            <input type="hidden" name="bannerEndTime" value="@(banner.EndDateTime == null ? "" : banner.EndDateTime.Value.ToString("yyyy-MM-dd HH:mm:ss"))" />
                            <input type="hidden" name="bannersShareType" value="@(banner.ShareType)" />

                            <input type="hidden" name="bannersTargetSmallAppId" value="@(banner.TargetSmallAppId)" />

                            <input type="hidden" name="bannersVIPRuleId" value="@(banner.VIPAuthorizationRuleId)" />
                            <input type="hidden" name="bannersTargetSmallAppUrl" value="@(banner.TargetSmallAppUrl)" />
                            <input type="hidden" name="bannersGrade" value="@(banner.Grade)" />
                            <input type="hidden" name="bannersLink" value="@(banner.Link)" />
                            <input type="hidden" name="bannersIOSPV" value="@(banner.IOSProcessValue)" />
                            <input type="hidden" name="bannersAndroidPV" value="@(banner.AndroidProcessValue)" />
                            <input type="hidden" name="bannersIOSCV" value="@(banner.IOSCommunicationValue)" />
                            <input type="hidden" name="bannersAndroidCV" value="@(banner.AndroidCommunicationValue)" />
                        </td>
                    </tr>
                }
            }
        </table>
        <input type="hidden" id="targetGroupBag" value="@JsonConvert.SerializeObject(ViewBag.AllTargetGroups)" />
        <br />
        <div id="pagerOfBanners" style="float: right">
            <label class="pagejumphint" id="pagejumphint">输入页数不符合要求！</label>
            第<input type="hidden" name="page" id="page" value="@(ViewBag.Page)">@(ViewBag.Page)页
            <input type="button" name="previousPage" id="previousPage" value="上一页" class="btn btn-primary" style="width:82px">
            &nbsp;<input type="button" name="nextPage" id="nextPage" value="下一页" class="btn btn-primary" style="width:82px">
            &nbsp;&nbsp;<label>跳转到第<input type="text" name="jumpPage" style="width: 82px" id="jumpPage" onfocus="discardJumpHints()" oninput="this.value = this.value.replace(/\D/g, '')">页</label>
            &nbsp;<input type="button" name="jumpPageTriger" id="jumpPageTriger" value="跳转" class="btn btn-primary" style="width:82px">
            &nbsp;&nbsp;共有@(ViewBag.NumOfBanners)条记录
        </div>
    </form>
</div>

<div class="modal fade" id="bannerEditor" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width:78%;height:78%;overflow-y: scroll">
        <form method="post" name="submitbannerEdit" enctype="multipart/form-data" action=@Url.Action("AddOrUpdate")>
            <div class="modal-content">
                <div class="modal-body">
                    <table id="bannerContentEditorTable" class="table table-bordered">
                        <tr>
                            <td colspan="2" class="titleInEditor" style="text-align:center">广告位内容</td>
                        </tr>
                        <tr>
                            <td style="width: 100px;">描述</td>
                            <td><input type="hidden" id="Id" name="Id" /><textarea id="Description" name="Description" rows="6" maxlength="1000" style="width: 647px;" placeholder="填写描述" onfocus="discardHints()"></textarea></td>
                        </tr>
                        <tr>
                            <td style="width: 100px;">跳转链接</td>
                            <td>
                                <input id="Route" name="Route" maxlength="500" style="width: 536px" placeholder="填写跳转链接">
                                <input type="button" class="btn btn-primary singleBannerBtn" value="万能跳转配置" id="almightyButton" style="width: 106px" /><input type="hidden" id="Creator" name="Creator">
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 100px;">目标小程序</td>
                            <td>
                                <select id="TargetSmallAppId" name="TargetSmallAppId" style="width:158px;text-align:center;">
                                    @foreach (var ddl in ViewBag.TargetSmallAppIdDLL as List<DropDownListViewModel>)
                                    {
                                        var seleected = ddl.IsSelect ? "selected=\"selected\"" : "";
                                        <option @seleected value="@ddl.Id">@ddl.Name</option>
                                    }
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 100px;">小程序跳转路径</td>
                            <td>
                                <input id="TargetSmallAppUrl" name="TargetSmallAppUrl" maxlength="500" style="width: 536px" placeholder="填写小程序跳转路径">
                            </td>
                        </tr>
                        <tr class="almightyLinkConfig">
                            <td style="width: 100px;">URI</td>
                            <td><input id="Link" name="Link" maxlength="500" style="width: 647px" placeholder="填写URI" /></td>
                        </tr>
                        <tr class="almightyLinkConfig">
                            <td style="width: 100px;">IOS处理</td>
                            <td><input id="IOSProcessValue" name="IOSProcessValue" maxlength="500" style="width: 647px" placeholder="填写IOS处理" /></td>
                        </tr>
                        <tr class="almightyLinkConfig">
                            <td style="width: 100px;">IOS特殊通讯</td>
                            <td><input id="IOSCommunicationValue" name="IOSCommunicationValue" maxlength="500" style="width: 647px" placeholder="填写IOS特殊通讯" /></td>
                        </tr>
                        <tr class="almightyLinkConfig">
                            <td style="width: 100px;">安卓处理</td>
                            <td><input id="AndroidProcessValue" name="AndroidProcessValue" maxlength="500" style="width: 647px" placeholder="填写安卓处理" /></td>
                        </tr>
                        <tr class="almightyLinkConfig">
                            <td style="width: 100px;">安卓特殊通讯</td>
                            <td><input id="AndroidCommunicationValue" name="AndroidCommunicationValue" maxlength="500" style="width: 647px" placeholder="填写安卓特殊通讯" /></td>
                        </tr>
                        <tr>
                            <td style="width: 100px;">分享类型</td>
                            <td>
                                <select id="ShareType" name="ShareType" style="width:158px;text-align:center;">
                                    <option value="0" selected="selected">Url</option>
                                    <option value="1">图片</option>
                                    <option value="2">文案</option>
                                    <option value="3">小程序</option>
                                </select>
                                <a target="_blank" href="/ShareConfig/Index"><input type="button" class="btn btn-primary singleBannerBtn" value="分享配置" /></a>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 100px;">图片</td>
                            <td><img height="86" width="148" id="imagePreviewer" /><input type="file" id="imagePrevInEditor" name="imagePrev" onchange="UploadImg(this)" width="240" /><input id="Image" name="Image" readonly style="width: 710px"></td>
                        </tr>
                    </table>
                    <table id="bannerPosEditorTable" class="table table-bordered">
                        <tr>
                            <td colspan="2" class="titleInEditor" style="text-align:center">广告位位置</td>
                        </tr>
                        <tr>
                            <td style="width: 100px;">平台</td>
                            <td>
                                <select id="Channel" name="Channel" style="width:158px;text-align:center;">
                                    @foreach (var ddl in ViewBag.ChannelDLL as List<DropDownListViewModel>)
                                    {
                                        var seleected = ddl.IsSelect ? "selected=\"selected\"" : "";
                                        <option @seleected value="@ddl.Id">@ddl.Name</option>
                                    }
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 100px;">位置</td>
                            <td>
                                <select id="Location" name="Location" style="width:182px;text-align:center;">
                                    @foreach (var ddl in LocationDLL)
                                    {
                                        var seleected = ddl.IsSelect ? "selected=\"selected\"" : "";
                                        <option @seleected value="@ddl.Id">@ddl.Name</option>
                                    }
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 100px;">应用市场渠道</td>
                            <td>
                                <table border-collapse:collapse>
                                    <tbody>
                                        <tr>
                                            <td style="border:1px solid #e8eef4;">
                                                <label><input id="SelectAllCheckbox" onclick="AllNoticeChannel_Checked(this);" type="checkbox" checked="checked" />全选/全不选</label>
                                            </td>
                                        </tr>
                                        <tr>
                                            @if (((List<Tuhu.Provisioning.DataAccess.Entity.NoticeChannel>)ViewBag.NoticeChannel).Any())
                                            {
                                                <td style="border:1px solid #e8eef4;">

                                                    @foreach (var item in (List<Tuhu.Provisioning.DataAccess.Entity.NoticeChannel>)ViewBag.NoticeChannel)
                                                    {
                                                        <label style="display:inline-block;width:150px;margin:2px 0;">
                                                            <input data-id="NoticeChannel_Checked" value="@item.Name" checked="checked" type="checkbox" onclick="SingleNoticeChannel_Checked(this)" />@item.DisplayName
                                                        </label>
                                                    }
                                                </td>
                                            }
                                        </tr>
                                    </tbody>
                                </table>
                                <input type="hidden" name="NoticeChannels" id="NoticeChannels" />
                            </td>
                        </tr>
                    </table>
                    <table id="bannerStatusEditorTable" class="table table-bordered">
                        <tr>
                            <td colspan="2" class="titleInEditor" style="text-align:center">显示状态</td>
                        </tr>
                        <tr>
                            <td style="width: 100px">有效日期</td>
                            <td>
                                <input class="inputForDate" id="StartDateTime" name="StartDateTime" readonly="readonly" style="CURSOR: pointer;" placeholder="请输入生效日期" />
                                <input class="inputForDate" id="EndDateTime" name="EndDateTime" readonly="readonly" style="CURSOR: pointer;" placeholder="请输入失效日期" />
                                <label class="searchtimehint" id="settimehint">结束时间不得早于开始时间！</label>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 100px">状态</td>
                            <td>
                                <select id="Status" name="Status" style="width:158px;text-align:center;">
                                    <option selected="selected" value="true">启用</option>
                                    <option selected="selected" value="false">禁用</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    <table id="bannerConditionEditorTable" class="table table-bordered">
                        <tr>
                            <td colspan="2" class="titleInEditor" style="text-align:center">显示条件</td>
                        </tr>
                        <tr>
                            <td>目标群体<input type="hidden" id="TargetGroups" name="TargetGroups" /></td>
                            <td>
                                <table>
                                    <tbody>
                                        <tr>
                                            <td style="border:1px solid #e8eef4;">
                                                <label><input id="SelectAllTGCheckbox" onclick="AllTargetGroup_Checked(this);" type="checkbox" />全选/全不选</label>
                                            </td>
                                        </tr>
                                        <tr id="targetGroupList"></tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 100px">会员等级</td>
                            <td>
                                @Html.DropDownList("Grade",
                                               new[]
                                               {
                                                    new SelectListItem() {Selected = true, Text = "--请选择--"},
                                                    new SelectListItem() {Value = "0", Text = "lv0"},
                                                    new SelectListItem() {Value = "1", Text = "lv1"},
                                                    new SelectListItem() {Value = "2", Text = "lv2"},
                                                    new SelectListItem() {Value = "3", Text = "lv3"},
                                                    new SelectListItem() {Value = "4", Text = "lv4"}
                                               },
                                               new
                                               {
                                                   id = "Grade",
                                                   @style = "width:158px;text-align:center;"
                                               })
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 100px">VIP权限规则</td>
                            <td>
                                <select id="VIPAuthorizationRuleId" name="VIPAuthorizationRuleId" style="text-align:center;">
                                    <option>--请选择--</option>
                                    @foreach (var item in rulelist)
                                    {
                                        <option value="@item.Id">@item.RuleName</option>
                                    }
                                </select>
                        </tr>
                        <tr>
                            <td style="width: 100px">有效版本</td>
                            <td>
                                <input id="StartVersion" name="StartVersion" maxlength="20" placeholder="填写开始版本">
                                <input id="EndVersion" name="EndVersion" maxlength="20" placeholder="填写结束版本">
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 100px">轮播顺序</td>
                            <td>
                                <input id="Sort" name="Sort" maxlength="8" placeholder="填写轮播顺序">
                                <input type="hidden" id="Creator" name="Creator">
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <label id="hintsInEditor"></label>
                    <button style="width:82px" type="button" class="btn btn-default"
                            data-dismiss="modal">
                        关闭
                    </button>
                    <input type="submit" id="submit" class="btn btn-primary" style="width:82px" value="保存" />
                    <img src="https://resource.tuhu.cn/Image/Public/loading-712.gif" style="vertical-align: middle; display:none" />
                </div>
            </div>
        </form>
    </div>
    <input type="hidden" id="hid-login-user" value="@(HttpContext.Current.User.Identity.Name)" />
    <input type="hidden" id="hid-numberofBanners-user" value="@(ViewBag.NumOfBanners)" />
</div>
<div class="modal fade" id="logsDisplay" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 850px">
        <div class="modal-content">
            <div class="modal-body">
                <table id="logsDisplayTable" class="table table-bordered">
                    <tr>
                        <td>操作人</td>
                        <td>日期</td>
                        <td>操作类型</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>
@section scripts{
    @*<script src="~/Content/nfine/js/bootstrap/bootstrap.js"></script>*@
    <script src="~/Content/ProductVehicleType/js/bootstrap.min.js"></script>
    <script src="~/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.js"></script>
    <script src="../../Scripts/ajaxfileupload.js" type="text/javascript"></script>
}


<script>
    var checkFlag = false, targetGroupDict = new Array();
                   $(document).ready(function () {
                       if (parseInt($("#page").val()) <= 1) {
                           $("#previousPage").attr("disabled", "disabled");
                       } else {
                           $("#previousPage").removeAttr("disabled");
                       }
                       var numberOfBanners = $('#hid-numberofBanners-user').val();
                       if (parseInt($("#page").val()) >= Math.ceil(parseInt(numberOfBanners) / 50)) {
                           $("#nextPage").attr("disabled", "disabled");
                       } else {
                           $("#nextPage").removeAttr("disabled");
                       }
                       $("#search").click(function () {
                           $("#page").val(1);
                           $("#submitBannerConfigQuery").submit();
                       });
                       $("#previousPage").click(function () {
                           if (parseInt($("#page").val()) > 1) {
                               var curPage = parseInt($('#page').val()) - 1;
                               $("#page").val(curPage);
                           }
                           $("#submitBannerConfigQuery").submit();
                       });
                       $("#nextPage").click(function () {
                           if (parseInt($("#page").val()) < Math.ceil(parseInt(numberOfBanners) / 50)) {
                               var curPage = parseInt($('#page').val()) + 1;
                               $("#page").val(curPage);
                           }
                           $("#submitBannerConfigQuery").submit();
                       });

                       $("#jumpPageTriger").click(function () {
                           if (parseInt($("#jumpPage").val()) < 1 || parseInt($("#jumpPage").val()) > Math.ceil(parseInt(numberOfBanners) / 50)) {
                               $("#pagejumphint").show();
                               return;
                           } else {
                               $("#page").val(parseInt($("#jumpPage").val()));
                           }
                           $("#submitBannerConfigQuery").submit();
                       });

                       targetGroupDict = JSON.parse($("#targetGroupBag").val());

                       $("[name='bannersTargetGroups']").each(function () {
                           var TGNames = TargetGroupNameRec($(this).data("value"));
                           if (TGNames && TGNames.length > 20)
                               $(this).html(TGNames.substring(0, 20)+'...');
                           else
                               $(this).html(TGNames);
                       });

                       $(".inputForDate").datetimepicker({
                           timeFormat: "HH:mm:ss",
                           dateFormat: "yy-mm-dd"
                       });
                   });

        function discardJumpHints() {
            $("#pagejumphint").hide();
        }

                   function TargetGroupNameRec(obj) {
                       if (obj.toString()) {
                           var TargetGroupVisualNames = new Array();
                           var TargetGroupVisualKeys = obj.toString().split(',');
                           for (var key in TargetGroupVisualKeys) {
                               if (targetGroupDict[TargetGroupVisualKeys[key]]) {
                                   TargetGroupVisualNames.push(targetGroupDict[TargetGroupVisualKeys[key]]);
                               }
                           }
                           if (TargetGroupVisualNames.length > 0)
                               return TargetGroupVisualNames.join(',');
                           else
                               return '';
                       }
                    }

                   $("#StartDateCriterion").change(function () {
                       var startDate = $("#StartDateCriterion").val();
                       var endDate = $("#EndDateCriterion").val();
                       if (startDate.length <= 0 || endDate.length <= 0 || Date.parse(startDate) <= Date.parse(endDate)) {
                           $("#searchtimehint").hide();
                           $("#search").removeAttr('disabled');
                       }
                       else {

                           $("#searchtimehint").show();
                           $("#search").attr('disabled', 'disabled');
                       }
                   });

                   $("#EndDateCriterion").change(function () {
                       var startDate = $("#StartDateCriterion").val();
                       var endDate = $("#EndDateCriterion").val();
                       if (startDate.length <= 0 || endDate.length <= 0 || Date.parse(startDate) <= Date.parse(endDate)) {
                           $("#searchtimehint").hide();
                           $("#search").removeAttr('disabled');
                       }
                       else {

                           $("#searchtimehint").show();
                           $("#search").attr('disabled', 'disabled');
                       }
                   });

                   $("#StartDateTime").change(function () {
                       var startDate = $("#StartDateTime").val();
                       var endDate = $("#EndDateTime").val();
                       if (startDate.length <= 0 || endDate.length <= 0 || Date.parse(startDate) <= Date.parse(endDate)) {
                           $("#settimehint").hide();
                           checkFlag = false;
                       }
                       else {
                           $("#settimehint").show();
                           checkFlag = true;
                       }
                   });

                   $("#EndDateTime").change(function () {
                       var startDate = $("#StartDateTime").val();
                       var endDate = $("#EndDateTime").val();
                       if (startDate.length <= 0 || endDate.length <= 0 || Date.parse(startDate) <= Date.parse(endDate)) {
                           $("#settimehint").hide();
                           checkFlag = false;
                       }
                       else {
                           $("#settimehint").show();
                           checkFlag = true;

                       }
                   });

        function UpdateNoticeChannel(obj) {
            if (!obj || obj == 'all')
            {
                $("#SelectAllCheckbox").attr("checked", "checked");
                $("input=[data-id='NoticeChannel_Checked']").attr("checked", "checked");
            }
            else
            {
                var noticeChannels = obj.split(',');
                $("#SelectAllCheckbox").removeAttr("checked");
                $("input=[data-id='NoticeChannel_Checked']").each(function () {
                    $(this).removeAttr("checked");
                    if (noticeChannels && noticeChannels.length > 0) {
                        for (var i = 0; i < noticeChannels.length; ++i) {
                            if (String($(this).val()) == noticeChannels[i]) {
                                $(this).attr("checked", "checked");
                                break;
                            }
                        }
                    }
                });
            }
        }


        function AllNoticeChannel_Checked(obj) {
            var hasChk = $(obj).is(':checked')
                ? $("input=[data-id='NoticeChannel_Checked']").attr("checked", "checked")
                : $("input=[data-id='NoticeChannel_Checked']").removeAttr("checked");
        }

        function SingleNoticeChannel_Checked(obj) {
            discardHints();
            if (!$(obj).is(':checked'))
                $("#SelectAllCheckbox").removeAttr("checked");
        }

        function ConfirmNoticeChannels(){
            var noticeChannels = new Array();
            $("input=[data-id='NoticeChannel_Checked']").each(function () {
                if ($(this).is(':checked'))
                    noticeChannels.push(String($(this).val()));
            });
            if (noticeChannels.length <= 0)
            {
                $('#hintsInNCEditor').html('请至少选择一个应用市场渠道！').show();
                return false;
            }
            if (noticeChannels.length >= @(((List<Tuhu.Provisioning.DataAccess.Entity.NoticeChannel>)ViewBag.NoticeChannel).Count))
            {
                $("#NoticeChannels").val('all');
                return true;
            }
            $("#NoticeChannels").val(String(noticeChannels.join(',')));
            return true;
        }

                   function CheckBannersHistory(PKID) {
                       $.ajax({
                           url: "/BannerConfig/SelectOprLogByPKID",
                           type: "GET",
                           data: { "PKID": PKID },
                           success: function (data) {
                               var content = "<tr><td style='font-weight:bold; text-align:center'>操作人</td><td style='font-weight:bold; text-align:center'>日期</td><td style='font-weight:bold; text-align:center'>操作类型</td></tr>";
                               if (data.status == "success") {
                                   console.log(data);
                                   $(data.data).each(function (index) {
                                       content += "<tr><td style='text-align:center'>" + data.data[index].Author + "</td><td style='text-align:center'>" + data_string(data.data[index].ChangeDatetime) + "</td><td style='text-align:center'>" + data.data[index].Operation + "</td></tr>";
                                   });
                               } else {
                                   content = "暂无记录";
                               }
                               $('#logsDisplayTable').html(content);
                               $('#logsDisplay').modal('show');
                           }
                       });
                    }
                   function DeleteBanner(PKID) {
                       if (confirm("确定要删除记录吗？") == true) {
                           $.ajax({
                               url: "/BannerConfig/DeleteBannerConfig",
                               type: "GET",
                               data: { "Id": PKID },
                               success: function (data) {
                                   if (parseInt(data) > 0) {
                                       alert("记录删除成功！");
                                       $("#bannersId_" + PKID).parent().remove();
                                   }
                                   else
                                       alert("记录删除失败！");
                               }
                           });
                       }
                   }

                    function discardHints() {
                        $("#hintsInEditor").hide();
                    }

                    function CreateNewBanner()
                    {
                        discardHints();
                        $("#Id").val("-1");
                        $("#Description").val('');
                        $("#Route").val('');
                        $("#Sort").val('');
                        $("#StartVersion").val('');
                        $("#EndVersion").val('');
                        $("#Channel").val('');
                        $("#Location").val('');
                        $("#Status").val('');
                        $("#ShareType").val('');
                        $("#imagePreviewer").attr("src", '');
                        $("#Image").val('');
                        $("#StartDateTime").val('');
                        $("#EndDateTime").val('');
                        $("#VIPAuthorizationRuleId").val('');
                        $("#Grade").val('');
                        $("#Creator").val($('#hid-login-user').val());

                        $("#TargetSmallAppId").val("");
                        $("#TargetSmallAppUrl").val("");

                        LoadTargetGroups();
                        UpdateNoticeChannel('all');
                        $("#Link").val('');
                        $("#IOSProcessValue").val('');
                        $("#AndroidProcessValue").val('');
                        $("#IOSCommunicationValue").val('');
                        $("#AndroidCommunicationValue").val('');
                        if (String($("#almightyButton").val()) == '收起')
                            $("#almightyButton").click();
                        $('#bannerEditor').modal('show');
                    }

                    function UpdateExistingBanner(obj)
                    {
                        discardHints();
                        $("#Id").val($(obj).parent().siblings("[name='bannersId']").html()).show();
                        $("#Description").val($(obj).parent().siblings("[name='bannersDescription']").data("value"));
                        $("#Route").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersRoute']").val());
                        $("#Sort").val($(obj).parent().siblings("[name='bannersSort']").html());
                        $("#StartVersion").val($(obj).parent().siblings("[name='bannersStartVersion']").html());
                        $("#EndVersion").val($(obj).parent().siblings("[name='bannersEndVersion']").html());
                        $("#Channel").val($(obj).parent().siblings("[name='bannersChannel']").data("value"));
                        $("#Location").val($(obj).parent().siblings("[name='bannersLocation']").data("value"));
                        $("#Status").val(String($(obj).parent().siblings("[name='bannersStatus']").data("value")).toLowerCase());
                        $("#ShareType").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersShareType']").val());

                        $("#TargetSmallAppId").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersTargetSmallAppId']").val());
                        $("#TargetSmallAppUrl").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersTargetSmallAppUrl']").val());

                        $("#imagePreviewer").attr("src", $(obj).parent().siblings("[name='bannerHistory']").find("[name='imagePath']").val());

                        var _imageName = $('#bannerInformation').find('td[name="bannerHistory"]').find('input[type="hidden"][name="imagePath"]').val();
                        $("#Image").val(_imageName);
                        $("#StartDateTime").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannerStartTime']").val());
                        $("#EndDateTime").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannerEndTime']").val());
                        $("#VIPAuthorizationRuleId").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersVIPRuleId']").val());
                        $("#Grade").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersGrade']").val());
                        $("#Creator").val($(obj).parent().siblings("[name='bannersCreator']").html());
                        UpdateNoticeChannel($(obj).parent().siblings("[name='bannersNoticeChannels']").data("value"));
                        LoadTargetGroups($(obj).parent().siblings("[name='bannersTargetGroups']").data("value"));
                        $("#Link").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersLink']").val());
                        $("#IOSProcessValue").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersIOSPV']").val());
                        $("#AndroidProcessValue").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersAndroidPV']").val());
                        $("#IOSCommunicationValue").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersIOSCV']").val());
                        $("#AndroidCommunicationValue").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersAndroidCV']").val());
                        if (String($("#almightyButton").val()) == '收起')
                            $("#almightyButton").click();
                        $('#bannerEditor').modal('show');
                    }

                    function CopyBanner(obj)
                    {
                        discardHints();
                        $("#Id").val("-1");
                        $("#Description").val($(obj).parent().siblings("[name='bannersDescription']").data("value"));
                        $("#Route").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersRoute']").val());
                        $("#Sort").val($(obj).parent().siblings("[name='bannersSort']").html());
                        $("#StartVersion").val($(obj).parent().siblings("[name='bannersStartVersion']").html());
                        $("#EndVersion").val($(obj).parent().siblings("[name='bannersEndVersion']").html());
                        $("#Channel").val($(obj).parent().siblings("[name='bannersChannel']").data("value"));
                        $("#Location").val($(obj).parent().siblings("[name='bannersLocation']").data("value"));
                        $("#Status").val(String($(obj).parent().siblings("[name='bannersStatus']").data("value")).toLowerCase());
                        $("#ShareType").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersShareType']").val());

                        $("#TargetSmallAppId").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersTargetSmallAppId']").val());
                        $("#TargetSmallAppUrl").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersTargetSmallAppUrl']").val());

                        $("#imagePreviewer").attr("src", $(obj).parent().siblings("[name='bannerHistory']").find("[name='imagePath']").val());
                        var _imageName = $('#bannerInformation').find('td[name="bannerHistory"]').find('input[type="hidden"][name="imagePath"]').val();
                        $("#Image").val(_imageName);
                        $("#StartDateTime").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannerStartTime']").val());
                        $("#EndDateTime").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannerEndTime']").val());
                        $("#VIPAuthorizationRuleId").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersVIPRuleId']").val());
                        $("#Grade").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersGrade']").val());
                        $("#Creator").val($(obj).parent().siblings("[name='bannersCreator']").html());
                        UpdateNoticeChannel($(obj).parent().siblings("[name='bannersNoticeChannels']").data("value"));
                        LoadTargetGroups($(obj).parent().siblings("[name='bannersTargetGroups']").data("value"));
                        $("#Link").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersLink']").val());
                        $("#IOSProcessValue").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersIOSPV']").val());
                        $("#AndroidProcessValue").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersAndroidPV']").val());
                        $("#IOSCommunicationValue").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersIOSCV']").val());
                        $("#AndroidCommunicationValue").val($(obj).parent().siblings("[name='bannerHistory']").find("[name='bannersAndroidCV']").val());
                        if (String($("#almightyButton").val()) == '收起')
                            $("#almightyButton").click();
                        $('#bannerEditor').modal('show');
                    }

                    function UploadImg(e) {
                        discardHints();
                        $.ajaxFileUpload({
                            url: '/BannerConfig/UploadImage',
                            secureuri: false,
                            fileElementId: $(e).attr("id"),
                            dataType: 'JSON',
                            type: 'post',
                            success: function (result) {
                                result = jQuery.parseJSON(jQuery(result).text());
                                if (result != "") {
                                    $("#imagePreviewer").attr("src", result);
                                    $("#Image").val(result);
                                } else {
                                    alert("上传失败！");
                                }
                            },
                            error: function () {
                                alert("上传失败！");
                            }
                        });
                    }

                    /*******读取目标群体**********/
                    function UpdateTargetGroups(obj, numOfTGDict) {
                        //if (!obj || obj == 'all') {
                        //    $("#SelectAllTGCheckbox").attr("checked", "checked");
                        //    $("input=[data-id='TargetGroup_Checked']").attr("checked", "checked");
                        //}
                        if (obj === undefined) {
                        }
                        else {
                            var TargetGroups = obj.toString().split(',');
                            $("input=[data-id='TargetGroup_Checked']").each(function () {
                                $(this).removeAttr("checked");
                                if (TargetGroups && TargetGroups.length > 0) {
                                    for (var i = 0; i < TargetGroups.length; ++i) {
                                        if (String($(this).val()) == TargetGroups[i]) {
                                            $(this).attr("checked", "checked");
                                            break;
                                        }
                                    }
                                }
                            });
                            if (numOfTGDict <= TargetGroups.length) {
                                $("#SelectAllTGCheckbox").attr("checked", "checked");
                            }
                        }
                    }
                        function AllTargetGroup_Checked(obj) {
                            var hasChk = $(obj).is(':checked')
                                ? $("input=[data-id='TargetGroup_Checked']").attr("checked", "checked")
                                : $("input=[data-id='TargetGroup_Checked']").removeAttr("checked");
                        }
                        function SingleTargetGroup_Checked(obj) {
                            discardHints();
                            if (!$(obj).is(':checked'))
                                $("#SelectAllTGCheckbox").removeAttr("checked");
                        }

                        function LoadTargetGroups(obj) {
                            var tglist = '';
                            var numOfTGDict = 0;
                            for (var key in targetGroupDict) {
                                tglist += "<label style='display:inline-block;width:300px; margin:2px 0;'>"
                                    + "<input data-id='TargetGroup_Checked' value='" + key + "' type= 'checkbox' onclick='SingleTargetGroup_Checked(this)'/>"
                                    + targetGroupDict[key] + "</label >";
                                numOfTGDict++;
                            }
                            $("#targetGroupList").html(tglist);
                            UpdateTargetGroups(obj, numOfTGDict);
                        }
                    /*********目标群体选择*******/
                    function ConfirmTargetGroups() {
                        var targetGroups = new Array();
                        $("input=[data-id='TargetGroup_Checked']").each(function () {
                            if ($(this).is(':checked')) {
                                targetGroups.push(String($(this).val()));
                            }
                        });
                        $("#TargetGroups").val(String(targetGroups.join(',')));
                        if (targetGroups.length <= 0) {
                            return false;
                        }
                        return true;
                    }

                    $(document.forms["submitbannerEdit"]).validate({
                        submitHandler: function (form) {
                            var flag = false;
                            var feedbacks = "保存失败";
                            if ($.trim($("#Description").val()).length <= 0) {
                                flag = true;
                                feedbacks += ", 未填写描述";
                            }
                            if ($.trim($("#Image").val()).length <= 0) {
                                flag = true;
                                feedbacks += ", 未上传图片";
                            }

                            /********* 确认市场渠道和目标群体 ************/
                            if (!ConfirmTargetGroups()) {
                                flag = true;
                                feedbacks += ", 至少选择一个目标群体";
                            }
                            if (!ConfirmNoticeChannels()) {
                                flag = true;
                                feedbacks += ", 至少选择一个应用市场渠道";
                            }

                            if (flag) {
                                $("#hintsInEditor").html(feedbacks).show();
                                return;
                            }
                            if (checkFlag)
                                return;

                            form = $(form);
                            $("#submit").attr("disabled", "disabled").next().show();
                            form.ajaxSubmit({
                                error: function () {
                                    $("#submit").removeAttr("disabled").next().hide();
                                    if (parseInt($("#Id").val()) < 0) {
                                        alert("创建时服务器出错");
                                    }
                                    else {
                                        alert("更新时服务器出错");
                                    }
                                },
                                success: function (data) {
                                    $("#submit").removeAttr("disabled").next().hide();
                                    if (parseInt($("#Id").val()) < 0) {
                                        if (parseInt(data) <= 0) {
                                            alert("创建失败");
                                        }
                                        else {
                                            var httpName = "@(HttpContext.Current.User.Identity.Name)";
                                            var myDate = new Date();
                                            var additionalLine = '<tr><td style="text-align: center" name="bannersId" id="bannersId_' + parseInt(data) + '">' + parseInt(data) +
                                                '</td><td style="text-align: center" name="bannersDescription" data-value="' + $("#Description").val() + '">' + ($("#Description").val().length>25 ? $("#Description").val().substring(0, 25)+'...' : $("#Description").val()) +
                                                '</td>';
                                            if (parseInt($("#Channel").val()) == 1)
                                                additionalLine += '<td style="text-align: center" name="bannersChannel" data-value="1">Android</td>';
                                            else if (parseInt($("#Channel").val()) == 2)
                                                additionalLine += '<td style="text-align: center" name="bannersChannel" data-value="2">IOS</td>';
                                            else if (parseInt($("#Channel").val()) == 3)
                                                additionalLine += '<td style="text-align: center" name="bannersChannel" data-value="3">途虎查违章小程序</td>';
                                            else
                                                additionalLine += '<td style="text-align: center" name="bannersChannel" data-value="0">全部</td>';

                                            additionalLine += '<td style="text-align: center" name="bannersStatus" data-value="' + String($("#Status").val()).toLowerCase() + '">' + ((String($("#Status").val()).toLowerCase() == 'false') ? '禁用' : '启用') + '</td>';
                                            var locationValue = $("#Location").val();
                                            var locationTest = $("#Location").find("option:selected").text();
                                            additionalLine += '<td style="text-align: center" name="bannersLocation" data-value="' + locationValue + '">' + locationTest+ '</td>';


                                            additionalLine += '<td  class="hide" style="text-align: center" name="bannersStartVersion">' + $("#StartVersion").val() +'</td>';
                                            additionalLine += '<td  class="hide" style="text-align: center" name="bannersEndVersion">' + $("#EndVersion").val() + '</td>';
                                            var TGNames = TargetGroupNameRec($("#TargetGroups").val());
                                            if (String(TGNames).length > 20) {
                                                additionalLine += '<td class="hide" style="text-align: center" name="bannersTargetGroups" data-value="' + $("#TargetGroups").val() + '">' + String(TGNames).substring(0,20) + '...</td>';
                                            }
                                            else {
                                                additionalLine += '<td class="hide" style="text-align: center" name="bannersTargetGroups" data-value="' + $("#TargetGroups").val() + '">' + TGNames + '</td>';
                                            }
                                            additionalLine += '<td  class="hide" style="text-align: center" name="bannersSort">' + $("#Sort").val() + '</td>';
                                            if (String($("#NoticeChannels").val()) == 'all')
                                                additionalLine += '<td class="hide" style="text-align: center" name="bannersNoticeChannels" data-value="all">全部</td>';
                                            else if (String($("#NoticeChannels").val()).length > 20)
                                                additionalLine += '<td class="hide" style="text-align: center" name="bannersNoticeChannels" data-value="' + $("#NoticeChannels").val() + '">' + String($("#NoticeChannels").val()).substring(0, 20) + '...</td>';
                                            else
                                                additionalLine += '<td class="hide" style="text-align: center" name="bannersNoticeChannels" data-value="' + $("#NoticeChannels").val() + '">' + String($("#NoticeChannels").val()) + '</td>';

                                            if (!httpName) // bannersCreator
                                                additionalLine += '<td style="text-align: center">' + myDate.getFullYear() + '/' + (myDate.getMonth() + 1) + '/' + myDate.getDate() + ' ' + myDate.getHours() + ':' + myDate.getMinutes() + ':' + formatToTwoDigits(parseInt(myDate.getSeconds())) + '</td><td style="text-align: center" name="bannersCreator">';
                                            else
                                                additionalLine += '<td style="text-align: center">' + myDate.getFullYear() + '/' + (myDate.getMonth() + 1) + '/' + myDate.getDate() + ' ' + myDate.getHours() + ':' + myDate.getMinutes() + ':' + formatToTwoDigits(parseInt(myDate.getSeconds())) + '</td><td style="text-align: center" name="bannersCreator">' + httpName;

                                            additionalLine += '</td><td align="center"><input type="button" class="btn btn-primary singleBannerBtn" value="编辑" onclick="UpdateExistingBanner(this);" /></td>';
                                            additionalLine += '<td align="center"><input type="button" class="btn btn-primary singleBannerBtn" value="复制" onclick="CopyBanner(this);" /></td>';
                                            additionalLine += '<td align="center"><input type="button" class="btn btn-primary singleBannerBtn" value="删除" onclick="DeleteBanner(' + parseInt(data) + ');" /></td>';
                                            additionalLine += '<td name= "bannerHistory" align="center"><input type="button" class="btn btn-primary singleBannerBtn" value="历史" onclick="CheckBannersHistory(' + parseInt(data) + ');" />';
                                            additionalLine += ' <input type="hidden" name="bannersRoute" value="' + $("#Route").val() + '" /><input type= "hidden" name= "imagePath" value= "' + $("#Image").val();
                                            additionalLine += '" /> <input type="hidden" name="bannerStartTime" value="' + $("#StartDateTime").val() + '" /> <input type="hidden" name="bannerEndTime" value="' + $("#EndDateTime").val();
                                            additionalLine += '" /> <input type="hidden" name="bannersShareType" value="' + $("#ShareType").val() + '" /> <input type="hidden" name="bannersVIPRuleId" value="' + $("#VIPAuthorizationRuleId").val() + '" /><input type="hidden" name="bannersGrade" value="' + $("#Grade").val() + '" />';

                                            additionalLine += '<input type="hidden" name="bannersTargetSmallAppId" value="' + $("#TargetSmallAppId").val() + '" /> ';
                                            additionalLine += '<input type="hidden" name="bannersTargetSmallAppUrl" value="' + $("#TargetSmallAppUrl").val() + '" /> ';

                                            additionalLine += '<input type="hidden" name="bannersLink" value="' + $("#Link").val() + '" /> <input type="hidden" name="bannersIOSPV" value="' + $("#IOSProcessValue").val() + '" />';
                                            additionalLine += '<input type="hidden" name="bannersAndroidPV" value="' + $("#AndroidProcessValue").val() + '" /> <input type="hidden" name="bannersIOSCV" value="' + $("#IOSCommunicationValue").val() + '" /><input type="hidden" name="bannersAndroidCV" value="' + $("#AndroidCommunicationValue").val() + '" /></td></tr>';
                                            $("#bannerInformation").append(additionalLine);
                                            $('#bannerEditor').modal('hide');
                                            alert("创建成功");
                                        }
                                    }
                                    else {
                                        if (parseInt(data) <= 0) {
                                            alert("更新失败");
                                        }
                                        else {
                                            var object = $("#bannersId_" + $("#Id").val());
                                            object.siblings("[name='bannersDescription']").html(($("#Description").val().length>25 ? ("#Description").val().substring(0, 25) +'...': $("#Description").val()));
                                            object.siblings("[name='bannersDescription']").data("value", $("#Description").val());
                                            object.siblings("[name='bannerHistory']").find("[name='bannersRoute']").val($("#Route").val());
                                            object.siblings("[name='bannersSort']").html($("#Sort").val());
                                            object.siblings("[name='bannersStartVersion']").html($("#StartVersion").val());
                                            object.siblings("[name='bannersEndVersion']").html($("#EndVersion").val());
                                            object.siblings("[name='bannersChannel']").data("value", $("#Channel").val());
                                            if (parseInt($("#Channel").val()) == 1)
                                                object.siblings("[name='bannersChannel']").html("Android");
                                            else if (parseInt($("#Channel").val()) == 2)
                                                object.siblings("[name='bannersChannel']").html("IOS");
                                            else if (parseInt($("#Channel").val()) == 3)
                                                object.siblings("[name='bannersChannel']").html("途虎查违章小程序");
                                            else
                                                object.siblings("[name='bannersChannel']").html("全部");

                                            object.siblings("[name='bannersLocation']").data("value", $("#Location").val());
                                            object.siblings("[name='bannersLocation']").html($("#Location").find("option:selected").text());

                                            object.siblings("[name='bannersTargetGroups']").data("value", $("#TargetGroups").val());
                                            var TGNames = TargetGroupNameRec($("#TargetGroups").val());
                                            if (String(TGNames).length > 20) {
                                                object.siblings("[name='bannersTargetGroups']").html(String(TGNames).substring(0, 20) + '...');
                                            }
                                            else {
                                                object.siblings("[name='bannersTargetGroups']").html(TGNames);
                                            }
                                            object.siblings("[name='bannersNoticeChannels']").data("value", $("#NoticeChannels").val());
                                            if (String($("#NoticeChannels").val()) == 'all')
                                                object.siblings("[name='bannersNoticeChannels']").html("全部");
                                            else if (String($("#NoticeChannels").val()).length > 20)
                                                object.siblings("[name='bannersNoticeChannels']").html(String($("#NoticeChannels").val()).substring(0, 20) + '...');
                                            else
                                                object.siblings("[name='bannersNoticeChannels']").html(String($("#NoticeChannels").val()));
                                            object.siblings("[name='bannersStatus']").data("value", String($("#Status").val()).toLowerCase());
                                            if (String($("#Status").val()).toLowerCase() == 'false')
                                                object.siblings("[name='bannersStatus']").html("禁用");
                                            else
                                                object.siblings("[name='bannersStatus']").html("启用");

                                            object.siblings("[name='bannerHistory']").find("[name='bannersShareType']").val($("#ShareType").val());

                                            object.siblings("[name='bannerHistory']").find("[name='bannersTargetSmallAppId']").val($("#TargetSmallAppId").val());
                                            object.siblings("[name='bannerHistory']").find("[name='bannersTargetSmallAppUrl']").val($("#TargetSmallAppUrl").val());

                                            object.siblings("[name='bannerHistory']").find("[name='imagePath']").val($("#Image").val());
                                            object.siblings("[name='bannerHistory']").find("[name='bannerStartTime']").val($("#StartDateTime").val());
                                            object.siblings("[name='bannerHistory']").find("[name='bannerEndTime']").val($("#EndDateTime").val());
                                            object.siblings("[name='bannerHistory']").find("[name='bannersVIPRuleId']").val($("#VIPAuthorizationRuleId").val());
                                            object.siblings("[name='bannerHistory']").find("[name='bannersGrade']").val($("#Grade").val());
                                            object.siblings("[name='bannerHistory']").find("[name='bannersLink']").val($("#Link").val());
                                            object.siblings("[name='bannerHistory']").find("[name='bannersIOSPV']").val($("#IOSProcessValue").val());
                                            object.siblings("[name='bannerHistory']").find("[name='bannersAndroidPV']").val($("#AndroidProcessValue").val());
                                            object.siblings("[name='bannerHistory']").find("[name='bannersIOSCV']").val($("#IOSCommunicationValue").val());
                                            object.siblings("[name='bannerHistory']").find("[name='bannersAndroidCV']").val($("#AndroidCommunicationValue").val());
                                            $('#bannerEditor').modal('hide');
                                            alert("更新成功");
                                        }
                                    }
                                }
                            });
                        }
                    });

                    function formatToTwoDigits(n) {
                        return n < 10 ? '0' + n : n;
                    }
                    function data_string(str) {
                        var d = eval('new ' + str.substr(1, str.length - 2));
                        var ar_date = [d.getFullYear(), d.getMonth() + 1, d.getDate(), d.getHours(), d.getMinutes(), d.getSeconds()];
                        for (var i = 0; i < ar_date.length; i++) ar_date[i] = dFormat(ar_date[i]);
                        return ar_date.slice(0, 3).join('-') + ' ' + ar_date.slice(3).join(':');

                        function dFormat(i) { return i < 10 ? "0" + i.toString() : i; }
                    }
                    $("#almightyButton").toggle(
                        function () {
                            $(".almightyLinkConfig").show();
                            $(this).val("收起");
                        },
                        function () {
                            $(".almightyLinkConfig").hide();
                            $(this).val("万能跳转配置");
                        }
                    );

                    function CacheUpdate() {
                        if (confirm("确定要刷新缓存吗？") == true) {
                            $.post('/BannerConfig/CacheUpdate', function (data) {
                                if (parseInt(data) == -1)
                                    alert("刷新缓存失败！");
                                else
                                    alert("刷新缓存成功！");
                            });
                        }
                    }
</script>
