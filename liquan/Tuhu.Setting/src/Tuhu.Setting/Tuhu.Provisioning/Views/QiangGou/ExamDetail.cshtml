@model Tuhu.Provisioning.DataAccess.Entity.QiangGouModel
@{
    ViewBag.Title = "审核活动";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    table {
        width: 100%;
    }

    #loading2 {
        width: 100%;
        height: 100%;
        border: 3px solid #C3DAF9;
        position: absolute;
        /*top: 300px;
        left: 300px;*/
        /*z-index: 10000;*/
        background-color: #F7F9FC;
        line-height: 25px;
        vertical-align: middle;
        font-size: 11pt;
        display: none;
    }
</style>
<div style="clear:both;float:left">
    <h3>审核活动</h3>
</div>
<div id="loading2"><img src="/Images/loading.gif" alt="" />正在审核通过,请稍候...</div>
<table >
    <tr>
        <td>活动ID</td>
        <td>@Model.ActivityID</td>
    </tr>
    <tr>
        <td>活动名称</td>
        <td>@Model.ActivityName</td>
    </tr>
    <tr>
        <td>活动时间</td>
        <td>@Model.StartDateTime.ToString("yyyy-MM-dd HH:mm")&nbsp;&nbsp;-&nbsp;&nbsp;@Model.EndDateTime.ToString("yyyy-MM-dd HH:mm")</td>
    </tr>
    <tr>
        <td>产品</td>
        <td>
            <table>
                <tr>
                    <th>商品PID</th>
                    <th>商品名称</th>
                    <th>成本价</th>
                    <th>原价</th>
                    <th>活动价</th>
                    <th>优惠券</th>
                    <th>降价幅度</th>
                </tr>
                @foreach (var item in Model.Products)
                {
                    var per = Math.Abs(((item.OriginalPrice - item.Price) / item.OriginalPrice));
                    <tr>
                        <td>@item.PID</td>
                        <td>@(item.ProductName ?? item.DisplayName)</td>
                        <td>@(item.CostPrice == null ? "无" : item.CostPrice.Value.ToString("0.00"))</td>
                        <td>@item.OriginalPrice.ToString("0.00")</td>
                        <td><span>@item.Price.ToString("0.00")</span></td>
                        <td>@(item.IsUsePCode ? "使用" : "不使用")</td>
                        <td><span style="color:@(item.CostPrice!=null&& item.CostPrice.Value>item.Price ? "red":"")">@(per.ToString("0%"))</span></td>
                    </tr>
                }
            </table>
        </td>
    </tr>
    <tr>
        <td colspan="2"><button onclick="ExamSuccess()">审核通过</button></td>
    </tr>
</table>
<script>
    var Edit = function (target) {
        var price = $(target).prev().text();
        $(target).parent().empty().html('<input type="text" name="Price" onkeyup="CheckPriceChangePer(this)" value="' + price + '"><button onclick="UpdatePrice(this)">保存</button>');
    }
    var ExamSuccess = function () {
        if (!confirm("确认审核通过?"))
            return false;
        $.ajax({
            //async: true,
            beforeSend: function () {
                $("#loading2").show();
            },
            complete: function () {
                $("#loading2").hide();
            },
            type: 'POST',
            url: '/QiangGou/ExamActivity',
            data: {
                aid: "@Model.ActivityID"
            },
            success: function (data) {
                if (data.code == -1)
                    alert("闪购时间重叠,请修正后在审核！");
                else if (data.code == -2)
                    alert("审核失败");
                else if (data.code == -3)
                    alert(data.msg);
                else if (data.code == -4) {
                    alert(data.msg);
                    location.href = "/QiangGou/ExamIndex";
                }
                else if (data.code > 0)
                    location.href = "/QiangGou/ExamIndex";
            }
        });
        @*$.post("/QiangGou/ExamActivity", { aid: "@Model.ActivityID" },
            beforeSend:
            function (data) {
            if (data == -1)
                alert("闪购时间重叠,请修正后在审核！")
            else if (data == -2)
                alert("审核失败");
            else if (data > 0)
              location.href="/QiangGou/ExamIndex"
        });*@
    };
    var UpdatePrice = function (target) {
        var price = $(target).prev().val();

        if (!price.length) {
            alert('促销价不允许为空');
            return false;
        }
        else if (isNaN(price)) {
            alert("促销价填写不规范");
            return false;
        }
        $.post("/QiangGou/ExamUpdatePrice", {
            Price: price,
            ActivityID: "@Model.ActivityID",
            PID: $(target).parent().parent().find("td:first").text()
        },
        function (result) {
            if (result <= 0) {
                alert("修改失败");
                location.reload();
            }
            else
                $(target).parent().empty().html('<span>' + parseFloat(price).toFixed(2) + '</span><button onclick="Edit(this)">修改</button>');

        })
    };
    var CheckPriceChangePer = function (target) {
        var priceValue = $(target).val();
        if (priceValue.length && !isNaN(priceValue)) {
            var oprice = $(target).parent().prev().text();
            var per = parseInt((Math.abs(parseFloat(oprice) - parseFloat(priceValue)) / parseFloat(oprice)).toFixed(2) * 100);
            var pid = $(target).parent().parent().find("tr:first").text();
            var cost = $(target).parent().prev().prev().text();
            //if (pid.toUpperCase().indexOf("TR-")>=0 || pid.toUpperCase().indexOf("LG-")>=0) {
            //    if (per >= 10)
            //        $(target).parent().next().empty().html('<span style="color:red;">' + per + '%</span>');
            //    else
            //        $(target).parent().next().empty().html('<span>' + per + '%</span>');
            //}
            //else {
            //    if (per >= 20)
            //        $(target).parent().next().empty().html('<span style="color:red;">' + per + '%</span>');
            //    else
            //        $(target).parent().next().empty().html('<span>' + per + '%</span>');
            //}
            if (cost && cost.length && !isNaN(cost) && parseFloat(priceValue) < parseFloat(cost))
                $(target).parent().next().empty().html('<span style="color:red;">' + per + '%</span>');
            else
                $(target).parent().next().empty().html('<span>' + per + '%</span>');

        }
        else
            $(target).parent().next().empty().html('<span style="color:red;">活动价有误,无法计算百分比</span>');
    };
</script>