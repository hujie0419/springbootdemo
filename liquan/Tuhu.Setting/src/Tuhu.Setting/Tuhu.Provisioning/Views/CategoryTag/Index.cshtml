@using Tuhu.Provisioning.DataAccess.Entity;
@{
    ViewBag.Title = "标签配置";
    Layout = "../Shared/_Layout.cshtml";
    List<CategoryTagModel> ParentList = (List<CategoryTagModel>)ViewBag.ParentList;
}
<style type="text/css">
    input[type=button], input[type=submit] {
        background: #0088cc none repeat scroll 0 0;
        border: medium none #0088cc;
        border-radius: 5px;
        color: #f0f0f0;
        cursor: pointer;
        font-family: "Microsoft Yahei";
        font-size: 12px;
        outline: medium none;
        padding: 5px 25px;
    }
</style>

<link href="/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.css" rel="stylesheet" type="text/css" />
<script src="/Scripts/jquery-ui-timepicker-addon/jquery-ui-sliderAccess.js" type="text/javascript"></script>
<script src="/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.js" type="text/javascript"></script>
<script src="/Scripts/ajaxfileupload.js"></script>
<div style="margin-top:20px;">
    <input class="button1" type="button" value="添加父标签模块" onclick="CategoryTagConfigs.BigModule.AddOrEdit('添加父标签',0,0,1,0);" />
    &nbsp;&nbsp;
    <input class="button1" type="button" value="刷新标签缓存" onclick="window.open('https://huodong.tuhu.cn/Discovery/UpdateHomeCategoryTags')" />
</div>

<div>
    <div id="left" style="float:left;width:20%;">
        @{
            <ul>
                @if (ParentList != null && ParentList.Count > 0)
                {
                    for (int i = 0; i < ParentList.Count; i++)
                    {
                        <li id="ParentMenu@(ParentList[i].id)" style="padding:3px 0;list-style-type:decimal;">
                            <a id="@(ParentList[i].id)" onclick="CategoryTagConfigs.ShowModuleChildList(@(ParentList[i].id),1,1)" href="javascript:void(0);"> @ParentList[i].name</a>
                            <span style="color:red;">@(ParentList[i].disable == false ? "启用" : "禁用")</span>
                            &nbsp;
                            <input type="button" value="编辑" style="padding:0;" onclick="CategoryTagConfigs.BigModule.AddOrEdit('@ParentList[i].name',@(ParentList[i].id),@(ParentList[i].parentId),0,0);">
                            &nbsp;
                            <input type="button" value="添加子标签" style="padding:0;" onclick="CategoryTagConfigs.BigModule.AddOrEdit('@ParentList[i].name',@(ParentList[i].id),@(ParentList[i].id),0,1);">
                        </li>
                    }
                }
                else
                {
                    <li>无模块</li>
                }
            </ul>
        }
    </div>

    <div id="right" style="float:left;width:80%;margin:20px 0;"></div>

    <div style="clear:left;"></div>
</div>

<div id="EditBigModule" style="display:none;"></div>

<script type="text/javascript">
    var CookieTools = {
        GetCookie: function (name) {
            var arr = document.cookie.match(new RegExp("(^| )" + name + "=([^;]*)(;|$)"));
            if (arr != null) return unescape(arr[2]); return null;
        },
        SetCookie: function (name, value) {
            var Days = 3600;
            var exp = new Date();
            //domain = "tuhu.cn";
            exp.setTime(exp.getTime() + Days * 24 * 60 * 60 * 1000);
            document.cookie = name + "=" + escape(value) + ";path=/;expires=" + exp.toGMTString();
        },
        DelCookie: function (name) {
            var exp = new Date();
            exp.setTime(exp.getTime() - 1);
            var cval = getCookie(name);
            if (cval != null)
                document.cookie = name + "=" + cval + ";expires=" + exp.toGMTString() + "; path=/";
        }
    }

    var CategoryTagConfigs = {
        BigModule: {
            AddOrEdit: function (t, n, p, ip, ic) {
                $("#EditBigModule").html("").load("/CategoryTag/BigModule?id=" + (n || 0) + "&parentId=" + (p || 0) + "&isAddParent="+(ip || 0)+ "&isAddChild="+(ic || 0));
                $("#EditBigModule").dialog({
                    title: t,
                    width: 600,
                    height: "auto",
                    modal: true,
                    resizable: false
                });
            }
        },
        ShowModuleChildList: function (p, f) {
            var _index = (p || 0);
            var _parent = (f || 0);
            var _cookieIndex = CookieTools.GetCookie("ChildMenu");
            var _cookieParentIndex = CookieTools.GetCookie("ParentMenu");

            //点击当前项高亮显示
            $("#left > ul > li").click(function (i) {
                $(this).css("border", "2px solid red").siblings().css("border", "0");
            });

            //左边菜单(默认项)
            if (_parent == 1) {
                CookieTools.SetCookie("ParentMenu", _index);
            }
            else {
                if (_cookieParentIndex != null) {
                    $("#ParentMenu" + _cookieParentIndex).css("border", "2px solid red").siblings().css("border", "0");
                }
            }

            //右边列表(默认项)
            if (_index > 0) {
                CookieTools.SetCookie("ChildMenu", _index);
                $("#right").html("").load("/CategoryTag/ShowModuleChildList?id=" + _index);
            }
            else {
                if (_cookieIndex != null) {
                    //优先读取最近一次浏览过的列表
                    CookieTools.SetCookie("ChildMenu", _cookieIndex);
                    $("#right").html("").load("/CategoryTag/ShowModuleChildList?id=" + _cookieIndex);
                }
                else {
                    //若为空则默认加载列表第一项
                    _index = $("#left > ul > li").first().find("a").attr("id");
                    $("#right").html("").load("/CategoryTag/ShowModuleChildList?id=" + _index);
                }
            }
        },
        UploadBImg: function (obj, showImg, showUrl) {
            var pobj = $(obj).parent();
            var rd = Math.ceil(Math.random() * 9999) + 1;
            var fileElId = $(obj).attr("id");
            console.log(fileElId);
            $.ajaxFileUpload({
                url: '/Article/ImageUploadToAli?rd=' + rd,
                secureuri: false,
                fileElementId: fileElId,
                dataType: 'json',
                async: false,
                success: function (result) {
                    if (result.BImage != "" && result.SImage != "") {
                        console.log($(pobj).find("#" + showImg));
                        $(pobj).find("#" + showImg).attr("src", result.SImage).show();
                        $(pobj).find("#" + showUrl).val(result.BImage);
                        //$(pobj).find("#icoimgurl").val(result.SImage);
                    } else {
                        alert("上传失败！");
                    }
                }
            });
        }
    };

    CategoryTagConfigs.ShowModuleChildList();
</script>