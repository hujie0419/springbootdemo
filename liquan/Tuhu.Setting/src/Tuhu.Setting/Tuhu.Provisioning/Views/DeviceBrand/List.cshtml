@{
    ViewBag.Title = "List";
    Layout = "~/Views/Shared/_Index.cshtml";
}

<div class="topPanel">
    <div class="toolbar">
        <div class="btn-group">
            <a id="NF-add" class="btn btn-primary dropdown-text" onclick="btn_add()"><i class="fa fa-plus"></i>新增机型配置</a>
        </div>
    </div>
    <div class="search">
        <table>
            <tbody>
                <tr>
                    <td>
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1"> 厂商 : </span>
                            <select class="form-control " id="BrandId" name="BrandId" aria-describedby="basic-addon1">
                                <option value="0">---不限---</option>
                                @{
                                    List<Tuple<int, string>> brandList = ViewBag.BrandList as List<Tuple<int, string>>;
                                    if (brandList != null && brandList.Any())
                                    {
                                        foreach (var item in brandList)
                                        {
                                            <option value="@item.Item1">@item.Item2</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                    </td>
                    <td style="padding-left: 30px;">
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon2"> 关键字: </span>
                            <input id="txt_keyword" type="text" class="form-control" aria-describedby="basic-addon2" placeholder="请输入机型关键字或设备号" style="width: 200px;">
                        </div>
                    </td>
                    <td></td>
                    <td>
                        <button id="btn_search" type="button" class="btn  btn-primary" style="margin-left: 20px;"><i class="fa fa-search">筛选</i></button>
                    </td>
                    <td>
                        <button id="btn_clear" type="button" class="btn  btn-primary" style="margin-left: 20px;">清空</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
<div class="gridPanel">
    <table id="gridList"></table>
    <div id="gridPager"></div>
</div>

<script type="text/javascript">
    function gridList() {
        var $gridList = $('#gridList');
        $gridList.dataGrid({
            height: $(window).height() - 118,
            url: "/DeviceBrand/GetGridJson",
            colModel: [
                { label: "BrandID", name: "BrandID", width: 120, align: "center", key: true, hidden: true },
                { label: "TypeID", name: "TypeID", width: 120, align: "center", key: true, hidden: true },
                { label: "ModelID", name: "ModelID", width: 120, align: "center", key: true, hidden: true },
                { label: "厂 商", name: "DeviceBrand", width: 260, align: 'center' },
                { label: "机 型", name: "DeviceType", width: 260, align: 'center' },
                { label: "设备号", name: "DeviceModel", width: 120, align: "center" },
                {
                    label: "创建时间", name: "CreateDateTime", width: 260, align: 'center',
                    formatter: "date", formatoptions: { srcformat: 'Y-m-d H:i:s', newformat: 'Y-m-d H:i:s' }
                },

                { label: "创建人", name: "CreateUser", width: 120, align: "center" },
                {
                    label: "操作", name: "H5Uri", width: 420, align: "center",
                    formatter: function (cellvalue, options, rowObject) {
                        var keyValue = "";
                        var modelId = rowObject.ModelID;
                        var typeId = rowObject.TypeID;
                        var brandId = rowObject.BrandID;

                        if (modelId) {
                            keyValue = "M" + modelId;
                        }
                        else if (typeId) {
                            keyValue = "T" + typeId;
                        }
                        else if (brandId) {
                            keyValue = "B" + brandId;
                        }

                        return `<a style="color: blue;" href="#" onclick="btn_update('${keyValue}')"> 修改 </a> | `
                            + `<a style="color: blue;" href="#" onclick="btn_delete('${keyValue}')">删除 </a> `;;
                    }
                }
            ],
            rowNum: 100
        });

        $("#btn_search").click(function () {
            $gridList.jqGrid('setGridParam', {
                postData: { brandId: $("#BrandId").val(), keyword: $("#txt_keyword").val() }
            }).trigger('reloadGrid');
        });
    }

    function btn_add() {
        $.modalOpen({
            id: 'ListForm',
            url: "/DeviceBrand/ListForm?keyValue=",
            title: "新增机型",
            width: "600px",
            height: "520px",
            callBack: function (iframeId) {
                var iframe = $.currentWindow();
                top.frames[iframeId].submitForm(iframe);
                setTimeout(function () {
                    $("#NF-addClick").trigger("click");
                }, 1000);
            }
        });
    }


    function btn_update(keyValue) {
        if (keyValue) {
            $.modalOpen({
                id: 'ListForm' + keyValue,
                url: "/DeviceBrand/ListForm?keyValue=" + keyValue,
                title: "修改机型",
                width: "600px",
                height: "520px",
                callBack: function (iframeId) {
                    var iframe = $.currentWindow();
                    top.frames[iframeId].submitForm(iframe);
                }
            });
        }
    }

    function btn_delete(keyValue) {
        if (keyValue) {
            $.deleteForm({
                url: "/DeviceBrand/DeleteForm",
                param: { keyValue: keyValue },
                success: function () {
                    $("#btn_search").trigger("click");
                }
            });
        }
    }

    $(function () {
        gridList();
        $('#NF-addClick').on('click', top.$.nfinetab.addTab);

        $("#btn_clear").click(function () {
            $("#BrandId").val("0");
            $("#txt_keyword").val("");
        });
    });
</script>