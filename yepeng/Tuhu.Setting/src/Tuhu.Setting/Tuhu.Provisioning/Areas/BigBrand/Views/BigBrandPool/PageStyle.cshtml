
@{
    ViewBag.Title = "List";
    Layout = "~/Views/Shared/_Index.cshtml";
}
<div>
    <span>页面类型:</span>
    <select id="PageType" name="PageType">
        <option value="1">大转盘</option>
        <option value="2">大翻牌</option>
        <option value="3">答题抽奖</option>
    </select>
    <span>全局分享按钮</span>
    <select id="IsShare">
        <option value="true">启用</option>
        <option value="false">禁用</option>
    </select>
    <span id="PromptStyleContainer" class="hidden">
    <span>节日弹窗</span>
    <select id="PromptStyle">
        <option value="0">普通弹窗</option>
        <option value="1">节日弹窗</option>
    </select>
    </span>
</div>
<div>
    <table id="gridList"></table>
    <table id="gridList2"></table>
    <div id="AnswerIframe" style="display:none;">
        @*<iframe id="AnswerIframe" src="/BigBrand/BigBrandPool/AnswerQuestionsForm" style="border:0;display:none;"/>*@
        <div>
            <form id="form1">
                <table class="form">
                    <tr>
                        <td class="formTitle">题目标签</td>
                        <td class="formValue">
                            <select id="Tip" name="Tip" class="form-control">
                                <option value="-1">全 部</option>
                            </select>
                        </td>
                        <td class="formTitle">题目数量</td>
                        <td class="formValue">
                            <input type="number" id="TipCount" name="TipCount" class="form-control" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">默认标题</td>
                        <td class="formValue">
                            <input type="text" id="DefTitle" name="DefTitle" class="form-control" />
                        </td>
                        <td class="formTitle">默认副标题</td>
                        <td class="formValue">
                            <input type="text" id="DefSmallTitle" name="DefSmallTitle" class="form-control" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">分享标题</td>
                        <td class="formValue">
                            <input type="text" id="ShareTitle" name="ShareTitle" class="form-control" />
                        </td>
                        <td class="formTitle">分享副标题</td>
                        <td class="formValue">
                            <input type="text" id="ShareSmallTitle" name="ShareSmallTitle" class="form-control" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">无次次数标题</td>
                        <td class="formValue">
                            <input type="text" id="NoTimeTitle" name="NoTimeTitle" class="form-control" />
                        </td>
                        <td class="formTitle">无次数副标题</td>
                        <td class="formValue">
                            <input type="text" id="NoTimeSmallTitle" name="NoTimeSmallTitle" class="form-control" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">默认结果标题</td>
                        <td class="formValue">
                            <input type="text" id="DefResTitle" name="DefResTitle" class="form-control" />
                        </td>
                        <td class="formTitle">默认结果副标题</td>
                        <td class="formValue">
                            <input type="text" id="DefResSmallTitle" name="DefResSmallTitle" class="form-control" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">分享结果标题</td>
                        <td class="formValue">
                            <input type="text" id="ShareResTitle" name="ShareResTitle" class="form-control" />
                        </td>
                        <td class="formTitle">分享结果副标题</td>
                        <td class="formValue">
                            <input type="text" id="ShareResSmallTitle" name="ShareResSmallTitle" class="form-control" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">背景图片</td>
                        <td class="formValue">
                            <img id="BgImgUri" width="30" height="30" />
                            <input type="file" id="FileBgImgUri" name="FileBgImgUri" onchange="BgfileImage(this,'BgImgUri')" />
                        </td>
                        <td class="formTitle">最高奖励图</td>
                        <td class="formValue">
                            <img id="LastImgUri" width="30" height="30" />
                            <input type="file" id="FileLastImgUri" name="FileLastImgUri" onchange="BgfileImage(this,'LastImgUri')" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">问答首页图片</td>
                        <td class="formValue">
                            <img id="HomeBgImgUri" width="30" height="30" />
                            <input type="file" id="FileHomeBgImgUri" name="FileHomeBgImgUri" onchange="BgfileImage(this, 'HomeBgImgUri')" />
                        </td>
                        <td class="formTitle">结果页图</td>
                        <td class="formValue">
                            <div>
                                <img id="ResultImgUri" name="ResultImgUri" width="30" height="30" />
                                <input type="file" id="FileResultImgUri" name="FileResultImgUri" onchange="BgfileImage(this, 'ResultImgUri')" />
                            </div>
                            <a style="margin-top:10px;display:block" id="btnAddResultImgUri" href="javascript:void(0)" onclick="AddFileImage(this,'ResultImgUri')">再添加一个</a>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
   
    <div style="text-align:center;">
        <a id="btnSave"  name="btnSave"  class="btn btn-sm btn-danger" style=""><i class="fa fa-plus"></i>保 存</a>`
        <a id="btnDelete" name="btnDelete" class="btn btn-sm btn-danger" style=""><i class="fa fa-plus"></i>删 除</a>`
    </div>
</div>
<script src="/Scripts/ajaxfileupload.js" type="text/javascript"></script>
<link href="~/Content/nfine/js/select2/select2.min.css" rel="stylesheet" />
<script src="~/Content/nfine/js/select2/select2.min.js"></script>
<link href="~/Content/nfine/css/framework-ui.css" rel="stylesheet" />
<script src="~/Content/nfine/js/framework-ui.js" type="text/javascript"></script>
<script src="~/Content/nfine/js/validate/jquery.validate.min.js"></script>
<script type="text/javascript">
    var keyValue = $.request("keyValue");
    var group = $.request("group");
    var type = $.request("type");
    var isShare=@ViewBag.IsShare.ToString().ToLower();
    var promptStyle=@ViewBag.PromptStyle;
    function gridList() {
      //  $('#gridList').empty();
        var $gridList = $("#gridList");
        $gridList.dataGrid({
            url: "/BigBrand/BigBrandPool/GetGridPageStyleJson?keyValue=" + keyValue + "&groupGuid=" + group,
            height: $(window).height() - 100,
            colModel: [
                  { label: "PKID", name: "PKID", width: 120, align: "center", key: true, hidden: true },
                  {
                      label: "位 置", name: "PositionText", width: 160, align: 'center',
                      formatter: function (cellValue,options,rowObject) {
                          var result = "";
                          switch (rowObject.Position) {
                              case 1:
                                  result = "左上";
                                  break;
                              case 2:
                                  result = "上";
                                  break;
                              case 3:
                                  result = "右上";
                                  break;
                              case 4:
                                  result = "左";
                                  break;
                              case 5:
                                  result = "右";
                                  break;
                              case 6:
                                  result = "左下";
                                  break;
                              case 7:
                                  result = "下";
                                  break;
                              case 8:
                                  result = "右下";
                                  break;
                          }
                          return result;
                      }
                  },
                  { label: "", name: "Position",hidden:true },
                  {
                      label: "图 片", name: "ImageUriText", width: 160, align: "center",
                      formatter: function (cellValue,options,rowObject) {
                          if (cellValue)
                              return `<img src="${cellValue}" width=30 height=30 />`;
                          else if (rowObject.ImageUri) {
                              return `<img src="${rowObject.ImageUri}" width=30 height=30 />`;
                          }else
                              return "";
                      }
                  },
                   { label: "", name: "ImageUri", hidden: true },
                   { label: "", name: "GroupGuid", hidden: true },
                   { label: "", name: "CreateUserName", hidden: true },
                   { label: "", name: "UpdateUserName", hidden: true },
                  {
                      label: "创建时间", name: "CreateDateTime", width: 120, align: "center",
                      formatter: "date", formatoptions: { srcformat: 'Y-m-d H:i:s', newformat: 'Y-m-d H:i:s' }
                  },
                    {
                        label: "更新时间", name: "LastUpdateDateTime", width: 120, align: "center",
                        formatter: "date", formatoptions: { srcformat: 'Y-m-d H:i:s', newformat: 'Y-m-d H:i:s' }
                    },
                    {
                        label: "操 作", name: "CaoZuo", width: 200, align: "center",
                        formatter: function (cellValue, options, rowObject) {
                            return ` <input type="file"  id="fileUpload${rowObject.Position}" data-pkid="${rowObject.PKID}" name="fileUpload${rowObject.Position}" onchange="fileImage(this,${options.rowId})" style="display: inline;"/> `;
                        }
                    }


            ]
        });
    }

    function gridListBig() {
        var $gridList = $("#gridList2");
        $gridList.dataGrid({
            url: "/BigBrand/BigBrandPool/GetGridPageStyleJson2?keyValue=" + keyValue + "&groupGuid=" + group,
            height: $(window).height() - 100,
            colModel: [
                { label: "PKID", name: "PKID", width: 120, align: "center", key: true, hidden: true },
                {
                    label: "位 置", name: "PositionText", width: 160, align: 'center',
                    formatter: function (cellValue, options, rowObject) {
                        var result = "";
                        switch (rowObject.Position) {
                            case 1:
                                result = "1行1列";
                                break;
                            case 2:
                                result = "1行2列";
                                break;
                            case 3:
                                result = "1行3列";
                                break;
                            case 4:
                                result = "1行4列";
                                break;
                            case 5:
                                result = "2行1列";
                                break;
                            case 6:
                                result = "2行4列";
                                break;
                            case 7:
                                result = "3行1列";
                                break;
                            case 8:
                                result = "3行2列";
                                break;
                            case 9:
                                result = "3行3列";
                                break;
                            case 10:
                                result = "3行4列";
                                break;
                        }
                        return result;
                    }
                },
                { label: "", name: "Position", hidden: true },
                {
                    label: "翻牌正面", name: "ImageUriText", width: 160, align: "center",
                    formatter: function (cellValue, options, rowObject) {
                        if (cellValue)
                            return `<img src="${cellValue}" width=30 height=30 />`;
                        else if (rowObject.ImageUri) {
                            return `<img src="${rowObject.ImageUri}" width=30 height=30 /> `;
                        } else
                            return "";
                    }
                }, {
                    label: "操作正面", name: "CImageUriText", width: 160, align: "center",
                    formatter: function (cellValue, options, rowObject) {
                         return ` <input type="file"  id="1fileUpload${rowObject.Position}" data-pkid="${rowObject.PKID}" name="1fileUpload${rowObject.Position}" onchange="fileImage(this,${options.rowId},2)" style="display: inline;"/> `;
                    }
                },
                {
                    label: "翻牌反面", name: "BImageUriText", width: 160, align: "center",
                    formatter: function (cellValue, options, rowObject) {
                        if (cellValue)
                            return `<img src="${cellValue}" width=30 height=30 />  `;
                        else if (rowObject.BImageUri) {
                            return `<img src="${rowObject.BImageUri}" width=30 height=30 /> `;
                        } else
                            return "";
                    }
                },
                {
                    label: "操作反面", name: "CBImageUriText", width: 160, align: "center",
                    formatter: function (cellValue, options, rowObject) {
                        return `<input type="file"  id="BfileUpload${rowObject.Position}" data-pkid="${rowObject.PKID}" name="BfileUpload${rowObject.Position}" onchange="BfileImage(this,${options.rowId})" style="display: inline;"/> `;
                    }
                },
                { label: "", name: "ImageUri", hidden: true },
                { label: "", name: "BImageUri", hidden: true },
                { label: "", name: "GroupGuid", hidden: true },
                { label: "", name: "CreateUserName", hidden: true },
                { label: "", name: "UpdateUserName", hidden: true },
                {
                    label: "创建时间", name: "CreateDateTime", width: 120, align: "center",
                    formatter: "date", formatoptions: { srcformat: 'Y-m-d H:i:s', newformat: 'Y-m-d H:i:s' }
                },
                {
                    label: "更新时间", name: "LastUpdateDateTime", width: 120, align: "center",
                    formatter: "date", formatoptions: { srcformat: 'Y-m-d H:i:s', newformat: 'Y-m-d H:i:s' }
                }

            ]
        });
    }


    function fileImage(obj, rowid,id=1) {
        console.log("rowid:", rowid);
        $.uploadFile({
            id: $(obj).attr("id"),
            preBack: function () {
                var size = $(obj)[0].files[0].size / 1024 * 1.0;
                if (size > 500) {
                    $.modalMsg("上传的图片过大", "warning");
                    return false;
                } else {
                    return true;
                }
            },
            callBack: function (res) {
                //res.BImage
                console.log(res.BImage)
                if (id == 1) {
                    $("#gridList").setCell(rowid, "ImageUriText", res.BImage);
                    $("#gridList").setCell(rowid, "ImageUri", res.BImage);
                }
                if (id == 2) {
                    $("#gridList2").setCell(rowid, "ImageUriText", res.BImage);
                    $("#gridList2").setCell(rowid, "ImageUri", res.BImage);
                }

            },
            complete: function () {

            }
        });
    }

    function BfileImage(obj, rowid) {
        console.log("rowid:", rowid);
        $.uploadFile({
            id: $(obj).attr("id"),
            preBack: function () {
                var size = $(obj)[0].files[0].size / 1024 * 1.0;
                if (size > 500) {
                    $.modalMsg("上传的图片过大", "warning");
                    return false;
                } else {
                    return true;
                }
            },
            callBack: function (res) {
                //res.BImage
                console.log(res.BImage)
                $("#gridList2").setCell(rowid, "BImageUriText", res.BImage);
                $("#gridList2").setCell(rowid, "BImageUri", res.BImage);
            },
            complete: function () {

            }
        });
    }
    function AddFileImage(obj,id,src) {
        src = src || '';
        var tempId = id + new Date().getTime();
        var html = '<div>' +
            '<img id="'+tempId+'" name="ResultImgUri" width="30" height="30" src="'+src+'" /><br/>' +
            '<input type="file" style="display:inline-block" id="File'+tempId+'" name="File'+tempId+'" onchange="BgfileImage(this, \''+tempId+'\')" />' +
            '<a  style="display:inline-block" href="javascript:void(0)" onclick="DeleteFileImage(this)">删除当前图片</a>' +
            '</div>';
        $(obj).before(html);
    }
    function DeleteFileImage(obj) {
        $(obj).parent("div").remove();
    }
    function BgfileImage(obj, imgId) {
        $.uploadFile({
            id: $(obj).attr("id"),
            preBack: function () {
                var size = $(obj)[0].files[0].size / 1024 * 1.0;
                if (size > 500) {
                    $.modalMsg("上传的图片过大", "warning");
                    return false;
                } else {
                    return true;
                }
            },
            callBack: function (res) {
                //res.BImage
                console.log(res.BImage)
               // $("#gridList2").setCell(rowid, "BImageUriText", res.BImage);
                // $("#gridList2").setCell(rowid, "BImageUri", res.BImage);
                $('#' + imgId).attr("src", res.BImage);
            },
            complete: function () {

            }
        });
    }

    function submitForm() {
        if ($("#PageType").val() == 1 || $("#PageType").val() == 2) {
            var $grid;
            if ($("#gbox_gridList").css("display") == "block") {
                $grid = $("#gridList");
            } else {
                $grid = $("#gridList2");
            }

            var data = [];
            var rowsIds = $grid.getDataIDs();
            var rows = [];
            for (var i in rowsIds) {
                rows.push($grid.getRowData(rowsIds[i]));
            }

            for (var key in rows) {
                var item = {};
                item.Position = rows[key].Position;
                item.PageType = $("#PageType").val();
                item.IsShare = $("#IsShare").val();
                item.PromptStyle = $("#PromptStyle").val();
                item.ImageUri = rows[key].ImageUri;
                item.BImageUri = rows[key].BImageUri;
                item.GroupGuid = rows[key].GroupGuid;
                item.CreateUserName = rows[key].CreateUserName;
                item.UpdateUserName = rows[key].UpdateUserName;
                item.FKPKID = keyValue;
                data.push(item);
            }


            $.ajax({
                url: "/BigBrand/BigBrandPool/SubmitPageStyle",
                type: "post",
                data: { json: JSON.stringify(data) },
                dataType: "json",
                success: function (res) {
                    if (res.state == "success") {
                        $.modalMsg("保存成功", "success");
                    } else {
                        $.modalMsg("保存失败", "error");
                    }
                }
            })
        } else if ($("#PageType").val() == 3) {
            if (!$("#form1").formValid()) {
                return false;
            }

            var formData = $("#form1").formSerialize();
            formData.BigBrandPKID = keyValue;
            formData.BgImgUri = $('#BgImgUri').attr("src") || '';
            formData.LastImgUri = $('#LastImgUri').attr("src") || '';
            formData.HomeBgImgUri = $('#HomeBgImgUri').attr("src") || '';
            var ResultImgUriArr = [];
            $('img[name="ResultImgUri"]').each(function() {
                if ($(this).attr("src")) {
                    ResultImgUriArr.push($(this).attr("src"));
                }
            });
            formData.ResultImgUri = ResultImgUriArr.join(",");
            $.ajax({
                url: '/BigBrand/BigBrandPool/SubmitAnswer',
                data: formData,
                dataType: 'json',
                type:'POST',
                success: function (res) {
                    if (res.state == "success") {
                        $.modalMsg("保存成功", "success");
                    } else {
                        $.modalMsg("保存失败", "error");
                    }
                }
            })

        } else {

        }

    }

    function bindAns() {
        //$('#AnswerIframe').empty();
        //$('#AnswerIframe').load('/BigBrand/BigBrandPool/AnswerQuestionsForm');
        $.ajax({
            url: '/BigBrand/BigBrandPool/GetAnswerEntity',
            data: {
                bigBrandPkid: keyValue
            },
            dataType:'json',
            success: function (res) {
                if (res.BigBrandPKID != 0) {
                    $("#form1").formSerialize(res);
                    if (res.BgImgUri)
                        $('#BgImgUri').attr("src", res.BgImgUri);
                    if (res.LastImgUri)
                        $('#LastImgUri').attr("src", res.LastImgUri);
                    if (res.HomeBgImgUri)
                        $('#HomeBgImgUri').attr("src", res.HomeBgImgUri);
                    if (res.ResultImgUri) {
                        var resultImgUriArr = res.ResultImgUri.split(',');
                        $('#ResultImgUri').attr("src", resultImgUriArr[0]);
                        if (resultImgUriArr.length > 1) {
                            for (var i = 1; i < resultImgUriArr.length; i++) {
                                AddFileImage($("#btnAddResultImgUri"), "ResultImgUri", resultImgUriArr[i]);
                            }
                        }
                    }
                        
                }
            }
        })
    }

    $(function () {
        //bindAns();
        $('#PageType').val(type);
        $("#IsShare").val(isShare.toString());
        $("#PromptStyle").val(promptStyle);
        if (type == 1) {
            gridList();
        }
        else if (type == 2) {
            $("#PromptStyleContainer").removeClass("hidden");
            gridListBig();
        } else if (type == 3) {
            bindAns();
            $('#AnswerIframe').show();
        } else {
            alert("类型为空")
        }
          
        $('#btnSave').on('click', submitForm);
        $('#PageType').on('change', function () {
            var val = $(this).val();
            $("#PromptStyleContainer").addClass("hidden");
            if (val == 1) {
                $("#gbox_gridList").show();
                $("#gbox_gridList2").hide();
                $('#AnswerIframe').hide();
                gridList();
            } else if (val == 2) {
                $("#gbox_gridList2").show();
                $("#gbox_gridList").hide();
                $('#AnswerIframe').hide();
                $("#PromptStyleContainer").removeClass("hidden");
                gridListBig();
            } else if (val == 3) {
                $('#AnswerIframe').show();
                $("#gbox_gridList").hide();
                $("#gbox_gridList2").hide();
            } else {

            }
        });

        $('#btnDelete').on('click', function () {
            var r = confirm("您确定删除？");
            if (r) {
                $.ajax({
                    url: '/BigBrand/BigBrandPool/DeletePageStyle?keyValue=' + keyValue + "&groupGuid=" + group,
                    type: 'POST',
                    success: function (res) {
                        if (res == 1) {
                            parent.location.reload();
                        }
                    }
                });
            }
           
        });

        $('#Tip').bindSelect({
            url: '/BigBrand/BigBrandPool/GetAnswerInfoList',
            id: "Tip",
            text: "Tip"
        });
       
    });

   
</script>