@using Newtonsoft.Json;
@model Tuhu.Provisioning.DataAccess.Entity.BaoYangRecommendServiceConfig
@{
    List<Tuhu.Provisioning.DataAccess.Entity.BaoYangPackage> packages = ViewBag.BaoYangPack;
    Layout = null;
}

<style>
    .btn {
        margin-top: 20px;
        padding: 5px 25px;
        border: none;
        color: #F0F0F0;
        font-size: 12px;
        outline: none;
        cursor: pointer;
        background: cornflowerblue;
        border-color: cornflowerblue;
    }

    a {
        color: cornflowerblue;
    }
</style>
<script src="../../Scripts/ajaxfileupload.js" type="text/javascript"></script>

<form action="/BaoYangRecommendServiceConfig/Edit" method="post">
    <input type="hidden" value="@Model.Id" name="Id" />
    <input type="hidden" id="hidServiceType" value="@Model.ServiceType" />
    <input type="hidden" id="editRecommend" value="@Model.Recommend" />
    <div>
        <table id="table1" style="width:100%">

            <tr>
                <td>状态</td>
                <td>
                    @Html.RadioButtonFor(m => m.Status, true) 启用
                    @Html.RadioButtonFor(m => m.Status, false) 禁用
                </td>
            </tr>

            <tr>
                <td>途虎推荐</td>
                <td>
                    @Html.RadioButtonFor(m => m.Recommend, true) 是
                    @Html.RadioButtonFor(m => m.Recommend, false) 否
                </td>
            </tr>
            <tr>
                <td style="width:40%">推荐标签</td>
                <td style="width:60%">
                    <input type="text" disabled="disabled" value="@Model.Tag" id="Tag" name="Tag" />
                </td>
            </tr>
            <tr>
                <td>保养服务</td>
                <td>
                    <select id="ServiceType" name="ServiceType">
                        @foreach (var item in packages)
                        {
                            <option value="@item.Type">@item.Name</option>
                        }
                    </select>
                </td>
            </tr>

            <tr>
                <td></td>
                <td>
                    <a href="javascript:;" style="color:blue" onclick="CloneTr(this)">添加优惠券</a>
                </td>
            </tr>
            @if (!string.IsNullOrWhiteSpace(Model.GetRuleGUID))
            {
                var ids = Model.GetRuleGUID.Substring(0, Model.GetRuleGUID.Length - 1).Split(';');
                var names = Model.CouponNames.Substring(0, Model.CouponNames.Length - 1).Split(';');
                int i = 0;
                foreach (var item in ids)
                {
                    <tr class="newTr">
                        <td>优惠券GUID：<input type="text" class="GetRuleGUID" value="@item" /></td>
                        <td>优惠券名称 <input class="CouponName" type="text" value="@names[i]" /></td>

                        <td><a style="color:blue;display:inline-block;width:50px;" href="javascript:;" onclick="DeleteTr(this)">删除</a></td>
                    </tr>
                    i++;
                }
            }
        </table>

        <input type="button" value="保存" onclick="SaveModel()" class="btn" />
    </div>
</form>


<table id="templateTable" style="display:none;">
    <tr class="newTr">
        <td>优惠券GUID：<input type="text" class="GetRuleGUID" value="" /></td>
        <td>优惠券名称 <input class="CouponName" type="text" value="" /></td>

        <td><a style="color:blue;display:inline-block;width:50px;" href="javascript:;" onclick="DeleteTr(this)">删除</a></td>
    </tr>
</table>

<script>

    $(function () {
        $("input[name='Recommend']").change(function(){
            if ($("input[name='Recommend']:checked").val()=="True") {
                $("#Tag").removeAttr("disabled");
            }else {
                $("#Tag").attr("disabled","disabled");
            }
        })

        if ($("input[name='Recommend']:checked").val()=="True") {
            $("#Tag").removeAttr("disabled");
        }else{
            $("#Tag").attr("disabled","disabled")
        }
        if (@Model.Id!=0) {
            $("#ServiceType").attr("disabled","disabled");
        }
        $("#ServiceType").val($("#hidServiceType").val())
    })

    function SaveModel() {
        var couponids = "";
        var couponnames = "";
        $('#table1 >tbody> tr').each(function (i) {
            if (i >= 0) {
                if ($(this).attr("class") == "newTr") {
                    var columns = $(this).children();

                    couponids += columns.eq(0).find("input[type='text']").val() + ";";
                    couponnames += columns.eq(1).find("input[type='text']").val() + ";";
                }
            }
        });

        $.ajax({
            type: "POST",
            url: "/BaoYangRecommendServiceConfig/Edit",
            data: {
                "Id": $("input[name='Id']").val(),
                "GetRuleGUID": couponids,
                "CouponNames": couponnames,
                "Status": $("input[name='Status']:checked").val(),
                "Recommend": $("input[name='Recommend']:checked").val(),
                "Tag": $("input[name='Tag']").val(),
                "ServiceType": $("#ServiceType").val(),
                "ServiceName": $("#ServiceType").find("option:selected").text()
            },
            dataType: "JSON",
            success: function (result) {
                if (result == "-100") {
                    alert("此服务已经存在！");
                } else if (result) {
                    window.location.reload(true);
                }
            },
            error: function (result) {

            }
        });
    }


    function DeleteTr(target) {

        $(target).closest('tr').remove();
    }

    function CloneTr(e) {
        var size = $("#table1").find(".newTr").size();
        if (size < 3) {
            var tr = $("#templateTable tr").clone();
            tr.appendTo("#table1");
        }
    }

    function UploadImg(e) {
        var $e = $(e);
        var $ee = $e.parents("tr").find("td").eq(1).find("img");
        var $smallImage = $e.parents("tr").find("td").eq(1).find("input[class='smallImage']");
        var $image = $e.parents("tr").find("td").eq(1).find("input[class='image']");
        $.ajaxFileUpload({
            url: '/Article/AddArticleImg2',
            secureuri: false,
            fileElementId: $e.attr("id"),
            dataType: 'json',
            data: {},
            type: "post",
            success: function (result) {
                if (result.BImage != "" && result.SImage != "") {
                    $ee.attr("src", result.SImage);
                    $(".vwPicture").show();
                    $smallImage.val(result.SImage);
                    $image.val(result.BImage);
                } else {
                    alert("上传失败！");
                }
            }
        })
    }

    $("#table1").on("blur", ".GetRuleGUID", function () {
        var $t = $(this);
        $.ajax({
            type: "POST",
            url: "/ActivityV1/CouponVlidate",
            data: {
                "couponRulePKID": $t.val()
            },
            dataType: "JSON",
            success: function (result) {
                console.log(JSON.stringify(result))
                $t.parents("tr").find("input[class='CouponName']").val(result.Name);
                $t.parents("tr").find("input[class='data']").val(result);
            },
            error: function (result) {

            }
        });
    })

</script>