@model Tuhu.Provisioning.Models.ProductDescriptionViewModel
@{
    ViewBag.Title = "商品详情配置模块";
}

@section head{
    <link href="~/Styles/zTreeStyle.css" type="text/css" rel="stylesheet" />
    <style>
        table {
            width: 90%;
        }

            table th {
                text-align: center;
            }

            table .type label {
                cursor: pointer;
            }

            table .category {
                width: 100%;
            }

                table .category .gouxuan {
                    width: 15px;
                    height: 15px;
                    border: 1px solid grey;
                    display: inline-block;
                    vertical-align: top;
                }

                table .category .cate {
                    vertical-align: top;
                    display: inline-block;
                    height: 15px;
                    line-height: 15px;
                }

                table .category li {
                    min-height: 30px;
                    line-height: 30px;
                }

        .item_delete {
            display: block;
            width: 40px;
            height: 30px;
            margin: 0 auto;
            background-color: #DEEEFE;
            text-align: center;
            line-height: 30px;
        }

        .tip {
            color: red;
            font-size: 10px;
            font-weight: bolder;
        }

        h2 {
            width: 200px;
            color: #333;
            float: left;
        }

        .button {
            width: 50px;
            height: 25px;
            text-align: center;
            line-height: 25px;
            margin-top: 20px;
            background: rgb(135, 182, 217);
            cursor: pointer;
        }

        .form-control {
            width: 950px;
            height: 34px;
            padding: 6px 12px;
            font-size: 14px;
            line-height: 1.42857143;
            color: #555;
            background-color: #fff;
            background-image: none;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
            -webkit-transition: border-color ease-in-out .15s,-webkit-box-shadow ease-in-out .15s;
            -o-transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s;
            transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s;
        }

        #brand .select {
            width: 90px;
            display: inline-block;
            float: left;
            border: 1px solid #e8e8e8;
            position: relative;
            height: 22px;
        }

            #brand .select .arrow_down {
                position: absolute;
                display: inline-block;
                border: 4px solid;
                border-color: #666 #fff #fff #fff;
                right: 4px;
                top: 9px;
            }

            #brand .select .input {
                border: none;
                width: 100%;
                float: left;
                height: 20px;
                line-height: 20px;
                cursor: pointer;
            }

            #brand .select .item {
                width: 90px;
                position: absolute;
                top: 23px;
                left: -1px;
                border-right-width: 1px;
                border-bottom-width: 1px;
                border-left-width: 1px;
                border-style: none solid solid;
                border-color: #e8eef4;
            }

                #brand .select .item label {
                    width: 90px;
                    display: block;
                    height: 20px;
                    line-height: 20px;
                    margin-bottom: 3px;
                    margin-top: 3px;
                    cursor: pointer;
                }


            #brand .select.children, #brand .select.grandson {
                display: none;
                border-left: none;
            }

        #brand .branditem {
            display: inline-block;
            height: 20px;
            line-height: 20px;
            margin-right: 20px;
        }

            #brand .branditem input {
                vertical-align: bottom;
            }

        .ui-dialog {
            border-radius: 3px;
            padding: 0px;
            width: auto;
            background-color: ghostwhite;
        }

        .ui-dialog-grid {
            width: 100%;
        }

        .ui-dialog-title {
            width: 75%;
            padding: 8px 15px 8px 15px;
        }

        .ui-dialog-close {
            display: none;
            top: 8px;
        }

        .ui-dialog-body {
            padding: 10px;
        }

        .ui-dialog-content {
            padding: 0px;
        }

        .ui-dialog-footer {
            padding: 5px 10px 5px 5px;
            background: #ffffff;
            border-top: 1px solid #eee;
        }

            .ui-dialog-footer button {
                padding: 3px 15px;
                border-radius: 2px;
                box-shadow: 0 1px 1px rgba(0,0,0,.15);
                font-size: 12px;
                float: right;
            }

                .ui-dialog-footer button.ui-dialog-autofocus {
                    font-weight: 700;
                    text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
                }
    </style>
}
<h2>商品详情新增</h2>
<table>
    <tr>
        <td><span class="content">按类别：</span></td>
        <td>
            <div id="category">
                <ul id="tree1" class="ztree"></ul>
            </div>
        </td>
    </tr>
    <tr style="height:50px">
        <td>按PID:</td>
        <td class="ordertype">
            <input type="checkbox" id="AddorDel" checked='@((Model!=null&&Model.ProductConfigDetails!=null)?((Model.ProductConfigDetails.AddOrDel == 1 || Model.ProductConfigDetails.AddOrDel == 2)?"checked":null):null)' />
            <label><input type="radio" id="AddPID" name="ordertype" value="1" checked='@((Model!=null&&Model.ProductConfigDetails!=null)?((Model.ProductConfigDetails.AddOrDel == 1)?"checked":null):null)' />在类别基础上增加部分PID</label>
            <label><input type="radio" id="DelPID" name="ordertype" value="2" checked='@((Model!=null&&Model.ProductConfigDetails!=null)?((Model.ProductConfigDetails.AddOrDel == 2)?"checked":null):null)' />在类别基础上去除部分PID</label>
            <div id="pid" style="display:@((Model!=null&&Model.ProductConfigDetails!=null)?((Model.ProductConfigDetails.AddOrDel == 1 || Model.ProductConfigDetails.AddOrDel == 2) ? null : " none"):null);">
                <table>
                    <tr style="text-align:center;">
                        <th style="width:15%;">产品编号</th>
                        <th>产品名称</th>
                        <th style="width:10%;">操作</th>
                    </tr>
                    @if (Model != null && Model.ProductConfigDetails != null && Model.ProductConfigDetails.Pids != null)
                    {
                        foreach (var item in Model.ProductConfigDetails.Pids)
                        {
                            <tr style="text-align:center;" class="productDis">
                                <td><input type="text" name="PID" style="width:80%" value="@item" class="ChangeProductName bitian" /></td>
                                <td></td>
                                <td><a href="#" class="item_delete">删除</a></td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr style="text-align:center;" class="productDis">
                            <td><input type="text" name="PID" style="width:80%" value="" class="ChangeProductName bitian" /></td>
                            <td></td>
                            <td><a href="#" class="item_delete">删除</a></td>
                        </tr>
                    }
                    <tr>
                        <td colspan="3">
                            <a href="#" class="product_add">添加商品</a>
                        </td>
                    </tr>
                </table>

            </div>
        </td>
    </tr>
    <tr style="height:50px;">
        <td width="10%" style="text-align:left">按品牌</td>
        <td width="90%" style="text-align:left">
            <div id="brand">
                <table>
                    <tr>
                        <th width="25%">商品类别</th>
                        <th>请选择品牌</th>
                        <th width="10%">操作</th>
                    </tr>
                    @if (Model != null && Model.ProductConfigDetails != null && Model.ProductConfigDetails.BrandDetails != null)
                    {
                        foreach (var item in Model.ProductConfigDetails.BrandDetails)
                        {
                            if (item.Brands.Count() > 0)
                            {
                                <tr class="per_categoryandbrand">
                                    <td>
                                        <input type="hidden" name="Category" value="@item.BrandCategoryName" data_key="@(string.Join(",", item.Brands.ToArray()))" />
                                        <span class="select parent">
                                            <span class="input"></span>
                                            <label class="arrow_down"></label>
                                            <span class="item" style="display:none;"></span>
                                        </span>
                                        <span class="select children" style="display:none;">
                                            <span class="input">--请选择--</span>
                                            <label class="arrow_down"></label>
                                            <span class="item"></span>
                                        </span>
                                        <span class="select grandson" style="display:none;">
                                            <span class="input"></span>
                                            <label class="arrow_down"></label>
                                            <span class="item"></span>
                                        </span>
                                    </td>
                                    <td class="result"></td>
                                    <td>
                                        <a href="#" class="item_delete">删除</a>
                                    </td>
                                </tr>
                            }
                        }
                    }
                    else
                    {
                        <tr class="per_categoryandbrand">
                            <td>
                                <input type="hidden" name="Category" />
                                <span class="select parent">
                                    <span class="input">--请选择--</span>
                                    <label class="arrow_down"></label>
                                    <span class="item" style="display:none;"></span>
                                </span>
                                <span class="select children">
                                    <span class="input">--请选择--</span>
                                    <label class="arrow_down"></label>
                                    <span class="item" style="display:none;"></span>
                                </span>
                                <span class="select grandson">
                                    <span class="input">--请选择--</span>
                                    <label class="arrow_down"></label>
                                    <span class="item" style="display:none;"></span>
                                </span>
                            </td>
                            <td class="result"></td>
                            <td>
                                <a href="#" class="item_delete">删除</a>
                            </td>
                        </tr>
                    }
                    <tr>
                        <td colspan="3">
                            <a href="#" class="brand_add">新增类别及品牌</a>
                        </td>
                    </tr>
                </table>
            </div>
        </td>
    </tr>
    <tr style="height:50px">
        <td width="10%" style="text-align:left;">模块的名称：</td>
        <td width="90%" style="text-align:left;">
            <input type="text" style="width:300px;height:20px" placeholder="如：购物流程、广告-机油活动" name="Name" value="@Model.ModuleName" class="bitian" />
        </td>
    </tr>
    <tr style="height:50px">
        <td width="10%" style="text-align:left">模块的顺序</td>
        <td width="90%" style="text-align:left">
            <input type="text" id="ModuleOrder" value="@Model.ModuleOrder" name="Order" />
            <span style="color:darkgray">(商品详情的顺序为0，所有模块按照从小到大的顺序排列，如果数字一样则随机排列)</span>
        </td>
    </tr>
    <tr style="height:50px">
        <td>是否广告：</td>
        <td>

            <input type="checkbox" id="Advert" checked='@(Model.IsAdvertise == true ? "checked" : null)' />
            <input type="text" id="startDate" style="width:12%" name="dateTime" value="@Model.StartDateTime" placeholder="请输入开始时间" />
            <input id="endDate" type="text" style="width:12%" name="dateTime" value="@Model.EndDateTime" placeholder="请输入结束时间" />
            <a style="cursor:pointer" href="#" onclick="OpenRole()">APP配置规则</a>
        </td>
    </tr>
    <tr style="height:50px">
        <td>显示平台：</td>
        <td class="Platform">
            <label><input type="radio" name="ShowPlatform" value="0" checked='@(Model.PlatfromType == 0 ? "checked" : null)' />全部</label>
            <label><input type="radio" name="ShowPlatform" value="1" checked='@(Model.PlatfromType == 1 ? "checked" : null)' />仅PC</label>
            <label><input type="radio" name="ShowPlatform" value="2" checked='@(Model.PlatfromType == 2 ? "checked" : null)' />仅手机</label>
        </td>
    </tr>
    <tr style="height:50px">
        <td>模块内容<br /><span style="color:red;display:@(Model.IsAdvertise == true ? "none" : null)">(请进入编辑框操作!)</span></td>
        <td>
            <textarea id="ueditor_title" class="form-control" style="display:@(Model.IsAdvertise == true ? "none" : null)">@Model.ContentHtml</textarea>
            <script id="editor" type="text/plain" name="editor" style="display:none">
            </script>
            <table id="tab-AppConfig" style="width:800px;display:@(Model.IsAdvertise == true ? null : "none");">
                <tr>
                    <td align="center">广告图片</td>
                    <td colspan="2">
                        <img height="40" class="vwPicture" id="vwPicture" src="@Model.SmallImageUrl" />
                        <input type="hidden" class="image" id="image" value="@Model.BigImageUrl" />
                        <input type="hidden" class="smallImage" id="smallImage" value="@Model.SmallImageUrl" />

                        <form method="post" action="" enctype="multipart/form-data">
                            <input style="width: 150px;" type="file" id="imgArea" name="imgArea" onchange="UploadImg(this)" /><br /><span style="color: #d43f3a;font-size:10px; font-weight: bolder">(请等待图片加载完成)</span>
                        </form>
                    </td>
                </tr>
                <tr>
                    <td rowspan="2" align="center">IOS跳转</td>
                    <td align="right"><label>APP处理值:</label></td>

                    <td><input style="width:600px;height:20px" id="IOSHandlekey" value="@Model.IOSHandleKey" type="text" /></td>

                </tr>
                <tr>
                    <td align="right"><label>特殊通讯值:</label></td>

                    <td><input style="width:600px;height:20px" id="IOSSpecialkey" value="@Model.IOSSpecialKey" type="text" /></td>

                </tr>
                <tr>
                    <td rowspan="2" align="center">Andorid跳转</td>
                    <td align="right"><label>APP处理值:</label></td>

                    <td><input style="width:600px;height:20px" id="AndorHandlekey" value="@Model.AndroidHandleKey" type="text" /></td>

                </tr>
                <tr>
                    <td align="right"><label>特殊通讯值:</label></td>

                    <td><input style="width:600px;height:20px" id="AndorSpecialkey" value="@Model.AndroidSpecialKey" type="text" /></td>

                </tr>
                <tr>
                    <td align="center">PC跳转</td>
                    <td align="right"><label>URL:</label></td>

                    <td><input style="width:600px;height:20px" id="PCUrl" placeholder="#代表不做处理" value="@Model.PCUrl" type="text" /></td>

                </tr>
                <tr>
                    <td align="center">H5跳转</td>
                    <td align="right"><label>URL:</label></td>

                    <td><input style="width:600px;height:20px" id="H5Url" placeholder="#代表不做处理" value="@Model.H5Url" type="text" /></td>

                </tr>
            </table>
        </td>
    </tr>
</table>
<div id="div_table" style="display:none; background-color:ghostwhite">
    <table style="font-size:10px;width:100%;text-align:center">
        <tr>
            <th>ModuleName</th>
            <th>ShowPlatform</th>
            <th>AppHandlerkey</th>
            <th>AppSpecialKey</th>
            <th>URL</th>
        </tr>
        <tr>
            <td>车品跳转</td>
            <td>手机(IOS)</td>
            <td>TNGoodsListDetailViewController</td>
            <td>{"ProductID": "LI-CARORI-Z-217A", "VariantID": "1"}</td>
            <td>空</td>
        </tr>
        <tr>
            <td>车品跳转</td>
            <td>手机(Android)</td>
            <td>toActityBridge</td>
            <td>{"ProductID":"LI-CARORI-Z-217A","VariantID":"1","FunctionID":"cn.TuHu.Activity.AutomotiveProducts.AutomotiveProductsDetialUI"}</td>
            <td>空</td>
        </tr>
        <tr>
            <td>车品跳转</td>
            <td>手机(H5)</td>
            <td>空</td>
            <td>空</td>
            <td>#</td>
        </tr>
        <tr>
            <td>车品跳转</td>
            <td>PC</td>
            <td>空</td>
            <td>空</td>
            <td>#</td>
        </tr>
        <tr>
            <td>h5跳转</td>
            <td>手机(IOS)</td>
            <td>TNHBH5VViewController</td>
            <td>{"url": "https://resource.tuhu.cn/StaticPage/TiresXian/index.html"}</td>
            <td>空</td>
        </tr>
        <tr>
            <td>h5跳转</td>
            <td>手机(Android)</td>
            <td>toActityBridge</td>
            <td>{"Url": "https://resource.tuhu.cn/StaticPage/TiresXian/index.html","FunctionID":"cn.TuHu.Activity.AutomotiveProducts.AutomotiveProductsWebViewUI"}</td>
            <td>空</td>
        </tr>
        <tr>
            <td>h5跳转</td>
            <td>手机(H5)</td>
            <td>空</td>
            <td>空</td>
            <td>#</td>
        </tr>
        <tr>
            <td>h5跳转</td>
            <td>PC</td>
            <td>空</td>
            <td>空</td>
            <td>#</td>
        </tr>
        <tr>
            <td>轮胎跳转</td>
            <td>手机(IOS)</td>
            <td>TNTireInfoVC</td>
            <td>{"ProductID":"TR-ME-PRIMACY-3-ST","VariantID":"15"}</td>
            <td>空</td>
        </tr>
        <tr>
            <td>轮胎跳转</td>
            <td>手机(Android)</td>
            <td>toActityBridge</td>
            <td>{"ProductID":"TR-ME-PRIMACY-3-ST","VariantID":"15","FunctionID":"cn.TuHu.Activity.TireInfoUI"}</td>
            <td>空</td>
        </tr>
        <tr>
            <td>轮胎跳转</td>
            <td>手机(H5)</td>
            <td>空</td>
            <td>空</td>
            <td>#</td>
        </tr>
        <tr>
            <td>轮胎跳转</td>
            <td>PC</td>
            <td>空</td>
            <td>空</td>
            <td>#</td>
        </tr>
        <tr>
            <td colspan="6">
                <span style="font-weight:bold">APP配置规则：</span><span style="color:red">图片上传</span>为必填项，<span style="color:red">H5跳转</span>和<span style="color:red">PC跳转</span>如果没有链接请输入<span style="color:red">#</span>。平台选择<span style="color:red">全部</span>，则相对应的输入框需要全部填写，
                平台选择<span style="color:red">仅PC</span>，则只需要填写<span style="color:red">PC跳转</span>的链接即可，平台选择<span style="color:red">仅手机</span>，则需要填写三项，分别是<span style="color:red">IOS跳转</span>、<span style="color:red">Android跳转</span>和<span style="color:red">H5跳转</span>。
            </td>
        </tr>
    </table>
</div>
<input type="button" class="button" id="save" value="保存" /><input type="button" class="button" id="return" value="取消" />
<link rel="stylesheet" href="/Scripts/artDialog6.0.4/css/ui-dialog.css" />
<script src="~/Scripts/artDialog6.0.4/dist/dialog-min.js"></script>
@section scripts{
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <script src="../../Scripts/ajaxfileupload.js" type="text/javascript"></script>
    <script src="~/Scripts/jquery.ztree.all-3.5.min.js"></script>
    <script src="~/Scripts/UEditor/ueditor.config.js"></script>
    <script src="~/Scripts/UEditor/ueditor.all.min.js"></script>
    <script src="~/Scripts/UEditor/lang/zh-cn/zh-cn.js"></script>
    <script src="~/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.js"></script>
    <link href="~/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.css" rel="stylesheet" />
    <script type="text/javascript">
        function UploadImg(e) {
            var $e = $(e);
            var $ee = $e.parents().find("td").eq(1).find("img");
            var $smallImage = $e.parents().find("td").eq(1).find("input[class='smallImage']");
            var $image = $e.parents().find("td").eq(1).find("input[class='image']");
            $.ajaxFileUpload({
                url: '/ProductModuleConfig/ImageUpload',
                secureuri: false,
                fileElementId: $e.attr("id"),
                dataType: 'json',
                data: {},
                type: "post",
                success: function (result) {
                    if (result.BImage != "" && result.SImage != "") {
                        $ee.attr("src", result.SImage);
                        $(".vwPicture").show();
                        $smallImage.val(result.SImage);
                        $image.val(result.BImage);
                    } else {
                        alert("上传失败！");
                    }
                }
            });
        }

        function OpenRole() {
            var d = dialog({
                title: "配置规则示例",
                modal: true,
                width: "100%",
                height: 400,
                fixed: true,
                button: [
                    {
                        value: "取消"
                    }
                ]
            });
            var html = $("#div_table").html();
            d.content(html);
            d.showModal();
        }

        $(function () {
            var categories = [];
            var children = [];
            var isSelectPid = 0;
            var isClickAdvert = 0;
            var addOrDel = -1;
            var platformConfig = new Array();

            $('#startDate').datetimepicker({
                timeFormat: "HH:mm:ss",
                dateFormat: "yy-mm-dd",
                monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
            });
            $('#endDate').datetimepicker({
                timeFormat: "HH:mm:ss",
                dateFormat: "yy-mm-dd",
                monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
            });

            var ue = UE.getEditor('editor', {
                UEDITOR_HOME_URL: "/Scripts/UEditor/",
                allowDivTransToP: false,
                autoHeightEnabled: false,
                initialFrameWidth: 950,
                initialFrameHeight: 480,
                zIndex: 2002,
                enterTag: ''
            });

            $("#ueditor_title").click(function () {
                $("#ueditor_title").hide();
                $("#editor").show();
                UE.getEditor('editor').execCommand('insertHtml', $("#ueditor_title").val());
                $("#ueditor_title").val("");
            })

            //获得产品的类别
            var treeObj = null;
            $.ajax({
                url: "/ProductModuleConfig/GetCategory",
                type: "get",
                dataType: "json",
                data: { type: "category" },
                success: function (data) {
                    if (data != null) {
                        var setting = {
                            check: {
                                enable: true,
                                nocheckInherit: true,
                                chkStyle: "checkbox",
                                chkboxType: { "Y": "s", "N": "ps" }
                            },
                            callback: {
                            }
                        };
                        treeObj = $.fn.zTree.init($("#tree1"), setting, data);

                        var presentcate = "@(Model!= null&& Model.ProductConfigDetails!=null&& Model.ProductConfigDetails.Categories!=null? String.Join(",", Model.ProductConfigDetails.Categories.ToArray()) : "")".split(',');//原有的类别
                        var nodes = treeObj.getNodes();
                        if (presentcate.length > 0) {
                            for (var i = 0, l = nodes.length; i < l; i++) {
                                if (presentcate.indexOf(nodes[i].title) >= 0)
                                    treeObj.checkNode(nodes[i], true, true);
                                else if (nodes[i].children.length > 0) {
                                    var f = true;
                                    $.each(nodes[i].children, function (i, v) {
                                        if (presentcate.indexOf(v.title) >= 0)
                                            treeObj.checkNode(v, true, true);
                                        else
                                            f = false;
                                    });
                                    if (f)
                                        treeObj.checkNode(nodes[i], true, true);

                                }
                            }
                        }
                    }
                }
            });

            var firstbrand = true;

            //获得产品品牌
            var categories = [];
            var children = [];
            var content1 = "";//产品大种类

            if (firstbrand) {
                $("#brand .parent .item").text("正在加载数据...");
                $.ajax({
                    url: "/ProductModuleConfig/GetCategory",
                    type: "get",
                    dataType: "json",
                    data: { type: "brand" },
                    success: function (data) {
                        if (data != null) {
                            categories = data;
                            firstbrand = false;
                            $.each(data, function (i, v) {
                                children[v.CategoryName] = v.ChildrenCategory;
                                if (v.ChildrenCategory.length > 0) {
                                    $.each(v.ChildrenCategory, function (j, k) {
                                        children[k.CategoryName] = k.ChildrenCategory;
                                    });
                                }
                            });
                            $.each(categories, function (i, v) {
                                content1 += "<label data-catagory='" + v.CategoryName + "'>" + v.DisplayName + "</label>";
                            });
                            $("#brand .parent .item").text("").append(content1).css("display", "block").hide();//
                            $("#brand .parent").parent().parent().css({ "vertical-align": "top" });// "height": "230px",

                            $(".per_categoryandbrand input[name=Category]").each(function () {
                                var td = $(this).parent();
                                var val = $(this).val();
                                var self = $(this);
                                var content2 = "";
                                var content3 = "";
                                var originalbrands = $(this).attr("data_key");
                                var brands = originalbrands.split(',');
                                var flag = false;
                                @*var originalbrands = "@(Model!=null&&Model.Count()>0 ? String.Join(",", Model.FirstOrDefault().Brands) : "")".split(',');*@
                                //品牌设置
                                $.ajax({
                                    url: "/Promotion/GetBrand",
                                    type: "get",
                                    dataType: "json",
                                    data: { type: val },
                                    success: function (data) {
                                        if (data != null) {
                                            var content = "";
                                            $.each(data, function (i, v) {
                                                flag = false;
                                                if (brands.length > 0) {
                                                    for (var i = 0; i < brands.length; i++) {
                                                        if (brands[i] == v.Cp_Brand) {
                                                            flag = true;
                                                            break;
                                                        }
                                                    }
                                                }
                                                if (originalbrands.length > 0 && originalbrands.indexOf(v.Cp_Brand) >= 0 && flag == true) {
                                                    content += '<span class="branditem"><input type="checkbox" name="brand" value="' + v.Cp_Brand + '" checked="checked" />' + v.Cp_Brand + '</span>';
                                                }
                                                else {
                                                    content += '<span class="branditem"><input type="checkbox" name="brand" value="' + v.Cp_Brand + '" />' + v.Cp_Brand + '</span>';
                                                }
                                            });
                                            td.next().text("").append(content);
                                        }
                                    }
                                });

                                //下拉框设置
                                $.each(categories, function (i, v) {
                                    //self.siblings(".parent").find(".item").append(content1);
                                    //self.siblings(".parent").find(".item").hide();
                                    if (v.CategoryName.trim() == val) {
                                        self.siblings(".parent").find(".input").text(v.DisplayName);
                                        return;
                                    }
                                    else {
                                        var parent = v.CategoryName;
                                        var grandpa = v.CategoryName;
                                        var grandpaName = v.DisplayName;
                                        var parentName = v.DisplayName;
                                        if (v.ChildrenCategory.length > 0) {
                                            $.each(v.ChildrenCategory, function (i, v) {
                                                parentName = v.DisplayName;
                                                if (v.CategoryName.trim() == val) {
                                                    $.each(children[parent], function (i, v) {
                                                        content2 += "<label data-catagory='" + v.CategoryName + "'>" + v.DisplayName + "</label>";
                                                    });
                                                    self.siblings(".parent").find(".input").text(grandpaName);
                                                    self.siblings(".parent").find(".item").hide();
                                                    self.siblings(".children").find(".input").text(parentName);
                                                    self.siblings(".children").show().find(".item").append(content2).hide();
                                                    return;
                                                }
                                                else {
                                                    if (v.ChildrenCategory.length > 0) {
                                                        parent = v.CategoryName;
                                                        $.each(v.ChildrenCategory, function (i, v) {
                                                            if (v.CategoryName.trim() == val) {
                                                                self.siblings(".children").find(".input").text(parentName);
                                                                $.each(children[parent], function (i, v) {
                                                                    content3 += "<label data-catagory='" + v.CategoryName + "'>" + v.DisplayName + "</label>";
                                                                });
                                                                $.each(children[grandpa], function (i, v) {
                                                                    content2 += "<label data-catagory='" + v.CategoryName + "'>" + v.DisplayName + "</label>";
                                                                });
                                                                self.siblings(".parent").find(".input").text(grandpaName);
                                                                self.siblings(".parent").find(".item").hide();
                                                                self.siblings(".children").show().find(".item").append(content2).hide();
                                                                self.siblings(".children").show().find(".input").text(parentName);
                                                                self.siblings(".grandson").show().find(".item").append(content3).hide();
                                                                self.siblings(".grandson").show().find(".input").text(v.DisplayName);
                                                                return;
                                                            }
                                                        });
                                                    }
                                                }
                                            });
                                        }
                                    }
                                });
                            });
                        }
                    }
                });
            }

            $("#AddorDel").change(function () {
                var isSendCoupon = document.getElementById("AddorDel").checked;
                if (!isSendCoupon) {
                    $("input[name=ordertype]").attr("disabled", true);
                    $("input[name=ordertype]").attr("checked", false);
                    isSelectPid = 0;
                    $("#pid").hide();
                } else {
                    $("input[name=ordertype]").attr("disabled", false);
                    isSelectPid = 1;
                    $("#AddPID").attr("checked", true);
                    $("#pid").show();
                }
            });

            if (document.getElementById("Advert").checked) {
                isClickAdvert = 1;
            } else {
                $("input[name=dateTime]").attr("value", "");
                $("input[name=dateTime]").attr("disabled", true);
                isClickAdvert = 0;
            }

            if (document.getElementById("AddorDel").checked) {
                isSelectPid = 1;
            } else {
                $("input[name=ordertype]").attr("disabled", true);
                $("input[name=ordertype]").attr("checked", false);
                isSelectPid = 0;
                $("#pid").hide();
            }

            function clear() {
                platformConfig.length = 0;
                $("#image").val("");
                $("#smallImage").val("");
                $("#IOSHandlekey").val("");
                $("#IOSSpecialkey").val("");
                $("#AndorHandlekey").val("");
                $("#AndorSpecialkey").val("");
                $("#PCUrl").val("");
                $("#H5Url").val("");
                $("#ueditor_title").val("");
                $("#vwPicture").attr("src", "");
            }

            $("#Advert").change(function () {
                var isAdvert = document.getElementById("Advert").checked;
                if (!isAdvert) {
                    clear();
                    $("input[name=dateTime]").attr("value", "");
                    $("input[name=dateTime]").attr("disabled", true);
                    isClickAdvert = 0;
                    $("#tab-AppConfig").hide();
                    $("#editor").hide();
                    $("#ueditor_title").show();
                } else {
                    clear();
                    $("input[name=dateTime]").attr("disabled", false);
                    isClickAdvert = 1;
                    $("#tab-AppConfig").show();
                    $("#editor").hide();
                    $("#ueditor_title").hide();
                }
            });


            $("#brand").on("click", ".select .input", function () {
                var s = $(this);
                //s.siblings(".item").toggleClass("current");
                if (s.siblings(".item").is(":visible") == false) {
                    s.parent().parent().parent().css({ "height": "320px", "vertical-align": "top" });
                    s.siblings(".item").css("display", "block");

                    //让其前后下拉框隐藏
                    s.parent().next().find(".item").hide();
                    s.parent().prev().find(".item").hide();
                    s.parent().next().next().find(".item").hide();
                    s.parent().prev().prev().find(".item").hide();
                }
                else {
                    s.siblings(".item").hide();
                    s.parent().parent().parent().css({ "height": "auto", "vertical-align": "top" });
                }
            });
            //新增产品类别及品牌
            $("#brand").on("click", ".brand_add", function () {
                var content = '<tr style="height:230px; vertical-align:top;" class="per_categoryandbrand"><td><input type="hidden" name="Category" /><span class="select parent"><span class="input">--请选择--</span><label class="arrow_down"></label><span class="item">' + content1 + '</span></span><span class="select children"><span class="input">--请选择--</span><label class="arrow_down"></label><span class="item" style="display:none;"></span></span><span class="select grandson"><span class="input">--请选择--</span><label class="arrow_down"></label><span class="item" style="display:none;"></span></span></td><td></td><td><a href="#" class="item_delete" >删除</a></td></tr>';
                $(this).parent().parent().before(content);
            });

            $("#brand").on("click", ".item label", function () {
                var s = $(this);
                var td = s.parent().parent().parent();
                var content2 = "";
                s.parent().siblings(".input").text(s.text());
                s.parent().hide();
                s.parent().parent().next().hide().find(".input").text("--请选择--");
                s.parent().parent().next().find(".item label").remove();
                s.parent().parent().next().next().hide().find(".input").text("--请选择--");
                s.parent().parent().next().next().find(".item label").remove();
                if (children[s.attr("data-catagory")] != null && children[s.attr("data-catagory")].length > 0) {
                    $.each(children[s.attr("data-catagory")], function (i, v) {
                        content2 += "<label data-catagory='" + v.CategoryName + "'>" + v.DisplayName + "</label>";
                    });
                    s.parent().parent().next().css("display", "inline-block").find(".item label").remove();
                    s.parent().parent().next().find(".item").css("display", "block").append(content2);

                    s.parent().parent().siblings("input[type=hidden]").val(null);
                    td.parent().css({ "height": "320px", "vertical-align": "top" });
                    td.next().text("");
                }
                else {
                    s.parent().parent().siblings("input[type=hidden]").val(s.attr("data-catagory"));
                    //table行的高度
                    td.parent().css({ "height": "auto", "vertical-align": "top" });
                    //单元格
                    //加载品牌
                    $.ajax({
                        url: "/Promotion/GetBrand",
                        type: "get",
                        dataType: "json",
                        data: { type: s.attr("data-catagory") },
                        success: function (data) {
                            if (data != null) {
                                var content = "";
                                $.each(data, function (i, v) {
                                    content += '<span class="branditem"><input type="checkbox" name="brand" value="' + v.Cp_Brand + '" />' + v.Cp_Brand + '</span>';
                                });
                                td.next().text("").append(content);
                            }
                        }
                    });

                }

            });

            $("#pid").on("click", ".product_add", function () {
                var content = '<tr style="text-align:center;" class="productDis"><td><input type="text" name="PID" style="width:80%" value="" class="ChangeProductName bitian" /></td><td></td><td><a href="#" class="item_delete">删除</a></td></tr>';
                $(this).parent().parent().before(content);
            });


            $("table").on("click", ".item_delete", function () {
                $(this).parent().parent().remove();
            });


            $("#pid").on("input", ".productDis .ChangeProductName", function () {
                var _ParentTr = $(this).parent();
                var _NewPID = $(this).val();
                if (_NewPID != "") {
                    $.ajax({
                        type: "post",
                        url: '/Advertise/GetProductNamebyPID',
                        data: { "PID": _NewPID, "Cate": 1 },
                        success: function (result) {
                            if (result != "")
                                _ParentTr.next().text(result);
                            else
                                _ParentTr.next().text("无此产品");
                        }
                    });
                }
            });

            $("#pid .ChangeProductName").each(function () {
                $(this).trigger("input");
            });


            $("#return").click(function () {
                location.href = "/ProductModuleConfig/Index";
            })

            $("#save").click(function () {
                $(".tip").remove();
                var type = "";
                var button = $(this);
                var moduleContent = "";
                var categoryData = [];
                var name = $("input[name=Name]").val();
                var order = $("input[name=Order]").val();
                var showPlatform = $(".Platform").find("input[name=ShowPlatform]:checked").val();
                var tip = "";
                var flag = true;

                var allNodes = treeObj.getNodes();
                $.each(allNodes, function (i, v) {
                    $.each(v.children, function (i, v) {
                        if (v.checked) {
                            categoryData.push({ CategoryName: v.title });
                        }
                    });
                });

                if ($("input[name=Name]").val().trim() == "") {
                    flag = false;
                    tip = "<span class='tip'>请填写模块的名称</span>";
                    $("input[name=Name]").after(tip);
                    $("html, body").animate({
                        scrollTop: "20px"
                    }, {
                        duration: 500,
                        easing: "swing"
                    });
                    button.css("pointer-events", "all");
                    return;
                }

                var modelOrder = $("#ModuleOrder").val();
                if (modelOrder == "") {
                    tip = "<div class='tip'>请填写模块顺序</div>";
                    if (flag)
                        flag = false;
                    $("#ModuleOrder").after(tip);
                }
                else if (isNaN(modelOrder)) {
                    tip = "<div class='tip'>请输入正确的数字</div>";
                    if (flag)
                        flag = false;
                    $("#ModuleOrder").after(tip);
                } else if (modelOrder == "0") {
                    tip = "<div class='tip'>顺序不能为0</div>";
                    if (flag)
                        flag = false;
                    $("#ModuleOrder").after(tip);
                }

                var startDate = $("#startDate").val();
                var endDate = $("#endDate").val();

                if (isClickAdvert == 1) {
                    if (startDate == "" || endDate == "") {
                        tip = "<div class='tip'>日期不能为空</div>";
                        if (flag)
                            flag = false;
                        $("#endDate").after(tip);
                    }
                }
                if (isClickAdvert == 1) {
                    var image = $("#image").val();
                    var smallImg = $("#smallImage").val();
                    var iosHandle = $("#IOSHandlekey").val();
                    var iosSpecial = $("#IOSSpecialkey").val();
                    var androidHandle = $("#AndorHandlekey").val();
                    var androidSpecial = $("#AndorSpecialkey").val();
                    var pcURL = $("#PCUrl").val();
                    var h5URL = $("#H5Url").val();


                    if (showPlatform == "0" || showPlatform == "2") {
                        if (iosHandle != "" && iosSpecial != "" && image != "" && androidHandle != "" && androidSpecial != "" && h5URL != "") {
                            moduleContent = encodeURIComponent("<img data-type=&advertisement& data-action=&jump& src=&" + image + "& handle=&" + iosHandle + "& specialVal=&" + encodeURIComponent(iosSpecial) + "&/>");
                            platformConfig.push({ AppHandlekey: iosHandle, AppSpecialkey: iosSpecial, ShowPlatform: 3, BigImageUrl: image, SmallImageUrl: smallImg, ModuleContent: moduleContent, URL: "" });
                            moduleContent = encodeURIComponent("<img data-type=&advertisement& data-action=&jump& src=&" + image + "& handle=&" + androidHandle + "& specialVal=&" + encodeURIComponent(encodeURIComponent(androidSpecial)) + "&/>");
                            platformConfig.push({ AppHandlekey: androidHandle, AppSpecialkey: androidSpecial, ShowPlatform: 4, BigImageUrl: image, SmallImageUrl: smallImg, ModuleContent: moduleContent, URL: "" });
                            moduleContent = encodeURIComponent("<a data-type=&advertisement& href=&" + h5URL + "& target=&_blank&><img src=&" + image + "&></a>");
                            platformConfig.push({ AppHandlekey: "", AppSpecialkey: "", ShowPlatform: 5, BigImageUrl: image, SmallImageUrl: smallImg, ModuleContent: moduleContent, URL: h5URL });
                        } else {
                            tip = "<div class='tip'>请完善数据</div>";
                            if (flag)
                                flag = false;
                            $("#tab-AppConfig").before(tip);
                            return;
                        }
                    }

                    if (showPlatform == "0" || showPlatform == "1") {
                        if (pcURL != "") {
                            moduleContent = encodeURIComponent("<a data-type=&advertisement& href=&" + pcURL + "& target=&_blank&><img src=&" + image + "&></a>");
                            platformConfig.push({ AppHandlekey: "", AppSpecialkey: "", ShowPlatform: 1, BigImageUrl: image, SmallImageUrl: smallImg, ModuleContent: moduleContent, URL: pcURL });
                        } else {
                            tip = "<div class='tip'>请完善数据</div>";
                            if (flag)
                                flag = false;
                            $("#tab-AppConfig").before(tip);
                        }
                    }
                }

                var pidData = [];
                if (isSelectPid == 1) {
                    pidData = [];
                    addOrDel = $(".ordertype").find("input[name=ordertype]:checked").val();
                    $("input[name=PID]").each(function () {
                        if ($(this).val() == "") {
                            if (flag)
                                flag = false;
                            tip = "<div class='tip'>请完善PID</div>";
                            $(this).after(tip);
                        }
                        else if ($(this).parent().next().text() == "无此产品") {
                            if (flag)
                                flag = false;
                            tip = "<div class='tip'>请正确填写PID</div>";
                            $(this).after(tip);
                        }
                        else
                            pidData.push({ PID: $(this).val() });
                    });
                }

                var brandData = [];
                $(".per_categoryandbrand").each(function () {
                    var cate = $(this).find("input[name=Category]").val();
                    $(this).find("input[name=brand]").each(function () {
                        if ($(this)[0].checked)
                            brandData.push({ CategoryName: cate, Brand: $(this).val() });
                    });
                });

                if (categoryData.length <= 0 && isSelectPid == 0 && brandData.length <= 0) {
                    flag = false;
                    tip = "<div class='tip'>请至少选择一种(类别|PID|品牌)</div>";
                    $("#category  #tree1").before(tip);
                    $("#pid").before(tip);
                    $("#brand").before(tip);
                    $("html, body").animate({
                        scrollTop: "20px"
                    }, {
                        duration: 500,
                        easing: "swing"
                    });
                }

                if ($("#ueditor_title").val() != "") {
                    moduleContent = encodeURIComponent($("#ueditor_title").val());
                }
                var guanggao = '国家级、世界级、最高级、最佳、最大、第一、唯一、首个、最好、最大、精确、顶级、最高、最低、最具、最新技术、最先进科学、国家级产品、最便宜、最新、最先进、最大程度、最填补国内空白、绝对、独家、首家、最新、第一品牌、金牌、优秀、最先、顶级、独家、全网销量第一、全球首发、全国首发、世界领先、顶级工艺、最新科学、最新技术、最先进加工工艺、最时尚、极品、终极、顶尖、最受欢迎、王牌、第一、NO.1、top1、极致、永久、王牌、掌门人、领袖品牌、独一无二、绝无仅有、前无古人、史无前例、万能';
                var jinyongci = guanggao.split('、')
                if (UE.getEditor('editor').getContent() != "") {
                    var content=UE.getEditor('editor').getContent();
                    while (content.indexOf("application/x-shockwave-flash") >= 0) { content = content.replace('application/x-shockwave-flash', '');}
                    moduleContent = encodeURIComponent(content);
                    for (var item in jinyongci) {
                        if (UE.getEditor('editor').getContent().indexOf(jinyongci[item]) >= 0) {
                            flag = false;
                            alert("内容输入了广告违禁词：" + jinyongci[item]);
                            return false;
                        }
                    }
                    //todo
                }
                $(decodeURIComponent(moduleContent)).find("img").each(function () {
                    if (!(this.src.indexOf(".tuhu.cn") >= 0 || this.src.indexOf(".tuhu.org") >= 0)) {
                        flag = false;
                        alert("请引用来源是途虎的图片！");
                        return false;
                    }
                });

                if (flag) {
                    var productModel = new Object();
                    productModel.ModuleName = name;
                    productModel.ModuleOrder = order;
                    productModel.ShowPlatform = showPlatform;
                    productModel.AddOrDel = addOrDel;
                    productModel.IsAdvert = isClickAdvert;
                    productModel.StartDateTime = startDate;
                    productModel.EndDateTime = endDate;
                    productModel.ModuleContent = moduleContent;

                    var r = confirm("是否确定保存信息？");
                    if (r) {
                        $.ajax({
                            url: "/ProductModuleConfig/InsertOrUpdateProductConfig",
                            type: "post",
                            dataType: "json",
                            data: { "productModel": JSON.stringify(productModel), "platformConfig": JSON.stringify(platformConfig), "categoryData": JSON.stringify(categoryData), "pid": JSON.stringify(pidData), "brand": JSON.stringify(brandData), "parentID": "@Request.QueryString["id"]" },
                            success: function (result) {
                                if (result > 0) {
                                    alert("操作成功！");
                                    location.href = "/ProductModuleConfig/Index";
                                } else {
                                    alert("操作失败！")
                                }
                            }
                        });
                    }
                    else {
                        button.css("pointer-events", "all");
                    }
                }
                else {
                    button.css("pointer-events", "all");
                }
            });

        })
    </script>
}
