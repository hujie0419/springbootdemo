@{
    ViewBag.Title = "模块列表";
}
@model IEnumerable<Tuhu.Provisioning.DataAccess.Entity.SE_HomePageModuleConfig>


<style>
    .content .style {
        width: 800px;
        font-size: 14px;
        margin: 0 auto 10px;
        border: 1px solid #D1EEEE;
        cursor: pointer;
    }

        .content .style span {
            display: inline-block;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-right: 1px solid #D1EEEE;
        }

        .content .style .col1 {
            width: 42%;
        }

        .content .style .col2 {
            width: 18%;
        }

        .content .style .col3 {
            width: 18%;
        }

        .content .style .col4 {
            /*width: 18%;*/
            border-right: none;
        }
</style>
<div class="row ibox ibox-content">
    <div class="row" style="text-align: right;padding: 0 18%;">
        <input type="hidden" id="hiddenID" name="hiddenID" value="@(Model.Count() !=0? Model.FirstOrDefault().FKHomePage.ToString():ViewBag.FKHomePage)" />
        <a href="javascript:void(0)" class="btn btn-danger btn-sm" id="btnModuleCancel" name="btnModuleCancel" style="margin-right:20px;width:150px;display:none;">撤 销</a>
        <a href="javascript:void(0)" class="btn btn-primary btn-sm" id="btnModuleListSave" name="btnModuleListSave" style="width:150px;">保 存</a>
    </div>
    <div class="row">
        <div class="content">
            <div class="style titile" data-type="-1">
                <span class="col1">名称</span>
                <span class="col2">状态</span>
                <span class="col3">顺序</span>
                <span class="col4">管理</span>
            </div>
            @*@if (Model != null)
                {
                    foreach (var item in Model.Take(3))
                    {
                        <div class="style modules" data-mtype="@item.ModuleType" data-id="@item.ID">
                            <span class="col1">@item.ModuleName</span>
                            <span class="col2">@(item.IsEnabled == true ? "启用" : "禁用")</span>
                            <span class="col3">@item.PriorityLevel</span>
                            <span class="col4">&nbsp; </span>
                        </div>
                    }
                }*@


        </div>
    </div>
    <div class="row">
        <div id="moduleContainer" style="min-height:300px;">
            <div class="content" id="moduleList">
                @if (Model != null)
                {
                    foreach (var item in Model)
                    {
                        <div class="style modules" data-mtype="@item.ModuleType" data-id="@item.ID">
                            <span class="col1">@item.ModuleName</span>
                            <span class="col2">@(item.IsEnabled == true ? "启用" : "禁用")</span>
                            <span class="col3">@item.PriorityLevel</span>
                            <span class="col4" style="text-align:right;">
                                @if (item.IsChildModule)
                                {
                                    <a href="javascript:void(0)" class="btn btn-default btn-sm" data-id="@item.ID" name="btnSelectChild" style="width:90px;padding:0px;">查看子模块</a>
                                }
                                else
                                {
                                    <label>&nbsp;</label>
                                }
                                <a href="javascript:void(0)" class="btn btn-danger btn-sm" data-id="@item.ID" name="btnDelete" style="width:60px;padding:0px;">删 除</a>
                            </span>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>
<div id="edit" class="modal fade" aria-hidden="true" role="dialog" tabindex="-1">

</div>
@section scripts{
    <script type="text/javascript">
        $(function () {

            $('#moduleContainer').droppable({
                drop: function (event, ui) {
                  
                    var type = ui.helper.data("type");
                    if (type != undefined) {
                        var id = $('#hiddenID').val();
                        if (id) {
                            // alert(type +" "+id);
                            var dialog = $('#edit');
                            dialog.empty();
                            var url = "/PersonalCenterConfigV2/HomePageModuleEdit?FKHomePage=" + id + "&ModeulType=" + type + "&Module=0";
                            dialog.html(dialog.load(url));
                            dialog.modal("show");
                            // debugger;
                        }

                    }
                }
            });
            $("#moduleList").sortable();
            $("#moduleList").disableSelection();

            //编辑模块
            $('.modules').on('click', function () {
                console.log("编辑");
                var type = $(this).data("mtype");
                console.log(type);
                if (type != undefined) {
                    var id = $('#hiddenID').val();
                    if (id) {
                        // alert(type +" "+id);
                        var dialog = $('#edit');
                        dialog.empty();
                        var url = "/PersonalCenterConfigV2/HomePageModuleEdit?FKHomePage=" + id + "&ModeulType=" + type + "&Module=" + $(this).data("id");
                        dialog.html(dialog.load(url));
                        dialog.modal("show");
                        // debugger;
                    }
                }
            });

            //保存排序
            $('#btnModuleListSave').on('click', function () {

                var array = [];
                var number = 1;
                $('.modules').each(function (e) {
                    var id = $(this).data("id");
                    var mtype = $(this).data("mtype");
                    var module = {
                        ID: id,
                        PriorityLevel: number++
                    };
                    array.push(module);
                });
                console.log(JSON.stringify(array));
               
                $.ajax({
                    url: '/PersonalCenterConfigV2/UpdateHomePageModulePriorityLevel',
                    type: 'post',
                    data: { content: JSON.stringify(array) },
                    dataType: 'json'
                }).done(function (result) {
                    if (result == 1)
                        location.reload();
                    else
                        alert("排序保存失败");
                }).fail(function (result) {
                    console.log("保存失败");
                });

            });

            //取消排序
            $('#btnModuleCancel').on('click', function () {
                $("#moduleList").sortable("cancel");
            });


            $('a[name="btnSelectChild"]').on('click', function (e) {

                location.href = "/PersonalCenterConfigV2/HomePageModuleChildList?moduleID=" + $(this).data("id");
                return false;
            });

            $('a[name="btnDelete"]').on('click', function () {
                var id = $(this).data("id");
                if (confirm("您确实删除吗?"))
                    if (id) {
                        $.ajax({
                            url: '/PersonalCenterConfigV2/HomePageModuleDelete',
                            type: 'post',
                            data: { id: id }
                        }).done(function (result) {
                            if (result == 1) {
                                alert("删除成功");
                                setTimeout(function () {
                                    location.reload();
                                }, 500)
                            }
                        });
                    }
                return false;
            });
        });

        ///showImg：上传时Image显示的标签ID
        //showUrl:真正显示的
        function UploadBgImg(obj, showImg, showUrl) {

            var pobj = $(obj);
            var rd = Math.ceil(Math.random() * 9999) + 1;
            var fileElId = $(obj).attr("id");
            console.log(fileElId);
            $.ajaxFileUpload({
                url: '/Article/ImageUploadToAli?rd=' + rd,
                secureuri: false,
                fileElementId: fileElId,
                dataType: 'json',
                async: false,
                success: function (result) {
                    if (result.BImage != "" && result.SImage != "") {
                        $("#" + showImg).attr("src", result.SImage).show();
                        $("#" + showUrl).val(result.BImage);
                    } else {
                        alert("上传失败！");
                    }
                },
                error: function (data, status, e)//服务器响应失败处理函数
                {
                    alert(e);
                }
            });
        }

        //var startPoint = { X: null, Y: null };
        // var endPoint = { width: null, height: null };
        // var isdraw = true;
        //  var rects = new Array();//矩形图集合

        ///查看子模块





    </script>
}