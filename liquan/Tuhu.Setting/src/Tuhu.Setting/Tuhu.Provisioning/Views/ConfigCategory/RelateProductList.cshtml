@using Tuhu.Provisioning.Models
@using Tuhu.Provisioning.Controllers
@model List<Tuhu.Provisioning.DataAccess.Entity.RelateProductModel>

@{
    var title = "关联商品配置";

    ViewBag.Title = title;
}
@section head{

    <link href="~/Scripts/jQuery-EasyUI/themes/default/easyui.css" type="text/css" rel="stylesheet" />
    <link href="~/Scripts/jQuery-EasyUI/themes/icon.css" type="text/css" rel="stylesheet" />
    <style type="text/css">
        input[type=file] {
            width: 65px;
        }
    </style>

}
@section scripts{
    <script type="text/javascript" src="~/Scripts/My97DatePicker/WdatePicker.js"></script>
}
<link href="~/Scripts/zTree/css/zTreeStyle/zTreeStyle.css" type="text/css" rel="stylesheet" />
<script type="text/javascript" src="~/Scripts/jQuery-EasyUI/jquery.easyui.min.js"></script>
<script type="text/javascript" src="~/Scripts/jQuery-EasyUI/locale/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="~/Scripts/layer/layer.js"></script>

<script src="~/Content/ProductVehicleType/js/angular.min.js"></script>
<script src="~/Content/ProductVehicleType/js/tm.pagination.js"></script>
<script src="~/Content/ProductVehicleType/js/underscore.js"></script>
<link href="~/Content/ProductVehicleType/css/detail.css" type="text/css" rel="stylesheet" />
<link href="~/Content/ProductVehicleType/css/bootstrap.v3.css" type="text/css" rel="stylesheet" />
<link href="~/Content/ProductVehicleType/css/showLoading.css" type="text/css" rel="stylesheet" />

<style>
    .button1 {
        border-radius: 5px;
        padding: 5px 25px;
        border: none;
        color: #F0F0F0;
        font-size: 12px;
        font-family: "Microsoft Yahei";
        outline: none;
        cursor: pointer;
        background: #0088cc;
        border-color: #0088cc;
    }

    table th {
        color: white;
        padding: 6px 5px;
        text-align: left;
        background-color: #0088cc;
        border: solid 1px #0088cc;
    }
</style>

<link rel="stylesheet" href="/Scripts/artDialog6.0.4/css/ui-dialog.css" />
<script src="~/Scripts/artDialog6.0.4/dist/dialog-min.js"></script>
<script src="~/Scripts/artDialog6.0.4/dist/dialog-plus-min.js"></script>

<script src="~/Content/ProductVehicleType/js/jquery.showLoading.min.js" type="text/javascript"></script>
<h2 style="">关联商品配置</h2>
<table>
    <tr>
        <td>搜索商品</td>
        <td>@Html.DropDownList("ddlProductTypeData", ViewData["ddlProductTypeData"] as SelectList, new {@id = "ddlProductTypeData"}) </td>
        <td class="pro" style="display: none"> <input class="" id="ProductInfo" type="text" value=""/></td>
        <div id="categorytree">
            <ul id="tree1" class="ztree"></ul>
        </div>
        <td>
            <button onclick="Func.LoadList()" class="button1" style="margin-bottom: 20px; float: right;">搜索</button>
        </td>
        <td><a class="button1" href="javascript:;" style="margin-bottom: 20px; float: right;" id="searchSelected">查看所有关联商品</a></td>
        <td><a class="button1" href="javascript:;" style="margin-bottom: 20px; float: right; margin: 0 6px;" onclick="LookOplog();">查看日志</a></td>
    </tr>
</table>

@*<table  id="dg" class="easyui-datagrid" title="商品列表" style="width: 100%; height: 500px;display:none"
       data-options="singleSelect:false,rownumbers:true,idField:'PID',pagination:true">
    <thead>
    <tr>
        <th data-options="field:'checked'" width="10%">选择</th>
        <th data-options="field:'ProductName',resizable:false" width="30%">商品名称</th>
        <th data-options="field:'PID',align:'left',resizable:false" width="30%">商品PID</th>
        <th data-options="field:'ProductType',align:'left',resizable:false" width="30%">商品类别</th>
    </tr>
    </thead>
    <tbody>
    @if (Model != null)
    {
        foreach (var item in Model)
        {
            <tr>
                <td><input id="@item.PID" type="checkbox" name="checkbox" value="@item.PID"/></td>
                <td>@(item.ProductName)</td>
                <td>@item.PID</td>
                <td>@item.ProductType</td>
            </tr>
        }

    }
    </tbody>
</table>*@

<div class="content">
    
    <div>
        每页显示：
        <select class="PageSize">
            @*<option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>*@
            <option value="100">100</option>
        </select>条
        <span class="data_count"></span>
    </div>
    <img class="loadimg" src="~/Scripts/layer/skin/default/loading-2.gif" style="margin:5% 50%;display:none;" />
    <div class="list">

    </div>
   
</div>

<div id="LookOplog"></div>

<div>
    <a class="button1" href="javascript:;" style="margin-bottom: 20px; float: left;" onclick="selectAllProduct();">全部勾选</a>
    <a class="button1" href="javascript:;" style="margin-bottom: 20px; float: left; margin: 0 6px;" onclick="clearAllSelectedProduct();">全部取消勾选</a>
    <a class="button1" href="javascript:;" style="margin-bottom: 20px; float: left; margin: 0 6px;" onclick="searchCurrentProduct();">全部勾选当前页</a>
    <a class="button1" href="javascript:;" style="margin-bottom: 20px; float: left; margin: 0 6px;" onclick="clearCurrentSelectedProduct();">全部取消勾选当前页</a>
</div>
<br />
<div style="clear:both;">
    <a class="button1" href="javascript:void(0);" style="margin-bottom: 20px; float: left; margin: 0 6px;" onclick="Func.ShowEditManyPidsDialog()">保存</a>
</div>
<div id="EditItemDIV"></div>
<input type="hidden" id="hidObjectType" value="SelectedRelateProduct" />
<script src="~/Scripts/jquery.ztree.all-3.5.min.js"></script>
<script src="~/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.min.js"></script>
<script>

    $(function() {

        //获得产品的类别
        var treeObj = null;

        $.ajax({
            url: "/ConfigCategory/GetCategory",
            type: "get",
            dataType: "json",
            data: { type: "category" },
            success: function (data) {
                if (data != null) {
                    var setting = {
                        check: {
                            enable: true,
                            nocheckInherit: true,
                            chkStyle: "checkbox",
                            chkboxType: { "Y": "s", "N": "ps" }
                        },
                        callback: {
                        }
                    };
                    treeObj = $.fn.zTree.init($("#tree1"), setting, data);
                    var nodes = treeObj.getNodes();
                }
            }
        });
        $('select#ddlProductTypeData').change(function() {
            var adType = $(this).val();
            if (adType == "1") {
                $(".pro").show();
                $("#categorytree").hide();
            } else if (adType == "2") {
                $(".pro").show();
                $("#categorytree").hide();
            } else if (adType == "3") {
                $(".pro").hide();
                $("#categorytree").show();
            } else {
                $(".pro").hide();
                $("#productCategory").hide();
            }
        }
        );

        $("#searchSelected").click(function() {
            var categoryid = @ViewData["productcategoryid"];

            var href = "/ConfigCategory/SelectedRelateProductList?categoryId=" + categoryid;
            window.location.href = href;
        });
    });

    $(function() {

        var adType = $('select#ddlProductTypeData').val();
        if (adType == "1") {
            $(".pro").show();
            $("#categorytree").hide();
        } else if (adType == "2") {
            $(".pro").show();
            $("#categorytree").hide();
        } else if (adType == "3") {
            $(".pro").hide();
            $("#categorytree").show();
        } else {
            $(".pro").hide();
            $("#categorytree").hide();
        }
    });

    function selectAllProduct() {

        $("input[name='Selected']").attr("checked", 'true');

    }

    function clearAllSelectedProduct() {
        $("input[name='Selected']").removeAttr("checked");
    }

    function searchCurrentProduct() {
        $("input[name='Selected']").each(function() {
            if($(this).parents("tr").is(":hidden"))
            {}
            else
            {$(this).attr("checked", 'true')}
        });
    }

    function clearCurrentSelectedProduct() {
        $("input[name='Selected']").each(function() {
            if ($(this).parents("tr").is(":visible")) {
                $(this).removeAttr("checked");
            }
        });
    }

    function saveAllSelectedProduct() {
        var categoryid = @ViewData["productcategoryid"];
        var pids = "";
        $("input[name='checkbox']:checked").each(function() {
            pids = pids + this.value + ";";
        });
        $.ajax({
            type: "POST",
            url: "/ConfigCategory/AddRelateProductList",
            data: {
                "pids": pids,
                "categoryId": categoryid
            },
            success: function(result) {
                if (result) {
                    //window.location.reload(true);
                    alert("保存成功！");
                } else {
                    alert("保存失败！");

                }
            }
        });
    }

    function GetQueryString(name) {
        ///<summary>获取页面参数</summary>
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
    }

    function LookOplog() {
        $("#LookOplog").html("").load('/Logger/list?objectType=SelectedRelateProduct');
        $("#LookOplog").dialog({
            title: "查看日志",
            width: 850,
            height: 450,
            modal: true,
            resizable: false,
            buttons: {
                "取消": function() {
                    $(this).dialog("close");
                }
            }
        });
    }

    var Func = {

        LoadList: function () {
            //是否显示 1 全部 2 已配置  3未配置

            var categoryid = @ViewData["productcategoryid"];
            var productType = $('select#ddlProductTypeData').val();
            var productPID = $("#ProductInfo").val();
            var productNameKey = $("#ProductInfo").val();
            var categoryId = categoryid;
           
            var oids = "";
            var adType = $('select#ddlProductTypeData').val();
            if (adType == "0") {
                alert("请选择查询方式");
                return;
            } else if (adType === "1" && ($("#ProductInfo").val() == null || $("#ProductInfo").val() === "")) {
                alert("请输入商品PID");
                return;
            } else if (adType === "2" && ($("#ProductInfo").val() == null || $("#ProductInfo").val() === "")) {
                alert("请输入商品名称关键词");
                return;
            } else if (adType === "3") {
                var treeObj = $.fn.zTree.getZTreeObj("tree1");
                var data = [];
                var allNodes = treeObj.getNodes();
                $.each(allNodes, function (i, v) {
                    // alert(v.checked);alert(v.id);
                    //alert(v.check_Child_State);
                    if (v.check_Child_State == 2) {
                        
                            $.each(v.children, function(i, v) {
                                oids = oids + v.title + ",";
                                data.push({
                                    Category: v.title,
                                    id:v.id
                                });
                            });
                        
                    } else if (v.check_Child_State == 1) {
                        $.each(v.children, function(i, v) {
                            if (v.checked) {
                                oids = oids + v.title + ",";
                                data.push({
                                    Category: v.title,
                                    id:v.id
                                });
                            }
                        });
                    }
            
                });
               
                if (data.length <= 0)
                {
                    alert("请选择商品类目");
                    return;
                }

            }
            $(".loadimg").show();
            $.post("/ConfigCategory/List", {
                productType: productType,
                productPID: productPID,
                productNameKey: productNameKey,
                categoryId: categoryId,
                pageSize: $(".PageSize option:selected").val(),
                productOids:oids
            }, function (html, status) {
                if (status === "success") {
                    $(".loadimg").hide();
                    $(".list").html(html);
                }
            });
        },
        ShowEditManyPidsDialog: function () {
            
            var pids = "";
            var $targets = $("[name=Selected]:checked");
           
            if (!$targets.length) {
                alert("当前未选中,无法批量处理");
                return false;
            }
            $("input[name='Selected']:checked").each(function() {
                pids = pids + this.value + ";";
            });
          
            var categoryid = @ViewData["productcategoryid"];
          
            $.ajax({
                type: "POST",
                url: "/ConfigCategory/AddRelateProductList",
                data: {
                    "pids": pids,
                    "categoryId": categoryid
                },
                success: function(result) {
                    if (result) {
                        //window.location.reload(true);
                        alert("保存成功！");
                    } else {
                        alert("保存失败！");

                    }
                }
            });
        },
    }
</script>


