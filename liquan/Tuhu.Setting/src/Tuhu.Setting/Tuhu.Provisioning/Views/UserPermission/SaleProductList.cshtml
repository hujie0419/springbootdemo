@{
    ViewBag.Title = "会员商品商城配置";
    Layout = "~/Views/Shared/_PersonalCenterLeft.cshtml";
}
@model System.Collections.Generic.IEnumerable<Tuhu.Provisioning.DataAccess.Entity.UserPermissionActivityProduct>

<h2>会员商品商城配置</h2>
<style type="text/css">
    .sale {
        width: 100%;
        text-align: center;
    }

    .toolar {
        margin-bottom: 5px;
    }

    input {
        /*width: 60px;
        margin-left: 5px;*/
    }
</style>

<script type="text/javascript" src="~/Scripts/layer/layer.js"></script>
<script src="~/Scripts/jquery.validate-1.8.1.min.js" type="text/javascript"></script>

<div class="toolar">
    用户等级:
    <select name="Rank" id="Rank" style="width:120px;">
        <option value="ac9a66e8-6fdf-4a96-a157-c5e166297d52">LV0</option>
        <option value="8312FE9D-6DCE-4CD5-87D5-99CE064336A3">LV1</option>
        <option value="650C6D05-51F8-46FB-A84F-F136D727A59B">LV2</option>
        <option value="663543D4-5B62-4133-935D-F0A4C68751F8">LV3</option>
        <option value="88C467DB-622E-4F02-89A5-F80405076599">LV4</option>
    </select>
    <input type="button" value="添加" class="btn" name="add" />
    <input type="button" value="编辑" class="btn" name="edit" />
    <input type="button" value="删除" class="btn" name="delete" />
</div>

<table class="sale">
    <thead>
        <tr>
            <th>选择</th>
            <th>等级</th>
            <th>PID</th>
            <th>名称</th>
            <th>原价</th>
            <th>伪原价</th>
            <th>促销价</th>
            <th>
                库存
            </th>
            <th>剩余</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
            {
            <tr>
                <td> <input type="checkbox" value="@item.PKID" /> </td>
                @if (item.ActivityID.ToString().ToLower() == "ac9a66e8-6fdf-4a96-a157-c5e166297d52")
                {
                    <td>LV0</td>
                }
                else if (item.ActivityID.ToString().ToUpper() == "8312FE9D-6DCE-4CD5-87D5-99CE064336A3")
                {
                    <td>LV1</td>
                }
                else if (item.ActivityID.ToString().ToUpper() == "650C6D05-51F8-46FB-A84F-F136D727A59B")
                {
                    <td>LV2</td>
                }
                else if (item.ActivityID.ToString().ToUpper() == "663543D4-5B62-4133-935D-F0A4C68751F8")
                {
                    <td>LV3</td>
                }
                else if (item.ActivityID.ToString().ToUpper() == "88C467DB-622E-4F02-89A5-F80405076599")
                {
                    <td>LV4</td>
                }


                <td>@item.PID</td>
                <td>@item.DisplayName</td>
                <td>@( Convert.ToDouble(item.cy_list_price).ToString("0.00"))</td>
                <td>@(Convert.ToDouble(item.FalseOriginalPrice).ToString("0.00"))</td>
                <td>@(Convert.ToDouble(item.Price).ToString("0.00"))</td>
                <td>@item.TotalQuantity</td>
                <td>@(item.TotalQuantity - @item.SaleOutQuantity)</td>
            </tr>
        }
    </tbody>
</table>
<div id="edit"></div>
<script type="text/javascript">
    $('input[type=checkbox]').click(function () {
        if ($(this).attr("checked") == undefined) {
            $(this).attr("checked", "checked");
            console.log("没有选中");
        } else {
            $(this).removeAttr("checked");
            console.log("选中");
        }

        return true;
    });


    $('table tbody tr').click(function () {
        $('table tbody tr').each(function (i) {
            $(this).find('input[type=checkbox]').removeAttr('checked')
        });

        if ($(this).find('input[type=checkbox]').attr("checked") == undefined) {
            $(this).find('input[type=checkbox]').attr("checked", "checked");

        } else {
            $(this).find('input[type=checkbox]').removeAttr("checked");

        }

    });


    var SaleTable = {
        getCheckRow: function () {
            var row = undefined;
            $('table tbody tr').each(function (i) {

                if ($(this).find('input[type=checkbox]').attr('checked') != undefined) {
                    //  console.log($(this).find('input[type=checkbox]').val());
                    row = $(this).find('input[type=checkbox]').val();
                }
            });
            return row;
        }
    };


    $('input[name=add]').click(function () {
        // console.log(  SaleTable.getCheckRow());
        $("#edit").html("").load('/UserPermission/SaleProductEdit');
        $('#edit').dialog({
            title: '编辑',
            width: 417,
            height: 300,
            modal: true,
            resizable: false,
            buttons: {
                "保存": function () {
                    var result = $('#form1').valid();
                    if (result) {
                        var data = GetForm();
                        $.ajax({
                            type: 'post',
                            url: '/UserPermission/AddActivityProduct',
                            data: data,
                            dataType: 'json',
                            success: function (result) {
                                console.log(result);

                                if (result.status == 1) {
                                    $('#edit').dialog("close");
                                    alert("保存成功!");
                                    location.reload();


                                } else {
                                    alert("保存失败！");
                                }

                            },
                            error: function () {
                                alert("失败");
                            }
                        });
                    }
                },
                "取 消": function () {
                    $(this).dialog("close");
                }
            }
        });


    });


    $('input[name=edit]').click(function () {

        // console.log(  SaleTable.getCheckRow());
        if (SaleTable.getCheckRow() == undefined || SaleTable.getCheckRow() == "") {
            alert("请选择编辑的行");
            return;
        }
        $("#edit").html("").load('/UserPermission/SaleProductEdit?id=' + SaleTable.getCheckRow());
        $('#edit').dialog({
            title: '编辑',
            width: 417,
            height: 300,
            modal: true,
            resizable: false,

            buttons: {
                "保存": function () {
                    var result = $('#form1').valid();
                    if (result) {
                        var data = GetForm();
                        $.ajax({
                            type: 'post',
                            url: '/UserPermission/AddActivityProduct',
                            data: data,
                            dataType: 'json',
                            success: function (result) {

                                if (result.status == 1) {
                                    $('#edit').dialog("close");
                                    alert("保存成功!");
                                    location.reload();

                                } else {
                                    alert("保存失败！");
                                }

                            },
                            error: function () {
                                alert("失败");
                            }
                        });
                    }

                },
                "取 消": function () {
                    $(this).dialog("close");
                }
            }
        });
    });


    $(function () {
        $('table tbody tr').each(function (i) {
            $(this).find('input[type=checkbox]').removeAttr('checked')
        });  //不选中任何行

        var sel = location.search.split('=')[1];
        if (sel != undefined) {
            $('#Rank').val(sel);
        }

    });

    $('#Rank').change(function () {
        location.href = "/UserPermission/SaleProductList?activityID=" + $(this).val();
    });

    $('input[name=delete]').click(function () {
        if (SaleTable.getCheckRow() == undefined || SaleTable.getCheckRow() == "") {
            alert("请选择编辑的行");
            return;
        }
        var is = confirm("您确定删除吗?");
        if (is) {
            $.ajax({
                url: '/UserPermission/DeleteActivityProduct',
                type: 'post',
                data: { activityID: $('#Rank').val(), pkid: SaleTable.getCheckRow() },
                dataType: 'json',
                success: function (result) {
                    if (result.status == 1) {
                        location.reload();
                    } else {
                        alert('删除失败');
                    }
                }
            });
        }
    });


</script>
