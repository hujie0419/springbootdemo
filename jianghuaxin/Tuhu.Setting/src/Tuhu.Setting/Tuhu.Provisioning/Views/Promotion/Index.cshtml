@using Tuhu.Provisioning;
@using Tuhu.Provisioning.DataAccess.Entity;
@{
    ViewBag.Title = "优惠券类型配置";
    PromotionFilterConditionModel Condition = new PromotionFilterConditionModel();
    if (ViewBag.Condition is PromotionFilterConditionModel)
    {
        Condition = ViewBag.Condition as PromotionFilterConditionModel;
    }
}
@model Tuhu.Component.Common.Models.ListModel<Tuhu.Provisioning.DataAccess.Entity.PromotionModel>
@section head{
    <style>
        table {
            width: 100%;
            text-align: center;
        }

            table tr:hover {
                background: #DEDEDE;
            }

            table tr th {
                text-align: center;
            }

        .addPromotion {
            margin-left: 200px;
            color: #08c;
        }

        #Edit {
        }

        .UpdateParent {
            width: 50px;
            height: 25px;
            text-align: center;
            line-height: 25px;
            margin-top: 20px;
            background: rgb(135, 182, 217);
            cursor: pointer;
        }

        .tip {
            color: red;
            font-size: 12px;
            clear: left;
            margin-bottom: 10px;
        }

        .select div {
            margin-bottom: 10px;
        }
    </style>
}
<script src="https://file-tuhu-cn.alikunlun.com/yewu/oms/scripts/md503.js" type="text/javascript"></script>
<script src="https://file-tuhu-cn.alikunlun.com/yewu/oms/scripts/verifyBtn.js" type="text/javascript"></script>
<h2>&nbsp;</h2>
<h2>优惠券使用规则配置 | <a href="/Promotion/EditPromotionNew" btnkey="AddPromotion" istuhuverify="1">添加优惠券使用规则</a>| <a href="/Promotion/CouponDepartmentUseSetting" btnkey="AddPromotion" istuhuverify="1">优惠券使用部门及用途配置</a>| <a href="/Promotion/BusinessLineSetting" btnkey="AddPromotion" istuhuverify="1">业务线配置</a></h2>
<form method="post" class="select">
    <h3>优惠券使用规则：</h3>
    <div>
        优惠券RuleID：<input type="text" name="RuleID" value="@Condition.RuleID" />
    </div>
    <div>
        优惠券名称：<input type="text" name="Remark" value="@Condition.Remark" />
    </div>
    <div>
        订单类型：
        <select class="ordertype" onchange="$('[name=OrderType]').val($(this).val())">
            <option value="" @(Condition.OrderType == null ? "selected" : null)>请选择</option>
            <option value="0" @(Condition.OrderType != null && Condition.OrderType.Value == 0 ? "selected" : null)>所有订单</option>
            <option value="1" @(Condition.OrderType != null && Condition.OrderType.Value == 1 ? "selected" : null)>仅到家</option>
            <option value="2" @(Condition.OrderType != null && Condition.OrderType.Value == 2 ? "selected" : null)>仅到店</option>
        </select>
    </div>
    <div>
        优惠券类型：
        <select class="promotiontype" onchange="$('[name=PromotionType]').val($(this).val())">
            <option value="" @(Condition.PromotionType == null? "selected" : null)>请选择</option>
            <option value="0" @(Condition.PromotionType != null && Condition.PromotionType.Value == 0 ? "selected" : null)>满减券</option>
            <option value="1" @(Condition.PromotionType != null && Condition.PromotionType.Value == 1 ? "selected" : null)>后返券</option>
            <option value="2" @(Condition.PromotionType != null && Condition.PromotionType.Value == 2 ? "selected" : null)>实付券</option>
        </select>
    </div>
    <h3>优惠券领取规则：</h3>
    <div>
        编号(数字)：<input type="text" name="GetRuleID" value="@Condition.GetRuleID" />
    </div>
    <div>
        编号(GUID)：<input type="text" name="GetRuleGUID" value="@Condition.GetRuleGUID" />
    </div>
    <div>
        名称：<input type="text" name="PromotionName" value="@Condition.PromotionName" />
    </div>
    <div>
        说明：<input type="text" name="Description" value="@Condition.Description" />
    </div>
    <div>
        面额：<input type="text" name="Discount_Min" value="@Condition.Discount_Min" />-<input type="text" name="Discount_Max" value="@Condition.Discount_Max" />
    </div>
    <div>
        使用条件：<input type="text" name="Minmoney_Min" value="@Condition.Minmoney_Min" />-<input type="text" name="Minmoney_Max" value="@Condition.Minmoney_Max" />
    </div>
    <div>
        电销是否可发放：<select class="allowchanel" onchange="$('[name=AllowChanel]').val($(this).val())">
            <option value="" @(Condition.AllowChanel == null ? "selected" : null)>请选择</option>
            <option value="1" @(Condition.AllowChanel != null && Condition.AllowChanel.Value == 1 ? "selected" : null)>是</option>
            <option value="0" @(Condition.AllowChanel != null && Condition.AllowChanel.Value == 0 ? "selected" : null)>否</option>
        </select>
    </div>
    <div>
        支持用户范围：<select class="userrange" onchange="$('[name=SupportUserRange]').val($(this).val())">
            <option value="" @(Condition.SupportUserRange == null ? "selected" : null)>请选择</option>
            <option value="0" @(Condition.SupportUserRange != null && Condition.SupportUserRange.Value == 0 ? "selected" : null)>全部</option>
            <option value="1" @(Condition.SupportUserRange != null && Condition.SupportUserRange.Value == 1 ? "selected" : null)>新用户</option>
            <option value="2" @(Condition.SupportUserRange != null && Condition.SupportUserRange.Value == 2 ? "selected" : null)>老用户</option>
        </select>
    </div>
    <input type="hidden" name="OrderType" value="@Condition.OrderType" />
    <input type="hidden" name="PromotionType" value="@Condition.PromotionType" />
    <input type="hidden" name="AllowChanel" value="@Condition.AllowChanel" />
    <input type="hidden" name="SupportUserRange" value="@Condition.SupportUserRange" />
    <input type="submit" name="button" value="搜索" />
</form>

<br />
@if (Model != null)
{
    <h2 style="">优惠券使用规则<button onclick="RefreshCache()">刷新缓存</button></h2>
    @Html.Pager(new Tuhu.Component.Common.Models.PagerModel()
    {
        PageSize = Model.Pager.PageSize,
        CurrentPage = Model.Pager.CurrentPage,
        TotalItem = Model.Pager.TotalItem
    }, true, id => Url.Action("Index", new
    {
        Condition.AllowChanel,
        Condition.DepartmentId,
        Condition.Description,
        Condition.Discount_Max,
        Condition.Discount_Min,
        Condition.GetRuleGUID,
        Condition.GetRuleID,
        Condition.IntentionId,
        Condition.Minmoney_Max,
        Condition.Minmoney_Min,
        Condition.OrderType,
        Condition.PromotionName,
        Condition.PromotionType,
        Condition.Remark,
        Condition.RuleID,
        Condition.SupportUserRange,
        PageIndex = id,
        Condition.PageSize
    }))
    <br />
    <table>
        <tr>
            <th width="18%">优惠券名称</th>
            <th width="6%">优惠券编号</th>
            <th width="6%">Type</th>
            <th width="5%">订单类型</th>
            <th width="5%">支付方式</th>
            <th width="5%">优惠券类型</th>
            <th width="15%">创建时间</th>
            <th width="15%">最后更新时间</th>
            <th width="10%">操作历史</th>
            <th width="10%">操作</th>
            <th width="10%">查看/添加<br /><b style="color:red;">领取规则</b></th>
        </tr>
        @foreach (var p in Model)
        {
            <tr>
                <td>@p.Name</td>
                <td>@p.PKID</td>
                <td>@(p.Type.GetValueOrDefault() == 0 ? "" : "" + p.Type)</td>
                <td>@(p.InstallType == 0 ? "所有" : (p.InstallType == 1 ? "仅到家" : "仅到店"))</td>
                <td>@(p.OrderPayMethod.ToString())</td>
                <td>@(p.PromotionType == 0 ? "满减券" : (p.PromotionType == 1 ? "后返券" : "实付券"))</td>
                <td>@p.CreateDateTime</td>
                <td>@p.LastDateTime</td>
                <td><a href="#" onclick="HistoryRecord('@(p.PKID)','SaveCouponRuleInfo')">查看历史</a></td>
                <td>
                    <a href="/Promotion/PromotionDetailNew?id=@p.PKID">查看</a>|
                    <a href="/Promotion/EditPromotionNew?id=@p.PKID" btnkey="EditPromotion" istuhuverify="1">编辑</a>|
                    <a href="/Promotion/EditPromotionNew?id=@p.PKID&IsCreate=1" btnkey="EditPromotion" istuhuverify="1">复制</a>
                    @*<a href="#" onclick="DeletePromotion('allChild',@p.PKID)">删除</a>*@
                </td>
                <td>
                    <a href="/Promotion/GetCouponRule?id=@p.PKID&condition=@(Newtonsoft.Json.JsonConvert.SerializeObject(new {
                                                                           Condition.AllowChanel,
                                                                           Condition.DepartmentId,
                                                                           Condition.Description,
                                                                           Condition.Discount_Max,
                                                                           Condition.Discount_Min,
                                                                           Condition.GetRuleGUID,
                                                                           Condition.GetRuleID,
                                                                           Condition.IntentionId,
                                                                           Condition.Minmoney_Max,
                                                                           Condition.Minmoney_Min,
                                                                           Condition.OrderType,
                                                                           Condition.PromotionName,
                                                                           Condition.PromotionType,
                                                                           Condition.Remark,
                                                                           Condition.RuleID,
                                                                           Condition.SupportUserRange,
                                                                           PageIndex = 1,
                                                                           Condition.PageSize}))">查看/添加<br />领取规则</a>
                </td>
            </tr> }
    </table>
    @Html.Pager(new Tuhu.Component.Common.Models.PagerModel()
    {
        PageSize = Model.Pager.PageSize,
        CurrentPage = Model.Pager.CurrentPage,
        TotalItem = Model.Pager.TotalItem
    }, true, id => Url.Action("Index", new
    {
        Condition.AllowChanel,
        Condition.DepartmentId,
        Condition.Description,
        Condition.Discount_Max,
        Condition.Discount_Min,
        Condition.GetRuleGUID,
        Condition.GetRuleID,
        Condition.IntentionId,
        Condition.Minmoney_Max,
        Condition.Minmoney_Min,
        Condition.OrderType,
        Condition.PromotionName,
        Condition.PromotionType,
        Condition.Remark,
        Condition.RuleID,
        Condition.SupportUserRange,
        PageIndex = id,
        Condition.PageSize
    }))

    <div id="Edit" style="display:none;margin:0 auto;">
        <table>
            <tr>
                <td>优惠券名称</td>
                <td><input type="text" name="Name" /> </td>
            </tr>
            <tr>
                <td>是否启用</td>
                <td>
                    <label><input type="radio" name="IsActive" value="1" checked="checked" />启用</label>
                    <label><input type="radio" name="IsActive" value="0" />不启用</label>
                </td>
            </tr>
        </table>
        <div class="UpdateParent">保存</div>
    </div>

    <div id="HistoryDisplay">
    </div>
}
<script src="~/Scripts/Promotion/FormatJson.js?v=20180223"></script>
@section scripts{
    <script>
        function Edit(id, name) {
            var content = $("#Edit").dialog({
                title: "操作历史",
                width: 600,
                height: 300,
                modal: true,
                buttons: {
                    "关闭": function () {
                        $(this).dialog("close"); //当点击取消按钮时，关闭窗口
                    }
                }
            });
            $(content).find("input[name=Name]").val(name);
            $(content).find(".UpdateParent").click(function () {
                var name = $(this).siblings("table").find("input[name=Name]").val();
                var isactive = $(this).siblings("table").find("input[name=IsActive]:checked").val();
                if (name.trim() == "") {
                    alert("请输入更改后的优惠券名称！");
                    return;
                }
                data = { Name: name, IsActive: isactive, PKID: id };
                $.post("/Promotion/UpdateParent", { model: JSON.stringify(data) }, function (result) {
                    if (result > 0) {
                        alert("更改成功！");
                        window.location.reload();
                    }
                });
            });
        }

        function HistoryRecord(activeID, type) {
            $("#HistoryDisplay").load('/Promotion/HistoryActions?objectId=' + activeID + '&objectType=' + type);
            $("#HistoryDisplay").dialog({
                title: "操作历史",
                width: 600,
                height: 680,
                modal: true,
                buttons: {
                    "关闭": function () {
                        $(this).dialog("close"); //当点击取消按钮时，关闭窗口
                    }
                }
            });
        }
        function RefreshCache() {
            $.post("/Promotion/RefreshCache", function (result) {
                if (result == 1)
                    alert("刷新成功");
                else if (result == -1)
                    alert("刷新失败");
            });
        }

        //function DeletePromotion(t,pkid)
        //{
        //	var r = confirm("是否确定保删除信息？");
        //	if (r)
        //	{
        //		var data = { type: t, PKID: pkid };
        //		$.post("/Promotion/DeleteRecord", data, function (result)
        //		{
        //			if (result > 0)
        //			{
        //				alert("删除成功！");
        //				window.location.reload();
        //			}
        //		});
        //	}
        //}
    </script>
}


