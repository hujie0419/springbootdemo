@model  Tuhu.Provisioning.DataAccess.Entity.AdvertCategoryModel


@{
    var title = "增加编辑广告";

    ViewBag.Title = title;
}
<style>
    .ui-dialog {
        border-radius: 3px;
        padding: 0px;
        width: auto;
    }

    .ui-dialog-grid {
        width: 100%;
    }

    .ui-dialog-title {
        width: 75%;
        padding: 8px 15px 8px 15px;
    }

    .ui-dialog-close {
        top: 8px;
    }

    .ui-dialog-body {
        padding: 10px;
    }

    .ui-dialog-content {
        padding: 0px;
    }

    .ui-dialog-footer {
        padding: 5px 10px 5px 5px;
        background: #ffffff;
        border-top: 1px solid #eee;
    }

        .ui-dialog-footer button {
            padding: 3px 15px;
            border-radius: 2px;
            box-shadow: 0 1px 1px rgba(0,0,0,.15);
            font-size: 12px;
        }

            .ui-dialog-footer button.ui-dialog-autofocus {
                font-weight: 700;
                text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            }

    .expanded_table_icon {
        background: url(/Scripts/TableTree/images/tree.gif) no-repeat 0px -4px;
        width: 9px;
        cursor: pointer;
        padding-top: 0px;
        margin: 0px;
        padding-left: 13px;
        zoom: 1;
    }

    .collapsed_table_icon {
        background: url(/Scripts/TableTree/images/tree.gif) no-repeat 0px -24px;
        width: 9px;
        cursor: pointer;
        padding-top: 0px;
        margin: 0px;
        padding-left: 13px;
        zoom: 1;
    }


    .button1 {
        border-radius: 5px;
        padding: 5px 25px;
        border: none;
        color: #F0F0F0;
        font-size: 12px;
        font-family: "Microsoft Yahei";
        outline: none;
        cursor: pointer;
        background: #0088cc;
        border-color: #0088cc;
    }

    table th {
        color: white;
        padding: 6px 5px;
        text-align: left;
        background-color: #0088cc;
        border: solid 1px #0088cc;
    }

    .Price {
        background: url(/Images/rmb.png) no-repeat left center;
        vertical-align: middle;
        height: 12px;
        padding-top: -2px;
        padding-left: 10px;
        border: none;
    }
</style>
<link href="~/Content/filtrateSelect.css" rel="stylesheet" />
<script src="../../Scripts/ajaxfileupload.js" type="text/javascript"></script>
<link rel="stylesheet" href="/Scripts/artDialog6.0.4/css/ui-dialog.css" />
<script src="~/Scripts/artDialog6.0.4/dist/dialog-min.js"></script>
<script src="~/Scripts/artDialog6.0.4/dist/dialog-plus-min.js"></script>

<link href="~/Scripts/jQuery-EasyUI/themes/default/easyui.css" type="text/css" rel="stylesheet" />
<link href="~/Scripts/jQuery-EasyUI/themes/icon.css" type="text/css" rel="stylesheet" />
<script type="text/javascript" src="~/Scripts/jQuery-EasyUI/jquery.easyui.min.js"></script>
<script type="text/javascript" src="~/Scripts/jQuery-EasyUI/locale/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="~/Scripts/layer/layer.js"></script>
<script src="~/Scripts/jquery.filtrateSelect.js"></script>

<link href="~/Content/filtrateSelect.css" rel="stylesheet" />
<script src="~/Scripts/jquery.filtrateSelect.js"></script>
<table style="width:100%">
    <tbody>
    <tr>
        <td>广告类型 </td>
        <td>@Html.DropDownListFor(T => T.AdvertType, ViewData["ddlAdTypeData"] as SelectList, new { @id = "ddlType" }) <input id="AddTypeValid" style="color: red; display: none;" /><span>@Html.ValidationMessageFor(T => T.AdvertType)</span></td>
    </tr>
    <tr>
        <td>广告名称 </td>
        <td> <input class="AdName" id="AdName"  type="text"  value="@Model.AdvertName" /><input id="AdNameValid" style="color: red; display: none;" /></td>
    </tr>
    <tr>
        <td>排序 </td>
        <td> <input class="Sort" id="Sort" type="text" value="@Model.Sort" /><input id="SortValid" style="color: red; display: none;" /></td>
    </tr>
    <tr>
        <td>图片地址（尺寸123px*61px）</td>
        <td>
            <form method="post" action="" enctype="multipart/form-data">
                <input style="width:150px;" type="file" id="upPicture" name="upPicture" onchange="UploadImg()" />
            </form><br />
            <img style="width: 123px; height: 61px;" src="@Model.ImageURL" id="vwPicture"/>
            <input id="ImageValid" style="color: red; display: none;" />
        </td>
    </tr>
    <tr class="h5" style="display: none">
        <td>APP链接</td>
        <td> <input class="AppLink" id="AppLink" type="text" value="@Model.AppLink" /><input id="AppLinkValid" style="color: red; display: none;" /></td>
    </tr>
    <tr class="h5" style="display: none">
        <td>移动链接</td>
        <td> <input class="MobileLink" id="MobileLink" type="text" value="@Model.H5Link" /><input id="MobileLinkValid" style="color: red; display: none;" /></td>
    </tr>
    <tr class="youhui" style="display: none">
        <td>优惠券ID</td>
        <td> <input class="PromotionCodeID" id="PromotionCodeID" type="text" value="@Model.PromotionRuleID" /><input id="PromotionCodeIDValid" style="color: red; display: none;" /></td>
    </tr>
    <tr class="youhui" style="display: none">
        <td>优惠券名称</td>
        <td> <input class="Extend1" type="text" id="Extend1" readonly="true" value="@Model.PromotionName" /></td>
    </tr>
    <tr class="youhui" style="display: none">
        <td>优惠券描述</td>
        <td> <input class="Extend2" type="text" id="Extend2" readonly="true" value="@Model.PromotionDescription"/></td>
    </tr>
    <tr>
        <td>是否显示</td>
        <td>
            @Html.RadioButtonFor(T => T.IsShow, true, new { @id = "radio1", @name = "IsShow" })是
            @Html.RadioButtonFor(T => T.IsShow, false, new { @id = "radio0", @name = "IsShow" })否
        </td>
    </tr>
    </tbody>
</table>
<div>
    <input type="hidden" id="PKID" value="@Model.PKID" />
    <input type="hidden" id="CategoryID" value="@Model.CategoryId"/>
    <input type="hidden" id="TypeName" value="@Model.AdvertTypeName"/>
    <input type="hidden" id="CreateTime" value="@Model.CreatedTime"/>
    <input type="hidden" id="LastUpdateTime" value="@Model.UpdatedTime"/>
    <input type="hidden" id="SmallImage" value="" />
    <input type="hidden" id="Image" value=""/>
    <input type="hidden" id="existImage" value="@Model.ImageURL" />
</div>
<div style="text-align: center; width: 100%; height: 100%; margin: 0px;">
    <a class="button1" href="javascript:;" style="margin-bottom: 20px; float: none" onclick="saveAdvert()">保存</a>
</div>
<script type="text/javascript">
    function saveAdvert() {
        var adName = $("#AdName").val();
        var sort = $("#Sort").val();
        var appLink = $("#AppLink").val();
        var mobileLink = $("#MobileLink").val();
        var promotionCodeID = $("#PromotionCodeID").val();
        var image = $("#Image").val();
        var existImage = $("#existImage").val();
        var flag = false;

        var adType = $('select#ddlType').val();

        if (adType == "1") {
            if (adName == '') {
                $("#AdNameValid").val("必填");
                $("#AdNameValid").show();
                flag = true;
            } else {
                $("#AdNameValid").val("");
                $("#AdNameValid").hide();
            }
            if (sort == '') {
                $("#SortValid").val("必填");
                $("#SortValid").show();
                flag = true;
            }
            if (isNaN(sort)) {
                $("#SortValid").val("必须是大于0的整数");
                $("#SortValid").show();
                flag = true;
            }
            var zhengze = /^[0-9]*[1-9][0-9]*$/;
            if (!(zhengze.test(sort))) {
                $("#SortValid").val("必须是大于0的整数");
                $("#SortValid").show();
                flag = true;
            }
            if (appLink == '') {
                $("#AppLinkValid").val("必填");
                $("#AppLinkValid").show();
                flag = true;
            } else {
                $("#AppLinkValid").val("");
                $("#AppLinkValid").hide();
            }
            if (mobileLink == '') {
                $("#MobileLinkValid").val("必填");
                $("#MobileLinkValid").show();
                flag = true;
            } else {
                $("#MobileLinkValid").val("");
                $("#MobileLinkValid").hide();
            }
            if(image == '' && existImage =='')
            {
                $("#ImageValid").val("图片不能为空");
                $("#ImageValid").show();
                flag = true;
            }
        }
        else if (adType == "2") {
            if (adName == '') {
                $("#AdNameValid").val("必填");
                $("#AdNameValid").show();
                flag = true;
            } else {
                $("#AdNameValid").val("");
                $("#AdNameValid").hide();
            }
            if (sort == '') {
                $("#SortValid").val("必填");
                $("#SortValid").show();
                flag = true;
            }
            if (isNaN(sort)) {
                $("#SortValid").val("必须是大于0的整数");
                $("#SortValid").show();
                flag = true;
            }
            var zhengze = /^[0-9]*[1-9][0-9]*$/;
            if (!(zhengze.test(sort))) {
                $("#SortValid").val("必须是大于0的整数");
                $("#SortValid").show();
                flag = true;
            }
            if (promotionCodeID == '') {
                $("#PromotionCodeIDValid").val("必填");
                $("#PromotionCodeIDValid").show();
                flag = true;
            } else {
                $("#PromotionCodeIDValid").val("");
                $("#PromotionCodeIDValid").hide();
            }
            if (image == '' && existImage == '') {
                $("#ImageValid").val("图片不能为空");
                $("#ImageValid").show();
                flag = true;
            }
        } else {
            $("#AddTypeValid").val("必须选择广告类型");
            $("#AddTypeValid").show();
            flag = true;
        }

        if (flag)
            return;
        $("#AdNameValid").hide();
        $("#SortValid").hide();
        $("#AppLinkValid").hide();
        $("#MobileLinkValid").hide();
        $("#PromotionCodeIDValid").hide();
      
        if (confirm("是否确认要保存？")) {
            var pkid = $("#PKID").val();
           
            if (pkid == "") {
                $.post("/ConfigCategory/InsertAdvertCategoryItem", {
                    categoryId: $("#CategoryID").val(), adType: $("#ddlType").val(), typeName: $("#ddlType option:selected").text(),
                    adName: $("#AdName").val(), imageURL: $("#Image").val(), sort: $("#Sort").val(), appLink: $("#AppLink").val(),
                    mobileLink: $("#MobileLink").val(), promotionCodeID: $("#PromotionCodeID").val(), isShow: $("input[type='radio']:checked").val(), extend1: $("#Extend1").val(), extend2: $("#Extend2").val()
                }, function (data) {

                    if (JSON.parse(data) === true) {
                        alert("保存成功！");
                        window.location.href = "/ConfigCategory/AdvertCategoryList?categoryid=" + $("#CategoryID").val();

                    } else {
                        alert("保存失败！");
                    }
                });
            } else {
                $.post("/ConfigCategory/UpdateAdvertCategoryItem", {
                    pkid: pkid, categoryId: $("#CategoryID").val(), adType: $("#ddlType").val(), typeName: $("#ddlType option:selected").text(),
                    adName: $("#AdName").val(), imageURL: $("#Image").val().length == 0 ? $("#existImage").val() : $("#Image").val(), sort: $("#Sort").val(), appLink: $("#AppLink").val(),
                    mobileLink: $("#MobileLink").val(), promotionCodeID: $("#PromotionCodeID").val(), isShow: $("input[type='radio']:checked").val(), extend1: $("#Extend1").val(), extend2: $("#Extend2").val()
                }, function (data) {

                    if (JSON.parse(data) === true) {
                        alert("保存成功！");
                        window.location.href = "/ConfigCategory/AdvertCategoryList?categoryid=" + $("#CategoryID").val();

                    } else {
                        alert("保存失败！");
                    }
                });
            }
        }
    }

</script>
<script>
    function UploadImg() {
     
        $.ajaxFileUpload({
            url: '/ConfigCategory/UploadImage',
            secureuri: false,
            fileElementId: 'upPicture',
            dataType: 'json',
            data: {},
            type: "post",
            success: function (result) {
                if (result.BImage != "" && result.SImage != "") {
                    $("#vwPicture").attr("src", result.SImage);
                    $("#vwPicture").show();
                    $("#SmallImage").val(result.SImage);
                    $("#Image").val(result.BImage);
                } else {
                    alert("上传失败！");
                }
            }
        });
    }

        $(function () {
            $('select#ddlType').change(function() {
                var adType = $(this).val();
                if (adType == "1") {
                    $(".h5").show();
                    $(".youhui").hide();
                }
                else if (adType == "2") {
                    $(".h5").hide();
                    $(".youhui").show();
                } else {
                    $(".h5").hide();
                    $(".youhui").hide();
                }
                }
            
            );
           
        });


        $(function () {
            $("#PromotionCodeID").on("change", function () {
                var promotionId = $(this).val();
               
                $.ajax({
                    type: "post",
                    url: "/ConfigCategory/GetPromotionModelByRuleID",
                    data: "promotionID=" + promotionId,
                    success: function (data) {
                        if (data.RuleID === 0) {
                            alert("优惠券不存在，请重新输入");
                            $("#PromotionCodeID").val("");
                            $("#Extend1").val("");
                            $("#Extend2").val("");
                            return;
                        }
                        if (data.Description != null) {
                            $("#Extend2").val(data.Description);
                        }
                        if (data.PromtionName != null) {
                            $("#Extend1").val(data.PromtionName);
                        }
                       
                        alert("优惠券加载成功");
                        
                    },
                    error: function () {
                        alert('优惠券加载失败');
                    }
                });
            });
        });

        $(function () {
            
            var adType = $('select#ddlType').val();
                if (adType == "1") {
                    $(".h5").show();
                    $(".youhui").hide();
                }
                else if (adType == "2") {
                    $(".h5").hide();
                    $(".youhui").show();
                } else {
                    $(".h5").hide();
                    $(".youhui").hide();
                }
               
        });

</script>
