@using Tuhu.Provisioning.Business;
@using Tuhu.Provisioning.DataAccess.Entity;
@using Newtonsoft.Json;
@model VehicleMountedCouponConfig
@{
    List<Region>
    ProvinceList = ViewBag.ProvinceList as List<Region>
        ;
}

<style>
    body {
        font-family: "Microsoft Yahei";
    }

    input[type=text] {
        width: 500px;
    }

    .btn {
        margin-top: 20px;
        padding: 5px 25px;
        border: none;
        color: #F0F0F0;
        font-size: 12px;
        outline: none;
        cursor: pointer;
        background: cornflowerblue;
        border-color: cornflowerblue;
    }

    table th {
        color: white;
        padding: 6px 5px;
        text-align: left;
        background-color: cornflowerblue;
        border: solid 1px cornflowerblue;
    }
</style>
<h2>车载优惠券编辑</h2>
<script src="../../Scripts/ajaxfileupload.js" type="text/javascript"></script>

<form action="/VehicleMountedCouponConfig/Edit" method="post">
    <input type="hidden" value="@Model.Id" name="Id" />
    <div>
        <table id="table1" style="width: 100%">

            <tr>
                <td>渠道</td>
                <td>
                    <input type="text" value="@Model.Channel" name="Channel" />
                    <label style="color:red">* 多个渠道之间用 英文逗号隔开 *</label>
                </td>
            </tr>
            <tr>
                <td>类型</td>
                <td>
                    <select class="type">

                        @if (Model.Type == 1)
                        {
                            <option value="1" selected="selected">洗车</option>
                            <option value="2">保养</option>
                            <option value="3">新手礼包</option>
                        }
                        else if (Model.Type == 2)
                        {
                            <option value="1">洗车</option>
                            <option value="2" selected="selected">保养</option>
                            <option value="3">新手礼包</option>
                        }
                        else if (Model.Type == 3)
                        {
                            <option value="1">洗车</option>
                            <option value="2">保养</option>
                            <option value="3" selected="selected">新手礼包</option>
                        }
                        else {
                            <option value="1">洗车</option>
                            <option value="2">保养</option>
                            <option value="3">新手礼包</option>
                        }


                    </select>
                </td>
            </tr>
            <tr>
                <td>版本</td>
                <td>
                    <input type="text" value="@Model.Versions" name="Versions" />
                    <label style="color:red">* 多个版本之间用 英文逗号隔开  *</label>
                </td>
            </tr>
            <tr>
                <td>活动名称/描述</td>
                <td><input type="text" value="@Model.Name" name="Name" /> </td>
            </tr>
            <tr>
                <td width="10%">状态</td>
                <td>
                    @Html.RadioButtonFor(m => m.Status, true) 启用
                    @Html.RadioButtonFor(m => m.Status, false) 禁用
                </td>
            </tr>
            <tr>
                <td>位置</td>
                <td>
                    <fieldset style="width:300px">
                        <div class="Location">
                            <input type="checkbox" value="1" @((Model.Location & 1) == 1 ? "checked" : "" ) value1="位置1" />
                            <label>位置1</label>
                            <input type="checkbox" value="2" @((Model.Location & 2) == 2 ? "checked" : "" ) value1="位置2" />
                            <label>位置2</label>
                            <input type="checkbox" value="4" @((Model.Location & 4) == 4 ? "checked" : "" ) value1="位置3" />
                            <label>位置3</label>
                        </div>
                    </fieldset>
                </td>
            </tr>

            @{
                string[] img = null;
                if (!string.IsNullOrWhiteSpace(Model.Images))
                {
                    img = Model.Images.Split(',');
                }

            }
            <tr class="img">
                <td>宽屏图</td>
                <td>
                    <img height="40" class="vwPicture" src="@(Model.Id != 0 ? img[0] : " ")" />
                    <form method="post" action="" enctype="multipart/form-data">
                        <input style="width:150px;" type="file" onchange="UploadImg(this)" id="1" name="1" />
                    </form><br />
                    <input type="text" class="image" value="@(Model.Id != 0 ? img[0] : " ")" />
                </td>
            </tr>
            <tr class="img">
                <td>普通屏幕图</td>
                <td>
                    <img height="40" class="vwPicture" src="@(Model.Id != 0 ? img[1] : " ")" />
                    <form method="post" action="" enctype="multipart/form-data">
                        <input style="width:150px;" type="file" onchange="UploadImg(this)" id="2" name="2" />
                    </form><br />
                    <input type="text" class="image" value="@(Model.Id != 0 ? img[1] : " ")" />
                </td>
            </tr>
            @*<tr class="img">
                <td>图片3</td>
                <td>
                    <img height="40" class="vwPicture" src="@(Model.Id != 0 ? img[2] : " ")" />
                    <form method="post" action="" enctype="multipart/form-data">
                        <input style="width:150px;" type="file" onchange="UploadImg(this)" id="3" name="3" />
                    </form><br />
                    <input type="text" class="image" value="@(Model.Id != 0 ? img[2] : " ")" />
                </td>
            </tr>*@
        </table>
        <fieldset>
            <legend>优惠券</legend>
            <table id="table2">
                <tr>
                    <td>
                        <a href="javascript:;" style="color:blue" onclick="CloneTr()">添加</a>
                    </td>
                    <td>
                        <label style="color:red">* 点击（添加）批量添加优惠券，输入框填写优惠券ID或者GUID *</label>
                    </td>
                </tr>
                @{
                    string[] coupons = null;
                    if (!string.IsNullOrWhiteSpace(Model.Coupons))
                    {
                        coupons = Model.Coupons.Substring(0, Model.Coupons.Length - 1).Split(',');
                    }

                }

                @if (coupons != null && coupons.Length > 0)
                {
                    foreach (var item in coupons)
                    {
                        <tr class="newTr">
                            <td>优惠券</td>
                            <td>
                                <input type="text" value="@item" class="GetRuleGUID" />
                            </td>
                            <td>
                                <a style="color:blue;display:inline-block;width:50px;" href="javascript:;" onclick="DeleteTr(this)">删除</a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr class="newTr">
                        <td>优惠券</td>
                        <td>
                            <input type="text" class="GetRuleGUID" />
                        </td>
                        <td>
                            <a style="color:blue;display:inline-block;width:50px;" href="javascript:;" onclick="DeleteTr(this)">删除</a>
                        </td>
                    </tr>
                }
            </table>
        </fieldset>
        <fieldset>
            <legend>
                地区
                <input type="checkbox" @(Model.Region.IndexOf("全国") >= 0 ? "checked" : "") value="0" id="quanguo" value1="全国" />
                <label>全国</label>
            </legend>
            <table id="table3">
                <tr class="quanguo">
                    <td style="width:10%">
                        <a style="color:blue;display:inline-block;width:50px;" href="javascript:;" onclick="AddRegion(this)">添加</a>
                    </td>
                    <td>
                        <label style="color:red">* 请点击（添加）批量添加地区 *</label>
                        @*<input type="checkbox" value="0" id="chkall" value1="全国" />
                            <label>全选/反选</label>*@
                    </td>
                </tr>
                @foreach (var item in ProvinceList)
                {
                    MeiRongAcitivityConfigManager manager = new MeiRongAcitivityConfigManager();
                    List
                    <Region>
                        citylist = manager.GetRegion(item.PKID);

                    List<RegionModel>
                        regionlist = JsonConvert.DeserializeObject<List<RegionModel>>(Model.Region);

                    var regionSelect = regionlist.Where(x => x.ProvinceName == item.RegionName).ToList();

                    if (regionlist != null && regionSelect.Count > 0)
                    {
                        foreach (var region in regionSelect)
                        {
                            if (region.ProvinceName == item.RegionName)
                            {
                                var citys = region.CityName.Split(',');

                                <tr class="region">
                                    <td>
                                        <select class="province">
                                            @foreach (var province in ProvinceList)
                                            {
                                                if (province.RegionName == region.ProvinceName)
                                                {
                                                    <option value="@province.PKID" selected="selected">@province.RegionName</option>
                                                }
                                                else
                                                {
                                                    <option value="@province.PKID">@province.RegionName</option>
                                                }
                                            }
                                        </select>

                                    </td>
                                    <td>
                                        <fieldset>
                                            <div>
                                                <input type="checkbox" class="cityall" value="0" value1="全部" />
                                                <label>全部</label>

                                                @foreach (var city in citylist)
                                                {
                                                    var selectCity = citys.Contains(city.RegionName);

                                                    if (selectCity)
                                                    {
                                                        foreach (var c in citys)
                                                        {
                                                            if (c == city.RegionName)
                                                            {
                                                                <input type="checkbox" checked="checked" value="@city.PKID" value1="@city.RegionName" />
                                                                <label>@city.RegionName</label>
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <input type="checkbox" value="@city.PKID" value1="@city.RegionName" />
                                                        <label>@city.RegionName</label>
                                                    }
                                                }
                                            </div>
                                        </fieldset>
                                    </td>
                                    <td>
                                        <a style="color:blue;display:inline-block;width:50px;" href="javascript:;" onclick="DeleteRegion(this)">删除</a>
                                    </td>
                                </tr>
                            }
                        }
                    }
                }
            </table>
        </fieldset>
        <input type="button" value="保存" onclick="SaveModel()" class="btn" />
    </div>
</form>

<table id="coupon" style="display:none;">
    <tr class="newTr">
        <td>优惠券</td>
        <td>
            <input type="text" class="GetRuleGUID" />
        </td>
        <td>
            <a style="color:blue;display:inline-block;width:50px;" href="javascript:;" onclick="DeleteTr(this)">删除</a>
        </td>
    </tr>
</table>

<table id="regionTable" style="display:none">
    <tr class="region">
        <td>
            <select class="province">
                <option value="0">省/自治区/直辖市</option>
                @foreach (var item in ProvinceList)
                {
                    <option value="@item.PKID">@item.RegionName</option>
                }
            </select>
        </td>
        <td>
            <fieldset>
                <div>
                </div>
            </fieldset>
        </td>
        <td>
            <a style="color:blue;display:inline-block;width:50px;" href="javascript:;" onclick="DeleteRegion(this)">删除</a>
        </td>
    </tr>

</table>

<script>
    $(function () {
        if ($("#quanguo").attr("checked")) {
            $("#table3").hide();
        } else {
            $("#table3").show();
        }
    })
    $(".province").change(function () {
        var self = $(this).find("option:selected");
        self.val(self.val());
        var sb = '<input type="checkbox" class="cityall" value="0" value1="全部" /><label>全部</label>';
        $.get("/MeiRongAcitivityConfig/GetRegion/" + self.val() + "", function (result) {

            if (result.length != 0) {
                for (var i = 0; i < result.length; i++) {

                    sb += '<input type="checkbox" value=' + result[i].PKID + ' value1="' + result[i].RegionName + '" /> <label>' + result[i].RegionName + '</label>'
                }
            }

            self.parents("tr").find("td").eq(1).find("div").html(sb);

            $(".cityall").click(function () {

                if ($(this).attr("checked")) {
                    $(this).siblings().attr("checked", "checked");
                } else {
                    $(this).siblings().attr("checked", false);
                }
            })
        });


    });

    $("#quanguo").click(function () {
        if ($(this).attr("checked")) {
            $("#table3").hide();
        } else {
            $(":checkbox").attr("checked", false);
            $("#table3").show();
        }
    })

    $("#chkall").click(function () {
        if ($(this).attr("checked")) {
            $(":checkbox").attr("checked", "checked");
        } else {
            $(":checkbox").attr("checked", false);
        }
    })

    $(".cityall").click(function () {
        if ($(this).attr("checked")) {
            $(this).siblings().attr("checked", "checked");
        } else {
            $(this).siblings().attr("checked", false);
        }
    })


    function DeleteRegion(target) {
        $(target).closest('tr').remove();
    }
    function AddRegion() {
        var tr = $("#regionTable tr").clone();
        tr.appendTo("#table3");

        $(".province").change(function () {
            var self = $(this);
            self.val(self.val());
            var sb = '<input type="checkbox" class="cityall" value="0" value1="全部" /><label>全部</label>';
            $.get("/MeiRongAcitivityConfig/GetRegion/" + self.val() + "", function (result) {
                if (result.length != 0) {
                    for (var i = 0; i < result.length; i++) {
                        sb += '<input type="checkbox" value=' + result[i].PKID + ' value1="' + result[i].RegionName + '" /> <label>' + result[i].RegionName + '</label>'
                    }
                }

                self.parents("tr").find("td").eq(1).find("div").html(sb);

                $(".cityall").click(function () {
                    if ($(this).attr("checked")) {
                        $(this).siblings().attr("checked", "checked");
                    } else {
                        $(this).siblings().attr("checked", false);
                    }
                })
            });
        });

    }


    function DeleteTr(target) {
        $(target).closest('tr').remove();
    }
    function CloneTr() {
        var tr = $("#coupon tr").clone();
        tr.appendTo("#table2");

        $(".GetRuleGUID").blur(function () {
            var $this = $(this);
            $.ajax({
                type: "POST",
                url: "/RecommendGetGiftConfig/GetCoupon",
                data: {
                    "guidOrId": $this.val()
                },
                dataType: "JSON",
                success: function (result) {
                    if (result) {
                        $this.val(result.GetRuleGUID);

                    } else {
                        $this.val("");
                    }
                },
                error: function (result) {

                }
            });
        })
    }

    function SaveModel() {

        var location = 0;
        $(".Location :checkbox").each(function (i) {
            if ($(this).attr("checked")) {
                location += parseInt($(this).val());
            }
        });
        var coupons = '';
        var quantity = 0;
        $('#table2 >tbody> tr').each(function (i) {
            if (i >= 0) {
                if ($(this).attr("class") == "newTr") {
                    var columns = $(this).children();
                    if (columns.eq(1).find(".GetRuleGUID").val()) {
                        quantity++;
                        coupons += columns.eq(1).find(".GetRuleGUID").val() + ",";
                    }
                }
            }
        });
        console.log(coupons);

        var iamges = '';
        $('#table1 >tbody> tr').each(function (i) {
            if (i >= 0) {
                if ($(this).attr("class") == "img") {
                    var columns = $(this).children();
                    if (columns.eq(1).find(".image").val()) {
                        iamges += columns.eq(1).find(".image").val() + ",";
                    }
                }
            }
        });
        console.log(iamges);
        var dataRegion = new Array();
        if ($("#quanguo").attr("checked")) {
            var jsonData = { "ProvinceName": "全国", "CityName": "全国" };
            dataRegion.push(jsonData);
        } else {
            $('#table3 >tbody> tr').each(function (i) {
                if (i >= 0) {
                    if ($(this).attr("class") == "region") {
                        var columns = $(this).children();
                        var jsonData = { "ProvinceName": "", "CityName": "" };
                        var proStr = columns.eq(0).find(".province").find("option:selected").text() || "";
                        if (proStr && proStr != "省/自治区/直辖市") {
                            jsonData.ProvinceName = proStr;
                            columns.eq(1).find(":checkbox").each(function (i) {
                                if ($(this).attr("checked")) {
                                    if ($(this).attr("value1") != "全部") {
                                        jsonData.CityName += $(this).attr("value1") + ",";
                                    }
                                }
                            });
                            if (jsonData.CityName) {
                                dataRegion.push(jsonData);
                            }
                        }
                    }
                }
            });
        }

        console.log(JSON.stringify(dataRegion));
      
        var dataStr = {
            "Id": $.trim($("input[name='Id']").val()),
            "Channel": $.trim($("input[name='Channel']").val()),
            "Versions": $.trim($("input[name='Versions']").val()),
            "Region": JSON.stringify(dataRegion),
            "Status": $("input[name='Status']:checked").val(),
            "Images": iamges,
            "Coupons": coupons,
            "Name": $.trim($("input[name='Name']").val()),
            "location": location,
            "CouponQuantity": quantity,
            "Type": $(".type").val(),
        };
        console.log(JSON.stringify(dataStr));

        $.ajax({
            type: "POST",
            url: "/VehicleMountedCouponConfig/Edit",
            data: dataStr,
            dataType: "JSON",
            success: function (result) {
                if (result) {
                    window.location.href = '/VehicleMountedCouponConfig/Index';
                }
            },
            error: function (result) {
            }
        });
    }

    function UploadImg(e) {
        var $e = $(e);
        var $ee = $e.parents("tr").find("td").eq(1).find("img");
        var $smallImage = $e.parents("tr").find("td").eq(1).find("input[class='smallImage']");
        var $image = $e.parents("tr").find("td").eq(1).find("input[class='image']");
        $.ajaxFileUpload({
            url: '/Article/AddArticleImg2',
            secureuri: false,
            fileElementId: $e.attr("id"),
            dataType: 'json',
            data: {},
            type: "post",
            success: function (result) {
                if (result.BImage != "" && result.SImage != "") {
                    $ee.attr("src", result.SImage);
                    $(".vwPicture").show();
                    $smallImage.val(result.SImage);
                    $image.val(result.BImage);
                } else {
                    alert("上传失败！");
                }
            }
        })
    }

    $(".GetRuleGUID").blur(function () {
        var $this = $(this);
        $.ajax({
            type: "POST",
            url: "/RecommendGetGiftConfig/GetCoupon",
            data: {
                "guidOrId": $this.val()
            },
            dataType: "JSON",
            success: function (result) {
                if (result) {
                    $this.val(result.GetRuleGUID);

                } else {
                    $this.val("");
                }
            },
            error: function (result) {
            }
        });
    })
</script>
