@using Tuhu.Service.Push.Models.Push;
@using Tuhu.Provisioning.Business.Push;
@model TemplateQueryResult
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    //if (Model != null && Model.Result.Count > 0)
    //{

    //}
    //var gffff = ViewData["query"];

    var querydata = ViewBag.query as Tuhu.Service.Push.Models.Push.TemplateQuery;
    int PageCount = 1;
    int pageindex = 1;
    if (Model != null && Model.TotalCount != 0 && Model.PageIndex != 0 && querydata != null && querydata.PageSize != 0)
    {
        PageCount = (Model.TotalCount / querydata.PageSize) + 1;
        pageindex = Model.PageIndex;
    }
    bool hasprev = pageindex > 1;
    bool hasnext = pageindex < PageCount;
    
}

@section head{
    <link href="~/Content/nfine/js/bootstrap/bootstrap.min.css" rel="stylesheet" />
}
@functions {

    List<SelectListItem> converttoselect<T>(string value)
    {
        var list = new List<SelectListItem>();
        list.Add(new SelectListItem()
        {
            Text = "All",
            Value = "",
            Selected = value == ""
        });
        list.AddRange(Enum.GetValues(typeof(T)).Cast<T>().Select(v => new SelectListItem
        {
            Text = typeof(T) == typeof(PushStatus)? PushManagerNew .GetPushStatusName((PushStatus)Enum.Parse(typeof(PushStatus),v.ToString())): v.ToString(),
            Value = Convert.ToInt32(v).ToString(),
            Selected = v.ToString() == value
        }));
        return list;
    }

    string gettemplatestatisticaldata(int templateid, string type)
    {
        var Statisticaldata = ViewBag.Statisticaldata == null ? new List<CalculateMessageInfo>() : ViewBag.Statisticaldata as IEnumerable<CalculateMessageInfo>;
        if (Statisticaldata == null)
        {
            return "";
        }
        var data = Statisticaldata.FirstOrDefault(x => x.Templateid == templateid);
        if (data == null)
        {
            return "";
        }
        switch (type)
        {
            case "Resolved":
                return data.Resolved;
            case "Click":
                return data.Click;
            case "ClickRate":
                return data.ClickRate;
            case "Delivered":
                return data.Delivered;
            case "DeliveryRate":
                return data.DeliveryRate;
            default:
                return "";
        }
    }

}
<div class="contact">
    @Html.Hidden("PageCount", PageCount)
    <h3>
        <a href="@Url.Action("TemplateEdit")">新增</a>
    </h3>
    <br />
    <form method="get" class="form-inline">
        <div class="form-group form-group-sm">
            <label>计划ID</label>
            <input class="form-control" name="BatchID" type="text" value="@(querydata != null && querydata.BatchID.HasValue ? querydata.BatchID.ToString() : "")" />
        </div>
        <div class="form-group form-group-sm">
            <label>计划名称</label> <input class="form-control" name="PlanName" type="text" value="@(querydata != null && !string.IsNullOrEmpty(querydata.PlanName) ? querydata.PlanName.ToString() : "")" />
        </div>
        <div class="form-group form-group-sm">
            <label>推送状态</label>
            @Html.DropDownList("PushStatus", converttoselect<PushStatus>(querydata != null && querydata.PushStatus.HasValue ? querydata.PushStatus.Value.ToString() : ""), new { @class = "form-control" })
        </div>
        <div class="form-group form-group-sm">
            <label>沟通渠道</label>
            @Html.DropDownList("DeviceType", converttoselect<DeviceType>(querydata != null && querydata.DeviceType.HasValue ? querydata.DeviceType.Value.ToString() : ""), new { @class = "form-control" })
        </div>

        <br />
        <div class="form-group form-group-sm">
            <label>推送时间</label> <input type="text" class="form-control" id="StartTime" name="StartTime" value="@(querydata != null && querydata.StartTime.HasValue ? querydata.StartTime.Value.ToString() : "")" />
            <input class="form-control" type="text" id="EndTime" name="EndTime" value="@(querydata != null && querydata.EndTime.HasValue ? querydata.EndTime.Value.ToString() : "")" />
            @Html.Hidden("PageIndex", pageindex)
        </div>
        <input id="submit" class="btn btn-primary btn-small" type="submit" value="搜索" />
        <br />
    </form>
    <br />
    <table style="background: #ffffff; font-size: 12px; width: 100%; text-align:center" border="1" class="table">
        <tr>
            <th colspan="2">沟通计划</th>
            <th rowspan="2">推送状态</th>
            <th rowspan="2">沟通类型</th>
            <th rowspan="2">推送时间</th>
            <th colspan="2">计划沟通</th>
            <th colspan="2">有效设备</th>
            <th colspan="2">送达</th>
            <th colspan="2">打开</th>
            <th rowspan="2" colspan="2">操作</th>
        </tr>
        <tr>
            <th>
                ID
            </th>
            <th>
                名称
            </th>
            <th>数</th>

            <th>率</th>
            <th>数</th>
            <th>率</th>
            <th>数</th>
            <th>率</th>
            <th>数</th>
            <th>率</th>
        </tr>
        @if (Model != null && Model.Result != null && Model.Result.Count > 0)
        {
            foreach (var template in Model.Result)
            {
                <tr>
                    <td>@template.BatchID</td>
                    <td>@template.PlanName</td>
                    <td>@PushManagerNew.GetPushStatusName(template.PushStatus)</td>
                    <td>@template.DeviceType</td>
                    <td>@template.Sendtime</td>
                    <td>
                        @gettemplatestatisticaldata(template.PKID, "Resolved")
                    </td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>
                        @gettemplatestatisticaldata(template.PKID, "Click")
                    </td>
                    <td>
                        @gettemplatestatisticaldata(template.PKID, "DeliveryRate")
                    </td>
                    <td>
                        @gettemplatestatisticaldata(template.PKID, "Click")
                    </td>
                    <td>
                        @gettemplatestatisticaldata(template.PKID, "ClickRate")
                    </td>
                    <td>
                        <a href="@Url.Action("TemplateEdit", new
                                 {
                                     batchid = template.BatchID
                                 })">编辑</a>
                        <a href="@Url.Action("ShowTemplateLog",new
                            {
                                templateid=template.PKID
                            })">查看操作日志</a>
                    </td>
                    <td></td>
                </tr>
            }
        }
    </table>
    <br />
    <button type="button" @(hasprev ? "" : "disabled") class="btn btn-primary btn-small" onclick="NextPage('prev')">上一页</button>
    <span>@pageindex</span>
    <button type="button" @(hasnext ? "" : "disabled") class="btn btn-primary btn-small" onclick="NextPage('next')">下一页</button>
</div>
<script src="/Scripts/ajaxfileupload.js" type="text/javascript"></script>
<script type="text/javascript" src="/Scripts/TimeObjectUtil.js"></script>
<link href="/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.css" rel="stylesheet" type="text/css" />
<link href="/Scripts/ztree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet" type="text/css" />
<script src="/Scripts/jquery-ui-timepicker-addon/jquery-ui-sliderAccess.js" type="text/javascript"></script>
<script src="/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.js" type="text/javascript"></script>
<script src="/Scripts/zTree/js/jquery.ztree.core-3.5.min.js" type="text/javascript"></script>
<script src="/Scripts/zTree/js/jquery.ztree.excheck-3.5.min.js" type="text/javascript"></script>

<script>
    $(function () {
        //$("[id=IOSExpireTime],[id=IOSPushTime],[id=AndroidPushTime],[id=AndroidExpireTime]").datetimepicker({
        $("[id=StartTime],[id=EndTime]").datetimepicker({
            //minDate: new Date(),
            controlType: 'select',
            dateFormat: "yy-mm-dd",
            timeFormat: 'HH:mm'
        });
    });
    function NextPage(type) {
        var pageindex = $("#PageIndex").val();
        var result = parseInt(pageindex);
        if (type == 'prev') {
            result -= 1;
        } else {
            result += 1;
        }
        $("#PageIndex").val(result);
        $("#submit").click();
    }
</script>