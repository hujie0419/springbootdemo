@using Tuhu.Provisioning.DataAccess.Entity
@model ShareConfigSource

@section head{
    <link href="~/Content/nfine/js/bootstrap/bootstrap.min.css" rel="stylesheet" />
}

<center>
    <div class="general">
        <div class="title" style="margin:20px 0 10px 0;font-size:16px;background-color:cornflowerblue;">分享内容</div>
        <div class="content">
            <form id="form1" class="form-inline">
                @Html.HiddenFor(m=>m.PKId,new { @name = "PKIdCriterion" })
                <table style="font-size:12px;width:700px;">
                    <tr>
                        <td style="width:100px;">标签</td>
                        <td>
                            @Html.TextBoxFor(m => m.Location, new { @name = "LocationCriterion", @class = "form-control", @style = "width:100%", onkeydown = "if(event.keyCode==13) return false;" })
                        </td>
                    </tr>
                    <tr>
                        <td>特殊参数</td>
                        <td>
                            @Html.TextAreaFor(m => m.SpecialParam, new { @name = "SpcParamCriterion", @class = "form-control", @style = "width:100%" })
                        </td>
                    <tr>
                        <td>描述</td>
                        <td>
                            @Html.TextAreaFor(m => m.Description, new { @name = "DescriptionCriterion", @class = "form-control", @style = "width:100%" })
                        </td>
                    </tr>
                    <tr>
                        <td>状态</td>
                        <td>
                            @Html.DropDownListFor(m => m.Status,
                                               new[]
                                               {
                                                   new SelectListItem() {Selected = (Model.Status==1), Value = "1", Text = "启用"},
                                                   new SelectListItem() {Selected = (Model.Status==2), Value = "2", Text = "禁用"}
                                               },
                                               new
                                               {
                                                   id = "StatusCriterion",
                                                   @name = "StatusCriterion",
                                                   @class = "form-control"
                                               })
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <input id="btnSaveShareConfig" class="btn btn-primary btn-small" type="button" onclick="CheckToSubmit()" value="保存" />
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
</center>

<center>
    <div id="shareSConfig" class="general">
        <div class="title" style="margin:20px 0 10px 0;font-size:16px;background-color:cornflowerblue;">分享配置</div>
        <div id="tbShareSConfig" class="content">
            <!--分享配置信息-->
        </div>
    </div>
</center>

<center>
    <div id="addShareMode" class="general" style="display:normal;">
        <div class="title" style="margin:20px 0 10px 0;font-size:16px;background-color:cornflowerblue;">创建分享渠道</div>
        <div class="content">
            <table style="font-size:12px;width:700px;">
                <tr>
                    <td>
                        <input type="button" id="btnAddShareMode" class="btn btn-primary btn-small" onclick="ShareSConfigEdit(0)" value="添加分享渠道" />
                        <span>点击添加分享渠道</span>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</center>

<script src="/Scripts/ajaxfileupload.js" type="text/javascript"></script>
<script type="text/javascript" src="/Scripts/TimeObjectUtil.js"></script>
<link href="/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.css" rel="stylesheet" type="text/css" />
<link href="/Scripts/ztree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet" type="text/css" />
<script src="/Scripts/jquery-ui-timepicker-addon/jquery-ui-sliderAccess.js" type="text/javascript"></script>
<script src="/Scripts/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.js" type="text/javascript"></script>
<script src="/Scripts/zTree/js/jquery.ztree.core-3.5.min.js" type="text/javascript"></script>
<script src="/Scripts/zTree/js/jquery.ztree.excheck-3.5.min.js" type="text/javascript"></script>

<div id="ShareSConfigEditModule" style="display:none;"></div>

<script type="text/javascript">
    function CheckToSubmit() {
        var location = document.getElementById("Location").value.trim();//新的Location
        $("#Location").val(location);
        var id0 = document.getElementById("PKId").value;
        var reg = /[\u4E00-\u9FA5|\u3002|\uff1f|\uff01|\uff0c|\u3001|\uff1b|\uff1a|\u201c|\u201d|\u2018|\u2019|\uff08|\uff09|\u300a|\u300b|\u3008|\u3009|\u3010|\u3011|\u300e|\u300f|\u300c|\u300d|\ufe43|\ufe44|\u3014|\u3015|\u2026|\u2014|\uff5e|\ufe4f|\uffe5]/i;
        if (location.length == 0)
        {
            alert("标签不能为空！");
            return;
        }
        else if (reg.test(location)) {
            alert("标签禁止输入中文或中文标点符号！");
            return;
        }
        else
        {
            $.ajax({
                url: "/ShareConfig/CheckLocationExist",
                type: "POST",
                data: {
                    location: location,
                    specialParam: $("#SpecialParam").val().trim()
                },
                dataType: "text",
                async: false,
                success: function (data) {
                    if (data != id0 && data != 0)
                    {
                        alert("标签已存在，请重新输入！");
                    }
                    else
                    {    
                        $.ajax({
                            url: "/ShareConfig/SaveShareConfig",
                            type: "POST",
                            data: $("#form1").serialize(),
                            dataType: "json",
                            async: false,
                            success: function (pkid) {
                                if (id0 < 0) {
                                    var id = -id0;//被复制的PKId
                                    CopyShareSConfigs(location, id, pkid);
                                }
                            }
                        });
                    }
                },
                error: function () {
                    alert('请求失败！');
                },
            })
        }
    }
    function CopyShareSConfigs(location,oldId,newId)
    {
        $.ajax({
            url: "/ShareConfig/CopyShareSConfigs",
            type: "POST",
            data: {
                location: location,
                id: oldId,
                newId: newId
            },
            dataType: "text",
            async: false,
            success: function (data) {
            },
            error: function () {
                alert('请求失败！');
            },
        })
    }
    $(function () {
        var pkid = document.getElementById("PKId").value;
        if (pkid > 0) {
            var str = "";
            str += "<div class='content'>" +
                "<table style= 'font-size:12px;width:100%;'>" +
                "<tr><th width='60px' style='text-align: center'>渠道</th>" +
                "<th width='40px' style='text-align: center'>状态</th>" +
                "<th width='40px' style='text-align: center'>顺序</th>" +
                "<th width='60px' style='text-align: center'>分享类型</th>" +
                "<th style='text-align: center'>标题</th>" +
                "<th style='text-align: center'>内容</th>" +
                "<th width='320px' style='text-align: center'>缩略图</th>" +
                "<th width='70px' style='text-align: center'>编辑</th></tr>";
            $.ajax({
                url: "/ShareConfig/GetShareSConfigByJumpId",
                type: "POST",
                data: {
                    jumpId : pkid
                },
                dataType: "json",
                async: false,
                success: function (data) {
                    var j;
                    for (j = 0; j < data.length; j++) {
                        str += "<tr><td height='220px'>";
                        switch (data[j].ShareScene) {
                            case 1: str += "微信好友"; break;
                            case 2: str += "朋友圈"; break;
                            case 4: str += "新浪微博"; break;
                            case 8: str += "QQ好友"; break;
                            case 16: str += "QQ空间"; break;
                            case 32: str += "复制链接"; break;
                            case 64: str += "短信"; break;
                        }
                        str += "</td><td>";
                        str += data[j].Status == "1" ? "启用" : "禁用";
                        str += "</td><td>";
                        str += data[j].SceneSequence;
                        str += "</td ><td>";
                        switch (data[j].ShareType) {
                            case 0: str += "链接"; break;
                            case 1: str += "图片"; break;
                            case 2: str += "文字"; break;
                            case 3: str += "小程序"; break;
                        }
                        str += "</td><td>";
                        //标题
                        if (data[j].Title == null) {
                            str += "-";
                        }
                        else {
                            str += data[j].Title;
                        }
                        str += "</td><td>";
                        //内容
                        if (data[j].Description == null) {
                            str += "-";
                        }
                        else {
                            str += data[j].Description;
                        }
                        str += "</td><td>";
                        //缩略图
                        if (data[j].ShareType == 2 || data[j].ShareScene == 32 || data[j].ShareScene == 64) {
                            str += "";
                        } else {
                            str += "<img width='200px' height='200px' style='float:left' src='" + data[j].ThumbPic + "'>";
                            str += "<label style='width:100px;float:left;word-wrap:break-word;'>" + data[j].ThumbPic + "</label>";
                        }
                        str += "</td><td>";
                        str += "<input class='btn btn-primary' type='button' onclick='ShareSConfigEdit(" + data[j].PKId + ")' value='编辑' /></br></br>";
                        str += "<input class='btn btn-primary' type='button' onclick='ShareSConfigEdit(" + -data[j].PKId + ")' value='复制' /></br></br>";
                        str += "<input class='btn btn-primary' type='button' onclick='ShareSConfigDel(" + data[j].PKId + ")' value='删除' />";
                        str += "</td></tr>";
                    }
                },
                error: function () {
                    alert('请求失败！');
                },
            })
            str += "</table></div>";
            document.getElementById("tbShareSConfig").innerHTML = str;
        }
        else if (pkid < 0) {
            var str = "";
            str += "<div class='content'>" +
                "<table style= 'font-size:12px;width:100%;'>" +
                "<tr><th width='60px' style='text-align: center'>渠道</th>" +
                "<th width='40px' style='text-align: center'>状态</th>" +
                "<th width='40px' style='text-align: center'>顺序</th>" +
                "<th width='60px' style='text-align: center'>分享类型</th>" +
                "<th style='text-align: center'>标题</th>" +
                "<th style='text-align: center'>内容</th>" +
                "<th width='320px' style='text-align: center'>缩略图</th>";
            $.ajax({
                url: "/ShareConfig/GetShareSConfigByJumpId",
                type: "POST",
                data: {
                    jumpId : -pkid
                },
                dataType: "json",
                async: false,
                success: function (data) {
                    var j;
                    for (j = 0; j < data.length; j++) {
                        str += "<tr><td height='220px'>";
                        switch (data[j].ShareScene) {
                            case 1: str += "微信好友"; break;
                            case 2: str += "朋友圈"; break;
                            case 4: str += "新浪微博"; break;
                            case 8: str += "QQ好友"; break;
                            case 16: str += "QQ空间"; break;
                            case 32: str += "复制链接"; break;
                            case 64: str += "短信"; break;
                        }
                        str += "</td><td>";
                        str += data[j].Status == "1" ? "启用" : "禁用";
                        str += "</td><td>";
                        str += data[j].SceneSequence;
                        str += "</td ><td>";;
                        switch (data[j].ShareType) {
                            case 0: str += "链接"; break;
                            case 1: str += "图片"; break;
                            case 2: str += "文字"; break;
                            case 3: str += "小程序"; break;
                        }
                        str += "</td><td>";
                        str += data[j].Title;
                        str += "</td><td>";
                        str += data[j].Description;
                        str += "</td><td>";
                        if (data[j].ShareType == 2) {
                            str += "";
                        } else {
                            str += "<img width='200px' height='200px' style='float:left' src='" + data[j].ThumbPic + "'>";
                            str += "<label style='width:100px;float:left;word-wrap:break-word;'>" + data[j].ThumbPic + "</label>";
                        }
                        str += "</td></tr>";
                    }
                },
                error: function () {
                    alert('请求失败！');
                },
            })
            str += "</table></div>";
            document.getElementById("tbShareSConfig").innerHTML = str;
        }
    });
    function ShareSConfigEdit(id)
    {
        var t;
        var pkid = document.getElementById("PKId").value;
        if (pkid <= 0)
        {
            alert("请先保存分享内容！")
            return;
        }
        if (id == 0) {
            t = "创建分享渠道";
        }
        else if (id > 0) {
            t = "修改分享渠道";
        }
        else
        {
            t = "复制分享渠道";
        }
        $("#ShareSConfigEditModule").html("").load("/ShareConfig/ShareSConfigEditModule?location=@Model.Location&id=" + id + "&jumpid=@Model.PKId");
        $("#ShareSConfigEditModule").dialog({
            title: t,
            width: 600,
            height: "auto",
            modal: true,
            resizable: false
        });
    }
    function ShareSConfigDel(id)
    {
        if (confirm("确定要删除吗？") == true) {
            $.ajax({
                url: "/ShareConfig/DelShareSConfig",
                type: "POST",
                data: {
                    id: id,
                    configid: @Model.PKId,
                },
                dataType: "text",
                async: false,
                success: function (data) {
                    if (data == "True") {
                        alert("删除成功！");
                        window.location.reload();
                    }
                    else {
                        alert("删除失败！");
                    }
                },
                error: function () {
                    alert('请求失败！');
                },
            })
        }
    }
    function UploadPic(obj, showImg, showUrl) {
        var pobj = $(obj).parent();
        var rd = Math.ceil(Math.random() * 9999) + 1;
        var fileElId = $(obj).attr("id");
        console.log(fileElId);
        $.ajaxFileUpload({
            url: '/Article/ImageUploadToAli?rd=' + rd,
            secureuri: false,
            fileElementId: fileElId,
            dataType: 'json',
            async: false,
            success: function (result) {
                if (result.BImage != "" && result.SImage != "") {
                    console.log($(pobj).find("#" + showImg));
                    $(pobj).find("#" + showImg).attr("src", result.SImage).show();
                    $(pobj).find("#" + showUrl).val(result.BImage);
                } else {
                    alert("上传失败！");
                }
            }
        });
    }
</script>
