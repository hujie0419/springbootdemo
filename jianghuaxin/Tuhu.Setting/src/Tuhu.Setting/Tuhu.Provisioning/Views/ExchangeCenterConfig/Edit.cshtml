@using Newtonsoft.Json;
@model Tuhu.Provisioning.DataAccess.Entity.ExchangeCenterConfig
@{
    Layout = null;
}

<style>
    /*.btn {
        margin-top: 20px;
        padding: 5px 25px;
        border: none;
        color: #F0F0F0;
        font-size: 12px;
        outline: none;
        cursor: pointer;
        background: cornflowerblue;
        border-color: cornflowerblue;
    }

    a {
        color: cornflowerblue;
    }*/
</style>
<script src="../../Scripts/ajaxfileupload.js" type="text/javascript"></script>
<div class="modal-dialog">
    <form action="/ExchangeCenterConfig/Edit" method="post">
        <input type="hidden" value="@Model.Id" name="Id" />
        <input type="hidden" value="@Model.CouponEndTime" id="CouponEndTime" name="CouponEndTime" />
        <input type="hidden" value="@Model.CouponDuration" id="CouponDuration" name="CouponDuration" />
        <input type="hidden" value="@Model.CouponId" id="CouponId" name="CouponId" />
        <div>
            <table id="table1" style="width:100%">
                <tr>
                    <td style="width:40%">开始版本</td>
                    <td style="width:60%">
                        <input type="text" value="@Model.StartVersion" id="StartVersion" name="StartVersion" />
                    </td>
                </tr>
                <tr>
                    <td style="width:40%">结束版本</td>
                    <td style="width:60%">
                        <input type="text" value="@Model.EndVersion" id="EndVersion" name="EndVersion" />
                    </td>
                </tr>
                <tr>
                    <td style="width:40%">优惠券GUID</td>
                    <td style="width:60%">
                        <input type="text" value="@Model.GetRuleGUID" id="GetRuleGUID" required="required" name="GetRuleGUID" />
                    </td>
                </tr>
                <tr>
                    <td>优惠券名称</td>
                    <td>
                        <input type="text" value="@Model.CouponName" id="CouponName" name="CouponName" />
                    </td>
                </tr>
                <tr>
                    <td>券后价格</td>
                    <td><input type="number" value="@Model.EndCouponPrice" name="EndCouponPrice" /></td>
                </tr>
                <tr>
                    <td>兑换周期（天）</td>
                    <td><input type="number" value="@Model.Period" name="Period" /></td>
                </tr>
                <tr>
                    <td>兑换积分值</td>
                    <td><input type="number" value="@Model.PointsValue" name="PointsValue" /></td>
                </tr>
                <tr>
                    <td>兑换截至时间</td>
                    <td><input type="date" value="@(Model.EndTime.ToString("yyyy-MM-dd"))" id="EndTime" name="EndTime" /></td>
                </tr>

                <tr>
                    <td>优惠券总量</td>
                    <td>
                        @if (!string.IsNullOrWhiteSpace(Model.Edit))
                        {
                            <input type="number" value="@Model.CouponSum" name="CouponSum" />
                        }
                        else
                        {
                            <input type="number" value="@Model.CouponSum" readonly="readonly" name="CouponSum" />
                        }
                    </td>
                </tr>
                <tr>
                    <td>优惠券剩余量</td>
                    <td><input type="number" value="@Model.CouponSurplus" readonly="readonly" name="CouponSurplus" /></td>
                </tr>

                <tr>
                    <td>图片</td>
                    <td>
                        <img height="40" class="vwPicture" src="@Model.Image" />
                        <input type="hidden" name="Image" class="image" value="@Model.Image" />
                        <form method="post" action="" enctype="multipart/form-data">
                            <input style="width:150px;" type="file" onchange="UploadImg(this)" id="2" name="2" />
                        </form>
                    </td>
                </tr>
                <tr>
                    <td>状态</td>
                    <td>
                        @Html.RadioButtonFor(m => m.Status, true) 启用
                        @Html.RadioButtonFor(m => m.Status, false) 禁用
                    </td>
                </tr>
                <tr>
                    <td>配置位置:</td>
                    <td>
                        <select id="Postion" name="Postion">
                            @if (Model.Postion != null && Model.Postion.Trim() == "精品通用券")
                            {
                                <option value="精品通用券" selected="selected">精品通用券</option>
                            }
                            else
                            {
                                <option value="精品通用券">精品通用券</option>
                            }

                            @if (Model.Postion != null && Model.Postion.Trim() == "会员商城")
                            {
                                <option value="会员商城" selected="selected">会员商城</option>
                            }
                            else
                            {
                                <option value="会员商城">会员商城</option>
                            }
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>PID:</td>
                    <td>
                        <input type="text" value="@Model.PID" name="PID" id="PID" />
                    </td>
                </tr>
                <tr>
                    <td>用户等级:</td>
                    <td>
                        <select id="UserRank" name="UserRank">
                            @if (Model.UserRank != null && Model.UserRank.Trim() == "V0")
                            {
                                <option value="V0" selected="selected">V0</option>
                            }
                            else
                            {
                                <option value="V0">V0</option>
                            }

                            @if (Model.UserRank != null && Model.UserRank.Trim() == "V1")
                            {
                                <option value="V1" selected="selected">V1</option>
                            }
                            else
                            {
                                <option value="V1">V1</option>
                            }
                            @if (Model.UserRank != null && Model.UserRank.Trim() == "V2")
                            {
                                <option value="V2" selected="selected">V2</option>
                            }
                            else
                            {
                                <option value="V2">V2</option>
                            }
                            @if (Model.UserRank != null && Model.UserRank.Trim() == "V3")
                            {
                                <option value="V3" selected="selected">V3</option>
                            }
                            else
                            {
                                <option value="V3">V3</option>
                            }
                            @if (Model.UserRank != null && Model.UserRank.Trim() == "V4")
                            {
                                <option value="V4" selected="selected">V4</option>
                            }
                            else
                            {
                                <option value="V4">V4</option>
                            }
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>顺序</td>
                    <td>
                        <input type="number" value="@Model.Sort" name="Sort" />
                    </td>
                </tr>
                <tr>
                    <td>兑换类型</td>
                    <td>
                        <input type="radio" name="ExchangeCenterType" value="true" @((Model.ExchangeCenterType != null && Model.ExchangeCenterType == true) ? "checked=\"checked\"" : "") /><span>抽奖</span>
                        <input type="radio" name="ExchangeCenterType" value="false" @((Model.ExchangeCenterType != null && Model.ExchangeCenterType == false) ? "checked=\"checked\"" : "") /><span>兑换</span>
                    </td>
                </tr>
                <tr>
                    <td>中奖的概率</td>
                    <td>
                        <input type="number" name="Chance" value="@Model.Chance" />
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <a href="javascript:;" style="color:blue" onclick="CloneTr()">添加描述</a>
                    </td>
                </tr>
                @if (!string.IsNullOrWhiteSpace(Model.Description))
            {
                foreach (var item in JsonConvert.DeserializeObject<List<Tuhu.Provisioning.DataAccess.Entity.Description>>(Model.Description))
                {
                        <tr class="newTr">
                            <td>标题：<input type="text" class="title" value="@item.Title" /></td>
                            <td><label>描述：</label> <textarea class="content" style="width:80%;">@item.Content</textarea></td>
                            <td><input style="width:40px" type="number" name="sort" required="required" value="@item.Sort" /></td>
                            <td><a style="color:blue;display:inline-block;width:50px;" href="javascript:;" onclick="DeleteTr(this)">删除</a></td>
                        </tr>
                    }
                }
            </table>

            <input type="button" value="保存" onclick="SaveModel()" class="btn" />
        </div>
    </form>


    <table id="templateTable" style="display:none;">
        <tr class="newTr">
            <td>标题：<input type="text" class="title" /></td>
            <td> <label>描述：</label> <textarea class="content" style="width:80%;"></textarea></td>
            <td><input type="number" style="width:40px" required="required" value="0" name="sort" /></td>
            <td><a style="color:blue;display:inline-block;width:50px;" href="javascript:;" onclick="DeleteTr(this)">删除</a></td>
        </tr>
    </table>
</div>
<script>

    function SaveModel() {      
        var dataArray = new Array();
        $('#table1 >tbody> tr').each(function (i) {
            if (i >= 0) {
                if ($(this).attr("class") == "newTr") {
                    var columns = $(this).children();
                    var jsonData = { "Title": "", "Content": "", "Sort": "" };
                    jsonData.Title = columns.eq(0).find("input[type='text']").val();
                    jsonData.Content = columns.eq(1).find(".content").val();
                    jsonData.Sort = columns.eq(2).find("input[type='number']").val();
                    dataArray.push(jsonData);
                }
            }
        });
        var dataList = JSON.stringify(dataArray);
        if (!$("input[name='StartVersion']").val()) {
            return false;
        }
        if (!$("input[name='EndVersion']").val()) {
            return false
        }
        var getAction = document.getElementById("ui-dialog-title-AddItem").innerText;
        var actionValue = '';
        if (getAction == "添加") actionValue = 'Add';
        if (getAction == "修改") actionValue = 'Update';
        if (getAction == "复制重建") actionValue = 'Copy';
        $.ajax({
            type: "POST",
            url: "/ExchangeCenterConfig/Edit",
            data: {
                "EndVersion": $.trim($("input[name='EndVersion']").val()),
                "StartVersion": $.trim($("input[name='StartVersion']").val()),
                "Id": $("input[name='Id']").val(),
                "CouponEndTime": $("input[name='CouponEndTime']").val(),
                "CouponDuration": $("input[name='CouponDuration']").val(),
                "CouponId": $("input[name='CouponId']").val(),
                "GetRuleGUID": $("input[name='GetRuleGUID']").val(),
                "CouponName": $("input[name='CouponName']").val(),
                "Period": $("input[name='Period']").val(),
                "PointsValue": $("input[name='PointsValue']").val(),
                "EndTime": $("input[name='EndTime']").val(),
                "CouponSum": $("input[name='CouponSum']").val(),
                "CouponSurplus": $("input[name='CouponSurplus']").val(),
                "Image": $("input[name='Image']").val(),
                "Status": $("input[name='Status']:checked").val(),
                "Sort": $("input[name='Sort']").val(),
                "Description": dataList,
                "Postion": $('#Postion').val(),
                "PID": $('input[name="PID"]').val(),
                "UserRank": $('#UserRank').val(),
                "EndCouponPrice": $("input[name=EndCouponPrice]").val(),
                "ExchangeCenterType": $('input[name="ExchangeCenterType"]:checked').val() || null,
                "Chance": $('input[name="Chance"]').val(),
                "Edit": actionValue,
            },
            dataType: "JSON",
            success: function (result) {
                if (result) {
                    window.location.reload(true);
                }
            },
            error: function (result) {

            }
        });
    }


    function DeleteTr(target) {

        $(target).closest('tr').remove();
    }
    function CloneTr() {
        var tr = $("#templateTable tr").clone();
        tr.appendTo("#table1");
    }

    function UploadImg(e) {
        var $e = $(e);
        var $ee = $e.parents("tr").find("td").eq(1).find("img");
        var $smallImage = $e.parents("tr").find("td").eq(1).find("input[class='smallImage']");
        var $image = $e.parents("tr").find("td").eq(1).find("input[class='image']");
        $.ajaxFileUpload({
            url: '/Article/AddArticleImg2',
            secureuri: false,
            fileElementId: $e.attr("id"),
            dataType: 'json',
            data: {},
            type: "post",
            success: function (result) {
                if (result.BImage != "" && result.SImage != "") {
                    $ee.attr("src", result.SImage);
                    $(".vwPicture").show();
                    $smallImage.val(result.SImage);
                    $image.val(result.BImage);
                } else {
                    alert("上传失败！");
                }
            }
        })
    }

    $("#GetRuleGUID").blur(function () {
        $.ajax({
            type: "POST",
            url: "/RecommendGetGiftConfig/GetCoupon",
            data: {
                "guidOrId": $("#GetRuleGUID").val()
            },
            dataType: "JSON",
            success: function (result) {
                console.log(JSON.stringify(result))
                if (result) {
                    $("#CouponName").val(result.Name);
                    $("#GetRuleGUID").val(result.GetRuleGUID);
                    $("#CouponEndTime").val(result.CouponEndTime);
                    $("#CouponDuration").val(result.CouponDuration);
                    $("#CouponId").val(result.PKID);
                } else {
                    $("#CouponName").val("");
                    $("#GetRuleGUID").val("");
                    $("#CouponEndTime").val("");
                    $("#CouponDuration").val("");
                    $("#CouponId").val("");
                }
            },
            error: function (result) {

            }
        });
    })
</script>