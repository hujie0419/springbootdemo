@{
    ViewBag.Title = "轮胎限购黑名单管理";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section head{
    <style>
        .top {
            float: left;
            font-size: 16px;
            margin-right: 25px;
        }

            .top > input, .top > select {
                height: 30px;
                font-size: 16px;
            }
    </style>
    <link href="~/Content/sweetalert/sweetalert.css" rel="stylesheet" />
    <link href="~/Content/bootstrap.min.css" rel="stylesheet" />
}
<div class="title">
    <h2>轮胎限购黑名单管理</h2>
</div>

<div class="content">
    <div class="condition">
        <div class="top">
            <span>操作:</span>
            <select id="operate" style="width:100px;">
                <option value="0" selected="selected">查询</option>
                <option value="1">添加</option>
                <option value="2">日志</option>
            </select>
        </div>
        <div class="top">
            <span>类型:</span>
            <select id="type" style="width:100px;">
                <option value="0" selected="selected">全部</option>
                <option value="1">手机号</option>
                <option value="2">设备号</option>
                <option value="3">支付账号</option>
                <option value="4">用户ID</option>
            </select>
        </div>
        <div class="top">
            <span>参数:</span>
            <input type="text" name="blacknumber" value="" style="width:200px;" />
        </div>
        <div class="top">
            <button onclick="Operate()" class="button_select" style="width: 200px;height: 35px;display: block;">执行</button>
        </div>
        <div style="clear:both"></div>
    </div>
    <div style="margin-bottom:30px">
        每页显示：
        <select class="PageSize">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>条
        <span class="data_count"></span>
        <a href="javascript:void(0)" onclick="UploadBox()">批量上传</a>
    </div>
    <img class="loadimg" src="~/Scripts/layer/skin/default/loading-2.gif" style="margin:5% 50%;display:none;" />
    <div class="list"></div>
</div>

<div id="History" style="display:none;">

</div>

<div id="Upload" style="display:none;">
    <input type="file" id="BlackUpdate" style="margin-top:50px;margin-bottom:50px;"/>
</div>

<script src="~/Content/sweetalert/sweetalert.js"></script>
<script src="~/Scripts/ajaxfileupload.js"></script>
<script>
    $(function () {
        LoadBlackList(1);
        $(".list").on("click", ".pager>a", function (event) {
            event.preventDefault();
            var url = $(this).attr("href");
            if (url) {
                $.post(url, function (html, status) {
                    if (status === "success") {
                        $(".list").html(html);
                    }
                });
            }
        });
        $("#operate").change(function () {
            var operate = $("#operate option:selected").val();
            $("#type").empty();
            if (operate == '1') {
                var html = '<option value="1" selected="selected">手机号</option><option value= "2"> 设备号</option><option value="3">支付账号</option><option value="4">用户ID</option>'
                $("#type").append(html);
            }
            else if (operate == '0') {
                var html = '<option value="0" selected="selected">全部</option><option value= "1"> 手机号</option><option value="2">设备号</option><option value="3">支付账号</option><option value="4">用户ID</option>';
                $("#type").append(html);
            }
            else {
                var html = '<option value="0" selected="selected">全部</option>';
                $("#type").append(html);
            }
        });
        $(".PageSize").change(function () {
            var operate = $("#operate option:selected").val();
            if (operate == "2") {
                LoadBlackListLog(1);
            } else {
                LoadBlackList(1);
            }

        });
    });
</script>
<script>
    LoadBlackList = function (index) {
        $(".loadimg").show();
        var type = $("#type option:selected").val();
        var blacknumber = $("[name=blacknumber]").val().trim();
        $.post("/Tire/TireBlackList2", {
            BlackNumber: blacknumber,
            Type: type,
            PageSize: $(".PageSize option:selected").val(),
            PageIndex: index
        }, function (html, status) {
            if (status === "success") {
                $(".loadimg").hide();
                $(".list").html(html);
                $(".data_count").text('共' + ($(".table").length ? $(".table").attr("data-count") : 0) + '条数据');
            }
        });
    },
        AddTireBlackList = function () {
            var type = $("#type option:selected").val();
            var blacknumber = $("[name=blacknumber]").val().trim();
            $.post("/Tire/AddTireBlackList", {
                BlackNumber: blacknumber,
                Type: type
            }, function (data) {
                if (data == 1) {
                    alert("添加成功");
                    $("#operate").val("1");
                    $("#type").empty();
                    $("#type").append('<option value="0" selected="selected">全部</option><option value= "1"> 手机号</option><option value="2">设备号</option><option value="3">支付账号</option><option value="4">用户ID</option>');
                    $("[name=blacknumber]").val("");
                    $("#type").val("0");
                    LoadBlackList(1);
                }
                else if (data == 2) {
                    alert("数据已存在");
                }
                else {
                    alert("添加失败!");
                }
            });
        },
        DeleteItem = function (blackNumber, type) {
            var msg = "您真的确定要删除吗？\n\n请确认！";
            if (confirm(msg) == false) {
                retrun;
            }
            $.post("/Tire/DeleteTireBlackListItem", {
                BlackNumber: blackNumber,
                Type: type
            }, function (data) {
                if (data == 1) {
                    alert("删除成功");
                    LoadBlackList(1);
                } else {
                    alert("删除失败，请稍后重试");
                }
            });
        },
        Operate = function () {
            var operate = $("#operate option:selected").val();
            if (operate == 1) {
                AddTireBlackList();
            }
            else if (operate == 0) {
                LoadBlackList(1);
            }
            else {
                LoadBlackListLog(1);
            }
        },
        BlackItemhistory = function (BlackNumber) {
            $("#History").empty();
            $.post("/Tire/BlackListItemHistory", {
                BlackNumber: BlackNumber
            }, function (data) {
                if (data.length == 0) {
                    $("#History").append('<p>暂无修改数据</p>');
                }
                else {
                    html = '<table width="100%"><tr><th>BlackNumber</th><th>操作类型</th><th>操作人</th><th>操作时间</th></tr>';
                    for (var i = 0; i < data.length; i++) {
                        var item = data[i];
                        html += '<tr><td>' + item.BlackNumber + '</td><td>' + (item.Type == 1 ? "添加" : "删除") + '</td><td>' + item.Operator + '</td><td>' + FormatTime(item.CreateDateTime) + '</td></tr>';
                    }
                    html += '</table>';
                    $("#History").append(html);
                }
            });
            $("#History").dialog({
                title: "轮胎限购黑名单修改日志",
                width: 800,
                modal: true,
                buttons: {
                    "关闭": function () {
                        $(this).dialog("close");
                    }
                }
            });
        },
        FormatTime = function (strTime) {
            var obj = new Date(parseInt(strTime.replace("/Date(", "").replace(")/", ""), 10));
            return obj.Format("yyyy-MM-ddThh:mm");
        },
        LoadBlackListLog = function (index) {
            $(".loadimg").show();
            var blacknumber = $("[name=blacknumber]").val().trim();
            $.post("/Tire/TireBlackList3", {
                BlackNumber: blacknumber,
                PageSize: $(".PageSize option:selected").val(),
                PageIndex: index
            }, function (html, status) {
                if (status === "success") {
                    $(".loadimg").hide();
                    $(".list").html(html);
                    $(".data_count").text('共' + ($(".table").length ? $(".table").attr("data-count") : 0) + '条数据');
                }
            });
        },
        UploadBox = function () {
        $("#Upload").dialog({
            title: "批量上传数据",
            width: 400,
            modal: true,
            buttons: {
                "下载模板": function () {
                    window.location.href = "/Tire/DownLoadTemp";
                },
                "关闭": function () {
                    $(this).dialog("close");
                },
                "确认": function () {
                    var $target = $("#BlackUpdate");
                    var now = new Date().getTime();
                    $target.attr("id", now);
                    $target.attr("name", now);
                    $.ajaxFileUpload(
                        {
                            url: '/Tire/ImportBlackListData',
                            secureuri: false,
                            fileElementId: now,
                            dataType: 'JSON',
                            type: 'post',
                            async: false,
                            success: function (data, status) {
                                $("#uploadfile").change(function () {
                                    UploadFile();
                                });
                                console.log(data);
                                var result = jQuery.parseJSON(jQuery(data).text());
                                alert(result.Info);
                            }
                        });
                    $(this).dialog("close");
                }
            }
        });
        }

        //UploadFile = function (target) {
        //    var $target = $(target);
        //    var now = new Date().getTime();
        //    $target.attr("id", now);
        //    $target.attr("name", now);
        //    $.ajaxFileUpload(
        //        {
        //            url: '/Tire/ImportBlackListData',
        //            secureuri: false,
        //            fileElementId: now,
        //            dataType: 'JSON',
        //            type: 'post',
        //            async: false,
        //            success: function (data, status) {
        //                $("#uploadfile").change(function () {
        //                    UploadFile();
        //                });
        //                console.log(data);
        //                var result = jQuery.parseJSON(jQuery(data).text());
        //                alert(result.Info);
        //            }
        //        });
        //}
</script>
