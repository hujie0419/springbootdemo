@{     
    ViewBag.Title = "发码权限配置";
    Layout = "~/Views/Shared/_LayoutNew.cshtml";
}
<link rel="stylesheet" href="/Scripts/artDialog6.0.4/css/ui-dialog.css" />
<link rel="stylesheet" href="~/css/beautyPackage.css" type="text/css" />
<link rel="stylesheet" href="~/Content/plugins/select2/select2.min.css" />
<style type="text/css">
    .ui-dialog {
        width: auto;
    }

    .select2-selection__choice {
        color: black;
    }
    .select2-container {
        margin-bottom:10px;
    }

    label.dialoglable {
        width: 20%;
        display: inline-block;
        font-weight: 900;
    }

    div.dialogdiv {
        width: 60%;
        display: inline-block;
    }

    input.inputcls, select.inputcls, textarea.inputcls {
        line-height: 1.42857143;
        width: 100%;
        height: 28px;
        padding: 2px 2px 2px 5px;
        color: #555;
        background-color: #fff;
        background-image: none;
        border: 1px solid #ccc;
        border-radius: 4px;
        -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
        box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
        -webkit-transition: border-color ease-in-out .15s,-webkit-box-shadow ease-in-out .15s;
        -o-transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s;
        transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s;
    }

    div.dialog-content > div {
        padding-top: 5px;
        padding-bottom: 5px;
        height: auto;
        width: 100%;
    }
</style>
<div id="div" v-cloak>
    <h2>
        @*<label>大客户</label>
        <input v-model="filterCondition.phoneNo" placeholder="请输入账号"/>*@
        <input type="button" value="添加" href="javascript:void(0)" v-on:click="EditServiceConfig('')" />
    </h2>
    <div is="pager" :total="total" v-model="pager">
        <table style="" class="table table-striped table-bordered table-hover dataTables-example">
            <thead>
                <tr>
                    <th>序号</th>
                    <th>账号</th>
                    <th>服务</th>
                    <th>发码权限</th>
                    <th>服务码查询</th>
                    <th>核销明细</th>
                    <th>服务码明细查询</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tr v-if="list.length<=0">
                <td colspan="8" style="text-align:center">无数据</td>
            </tr>
            <tr v-if="loading">
                <td colspan="8"><img src="/Images/loading.gif" /></td>
            </tr>
            <tr v-for="(item,index) in list">
                <td>{{++index}}</td>
                <td>{{item.UserMobile}}</td>
                <td>
                    <table v-for="(y,i) in item.CooperateUserServiceDeails">
                        <tr >
                            <td>{{++i}}<span> . </span>{{y.CooperateName}}-{{y.Name}}-{{y.ServiceName}}{{y.SettlementMethod | formatValue}}</td>
                        </tr>
                    </table>
                </td>
                <td>{{[item.UserModuleDetails,'GenerateCode'] | ConvertModuleType}}</td>
                <td>{{[item.UserModuleDetails,'SearchServiceCode'] | ConvertModuleType}}</td>
                <td>{{[item.UserModuleDetails,'SearchVerifyServiceCode'] | ConvertModuleType}}</td>
                <td>{{[item.UserModuleDetails,'ServiceCodeStatement'] | ConvertModuleType}}</td>
                <td>
                    <a href="javascript:void(0)" v-on:click="EditServiceConfig(item.UserId,item.CompanyId,item.CompanyName,item.UserMobile)">编辑</a>
                </td>
            </tr>
        </table>
    </div>
        <artdialog v-if="showdialog" :height="400" v-on:save="save" ref="artdialog" v-on:close="showdialog=false" :buttons="buttons" :title="'套餐产品详情页'">
            <div class="dialog-content" style="overflow:auto;width:100%;height:400px">
                <div style="margin-bottom:10px">
                    <label class="dialoglable">选择大客户：</label>
                    <div class="dialogdiv" v-if="AddShow==true">
                        <select is="select2"  v-model="config.CompanyId" :styles="{'margin-left':'20px',height:'30px'}" :closeonselect="true" 　:options="companyOptions"></select>
                    </div>
                    <div class="dialogdiv" v-else-if="AddShow==false">
                        <input readonly="readonly" style="background:#dfdfdf" v-model="config.CompanyName" class="inputcls"  />
                    </div>
                </div>
                <div>
                    <label class="dialoglable">大客户用户：</label>
                    <div class="dialogdiv" v-if="AddShow==true">
                        <select is="select2" v-model="config.UserId" :styles="{'margin-left':'20px',height:'30px',width:'100%'}" :closeonselect="true" 　:options="accountOptions"></select>
                    </div>
                    <div class="dialogdiv" v-else-if="AddShow==false">
                        <input readonly="readonly" style="background:#dfdfdf"  v-model="config.UserMobile" class="inputcls" />
                    </div>
                </div>
                <div>
                    <label class="dialoglable">服务模板：</label>
                    <div class="dialogdiv">
                        <select is="select2" v-model="config.PackageDetailIds" :styles="{'margin-left':'20px',height:'30px',width:'100%'}" v-bind:multiple="true"　:options="cooperateUserOptions"></select>
                    </div>
                    @*<a style="margin-left:5%" v-on:click="DeleteService(item.Index)">删除</a>*@
                </div>
                @*<div>
                    <label class="dialoglable"></label>
                    <div class="dialogdiv"><input type="button" value="增加" v-on:click="AddService" /></div>
                </div>*@
                <div>
                    <label class="dialoglable">发码权限：</label>
                    <div class="dialogdiv">
                        <span style="width:40%;display:inline-block;">
                            <input type="radio" :value="true" v-model="config.GenerateCode" />是
                        </span>
                        <span style="width:40%;display:inline-block;">
                            <input type="radio" :value="false"  v-model="config.GenerateCode" />否
                        </span>
                    </div>
                </div>
                <div>
                    <label class="dialoglable">核销明细：</label>
                    <div class="dialogdiv">
                        <span style="width:40%;display:inline-block;">
                            <input type="radio" :value="true" v-model="config.SearchVerifyServiceCode" />是
                        </span>
                        <span style="width:40%;display:inline-block;">
                            <input type="radio" :value="false" v-model="config.SearchVerifyServiceCode" />否
                        </span>
                    </div>
                </div>
                <div>
                    <label class="dialoglable">服务码查询：</label>
                    <div class="dialogdiv">
                        <span style="width:40%;display:inline-block;">
                            <input type="radio" :value="true"  v-model="config.SearchServiceCode" />是
                        </span>
                        <span style="width:40%;display:inline-block;">
                            <input type="radio" :value="false"  v-model="config.SearchServiceCode" />否
                        </span>
                    </div>
                </div>
                <div>
                    <label class="dialoglable">服务码明细查询：</label>
                    <div class="dialogdiv">
                        <span style="width:40%;display:inline-block;">
                            <input type="radio" :value="true" v-model="config.ServiceCodeStatement" />是
                        </span>
                        <span style="width:40%;display:inline-block;">
                            <input type="radio" :value="false" v-model="config.ServiceCodeStatement" />否
                        </span>
                    </div>
                </div>
                <div>
                    <label class="dialoglable">备注：</label>
                    <div class="dialogdiv">
                        <textarea v-model="config.Remark" style="height:100px" class="inputcls"></textarea>
                    </div>
                </div>
                @*<div>
                    <label class="dialoglable">生效：</label>
                    <div class="dialogdiv">
                        <span style="width:40%;display:inline-block;">
                            <input type="radio" value="true"  v-model="config.IsActivity" />是
                        </span>
                        <span style="width:40%;display:inline-block;">
                            <input type="radio" value="false"  v-model="config.IsActivity" />否
                        </span>
                    </div>
                </div>*@
            </div>
        </artdialog>
    </div>
@section scripts{
    <script type="text/javascript" src="~/Scripts/vue.min.js"></script>
    <script src="~/Scripts/plugins/select2/select2.full.min.js"></script>
    <script src="/Scripts/artDialog6.0.4/dist/dialog-min.js"></script>
    <script src="/Scripts/artDialog6.0.4/dist/dialog-plus-min.js"></script>
    <script src="~/Scripts/vue.common.js"></script>
    <script type="text/javascript">
        function formatValue(value) {
            var result = value;
            if (value == "" || value == null || value == undefined) {
                result = "/"
            } else if (value == "PreSettled") {
                result = "（买断）";
            } else if (value == "ByPeriod") {
                result = "（据实）";
            }
            return result;
        }
        function ConvertModuleType([data, type]) {
            var result = "关闭";
            for (var i = 0; i < data.length; i++) {
                if (data[i].ModuleType == 'SearchVerifyServiceCode' && type == 'SearchVerifyServiceCode') {
                    result = "开启";
                    break;
                } else if (data[i].ModuleType == 'SearchServiceCode' && type == 'SearchServiceCode') {
                    result = "开启";
                    break;
                } else if (data[i].ModuleType == 'GenerateCode' && type == 'GenerateCode') {
                    result = "开启";
                    break;
                } else if (data[i].ModuleType == "ServiceCodeStatement" && type == 'ServiceCodeStatement') {
                    result = "开启";
                    break;
                }
            }
            return result;
        }

        Vue.filter('ConvertModuleType', ConvertModuleType);
        Vue.filter('formatValue', formatValue);
        var addServiceIndex = 0;
        var vue = new Vue({
            el: "#div",
            data: {
                pager: {
                    index: 1,
                    pages: 0,
                    currentPage: 1,
                    size: 20,
                    inputPage: 0,
                },
                total: 0,
                AddShow: true,
                loading: false,
                showdialog: false,
                companyOptions: [],
                accountOptions: [],
                cooperateUserOptions: [],
                serviceOptions:[],
                sizes: [5, 10, 20, 40, 50, 100, 200],
                list: [],
                filterCondition: {
                    phoneNo: "",
                },
                config: {
                    CompanyId: "0",
                    UserMobile: "",
                    CompanyName:"",
                    UserId: "",
                    Remark: "",
                    PackageDetailIds: [],
                    UserModuleDetails: [],
                    IsActivity: false,
                    SearchVerifyServiceCode: false,
                    SearchServiceCode: false,
                    ServiceCodeStatement:false,
                    GenerateCode: false
                },
                buttons: "",
            },
            created: function () {
                //this.GetAllServiceConfig();
                this.load();
                this.GetAllVipCompany();
            },
            watch: {
                "pager.size": function () {
                    var self = this;
                    if (self.pager.index === 1) {
                        this.load();
                    } else {
                        self.pager.index = 1;
                    }
                },
                "pager.index": function () {
                    this.load();
                },
                "config.CompanyId": function () {
                    var self = this;
                    self.cooperateUserOptions = [];
                    self.accountOptions = [];
                    self.SelectCooperateUserByCompanyId();
                },
            },
            methods: {
                load: function () {
                    var vm = this;
                    vm.loading = true;
                    $.get("GetEnterpriseUserConfig", {
                        pageIndex: vm.pager.index,
                        pageSize: vm.pager.size,
                        userId: "00000000-0000-0000-0000-000000000000"
                    }, function (rsp) {
                        vm.total = rsp.total || 0;
                        vm.list = rsp.data || [];
                        setTimeout(function () {
                            vm.loading = false;
                        }, 200)
                    }).error(function (rsp) {
                        vm.list = [];
                        setTimeout(function () {
                            vm.loading = false;
                        }, 200)
                    });
                },         
                GetAllVipCompany: function () {
                    var self = this;
                    $.get("GetAllVipCompany", function (data) {
                        self.companyOptions = [{
                            id: '0',
                            text: '-请选择-'
                        }];
                        (data || []).forEach(function (v) {
                            self.companyOptions.push({
                                id: v.Id,
                                text: v.Name
                            })
                        })
                    })
                },
                SelectCooperateUserByCompanyId: function () {
                    var self = this;
                    if (self.config.CompanyId > 0) {
                        $.get("SelectCooperateUserByCompanyId", { companyId: self.config.CompanyId }, function (data) {
                            (data.cooperateUser || []).forEach(function (v) {
                                self.cooperateUserOptions.push({
                                    id: v.PackageDetailId,
                                    text: (v.CooperateName + "-" + v.Name + "-" + (v.SettlementMethod == "ByPeriod" ? "(据实)" : "（买断）"))
                                })
                            })
                            self.accountOptions = [{
                                id: '0',
                                text: '-请选择-'
                            }];
                            (data.account || []).forEach(function (v) {
                                self.accountOptions.push({
                                    id: v.UserId,
                                    text: v.UserMobile
                                })
                            })
                        })
                    }
                },
                EditServiceConfig: function (userId, companyId,companyName,userMobile) {
                    var self = this;
                    if (userId != "") {
                        $.get("SelectConfigByUserId", { userId: userId, companyId: companyId }, function (result) {
                            self.AddShow = false;
                            var data = result.data;
                            self.config.CompanyName = companyName;
                            self.cooperateUserOptions = [];
                            (result.cooperateUser || []).forEach(function (v) {
                                self.cooperateUserOptions.push({
                                    id: v.PackageDetailId,
                                    text: (v.CooperateName + "-" + v.Name + "-" + (v.SettlementMethod == "ByPeriod" ? "(据实)" : "（买断）"))
                                })
                            })
                            self.config.UserMobile = userMobile;
                            self.config.UserId = data.UserId;
                            self.config.Remark = data.Remark;
                            self.config.GenerateCode = data.GenerateCode;
                            self.config.SearchVerifyServiceCode = data.SearchVerifyServiceCode;
                            self.config.ServiceCodeStatement = data.ServiceCodeStatement;
                            self.config.SearchServiceCode = data.SearchServiceCode;
                            self.config.PackageDetailIds = data.PackageDetailIds;
                            self.config.UserModuleDetails = [];
                            self.showdialog = true;
                        });
                    } else {
                        self.AddShow = true;
                        self.config.CompanyId = "";
                        self.config.UserMobile = "";
                        self.config.UserId = "";
                        self.config.Remark = "";
                        self.config.PackageDetailIds = [];
                        self.config.UserModuleDetails = [];
                        self.config.IsActivity = false;
                        self.config.GenerateCode = false;
                        self.config.SearchVerifyServiceCode = false;
                        self.config.ServiceCodeStatement = false;
                        self.config.SearchServiceCode = false;
                        self.showdialog = true;
                    } 
                },
                save: function () {
                    var self = this;
                    if (self.config.userId="") {
                        alert("请选择用户");
                        return false;
                    }
                    if (self.config.SearchServiceCode)
                        self.config.UserModuleDetails.push({ModuleType: "SearchServiceCode" })
                    if (self.config.SearchVerifyServiceCode)
                        self.config.UserModuleDetails.push({ ModuleType: "SearchVerifyServiceCode" })
                    if (self.config.GenerateCode)
                        self.config.UserModuleDetails.push({ ModuleType: "GenerateCode" })
                    if (self.config.ServiceCodeStatement)
                        self.config.UserModuleDetails.push({ ModuleType:"ServiceCodeStatement"})
                    //if (self.config.PackageDetailIds.length <= 0) {
                    //    alert("请选择服务模板");
                    //    return false;
                    //}
                    if (confirm("是否确认操作")) {
                        $.post("UsertEnterpriseUserConfig", { data: self.config }, function (result) {
                            if (result.status) {
                                alert("操作成功");
                                self.$refs.artdialog.close();
                                self.load();
                            } else {
                                alert(result.msg);
                            }
                        })
                    }
                },
                AddService: function () {
                    var self = this;
                    addServiceIndex++;
                    self.config.CooperateUserServiceDeails.push({
                        CooperateId:"",
                        Index: addServiceIndex,
                    });
                },
                DeleteService: function (removeIndex) {
                    var self = this;
                    if (self.config.CooperateUserServiceDeails) {
                        self.config.CooperateUserServiceDeails = self.config.CooperateUserServiceDeails.filter(function (v) {
                            return v.Index != removeIndex;
                        })
                    }
                },
                //GetCompanyUsersByCompanyId() {
                //    var self = this;
                //    if (self.config.CompanyId > 0) {
                //        $.get("GetUsersByCompanyId", { companyId: self.config.CompanyId }, function (data) {
                //            self.accountOptions = [{
                //                id: '0',
                //                text: '-请选择-'
                //            }];
                //            (data || []).forEach(function (v) {
                //                self.accountOptions.push({
                //                    id: v.UserId,
                //                    text: v.UserMobile
                //                })
                //            })
                //        })
                //    }
                //},
                //GetAllServiceConfig: function () {
                //    var self = this;
                //    $.get("GetEnterpriseServices", { companyId: self.config.CompanyId }, function (data) {
                //        self.serviceOptions = [{
                //            id: '',
                //            text: '-请选择-'
                //        }];
                //        (data || []).forEach(function (v) {
                //            self.serviceOptions.push({
                //                id: v.PackageDetailId,
                //                text: (v.PackageDetailId + "-" + v.CooperateName + "-" + v.ServiceName + "-" + (v.SettlementMethod == "ByPeriod" ? "据实" : "买断"))
                //            })
                //        })
                //    })
                //},
            },
        });

    </script>
}