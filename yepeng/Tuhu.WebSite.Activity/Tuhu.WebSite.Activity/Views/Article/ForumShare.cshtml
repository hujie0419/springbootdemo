@{
    Layout = null;
}
@using Newtonsoft.Json
@model ForumDetailModel
@{
    ForumUserModel userModel=new ForumUserModel();
    ForumUserModel categoryModel= new ForumUserModel();
    try
    {
        string userInfo = Model.user.data.ToString();
        userModel = JsonConvert.DeserializeObject<ForumUserModel>(userInfo);

        string cateInfo = Model.category.data.ToString();
        categoryModel = JsonConvert.DeserializeObject<ForumUserModel>(cateInfo);
    }
    catch
    {

    }

}
@helper GetShowTime(string time)
{
    if (string.IsNullOrWhiteSpace(time))
    {
        @( "")
    }
    else
    {
        DateTime orginalDateTime;
        string resultTime = "";
        if (DateTime.TryParse(time, out orginalDateTime))
        {
            //1分钟之内
            if ((DateTime.Now - orginalDateTime).TotalSeconds <= 59)
            {
                resultTime = Math.Floor((DateTime.Now - orginalDateTime).TotalSeconds).ToString() + "秒前";
            }
            //1小时之内
            else if ((DateTime.Now - orginalDateTime).TotalHours < 1)
            {
                resultTime = Math.Floor((DateTime.Now - orginalDateTime).TotalMinutes).ToString() + "分钟前";
            }
            //1天之内
            else if ((DateTime.Now - orginalDateTime).TotalDays < 1)
            {
                resultTime = Math.Floor((DateTime.Now - orginalDateTime).TotalHours).ToString() + "小时前";
            }
            //1天之外
            else
            {
                resultTime = time;
            }
        }
        @( resultTime)
    }
}
<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>@(Model?.title)</title>
    <link href="~/Content/forumShare/detailShare.css" rel="stylesheet" />
    <link href="~/Content/forumShare/wxreset.min.css" rel="stylesheet" />
</head>
<body>
    <div class="wrapper">
        <div id="headBarShow">
            <div class="load-tip">
                <a id="backApp1" class="load-tap">
                    <img src="https://res.tuhu.org/react/findDetail/static/media/app.663d56ed.jpg" />
                </a>
            </div>
        </div>
        <!-- 顶部标题 -->
        <div class="headline martop44">
            @(Model?.title)
        </div>
        <!-- 帖子信息 -->
        <div class="postInfo">
            <div class="huitie">@(Model?.reply_count)回帖</div>
            <div class="dot">·</div>
            <div class="liulan">@(Model?.view_count)浏览</div>
            <div class="dot">·</div>
            <div class="laiyuan">来自@(categoryModel?.name)版块</div>
        </div>
        <!-- 帖子正文 -->
        <div class="postMain">
            <div class="postTop">
                <div class="authorImg">
                    <img src="@(userModel?.avatar)">
                </div>
                <div class="postTopCen">
                    <div class="authorName">@(userModel?.name)</div>
                    <div class="postTime">@GetShowTime(Model?.created_at)</div>
                </div>
                <div class="authorId">楼主</div>
            </div>
            <!-- 帖子内容 -->
            <div class="postContent">
                @*<div id="wrapContent">@Html.Raw(Model.body)</div>*@
                @*假结构--------------------------------------------------------------*@
               
                <div id="wrapContent">
                    @{
                        if (Model?.body_original != null && Model.body_original.Count > 0)
                        {
                            foreach (var i in Model.body_original)
                            {
                                if (i.type == "image")
                                {
                                    <p>
                                        <img alt="@i.description" src="@i.content" style="background:url(https://res.tuhu.org/image/public/loading-712.gif) no-repeat center center" data-original="@i.content">
                                        @*添加了span----------------------*@
                                        <span>@i.description</span>
                                    </p>
                                }
                                else
                                {
                                    <p>
                                        @i.content
                                    </p>
                                }
                            }
                        }
                    }
                </div>
                
                <!-- 展开阅读全文按钮 -->
                <div class="showAll">
                    <img src="/Content/images/bgcover.png">
                    <div class="showAllBtn">
                        展开阅读全文
                        <i></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- 评论部分 -->
        <div class="postComment">
            @{
                if (Model != null)
                {
                    @Html.Action("ForumReply", new { id = Model.id })
                }
            }
        </div>
        <!-- 查看更多的按钮 -->
        <div class="readMore">
            <a href="javascript:void(0);" id="backApp2">进入途虎论坛查看更多内容</a>
        </div>
    </div>
    <script src="https://res.tuhu.org/react/jweixin.min.js"></script>
    <script src="https://static.mlinks.cc/scripts/dist/mlink.min.js"></script>
    <script src="https://res.tuhu.org/scripts/zepto.min.js"></script>
    <script src="https://res.tuhu.org/Activity/packing/packing.1.0.0.min.js"></script>
    <script src="https://res.tuhu.org/Scripts/Activity/CommentFile/ta.min.js" type="text/javascript"></script>
    <script src="~/Scripts/CommentFile/OpenApp.js"></script>
    <script type="text/javascript">

        $(function () {
            /*点击“展开阅读全文”，内容显示，按钮和遮罩消失*/
            //$(".showAllBtn").tap(function(event) {
            //	$(".postContent").css('height', 'auto');
            //	$(".showAll").css('display', 'none');
            ////});
            if ($(".postContent").height() > 460) {
                $(".showAll").css('display', 'block');
                $(".postContent").css('height', '460px');
            }
            $(".showAllBtn").click(function () {
                $(".postContent").css('height', 'auto');
                $(".showAll").css('display', 'none');
            });
            $("#wrapContent").find("img").each(function () {
                var imgObj = $(this);
                var src = imgObj.attr("src") || "";
                imgObj.attr({
                    "style": "background:url(http://resource.tuhu.cn/image/public/loading-712.gif) no-repeat center center",
                    "data-original": src
                });
            });
            $("#backApp1,backApp2").click(function () {
                Ta.Run("home_click_打开论坛app", "event");
            });
            //PV
            Ta.Run("pageview", "pv");
        });
    </script>
    <script>
        var shareModel = {
            Title: "@(Model?.title)",
            Link: location.href,
            ImageUrl: GetShareImage(),
            Description: GetDesc()
        };

        function GetDesc() {
            var str = $("#wrapContent").html().replace(/<\/?.+?>/g, "");
            if (str.length > 50) {
                str = str.substring(0, 50) + "...";
            }
            return str;
        };
        function GetShareImage() {
            var contentImages = $("#wrapContent img");
            if (contentImages.length > 0) {
                return contentImages[0].src;
            }
            return "https://img1.tuhu.org/hushuo/uploads/avatars/4Jr9hPBlSFxGl08OSQAwzIL2X26RJmF7.jpg";
        };
        $(function () {
            $.ajax({
                url: 'https://wx.tuhu.cn/home/GetWxJsApiParams?url=' + location.href.split("?")[0] + "?" + encodeURIComponent(location.href.split("?")[1]),
                type: "GET",
                dataType: "jsonp",
                data: {},
                jsonp: "_GetWxJsApiParams_",
                async: false,
                success: function (data) {
                    try {
                        var params = JSON.parse(data);
                        WxConfig(params, shareModel);
                    } catch (e) {
                        console.log(e);
                    }
                }
            });
        });

        function WxConfig(parameters, data) {
            wx.config({
                debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                appId: parameters.appid, // 必填，公众号的唯一标识
                timestamp: parameters.timestamp, // 必填，生成签名的时间戳
                nonceStr: parameters.nonceStr, // 必填，生成签名的随机串
                signature: parameters.signature,// 必填，签名，见附录1
                jsApiList: ["onMenuShareTimeline", "onMenuShareAppMessage"] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
            });

            wx.ready(function () {
                wx.onMenuShareAppMessage({
                    title: data.Title,
                    desc: data.Description,
                    link: data.Link,
                    imgUrl: data.ImageUrl,
                    success: function () {

                    },
                    cancel: function () {

                    }
                });

                wx.onMenuShareTimeline({
                    title: data.Title,
                    desc: data.Description,
                    link: data.Link,
                    imgUrl: data.ImageUrl,
                    success: function () {

                    },
                    cancel: function () {

                    }
                });
            });
        }

    </script>
</body>
</html>
