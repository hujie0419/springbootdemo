<?xml version="1.0" encoding="utf-8" ?>
<configuration>
    <configSections>
        <section name="log4net" type="log4net.Config.Log4NetConfigurationSectionHandler, log4net" />
    </configSections>
    <log4net>
        <root>
            <level value="INFO" />
            <appender-ref ref="AmqpAppender" />
            <appender-ref ref="ErrorHandlerAppender" />
            <appender-ref ref="SentryAppender" />
        </root>
        <logger name="PerformanceLogger" additivity="false">
            <level value="INFO" />
            <appender-ref ref="PerformanceAppender" />
        </logger>
        <logger name="ErrorHandlerLogger" additivity="false">
            <level value="INFO" />
            <appender-ref ref="ErrorHandlerAppender" />
        </logger>
        <renderer renderingClass="Tuhu.Log.ExceptionRenderer, Tuhu.Log" renderedClass="System.Exception, mscorlib" />
        <appender name="AmqpAppender" type="Tuhu.Log.KafkaAppender, Tuhu.Log">
            <server value="wcf.tuhu.work:19092" />
            <topic type="log4net.Layout.PatternLayout">
                <conversionPattern value="servicelog" />
            </topic>
            <bodyProperties>
                <property>
                    <name value="requestid" />
                    <layout type="Tuhu.Log.RequestIDLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="host" />
                    <layout type="Tuhu.Log.MachineNameLayout, Tuhu.Log" />
                </property>
                <property>
                    <name value="datetime" />
                    <layout type="log4net.Layout.RawTimeStampLayout" />
                </property>
                <property>
                    <name value="level" />
                    <layout type="log4net.Layout.PatternLayout">
                        <conversionPattern value="%level" />
                    </layout>
                </property>
                <property>
                    <name value="logger" />
                    <layout type="log4net.Layout.PatternLayout">
                        <conversionPattern value="%logger" />
                    </layout>
                </property>
                <property>
                    <name value="message" />
                    <!--<layout type="Tuhu.Log.MixMessageLayout, Tuhu.Log" />-->
                    <layout type="log4net.Layout.PatternLayout">
                        <conversionPattern value="%message" />
                    </layout>
                </property>
                <property>
                    <name value="exception" />
                    <layout type="log4net.Layout.ExceptionLayout" />
                </property>
                <property>
                    <name value="item" />
                    <layout type="log4net.Layout.PatternLayout">
                        <conversionPattern value="servicelog" />
                    </layout>
                </property>
            </bodyProperties>
        </appender>
        <appender name="ErrorHandlerAppender" type="Tuhu.Log.RabbitMQAppender, Tuhu.Log">
            <!--<rabbitMQSection value="rabbitmq" />-->
            <appId value="Tuhu.Service.Hosting" />
            <exchangeProperties>
                <name value="topic.loggingExchage" />
                <exchangeType value="topic" />
                <durable value="false" />
                <binding>
                    <destination value="topic.servicelogExchage" />
                    <topic value="error.service.#" />
                </binding>
            </exchangeProperties>
            <messageProperties>
                <appId value="Tuhu.Service.Hosting" />
                <topic type="log4net.Layout.PatternLayout">
                    <conversionPattern value="error.service" />
                </topic>
                <contentType type="log4net.Layout.PatternLayout">
                    <conversionPattern value="application/json" />
                </contentType>
                <persistent value="false" />
                <priority type="log4net.Layout.PatternLayout">
                    <conversionPattern value="0" />
                </priority>
                <ExtendedData value="false" />
            </messageProperties>
            <bodyProperties>
                <property>
                    <name value="Host" />
                    <layout type="Tuhu.Log.MachineNameLayout, Tuhu.Log" />
                </property>
                <property>
                    <name value="RequestID" />
                    <layout type="Tuhu.Log.RequestIDLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="RemoteName" />
                    <layout type="Tuhu.Log.RemoteNameLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="RemoteEndpoint" />
                    <layout type="Tuhu.Log.RemoteEndpointLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="ServiceType" />
                    <layout type="Tuhu.Log.ServiceTypeLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="ServiceAction" />
                    <layout type="Tuhu.Log.ServiceActionLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="RequestParameters" />
                    <layout type="Tuhu.Log.RequestParametersLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="Message" />
                    <layout type="log4net.Layout.PatternLayout">
                        <conversionPattern value="%message" />
                    </layout>
                </property>
                <property>
                    <name value="Exception" />
                    <layout type="log4net.Layout.ExceptionLayout" />
                </property>
            </bodyProperties>
            <filter type="log4net.Filter.LevelRangeFilter">
                <param name="LevelMin" value="ERROR" />
                <param name="LevelMax" value="FATAL" />
            </filter>
        </appender>
        <appender name="PerformanceAppender" type="Tuhu.Log.KafkaAppender, Tuhu.Log">
            <server value="wcf.tuhu.work:19092" />
            <topic type="log4net.Layout.PatternLayout">
                <conversionPattern value="performance.service" />
            </topic>
            <bodyProperties>
                <property>
                    <name value="host" />
                    <layout type="Tuhu.Log.MachineNameLayout, Tuhu.Log" />
                </property>
                <property>
                    <name value="datetime" />
                    <layout type="log4net.Layout.RawTimeStampLayout" />
                </property>
                <property>
                    <name value="requestid" />
                    <layout type="Tuhu.Log.RequestIDLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="remotename" />
                    <layout type="Tuhu.Log.RemoteNameLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="remoteendpoint" />
                    <layout type="Tuhu.Log.RemoteEndpointLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="servicetype" />
                    <layout type="Tuhu.Log.ServiceTypeLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="serviceaction" />
                    <layout type="Tuhu.Log.ServiceActionLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="requestparameters" />
                    <layout type="Tuhu.Log.RequestParametersLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="returnvalue" />
                    <layout type="Tuhu.Log.ReturnValueLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="elapsedmilliseconds" />
                    <layout type="Tuhu.Log.MixMessageLayout, Tuhu.Log" />
                </property>
                <property>
                    <name value="item" />
                    <layout type="Tuhu.Log.LogWeekPatternLayout, Tuhu.Log">
                        <conversionPattern value="serviceperformance-%week" />
                    </layout>
                </property>
            </bodyProperties>
        </appender>
        <appender name="ElasticsearchAppender" type="Tuhu.Log.ElasticsearchAppender, Tuhu.Log">
            <bufferSize value="2" />
            <connectionString value="Elasticsearch" />
            <timeout value="3000" />
            <index value="logstash-inspector-serviceperformance" />
            <rollingFormat value="yyMMdd" />

            <bodyProperties>
                <property>
                    <name value="host" />
                    <layout type="Tuhu.Log.MachineNameLayout, Tuhu.Log" />
                </property>
                <property>
                    <name value="datetime" />
                    <layout type="log4net.Layout.RawTimeStampLayout" />
                </property>
                <property>
                    <name value="requestid" />
                    <layout type="Tuhu.Log.RequestIDLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="remotename" />
                    <layout type="Tuhu.Log.RemoteNameLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="remoteendpoint" />
                    <layout type="Tuhu.Log.RemoteEndpointLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="servicetype" />
                    <layout type="Tuhu.Log.ServiceTypeLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="serviceaction" />
                    <layout type="Tuhu.Log.ServiceActionLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="requestparameters" />
                    <layout type="Tuhu.Log.RequestParametersLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="returnvalue" />
                    <layout type="Tuhu.Log.ReturnValueLayout, Tuhu.Service" />
                </property>
                <property>
                    <name value="elapsedmilliseconds" />
                    <layout type="Tuhu.Log.MixMessageLayout, Tuhu.Log" />
                </property>
            </bodyProperties>
        </appender>
        <appender name="SentryAppender" type="TuhuRaven.Log4Net.SentryAppender, TuhuRaven">
            <DSN value="http://9e6f8e8453214ca090dc084e3d5a6a0c:36f8c825c3374e7b855bece7747dec5d@netscaler.ad.tuhu.cn:9000/2" />
            <Logger value="Tuhu.Service.Hosting" />
            <Timeout value="100" />
            <threshold value="ERROR" />
            <layout type="log4net.Layout.PatternLayout">
                <conversionPattern value="%5level - %message%newline" />
            </layout>
        </appender>
        <appender name="EventLogAppender" type="log4net.Appender.EventLogAppender" >
            <applicationName value="Tuhu.Service.Hosting" />
            <layout type="log4net.Layout.PatternLayout">
                <conversionPattern value="%exception" />
            </layout>
        </appender>
    </log4net>
</configuration>
