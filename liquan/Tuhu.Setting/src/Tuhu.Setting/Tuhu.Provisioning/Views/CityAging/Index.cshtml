<head>
    <meta name="viewport" content="width=device-width" />
    <title>inex</title>
    <script src="~/Scripts/vue.min.js"></script>
    <script src="~/Scripts/iview/iview.min.js"></script>
    <link href="~/Content/nfine/js/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <script src="~/Content/listmenu/js/jquery.min.js"></script>
    <script src="~/Content/ProductVehicleType/js/bootstrap.min.js"></script>
    <script src="https://file-tuhu-cn.alikunlun.com/yewu/oms/scripts/md503.js" type="text/javascript"></script>
    <script src="https://file-tuhu-cn.alikunlun.com/yewu/oms/scripts/verifyBtn.js" type="text/javascript"></script>
    <link href="~/Content/iview/iview.css" rel="stylesheet" />
    <style>
        .ivu-table .demo-table-info-row td {
            background-color: #2db7f5;
            color: #fff;
        }

        .ivu-table .demo-table-error-row td {
            background-color: #ff6600;
            color: #fff;
        }

        .ivu-table td.demo-table-info-column {
            background-color: #2db7f5;
            color: #fff;
        }

        .ivu-table .demo-table-info-cell-name {
            background-color: #2db7f5;
            color: #fff;
        }

        .ivu-table .demo-table-info-cell-age {
            background-color: #ff6600;
            color: #fff;
        }

        .ivu-table .demo-table-info-cell-address {
            background-color: #187;
            color: #fff;
        }

        [v-cloak] {
            display: none;
        }

        .comments {
            width: 100%; /*自动适应父布局宽度*/
            overflow: auto;
            word-break: break-all;
            /*在ie中解决断行问题(防止自动变为在一行显示，主要解决ie兼容问题，ie8中当设宽度为100%时，文本域类容超过一行时，
            当我们双击文本内容就会自动变为一行显示，所以只能用ie的专有断行属性“word-break或word-wrap”控制其断行)*/
        }
    </style>
</head>
<body>
    <div class="container-fluid">

        <div style="text-align: center; margin: 0px 0 30px 0 ">
            <h1 style="margin-top: 50px">时效开关及城市通告</h1>
        </div>
        <div id="app" style="margin-left:10px;margin-right:10px;" v-cloak>
            <div>

                省：<i-select v-model="province" style="width:200px" placeholder="请选择" v-on:on-change="provinceChange(province)">
                    <i-option v-for="item in provinceList" :value="item.province" :key="item.name">{{ item.name }}</i-option>
                </i-select>
                市： <i-select v-model="city" style="width:200px" placeholder="请选择">
                    <i-option v-for="item in cityList" :value="item.city" :key="item.name">{{ item.name }}</i-option>
                </i-select>

                <i-button type="primary" icon="ios-search" v-on:click="searchPage">查询</i-button>
                <i-button v-on:click="handleSelect()" class="ivu-btn ivu-btn-success">批量编辑</i-button>
                <i-button v-on:click="updateCache()" class="ivu-btn ivu-btn-success">更新缓存</i-button>
            </div>
            <br />
            <i-table :data="tableData1" :columns="tableColumns1" id="tableList" stripe></i-table>
            <div style="margin: 10px;overflow: hidden">
                <div style="float: right;">
                    <Page :total="totalCount" :current="currentPage" :page-size="pageSize" show-total v-on:on-change="changePage"></Page>
                </div>
            </div>
            <!-- 批量编辑Modal -->
            <div class="modal fade" id="ruleModelBulk" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="ruleModelBulkLabel">批量编辑</h4>
                        </div>
                        <div>
                            <div class="modal-body">
                                <form>
                                    <Spin fix v-show="loading">正在保存中，请不要重复点击保存!</Spin>
                                    <div class="form-group">
                                        <Checkbox v-model="IsShowCheck"></Checkbox>&nbsp;&nbsp;<i-label>时  效：</i-label>
                                        <i-select v-model="IsShow" style="width: 100px" :disabled="!IsShowCheck">
                                            <i-option v-for="item in List" v-bind:value="item.value">{{ item.label }}</i-option>
                                        </i-select>


                                    </div>
                                    <i-label>* 时效开关控制此地区是否展示当日达、次日达、预计到达时间等信息。</i-label>

                                    <div class="form-group">
                                        <Checkbox v-model="TitleCheck"></Checkbox>&nbsp;&nbsp; <i-label>通告标题：</i-label>
                                        <i-input type="text" v-model="Title" :disabled="!TitleCheck"  clearable  />
                                    </div>
                                    <div class="form-group">
                                        <Checkbox v-model="ContentCheck"></Checkbox>&nbsp;&nbsp; <i-label>通  告：</i-label>

                                        <i-input v-model="Content" :disabled="!ContentCheck" type="textarea" :rows="4"  />


                                    </div>
                                    * 通告内容将展示在下单页
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                                <button type="button" class="btn btn-primary" v-on:click="Save">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 编辑Modal -->
        <div class="modal fade" id="ruleModel" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="ruleModalLabel">编辑</h4>
                    </div>
                    <div id="app2">
                        <div class="modal-body">
                            <form>
                                <Spin fix v-show="loading">正在保存中，请不要重复点击保存!</Spin>
                                <div class="form-group" id="pCity">
                                    <h5> <i-label>省:{{ProvinceName}}</i-label>&nbsp&nbsp&nbsp&nbsp <i-label>市:{{CityName}}</i-label></h5>
                                </div>
                                <div class="form-group">
                                    <i-label>时  效：</i-label>
                                    <i-select v-model="IsShow" style="width: 100px">
                                        <i-option v-for="item in List" v-bind:value="item.value">{{ item.label }}</i-option>
                                    </i-select>
                                    <br />
                                    <i-label>* 时效开关控制此地区是否展示当日达、次日达、预计到达时间等信息。</i-label>
                                </div>
                                <div class="form-group">
                                    <i-label>通告标题：</i-label>
                                    <i-input type="text" v-model="Title"  clearable />
                                </div>
                                <div class="form-group">
                                    <i-label>通  告：</i-label>
                                    <i-input v-model="Content"  type="textarea" :rows="4"   />
                                    <br /> * 通告内容将展示在下单页
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                            <button type="button" class="btn btn-primary" v-on:click="Save">保存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    var vm2 = new Vue({
        el: '#app2',
        data() {
            return {
                loading: false,
                Pid: "",
                ProvinceId: "",
                ProvinceName: "",
                CityId: "",
                CityName: "",
                Content: '',
                Title: '',
                IsShow: '',
                List: [
                    {
                        value: '0',
                        label: '否'
                    },
                    {
                        value: '1',
                        label: '是'
                    }
                ]
            }
        },
        mounted: function () {

        },
        methods: {
            Save: function () {
                _this = this;
                if (_this.CityName == "") {
                    alert("城市必填！");
                    return;
                }
                $.ajax({
                    url: "/CityAging/SaveCityAging",
                    type: "post",
                    async: true,
                    beforeSend: function () {
                        _this.loading = true;
                    },
                    data: {
                        PKid: _this.PKid,
                        CityId: _this.CityId,
                        CityName: _this.CityName,
                        IsShow: _this.IsShow,
                        Title: _this.Title,
                        Content: _this.Content
                    },
                    success: function (data) {
                        _this.loading = false;
                        if (data) {
                            if (data.Status) {
                                $('#ruleModel').modal('hide');
                                vm.searchPage();
                                alert('保存成功！');
                            } else {
                                alert(data.Msg);
                            }
                        }
                        else {
                            alert('保存失败！');
                        }

                    },
                    error: function () {
                        alert("服务端异常！");
                    },
                    complete: function () {
                        _this.loading = false;
                    }
                });
            }

        }

    });

    var vm = new Vue({
        el: '#app',
        data() {
            return {
                loading: false,
                IsShowCheck: "",
                TitleCheck: "",
                ContentCheck: "",
                Pid: "",
                ProvinceId: "",
                ProvinceName: "",
                CityId: "",
                CityName: "",
                Content: '',
                Title: '',
                IsShow: '1',
                List: [
                    {
                        value: '0',
                        label: '否'
                    },
                    {
                        value: '1',
                        label: '是'
                    }
                ],
                tableData1: this.GetDataList(),
                tableColumns1: [
                    {
                        type: 'selection',
                        width: 60,
                        align: 'center'
                    },
                    {
                        title: '省',
                        key: 'ProvinceName'
                    },
                    {
                        title: '市',
                        key: 'CityName'
                    },
                    {
                        title: '是否展示时效信息',
                        key: 'IsShow'
                    },
                    {
                        title: '通告标题',
                        key: 'Title'
                    },
                    {
                        title: '通告栏',
                        key: 'Content'
                    },
                    {
                        title: '操作',
                        key: 'action',
                        width: 260,
                        align: 'center',
                        render: (h, params) => {
                            return h('div',
                                [
                                    h('Button',
                                        {
                                            props: {
                                                type: 'primary',
                                                size: 'small'
                                            },
                                            style: {
                                                marginRight: '5px'
                                            },
                                            on: {
                                                click: () => {
                                                    this.edit(params.index);
                                                }
                                            }
                                        },
                                        '编辑'),
                                    h('Button',
                                        {
                                            props: {
                                                type: 'primary',
                                                size: 'small'
                                            },
                                            on: {
                                                click: () => {
                                                    this.getlog(params.index);
                                                }
                                            }
                                        },
                                        '查看日志')
                                ]);
                        }
                    }
                ],
                province: "",
                city: "",
                provinceList: [
                    {
                        province: 0,
                        name: '请选择'
                    }
                ],
                cityList: [
                    {
                        city: 0,
                        name: '请选择'
                    }
                ],
                currentPage: 1,
                pageSize: 20,
                totalCount: 1
            }
        },
        mounted: function () {
            this.GetDataList();
            this.getProvinces();
        },
        methods: {
            getProvinces() {
                var _this = this;
                $.ajax({
                    url: "/LimitAreaSale/SelectAllProvince",
                    type: "post",
                    async: false,
                    data: {},
                    success: function (data) {
                        if (data != null && data.length > 0) {
                            $(data).each(function (i, e) {
                                _this.provinceList.push({
                                    name: e.ProvinceName,
                                    province: e.ProvinceId
                                });
                            });
                        } else {
                            _this.$Notice.warning({
                                title: '获取省信息异常！',
                                desc: '获取省信息异常！'
                            });
                        }
                    },
                    error: function () {
                        alert("服务端异常！");
                    }
                });
            },
            provinceChange(e) {
                var _this = this;
                //var exist = this.areaData.filter(function (x) { return x.provinceId == e.provinceId; });
                if (e != 0) {
                    $.ajax({
                        url: "/LimitAreaSale/GetAllCitys",
                        type: "post",
                        async: false,
                        data: {
                            ProvinceId: e
                        },
                        beforeSend: function () {
                            _this.cityList = [
                                {
                                    city: 0,
                                    name: '请选择'
                                }
                            ];
                        },
                        success: function (data) {
                            if (data != null && data.length > 0) {
                                $(data).each(function (i, x) {
                                    _this.cityList.push({
                                        name: x.name,
                                        city: x.id,
                                    });
                                });
                            } else {
                                _this.$Notice.warning({
                                    title: '获取省市信息异常！',
                                    desc: '获取省市信息异常！'
                                });
                            }
                        },
                        error: function () {
                            alert("服务端异常！");
                        }
                    });

                }


            },
            GetDataList() {
                var data1 = [];

                var currentpage = this.currentPage;
                if (!currentpage) {
                    currentpage = 1;
                }
                var pagesize = this.pageSize;
                if (!pagesize) {
                    pagesize = 20;
                }

                var city = this.city;
                if (!city) {
                    city = 0;
                }
                var province = this.province;
                if (!province) {
                    province = 0;
                }

                var postData = {
                    PageIndex: currentpage,
                    PageSize: pagesize,
                    City: city,
                    Province: province
                };
                $.ajax({
                    url: "/CityAging/CityAgingSearch",
                    type: "post",
                    async: false,
                    data: postData,
                    success: function (data) {
                        if (data != null) {
                            $(data.Item2).each(function (i, e) {
                                data1.push({
                                    PKid: e.PKid,
                                    ProvinceId: e.ProvinceId,
                                    ProvinceName: e.ProvinceName,
                                    CityId: e.CityId,
                                    CityName: e.CityName,
                                    IsShow: e.IsShow == 0 ? "否" : "是",
                                    Title: e.Title,
                                    Content: e.Content
                                });
                            });
                            total = data.Item1;
                        }
                    },
                    error: function () {
                        alert("服务端异常！");
                    }
                });
                this.totalCount = total;
                return data1;
            },
            changePage(page) {
                // The simulated data is changed directly here, and the actual usage scenario should fetch the data from the server
                this.currentPage = page;
                this.tableData1 = this.GetDataList();
            },
            searchPage() {
                this.tableData1 = this.GetDataList();
            },
            edit(a) {
                $('#ruleModel').modal('show');
                vm2.PKid = this.tableData1[a].PKid;
                vm2.IsShow = this.tableData1[a].IsShow === "是" ? "1" : "0";
                vm2.CityId = this.tableData1[a].CityId;
                vm2.CityName = this.tableData1[a].CityName;
                vm2.ProvinceId = this.tableData1[a].ProvinceId;
                vm2.ProvinceName = this.tableData1[a].ProvinceName;
                vm2.Title = this.tableData1[a].Title;
                vm2.Content = this.tableData1[a].Content;

            },
            getlog(a) {
                var item = this.tableData1[a];
                window.location.href = '/CityAging/CityAgingConfigLog?logId=' + item.CityId;
            },
            handleSelect() {

                _this = this;
                _this.IsShowCheck = false;
                _this.TitleCheck = false;
                _this.ContentCheck = false;
                _this.Title = "";
                _this.Content = "";
              

                var dom = $("#tableList .ivu-checkbox-input");
                var cityArray = [];
                dom.each(function (i, e) {
                    if (i != 0) {
                        if ($(this).is(':checked')) {
                            var index = i - 1;
                            var city = {
                                PKid: vm.tableData1[index].PKid,
                                CityId: vm.tableData1[index].CityId,
                                CityName: vm.tableData1[index].CityName,
                                Title: _this.Title,
                                Content: _this.Content,
                                IsShow: _this.IsShow
                            };
                            cityArray.push(city);
                        }
                    }
                });
                if (cityArray.length == 0) {
                    alert("请选择要编辑的数据！");
                    return;
                }
                $('#ruleModelBulk').modal('show');
            },
            Save() {
                _this = this;
                if (!_this.IsShowCheck && !_this.TitleCheck && !_this.ContentCheck) {
                    return;
                }

                var isShow = _this.IsShowCheck ? _this.IsShow : -1;
                var title = _this.TitleCheck ? _this.Title : "-1";
                var content = _this.ContentCheck ? _this.Content : "-1";

                var array = [];
                var dom = $("#tableList .ivu-checkbox-input");
                dom.each(function (i, e) {
                    if (i != 0) {
                        if ($(this).is(':checked')) {
                            var index = i - 1;
                            var city = {
                                PKid: vm.tableData1[index].PKid,
                                CityId: vm.tableData1[index].CityId,
                                CityName: vm.tableData1[index].CityName,
                                Title: title,
                                Content: content,
                                IsShow: isShow
                            };
                            array.push(city);
                        }
                    }
                });
                $.ajax({
                    url: "/CityAging/SaveCityAgingBulk",
                    type: "post",
                    async: true,
                    dataType: "json",
                    contentType: 'application/json',
                    beforeSend: function () {
                        _this.loading = true;
                    },
                    data: JSON.stringify(array),
                    success: function (data) {
                        _this.loading = false;
                        if (data) {
                            if (data.Status) {
                                $('#ruleModelBulk').modal('hide');
                                vm.searchPage();
                                alert('保存成功！');
                            } else {
                                alert(data.Msg);
                            }
                        }
                        else {
                            alert('保存失败！');
                        }

                    },
                    error: function () {
                        alert("服务端异常！");
                    },
                    complete: function () {
                        _this.loading = false;
                    }
                });
            },
            updateCache() {
                $.ajax({
                    url: "/CityAging/UpdateCache",
                    type: "post",
                    async: true,
                    success: function (data) {
                        if (data) {
                            if (data.Status) {                 
                                alert('更新缓存成功！');
                            } else {
                                alert(data.Msg);
                            }
                        }
                        else {
                            alert('保存失败！');
                        }
                    },
                    error: function () {
                        alert("服务端异常！");
                    }
                    
                });

            }
        }

    });

</script>
