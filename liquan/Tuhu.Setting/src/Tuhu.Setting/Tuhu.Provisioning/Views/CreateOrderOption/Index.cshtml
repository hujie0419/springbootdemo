@using Tuhu.Provisioning.Models
@model List<Tuhu.Provisioning.DataAccess.Entity.TireCreateOrderOptionsConfigModel>
    @{
        ViewBag.Title = "轮胎下单可选项后台";
        Layout = "~/Views/Shared/_Layout.cshtml";
    }
    @section head{
        <link href="~/Content/nfine/js/bootstrap/bootstrap.min.css" rel="stylesheet" />
        <link href="~/Content/ProductVehicleType/css/bootstrap-datetimepicker.css" rel="stylesheet" />
    }
    <script src="https://file-tuhu-cn.alikunlun.com/yewu/oms/scripts/md503.js" type="text/javascript"></script>
    <script src="https://file-tuhu-cn.alikunlun.com/yewu/oms/scripts/verifyBtn.js" type="text/javascript"></script>
    <div class="page-header">
        <h2>轮胎下单可选项后台</h2>
    </div>
<div class="container-fluid">
    <button type="button" class="btn btn-primary"  onclick="Refresh()" style="margin-bottom: 10px;">
        刷新缓存
        <span class="glyphicon glyphicon glyphicon-refresh" aria-hidden="true"></span>
    </button>
    <table class="table table-striped table-bordered table-hover">
        <tr>
            <th>类型</th>
            <th>是否启用</th>
            <th>产品pid</th>
            <th>产品名称</th>
            <th>产品价格 </th>
            <th>是否需要自动读取上下架状态</th>
            <th>服务PID</th>
            <th>服务价格</th>
            <th>是否自动计算运费</th>
            <th>操作</th>
            <th>操作日志</th>
            <th>特殊规则</th>
        </tr>
        @foreach (var item in Model)
        {
            <tr>
                <td>
                    @(item.Type == 0 ? "四轮定位" : @item.Type == 1 ? "胎压监测" : @item.Type == 2?"铝合金气门嘴":"小保养套餐")
                </td>
                <td>
                    @(item.Status==0?"禁用":"启用")
                </td>
                <td>
                    @item.Pid
                </td>
                <td>
                    @item.ProductName
                </td>
                <td>
                    @item.ProductPrice
                </td>
                <td>
                    @(item.IsAuto == 0 ? "否" : "是")
                </td>
                <td>
                    @item.ServicePid
                </td>
                <td>
                    @item.ServicePrice
                </td>
                <td>
                    @(item.HasFreight == 0 ? "否" : "是")
                </td>
                <td>
                    <a href="javascript:void(0)" onclick="Edit('@item.Id',false) ">修改</a>
                </td>
                <td>
                    <a href="javascript:void(0)" onclick="Log('@item.Id') ">操作日志</a>
                </td>
                <td>
                    <a href="javascript:void(0)" onclick="Rule('@item.Id') ">特殊规则</a>
                </td>
            </tr>
        }
    </table>
    <!-- 特殊规则Modal -->
    <div class="modal fade" id="ruleModel" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="ruleModalLabel">特殊规则</h4>
                </div>
                <div class="modal-body">
                    <table class="table table-striped table-bordered table-hover" id="Products" style="margin-left: 10px;">
                        <thead>
                        <tr class="danger">
                            <th style="text-align: center">Pid</th>
                            <th style="text-align: center">数量</th>
                            <th style="text-align: center">特惠价</th>
                            <th style="text-align: center"><input type="button" value="添加" onclick="Add_Pid();"/> </th>
                        </tr>
                        </thead>
                        <tbody id="PidBody"></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="SavePids()">保存</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                        日志
                    </h4>
                </div>
                <div class="modal-body">

                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <div id="editConfig"></div>
    <div id="log"></div>
    <input type="button" name="name" class="mybutton" onclick="ClickSave()" style="display: none;" value=""/>
</div>
    @section scripts{
        <script src="~/Content/ProductVehicleType/js/bootstrap.min.js"></script>
        @*<script type="text/javascript" src="~/Content/My97DatePicker/WdatePicker.js"></script>*@
               <script src="~/Content/ProductVehicleType/js/bootstrap-datetimepicker.min.js"></script>
               <script src="~/Content/ProductVehicleType/js/bootstrap-datetimepicker.zh-CN.js"></script>
        <script type="text/javascript">
            function Rule(id) {
                var source = [];
                $.ajax({
                    type: "POST",
                    url: "/CreateOrderOption/SelectPids",
                    async: false,
                    data: { id: id },
                    success: function(v) {
                        if (v.status == 1)
                            source = v.data;
                    }
                });
                var $template = $("#PidTemplate").html();
                for (var i = 0; i < source.length; i++) {
                    $("#PidBody").append($template
                        .replace(/{{Pid}}/ig, source[i].Pid)
                        .replace(/{{Num}}/ig, source[i].Num)
                        .replace(/{{Price}}/ig, source[i].Price)
                    );
                }
                $('#ruleModel').data("data_pkid", id);


                $('#ruleModel').modal('show');
            };

            $("#ruleModel").on("hidden.bs.modal",
                function() {
                    $(this).removeData("bs.modal");
                    $("#PidBody").html('');
                });

            function Add_Pid() {
                $("#PidBody").append($("#PidTemplate").html()
                    .replace(/{{Pid}}/ig, "")
                    .replace(/{{Num}}/ig, "")
                    .replace(/{{Price}}/ig, ""));
            }

            function Get_Pids() {
                var items = [];
                $("#Products tbody tr").each(function(i, e) {
                    var _pid = $(e).find("td").eq(0).find("input").val() || "",
                        _num = $(e).find("td").eq(1).find("input").val() || 0;
                    _price = 0;

                    if (_pid.length > 0)
                        items.push({ pid: _pid, num: _num, price: _price });
                });
                return items.length > 0 ? JSON.stringify(items) : null;
            }

            function Del_Pid(obj) {
                if (confirm("确认删除？"))
                    $(obj).parents("tr").remove();
            }

            function SavePids() {
                var value = Get_Pids();
                var id = $('#ruleModel').data("data_pkid");
                $.ajax({
                    type: "POST",
                    url: "/CreateOrderOption/Edit",
                    data: { value: value, id: id },
                    success: function(r) {
                        if (r.state) {
                            alert("保存成功");
                            window.location.href = decodeURI('/CreateOrderOption/Index');
                        } else {
                            alert("保存失败\r\n");
                        }
                    }
                });
                $('#ruleModel').modal('hide');
            }

            function Edit(id, isAdd) {
                $("#editConfig").load('/CreateOrderOption/SelectById?id=' + id);
                $("#editConfig").dialog({
                    title: isAdd ? "新增" : "修改",
                    width: 800,
                    height: 600,
                    modal: true,
                    buttons: {
                        "保存": function() {
                            $(".mybutton").click();
                        },
                        "关闭": function() {
                            $(this).dialog("close");
                        }
                    }
                });
            }
            function Log(id) {
                $('#myModal').modal('show');
                $("#myModal .modal-body").html("").load('/CreateOrderOption/ListBoostrap?objectType=OOption&id='+id);
                //$("#log").load('/Logger/ListLoger?objectType=OrderOption');
                //$("#log").dialog({
                //    title: "查看日志",
                //    width: 1500,
                //    height: 600,
                //    modal: true,
                //    buttons: null                    
                //});
            }

            function Refresh() {
                $.ajax({
                    type: "POST",
                    url: "/CreateOrderOption/RefreshCache",  
                    success: function (r) {
                        alert(r.Msg);
                    }
                });
            }
        </script>
        <script type="text/template" id="PidTemplate">
            <tr class="success">
                <td><input type="text" style="width:200px;" name="Pid" value="{{Pid}}" /></td>
                <td><input type="text" value="{{Num}}" style="width:100px;" name="Num" /></td>
                <td>0</td>
                <td><input type="button" value="删除" onclick="Del_Pid(this);" /></td>
            </tr>
        </script>

    }

