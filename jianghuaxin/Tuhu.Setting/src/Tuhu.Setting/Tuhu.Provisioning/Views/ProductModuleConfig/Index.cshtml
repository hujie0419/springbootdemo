@{
    ViewBag.Title = "商品详情配置";
}
@using Tuhu.Provisioning.Models
@model Tuhu.Component.Common.Models.ListModel<Tuhu.Provisioning.Models.ProductDescriptionViewModel>
    @section head{
        <style>
            table {
                width: 70%;
                text-align: center;
            }

                table tr:hover {
                    background: #DEDEDE;
                }

                table tr th {
                    text-align: center;
                }

            h2 {
                width: 200px;
                color: #333;
                float: left;
            }

            .addPromotion {
                margin-left: 200px;
                color: #08c;
            }

            #Edit {
            }

            .UpdateParent {
                width: 50px;
                height: 25px;
                text-align: center;
                line-height: 25px;
                margin-top: 20px;
                background: rgb(135, 182, 217);
                cursor: pointer;
            }

            .tip {
                color: red;
                font-size: 12px;
                clear: left;
                margin-bottom: 10px;
            }
        </style>
    }
    <script src="https://file-tuhu-cn.alikunlun.com/yewu/oms/scripts/md503.js" type="text/javascript"></script>
    <script src="https://file-tuhu-cn.alikunlun.com/yewu/oms/scripts/verifyBtn.js" type="text/javascript"></script>
    <h2 style="">商品详情配置</h2>
    <h2 class="addproductModule"><a href="/ProductModuleConfig/AddProductDescModule" btnkey="AddproductModule" istuhuverify="1">+新增模块</a></h2>
    <table>
        <tr>
            <td>
                <span>模块类型：</span>
                @Html.DropDownList("IsShow", new SelectListItem[]{
                    new SelectListItem() { Selected = ViewBag.IsAdvert == -1, Value = "-1", Text = "全部" },
                    new SelectListItem() { Selected = ViewBag.IsAdvert == 1, Value = "1", Text = "广告" },
                    new SelectListItem() { Selected = ViewBag.IsAdvert == 0, Value = "0", Text = "非广告" },
                })
            </td>
            <td>
                <span>是否启用：</span>@Html.DropDownList("IsActive", new SelectListItem[]{
                    new SelectListItem() { Selected = ViewBag.IsActive == -1, Value = "-1", Text = "全部" },
                    new SelectListItem() { Selected = ViewBag.IsActive == 0, Value = "0", Text = "启用" },
                    new SelectListItem() { Selected = ViewBag.IsActive == 1, Value = "1", Text = "未启用" },
                })
            </td>
            <td><input type="text" id="PID" value="@ViewBag.PID" placeholder="请输入ProductID" /></td>
            <td><input type="text" id="ModuleName" value="@ViewBag.ModuleName" placeholder="请输入模块的名称"/></td>
            <td><input type="submit" value="搜索" onclick="SearchProductByPID()" /></td>
        </tr>
    </table>
    @if (Model != null)
    {
        <table>
            <tr>
                <th width="14%">按类别</th>
                <th width="6%">按PID</th>
                <th width="13%">PID</th>
                <th width="5%">模块顺序</th>
                <th width="14%">模块名称</th>
                <th width="20%">广告时间</th>
                <th width="8%">显示平台</th>
                <th width="10%">操作历史</th>
                <th width="10%">操作</th>
            </tr>
            @foreach (var p in Model)
            {
                <tr>
                    <td>@(p.ProductConfigDetails.CategoryName == null ? "无" : p.ProductConfigDetails.CategoryName)</td>
                    <td>@(p.ProductConfigDetails.AddOrDel == 0 ? "无" : (p.ProductConfigDetails.AddOrDel == 1 ? "增加PID" : "去除PID"))</td>
                    <td>
                        @if (p.ProductConfigDetails.Pids != null&&p.ProductConfigDetails.Pids.Count()>0)
                        {
                            var pidStr = string.Empty;
                            foreach (var item in p.ProductConfigDetails.Pids)
                            {
                                pidStr += item + ',';
                            }
                            <span>@pidStr</span>
                        }
                        else
                        {
                            <span>无</span>
                        }
                    </td>
                    <td>@p.ModuleOrder</td>
                    <td>@p.ModuleName</td>
                    @if (p.IsAdvertise == false)
                    {
                        <td>未启用</td>
                    }
                    else
                    {
                        <td>@p.StartDateTime-@p.EndDateTime</td>
                    }
                    <td>@(p.PlatfromType == 0 ? "全部" : (p.PlatfromType == 1 ? "仅PC" : "仅手机"))</td>
                    <td><a href="#" onclick="HistoryRecord(@p.ModuleID)">查看历史</a></td>
                    <td>
                        <a href="/ProductModuleConfig/AddProductDescModule?id=@p.ModuleID" btnkey="EditPromotion" istuhuverify="1">编辑</a>
                        <a href="#" onclick="DeleteProductAllInfo(@p.ModuleID)">删除</a>
                    </td>
                </tr>}
        </table>
        <div id="HistoryDisplay"></div>
        <div>
            @{
                var pid = ViewBag.PID;
                var isActive = ViewBag.IsActive;
                var isAdvert = ViewBag.IsAdvert;
                var moduleName = ViewBag.ModuleName;
            }
            @Html.Pager(Model.Pager, pageIndex => Url.RouteUrl(new { pageIndex, pid, isActive, isAdvert,moduleName }))
        </div>
                }
    @section scripts{
        <script>

            function HistoryRecord(moduleID) {
                var content = "";
                $("#HistoryDisplay").empty();
                $.get("/ProductModuleConfig/SelectOprLogByPKID", { id: moduleID }, function (data) {
                    if (data.status == "success") {
                        console.log(data);
                        $(data.data).each(function (index) {
                            var changeDatetime = data_string(data.data[index].ChangeDatetime);
                            content += "<span style='display:block;margin-bottom:5px;'>操作人：" + data.data[index].Author + "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;操作：" + data.data[index].Operation + "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;操作时间：" + changeDatetime + "</span>";
                        })
                    } else {
                        content = "暂无记录";
                    }
                    $("#HistoryDisplay").append(content);

                })

                $("#HistoryDisplay").dialog({
                    title: "操作历史",
                    width: 600,
                    height: 500,
                    modal: true
                });
            }

            function data_string(str) {
                var d = eval('new ' + str.substr(1, str.length - 2));
                var ar_date = [d.getFullYear(), d.getMonth() + 1, d.getDate(), d.getHours(), d.getMinutes(), d.getSeconds()];
                for (var i = 0; i < ar_date.length; i++) ar_date[i] = dFormat(ar_date[i]);
                return ar_date.slice(0, 3).join('-') + ' ' + ar_date.slice(3).join(':');

                function dFormat(i) { return i < 10 ? "0" + i.toString() : i; }
            }


            function DeleteProductAllInfo(pkid) {
                var r = confirm("是否确定保删除信息？");
                if (r) {
                    var data = { PKID: pkid };
                    $.post("/ProductModuleConfig/DeleteProductAllInfo", data, function (result) {
                        if (result > 0) {
                            alert("删除成功！");
                            window.location.reload();
                        }
                    });
                }
            }


            function SearchProductByPID() {
                var isActive = $("#IsActive option:selected").val();
                var isAdvert = $("#IsShow option:selected").val();

                location.href = "/ProductModuleConfig/Index?isActive=" + isActive + "&&pid=" + $("#PID").val() + "&&isAdvert=" + isAdvert+"&&moduleName="+$("#ModuleName").val();
            }
        </script>
    }


