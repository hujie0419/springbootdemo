@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "查看券码";
}

<h2 style="font-size:2em;color:#000;padding:0 0 10px 0;width:250px">查看券码-@ViewBag.Channel</h2>
<link rel="stylesheet" href="/Scripts/artDialog6.0.4/css/ui-dialog.css" />
<style type="text/css">
    .buttonStyle { background: #50c16a; border: none; color: azure; box-shadow: 1px 1px 1px #eee8aa; width: 50px; height: 26px; border-radius: 3px; outline: none; cursor: pointer; font-size: 15px; font-family: "Microsoft Yahei"; }

    .buttonStyle:hover { background-color: #008b8b; border-color: #008b8b; }
    .buttonStyleHidden { background: #808080; }
    .buttonStyleHidden:hover { background: #808080; }
    .ui-dialog { width: auto; }
</style>

<div>
    <form>
        <div>
            <select id="isBind">
                <option value="-1">全部</option>
                <option value="1">已绑定</option>
                <option value="0">未绑定</option>
            </select>
            （共<span class="search-count" style="font-size:small">0</span>条）
            <input type="text" id="count" placeholder="请填写数量"/>
            <input type="button" id="btn_submit" value="生成券码" style="width:80px" class="buttonStyle" onclick="GenerateCode()" />
            <input type="button" id="btn_submit" value="导出数据" style="width:80px" class="buttonStyle" onclick="Export()" />
        </div>
    </form>
    <div id="div_table" style="width:100%;margin-top:10px">
        <table class="tableContainer" style="width:100%;text-align:center;margin-bottom:20px">
            <tr>
                <th style="text-align:center">PKID</th>
                <th style="text-align:center">活动券码</th>
                <th style="text-align:center">手机号</th>
                <th style="text-align:center">创建时间</th>
            </tr>
        </table>
    </div>
    <div id="PageLoadingEffects" style="display:none;">
        <table>
            <tr>
                <td><img src="/Images/loading.gif" /></td>
                <td>玩命加载中，请稍后...</td>
            </tr>
        </table>
    </div>
    @*<input id="pageIndex" type="hidden" value="1" />
    <input id="totalPage" type="hidden" />
    <span class="count">
        <input id="pageNum" type="hidden" value="1" />
        <input id="firstPage" type="button" onclick="Search('1')" value="首页" />
        <input id="lastPage" type="button" onclick="Search('lastPage')" value="上一页" />
        <input id="nextPage" type="button" onclick="Search('nextPage')" value="下一页" />
        <input id="tailPage" type="button" onclick="Search('tailPage')" value="尾页" />
        <input id="skipPage" type="button" value="跳转到" onclick="Search('skipPage')" />
        <input id="jumpPage" type="text" style="width: 30px" />
    </span>
    <span id="PageDetail" class="count"></span>
    <span id="PageDetailTemplate" class="count" style="display: none">
        <label>当前第$pageNum$页</label>
        <label>共$pageCount$页</label>
        <label>共$count$条记录</label>
    </span>*@
</div>
<input value="@ViewBag.ParentId" class="parentId" type="hidden"/>
<input value="@ViewBag.Channel" class="channel" type="hidden"/>
<script src="/Scripts/ajaxfileupload.js"></script>
<script src="/Scripts/artDialog6.0.4/dist/dialog-min.js"></script>
<script src="/Scripts/artDialog6.0.4/dist/dialog-plus-min.js"></script>
<script type="text/javascript">
    $(function () {
        Search(1);
    });

    function GenerateCode() {
        var count = $("#count").val();
        var channel = $(".channel").val();
        var parentId = $(".parentId").val();
        if (count != "") {
            if (!isNaN(count)) {
                if (parseInt(count) < 10000) {
                    if (confirm("是否确认生成")) {
                        $.post("GenerateCouponCode", { channel: channel, count: count, parentId: parentId }, function (result) {
                            if (result.status == "success") {
                                alert("操作成功");
                                Search(1);
                            } else {
                                alert("操作失败");
                            }
                        });
                    }
                } else {
                    alert("每次生成券码的最大数量不能超过10000");
                }
            } else {
                alert("请填写数字")
            }
        } else {
            alert("请填写生成的数量");
        }
    }

    $("#isBind").change(function () {
        Search(1);
    });

    function Search(pageMark) {
        var isBind = $("#isBind").val();
        $(".tableContainer tr:not(:first)").empty();
        $("#PageLoadingEffects").css("display", "block");
        //var pageNum;
        //if (pageMark == null) {
        //    pageNum = parseInt($("#pageIndex").val());
        //} else if (pageMark == 'lastPage') {
        //    pageNum = parseInt($("#pageIndex").val()) - 1;
        //} else if (pageMark == 'nextPage') {
        //    pageNum = parseInt($("#pageIndex").val()) + 1;
        //} else if (pageMark == 'tailPage') {
        //    pageNum = $("#totalPage").val();
        //} else if (pageMark == 'skipPage') {
        //    //if (/^[0-9]*$/.test($("#jumpPage").val()) && $("#jumpPage").val() > 0 && $("#jumpPage").val() <= $("#totalPage").val())
        //    if (/^[0-9]*$/.test(parseInt($("#jumpPage").val())) && parseInt($("#jumpPage").val()) > 0 && parseInt($("#jumpPage").val()) <= parseInt($("#totalPage").val())) {
        //        pageNum = $("#jumpPage").val();
        //    } else {
        //        alert("数据不合法");
        //        return;
        //    }
        //} else {
        //    pageNum = pageMark;
        //}
        //$("#pageIndex").val(pageNum);

        $.get("SelectCouponCodeByParentId", { parentId: $(".parentId").val(),isBind:isBind }, function (result) {
            BindDate(result);
        });
    }

    function BindDate(data) {
        $(".tableContainer tr:not(:first)").empty();
        $("#PageLoadingEffects").css("display", "none");
        $(".search-count").text(data.count);
        var html = "";
        if (data.status == "success") {
            $.each(data.data, function (index) {
                var item = data.data[index];
                html += "<tr><td>" + item.PKID + "</td><td>" + item.CouponCode + "</td><td>" + (item.Telephone == null ? "未绑定" : item.Telephone) + "</td><td>" + formatTime(item.CreatedTime) + "</td><tr>";
            });
            $(".tableContainer").append(html);
            //var pageDetailTemplateHtml = $("#PageDetailTemplate").html();
            //pageDetailTemplateHtml = pageDetailTemplateHtml.replace("$pageNum$", $("#pageIndex").val());
            //var totalPage = parseInt((data.count - 1) / 10) + 1;
            //$("#totalPage").val(totalPage);
            //pageDetailTemplateHtml = pageDetailTemplateHtml.replace("$pageCount$", totalPage);
            //pageDetailTemplateHtml = pageDetailTemplateHtml.replace("$count$", data.count);
            //$("#PageDetail").empty();
            //$("#PageDetail").append(pageDetailTemplateHtml);
            //PageChange();
            $(".tableContainer tr").mouseover(function () {
                $(this).addClass("mouseOn");
            });
            $(".tableContainer tr").mouseout(function () {
                $(this).removeClass("mouseOn");
            });
        } else {
            html += "<tr><td colspan='5'>无数据</td></tr>";
            $(".tableContainer").append(html);
            //PageChange();
        }
    }

    function Export() {
        var parentId = $(".parentId").val();
        var isBind = $("#isBind").val();
        var channel = $(".channel").val();
        if (confirm("是否要导出这些记录？")) {
            window.open("/CompanyClient/ExportClientCouponCode?parentId=" + parentId + "&isBind=" + isBind+"&channel="+channel);
        } else {
            return;
        }

    }

    function formatTime(val) {
        if (val != null) {
            return eval('new ' + eval(val).source).Format('yyyy-MM-dd hh:mm:ss');
        } else {
            return "无";
        }
    }

    //function PageChange() {
    //    if ($("#totalPage").val() == 0 || $("#totalPage").val() == 1) {
    //        $("#firstPage").attr("disabled", true);
    //        $("#lastPage").attr("disabled", true);
    //        $("#nextPage").attr("disabled", true);
    //        $("#tailPage").attr("disabled", true);
    //        $("#skipPage").attr("disabled", true);
    //    } else if ($("#pageIndex").val() == 1) {
    //        $("#firstPage").attr("disabled", true);
    //        $("#lastPage").attr("disabled", true);
    //        $("#nextPage").attr("disabled", false);
    //        $("#tailPage").attr("disabled", false);
    //        $("#skipPage").attr("disabled", false);
    //    } else if ($("#pageIndex").val() == $("#totalPage").val()) {
    //        $("#firstPage").attr("disabled", false);
    //        $("#lastPage").attr("disabled", false);
    //        $("#nextPage").attr("disabled", true);
    //        $("#tailPage").attr("disabled", true);
    //        $("#skipPage").attr("disabled", false);
    //    } else {
    //        $("#firstPage").attr("disabled", false);
    //        $("#lastPage").attr("disabled", false);
    //        $("#nextPage").attr("disabled", false);
    //        $("#tailPage").attr("disabled", false);
    //        $("#skipPage").attr("disabled", false);
    //    }
    //}
</script>