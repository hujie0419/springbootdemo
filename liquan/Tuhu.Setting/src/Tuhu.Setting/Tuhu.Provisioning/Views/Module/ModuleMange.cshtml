@{
    ViewBag.Title = "模块管理";
    Layout = "../Shared/_Layout.cshtml";
}
<link href="//res.tuhu.cn/Css/easyuiCss/themes/default/easyui.css" rel="stylesheet" />
<link href="//res.tuhu.cn/Css/easyuiCss/themes/icon.css" rel="stylesheet" />
<script src="//res.tuhu.cn/Scripts/easyui/jquery.easyui.min.js"></script>
<script src="//res.tuhu.cn/Scripts/easyui/easyui-lang-zh_CN.js"></script>
<script type="text/javascript">
    $(function () {
        $('#tt').treegrid({
            url: '/Module/Modules?id=' + 0,
            idField: 'id',
            treeField: 'mname',
            state: "closed",
            toolbar: [{
                iconCls: 'icon-add',
                text: "添加根模块",
                handler: function () {
                    clear();
                    $("#dlg").dialog("open").dialog('setTitle', '添加模块');
                    $("#dlg").css("visibility", "visible");
                    var myDate = new Date();
                    var nowStimeTime = myDate.getFullYear() + "-" + myDate.getMonth() + "-" + myDate.getDate() + " " + myDate.getHours() + ":" + myDate.getMinutes();
                    var nowEtimeTime = myDate.getFullYear() + 1 + "-" + myDate.getMonth() + "-" + myDate.getDate() + " " + myDate.getHours() + ":" + myDate.getMinutes();
                    $('#stime').datetimebox('setValue', nowStimeTime);
                    $('#etime').datetimebox('setValue', nowEtimeTime);
                    $("#addoredit").val(1);
                    $("#moduleid").val(0);//parentid==0
                    $("#mstatus").attr("checked", true);
                    $("#dispbanner").attr("checked", true);
                }
            }],
            onBeforeExpand: function (row) { },
            columns: [[
                { field: 'id', title: '编号', width: 50 },
                { field: 'mname', title: '名称', width: 200 },
                { field: 'sort', title: '排序', width: 80, align: 'right' },
                {
                    field: 'banner', title: 'Banner', width: 150, formatter: function (index, rowData) {
                        return "<img  width=120px; height=80px; src=" + rowData.banner + " />"
                    }
                },
                {
                    field: 'dispbanner', title: '图片显示', width: 80, align: 'right', formatter: function (index, rowData) {
                        if (rowData.dispbanner == 1) {
                            return "<span style='color: green;'>显示状态</span>"
                        }
                        else {
                            return "<span style='color: #f00;'>禁用状态</span>"
                        }
                    }
                },
                {
                    field: 'mstatus', title: '模块显示', width: 80, align: 'right', formatter: function (index, rowData) {
                        if (rowData.mstatus == 1) {
                            return "<span style='color: green;'>启用状态</span>"
                        }
                        else {
                            return "<span style='color: #f00;'>禁用状态</span>"
                        }
                    }
                },
                {
                    field: 'parentid', title: '父级名称', width: 120, formatter: function (index, rowData) {
                        if (rowData.parentid == 0 || rowData.parentid == null) {
                            return "无";
                        }
                        else {
                            var ParentNode = $("#tt").treegrid("find", rowData.parentid);
                            return ParentNode.mname;

                        }

                    }
                },
                {
                    field: 'stime', title: '开始时间', width: 120, formatter: function (index, rowData) {
                        return ChangeDateFormat(rowData.stime);
                    }
                },
                {
                    field: 'etime', title: '结束时间', width: 120, formatter: function (index, rowData) {
                        return ChangeDateFormat(rowData.etime);
                    }
                },
                {
                    title: '控制列', field: ' ', width: 250,
                    formatter: function (index, rowData) {
                        return "<button onclick='addNode(" + rowData.id + ")'>添加子模块</button>" + "<button onclick='edit(" + JSON.stringify(rowData) + ")'>修改</button>" + "<button onclick='deletenode(" + rowData.id + ")'>删除</button>" + "<button onclick='delist()'>产品配置</button>";
                    }
                }
            ]]
        });
    })

    //function deleteConfirm(msg) {
    //    $.messager.confirm("确定", msg, function (r) {
    //        if (r) {
    //            alert("sdfsdf");
    //        }

    //    });
    //}

    //删除节点
    function deletenode(id) {
        $.messager.confirm("确定", "确定要删除吗", function (r) {
            if (r) {
                $("#tt").treegrid('remove', id);
                $.ajax({
                    url: '/Module/Remove?id=' + id,
                }).done(function (data) {
                    var jsonresult = JSON.parse(data);
                    if (jsonresult.resultCode == "1") {
                        $.messager.alert("提示信息", "操作成功");
                        $("#dlg").dialog("close");
                        $('#tt').treegrid('reload');
                    }
                    else {
                        $.messager.alert("提示信息", "操作失败");
                    }
                })
            }
        });

    }
    //查看详情
    function delist() {
        window.location = "http://setting.tuhu.cn/Sale/SaleProIndex"
    }
    //添加节点
    function addNode(id) {
        clear();
        if (id != null) {
            $("#dlg").dialog("open").dialog('setTitle', '添加模块');
            $("#dlg").css("visibility", "visible");
            var myDate = new Date();
            var nowStimeTime = myDate.getFullYear() + "-" + myDate.getMonth() + "-" + myDate.getDate() + " " + myDate.getHours() + ":" + myDate.getMinutes();
            var nowEtimeTime = myDate.getFullYear() + 1 + "-" + myDate.getMonth() + "-" + myDate.getDate() + " " + myDate.getHours() + ":" + myDate.getMinutes();
            $('#stime').datetimebox('setValue', nowStimeTime);
            $('#etime').datetimebox('setValue', nowEtimeTime);
            $("#addoredit").val(1);
            $("#moduleid").val(id);
            $("#mstatus").attr("checked", true);
            $("#dispbanner").attr("checked", true);
        }

    }

    //修改
    function edit(rowData) {
        clear();
        if (rowData != null) {
            $("#dlg").dialog("open").dialog('setTitle', '模块编辑');
            $("#dlg").css("visibility", "visible");
            $("#fm").form("load", rowData);
            if (rowData.dispbanner == 1)
                $("#dispbanner").attr("checked", true);
            else
                $("#dispbanner").attr("checked", false);
            if (rowData.mstatus == 1)
                $("#mstatus").attr("checked", true);
            else
                $("#mstatus").attr("checked", false);
            $("#preview").attr("src", rowData.banner);
            // alert(rowData.stime);
            //$("input[name='stime']").val( '2015-05-07 19:11');
            $('#stime').datetimebox('setValue', ChangeDateFormat(rowData.stime));
            $('#etime').datetimebox('setValue', ChangeDateFormat(rowData.stime));
            $("#addoredit").val(0);
            $("#bannerurl").val(rowData.banner);
        }

    }


    //json日期转换成，常用个shi
    function ChangeDateFormat(cellval) {
        try {
            var date = new Date(parseInt(cellval.replace("/Date(", "").replace(")/", ""), 10));
            var month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
            var currentDate = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
            return date.getFullYear() + "-" + month + "-" + currentDate + " " + date.getHours() + ":" + date.getMinutes();//+ ":" + date.getSeconds()
        } catch (e) {
            return "";
        }
    }

    //情况弹出框的数据
    function clear() {
        $("#preview").attr("src", '');
        $("#mname").attr("value", '');
        $("#idFile").attr("value", '');
        $("#sort").attr("value", '');
    }

    //保存事件图片随这个form一起到后台
    function saveuser() {
        var addoredit = $("#addoredit").val();//1:添加0：修改
        $("#fm").form("submit", {
            url: "/Module/Save?a=" + addoredit,
            onsubmit: function () {
                return $(this).form("validate");
            },
            success: function (data) {
                var jsonresult = JSON.parse(data);
                if (jsonresult.resultCode == "1") {
                    $.messager.alert("提示信息", "操作成功");
                    $("#dlg").dialog("close");
                    $('#tt').treegrid('reload');
                }
                else if (jsonresult.resultCode == "2") {
                    $.messager.alert("提示信息", "已存在此名称请重新填写");
                }
                else {
                    $.messager.alert("提示信息", "操作失败");
                }
            }
        });
    }


    //上传图片和预览
    //检查图片的格式是否正确,同时实现预览
    function setImagePreview(obj, localImagId, imgObjPreview) {
        var array = new Array('gif', 'jpeg', 'png', 'jpg', 'bmp'); //可以上传的文件类型
        if (obj.value == '') {
            $.messager.alert("让选择要上传的图片!");
            return false;
        }
        else {
            var fileContentType = obj.value.match(/^(.*)(\.)(.{1,8})$/)[3]; //这个文件类型正则很有用
            ////布尔型变量
            var isExists = false;
            //循环判断图片的格式是否正确
            for (var i in array) {
                if (fileContentType.toLowerCase() == array[i].toLowerCase()) {
                    //图片格式正确之后，根据浏览器的不同设置图片的大小
                    if (obj.files && obj.files[0]) {
                        //火狐下，直接设img属性
                        imgObjPreview.style.display = 'block';
                        imgObjPreview.style.width = '400px';
                        imgObjPreview.style.height = '300';
                        //火狐7以上版本不能用上面的getAsDataURL()方式获取，需要一下方式
                        imgObjPreview.src = window.URL.createObjectURL(obj.files[0]);
                    }
                    else {
                        //IE下，使用滤镜
                        obj.select();
                        var imgSrc = document.selection.createRange().text;
                        //必须设置初始大小
                        localImagId.style.width = "400px";
                        localImagId.style.height = "300";
                        //图片异常的捕捉，防止用户修改后缀来伪造图片
                        try {
                            localImagId.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
                            localImagId.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = imgSrc;
                        }
                        catch (e) {
                            $.messager.alert("您上传的图片格式不正确，请重新选择!");
                            return false;
                        }
                        imgObjPreview.style.display = 'none';
                        document.selection.empty();
                    }
                    isExists = true;
                    return true;
                }
            }
            if (isExists == false) {
                $.messager.alert("上传图片类型不正确!");
                return false;
            }
            return false;
        }
    }

    function over(imgid, obj, imgbig) {
        //大图显示的最大尺寸  4比3的大小  400 300
        maxwidth = 400;
        maxheight = 300;

        //显示
        obj.style.display = "";
        imgbig.src = imgid.src;

        //1、宽和高都超过了，看谁超过的多，谁超的多就将谁设置为最大值，其余策略按照2、3
        //2、如果宽超过了并且高没有超，设置宽为最大值
        //3、如果宽没超过并且高超过了，设置高为最大值

        if (img.width > maxwidth && img.height > maxheight) {
            pare = (img.width - maxwidth) - (img.height - maxheight);
            if (pare >= 0)
                img.width = maxwidth;
            else
                img.height = maxheight;
        }
        else if (img.width > maxwidth && img.height <= maxheight) {
            img.width = maxwidth;
        }
        else if (img.width <= maxwidth && img.height > maxheight) {
            img.height = maxheight;
        }
    }




</script>
<div style="width:100%; height:auto">
    <table id="tt" style="width:100%;height:auto;margin:0 auto;"></table>
</div>
<div id="dlg" class="easyui-dialog" style="width: 530px; height: 530px; padding: 10px 20px;visibility: hidden;"
     closed="true" buttons="#dlg-buttons">
    <form id="fm" method="post" enctype="multipart/form-data">
        <table>
            <tr>
                <td>名称:</td>
                <td><input name="mname" id="mname" class="easyui-validatebox" required="true" /> </td>
            </tr>
            <tr>
                <td>上传图片</td>
                <td>
                    <input id="idFile" style="width:224px" name="idFile" onchange="javascript:setImagePreview(this,localImag,preview);" type="file">
                </td>
            </tr>
            <tr>
                <td>  预览:</td>
                <td>
                    <div id="localImag" style="width: 300px; height: 200px;">
                        <img id="preview" alt="预览图片" width="300" height="200" />
                    </div>
                </td>
            </tr>
            <tr>
                <td>开始时间:</td>
                <td><input name="stime" id="stime" class="easyui-datetimebox" type="text" required="true" /> </td>
            </tr>
            <tr>
                <td>结束时间:</td>
                <td><input name="etime" id="etime" class="easyui-datetimebox" type="text" required="true" /> </td>
            </tr>
            <tr>
                <td>模块显示:</td>
                <td><input name="mstatus" id="mstatus" type="checkbox" /> </td>
            </tr>
            <tr>
                <td>图片显示:</td>
                <td><input name="dispbanner" id="dispbanner" type="checkbox" /> </td>
            </tr>
            <tr>
                <td>排序码:</td>
                <td><input name="sort" id="sort" class="easyui-validatebox" required="true" /> </td>
            </tr>
            <input type="hidden" name="id" id="moduleid" />
            <input type="hidden" name="bannerurl" id="bannerurl" />
            <input type="hidden" name="addoredit" id="addoredit" />
        </table>
    </form>
</div>
<div id="dlg-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="saveuser()" iconcls="icon-save" id="aSave">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg').dialog('close')"
       iconcls="icon-cancel">取消</a>
</div> 