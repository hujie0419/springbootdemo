<head>
    <meta name="viewport" content="width=device-width" />
    <title>途虎奖励申请审核界面</title>
    <script src="~/Scripts/vue.min.js"></script>
    <script src="~/Scripts/iview/iview.min.js"></script>
    <link href="~/Content/nfine/js/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <script src="~/Content/listmenu/js/jquery.min.js"></script>
    <script src="~/Content/ProductVehicleType/js/bootstrap.min.js"></script>
    <script src="https://file-tuhu-cn.alikunlun.com/yewu/oms/scripts/md503.js" type="text/javascript"></script>
    <script src="https://file-tuhu-cn.alikunlun.com/yewu/oms/scripts/verifyBtn.js" type="text/javascript"></script>
    <link href="~/Content/iview/iview.css" rel="stylesheet" />
    @*<style>
            .ivu-table-cell {
                height: 50px;
            }
        </style>*@
</head>
<body>
    <fieldset>
        <legend>筛选条件</legend>
        <div id="app" style="margin-left:10px;margin-right:10px;" v-cloak>
            <div>
                <i-input v-model="ApplicationName" placeholder="姓名" style="width: 200px"></i-input>
                <i-input v-model="Phone" placeholder="手机号" style="width: 200px"></i-input>
                <Date-Picker v-model="CreateDateTime" type="datetime" format="yyyy-MM-dd HH:mm" placeholder="申请时间" style="width: 150px"></Date-Picker>
                <i-select v-model="ApplicationState" style="width: 200px" placeholder="全部">
                    <i-option v-for="item in List" v-bind:value="item.value">{{ item.label }}</i-option>
                </i-select>
                <i-button type="primary" icon="ios-search" v-on:click="searchPage">搜索</i-button>
            </div>
            <br />
            <i-table :data="tableData1" :columns="tableColumns1" stripe></i-table>
            <div style="margin: 10px;overflow: hidden">
                <div style="float: right;">
                    <Page :total="totalCount" :current="currentPage" :page-size="pageSize" show-total v-on:on-change="changePage"></Page>
                </div>
            </div>
            @*<i-modal v-model="modal" height="500px;" width="800px;">
                    <ul style="width: 500px;float:left;">
                        <li style="margin-bottom: 10px;height: 100px"><img src="https://img1.tuhu.org/ImageUploadToAli/8fb9/c2fc/5018ae66a16bc93d71134fb3_w500_h375.jpg@100Q.jpg"/></li>
                        <li style="margin-bottom: 10px;height: 100px" ><img src="https://img1.tuhu.org/ImageUploadToAli/8fb9/c2fc/5018ae66a16bc93d71134fb3_w500_h375.jpg@100Q.jpg" /></li>
                        <li style="margin-bottom: 10px;height: 100px"><img src="https://img1.tuhu.org/ImageUploadToAli/8fb9/c2fc/5018ae66a16bc93d71134fb3_w500_h375.jpg@100Q.jpg" /></li>
                    </ul>
                    <div style="width: 300px;float:right;"></div>
                </i-modal>*@
        </div>
    </fieldset>
    <div class="modal fade" id="ruleModel" role="dialog" style="width: 800px;height:600px">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="ruleModalLabel">审核</h4>
                </div>
                <div id="app2">
                    <div class="modal-body" style="background-color: darkgray">
                        <div class="row">
                            <div class="col-md-6">

                                <div>
                                    <img v-bind:src="Image1" class="img-thumbnail" />
                                </div>
                                <div>
                                    <img v-show="ShowImage2" v-bind:src="Image2" class="img-thumbnail" />
                                </div>
                                <div>
                                    <img v-show="ShowImage3" v-bind:src="Image3" class="img-thumbnail" />
                                </div>
                            </div>
                            <div class="col-md-6 jumbotron">
                                <div class="col-md-2">

                                </div>
                                <div class="col-md-10">
                                    <div class="well well-lg">
                                        <label>申请人:{{ApplicationName}}</label>
                                    </div>
                                    <div class="well well-lg">
                                        <label>手机号:{{Phone}}</label>
                                    </div>
                                    <div class="well well-lg">
                                        <label>申请时间:{{CreateDateTime}}</label>
                                    </div>
                                    <div class="well well-lg">
                                        <label>审核状态:{{ApplicationState}}</label>
                                    </div>
                                    <button type="button" class="btn btn-primary" v-on:click="Save(2)">通过</button>
                                    <button type="button" class="btn btn-warning" v-on:click="Save(3)">驳回</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" >
                        <button type="button" class="btn btn-success " v-on:click="GetNextOrPre(-1)">
                            <span class="glyphicon glyphicon-fast-backward" aria-hidden="true"></span> 上一个
                        </button>
                        <button type="button" class="btn btn-success " v-on:click="GetNextOrPre(1)">
                            <span class="glyphicon glyphicon-fast-forward" aria-hidden="true"></span> 下一个
                        </button>
                        <button type="button" class="btn btn-success" data-dismiss="modal">退出</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    var vm2 = new Vue({
        el: '#app2',
        data() {
            return {
                Image1: "",
                Image2: "",
                Image3: "",
                //ShowImage1: false,
                //ShowImage2: false,
                //ShowImage3: false,
                ApplicationName: "",
                Phone: "",
                CreateDateTime: "",
                ApplicationState: "",
                Phones: []
            }
        },
        computed: {
            ShowImage1: function () {
                return this.Image1 != null;
            },
            ShowImage2: function () {
                return this.Image2 != null;
            },
            ShowImage3: function () {
                return this.Image3 != null;
            },
            //this.ShowImage1 = this.Image1 != null;
            //this.ShowImage2 = this.Image2 != null?true:false;
            //this.ShowImage3 = this.Image3 != null;
        },
        methods: {
            Save(s) {
                var self = this;
                $.ajax({
                    url: "/RewardApplication/Save",
                    type: "post",
                    async: true,
                    data: {
                        phone: self.Phone,
                        state: s
                    },
                    success: function (r) {
                        if (r.status == 1) {
                            alert('审核成功，自动进入下一个，请继续！');
                            vm2.FindNext();
                        }
                        else {
                            alert('保存失败！');
                        }
                    },
                    error: function () {
                        alert("服务端异常！");
                    }
                });
            },
            GetNextOrPre(i) {
                var self = this;
                var phone = '';
                for (var index = 0; index < self.Phones.length; index++) {
                    //alert(self.Phones.length);
                    if (self.Phones[index] == self.Phone) {
                        var nextindex = index + i;
                        if (nextindex == self.Phones.length) {
                            alert("已经是当前页的最后一个");
                            phone = self.Phones[index];
                        }
                        else {
                            if (nextindex == -1) {
                                alert("已经是当前页的第一个");
                                phone = self.Phones[index];
                            }
                            else {
                                phone = self.Phones[nextindex];
                            }
                        }
                        break;
                    }
                }
                $.ajax({
                    url: "/RewardApplication/FetchNextOrPre",
                    type: "post",
                    async: true,
                    data: {
                        phone: phone
                    },
                    success: function (data) {
                        if (data.status == 1) {
                            vm2.Image1 = data.dbResult.ImageUrl1;
                            vm2.Image2 = data.dbResult.ImageUrl2;
                            vm2.Image3 = data.dbResult.ImageUrl3;
                            vm2.ApplicationName = data.dbResult.ApplicationName;
                            vm2.Phone = data.dbResult.Phone;
                            vm2.CreateDateTime = new Date().Format(data.dbResult.CreateDateTime);
                            vm2.ApplicationState = data.dbResult.ApplicationState == 1 ? "待审核" : data.dbResult.ApplicationState == 2 ? "已审核" : "已驳回"
                        }
                        else {
                            alert('失败！');
                        }
                    },
                    error: function () {
                        alert("服务端异常！");
                    }
                });
            },
            FindNext() {
                var self = this;
                $.ajax({
                    url: "/RewardApplication/FindNextRewardApplication",
                    type: "post",
                    async: true,
                    data: {
                        phone: self.Phone,
                        phones: self.Phones
                    },
                    success: function (data) {
                        if (data.status == 1) {
                            vm2.Image1 = data.dbResult.ImageUrl1;
                            vm2.Image2 = data.dbResult.ImageUrl2;
                            vm2.Image3 = data.dbResult.ImageUrl3;
                            vm2.ApplicationName = data.dbResult.ApplicationName;
                            vm2.PrePhone = self.Phone;
                            vm2.Phone = data.dbResult.Phone;
                            vm2.CreateDateTime = new Date().Format(data.dbResult.CreateDateTime);
                            vm2.ApplicationState = data.dbResult.ApplicationState == 1 ? "待审核" : data.dbResult.ApplicationState == 2 ? "已审核" : "已驳回"
                        }
                        else {
                            alert('当前页已经操作完成请审核下一页！');
                        }
                    },
                    error: function () {
                        alert("服务端异常！");
                    }
                });
            }
        }
    })
    var vm = new Vue({
        el: '#app',
        data() {
            return {
                tableData1: this.GetDataList(),
                tableColumns1: [
                    {
                        title: '申请时间',
                        key: 'CreateDateTime',
                        align: 'center',
                        render: function (h, params) {
                            return h('div',
                                new Date().Format(params.row.CreateDateTime));/*这里的this.row能够获取当前行的数据*/
                        }
                    },
                    {
                        title: '申请人',
                        key: 'ApplicationName',
                        render: (h, params) => {
                            return h('div', [
                                h('Icon', {
                                    props: {
                                        type: 'person'
                                    }
                                }),
                                h('strong', params.row.ApplicationName)
                            ]);
                        }
                    },
                    {
                        title: '手机号',
                        key: 'Phone'
                    },
                    {
                        title: '图片1',
                        key: 'ImageUrl1',
                        render: (h, params) => {
                            if (params.row.ImageUrl1 != null) {
                                return h('div', {
                                    attrs: {
                                        style: 'width: 40px;height: 40px;'
                                    },
                                }, [
                                        h('img', {
                                            //props: {
                                            //    type: 'primary',
                                            //    size: 'large'
                                            //},
                                            attrs: {
                                                src: params.row.ImageUrl1, style: 'width: 40px;height: 40px;'
                                            },
                                            style: {
                                            },
                                        }),
                                    ]);
                            }
                        }
                    },
                    {
                        title: '图片2',
                        key: 'ImageUrl2',
                        render: (h, params) => {
                            if (params.row.ImageUrl2 != null && params.row.ImageUrl2 != '') {
                                return h('img', {
                                    domProps: {
                                        src: params.row.ImageUrl2
                                    },
                                    style: 'width: 40px;height: 40px;',
                                })
                            }
                        }
                    },
                    {
                        title: '图片3',
                        key: 'ImageUrl3',
                        render: (h, params) => {
                            if (params.row.ImageUrl3 != null) {
                                return h('img', {
                                    domProps: {
                                        src: params.row.ImageUrl3
                                    },
                                    style: 'width: 40px;height: 40px;'
                                })
                            }
                        }
                    },
                    {
                        title: '审核时间',
                        key: 'LastUpdateDateTime',
                        render: function (h, params) {
                            return h('div',
                                new Date().Format(params.row.LastUpdateDateTime));/*这里的this.row能够获取当前行的数据*/
                        }
                    },
                    {
                        title: '审核结果',
                        key: 'ApplicationState'
                    },
                    {
                        title: '审核人',
                        key: 'Auditor',
                        render: (h, params) => {
                            return h('div', [
                                h('Icon', {
                                    props: {
                                        type: 'person'
                                    }
                                }),
                                h('strong', params.row.Auditor)
                            ]);
                        }
                    },
                    {
                        title: '操作',
                        key: 'action',
                        width: 80,
                        align: 'center',
                        render: (h, params) => {
                            return h('div', [
                                h('Button', {
                                    props: {
                                        type: 'primary',
                                        size: 'small'
                                    },
                                    style: {
                                        marginRight: '5px'
                                    },
                                    on: {
                                        click: () => {
                                            this.edit(params.index)
                                        }
                                    }
                                }, '审核')

                            ]);
                        }
                    }
                ],
                ApplicationState: '4',
                ApplicationName: "",
                Phone: "",
                CreateDateTime: "",
                AuditorPage: false,
                modal: true,
                value1: 0,
                Phones: [],
                List: [
                    {
                        value: '4',
                        label: '全部'
                    },
                    {
                        value: '1',
                        label: '待审核'
                    },
                    {
                        value: '2',
                        label: '已审核'
                    },
                    {
                        value: '3',
                        label: '已驳回'
                    }
                ],
                currentPage: 1,
                pageSize: 20,
                totalCount: 1
            }
        },
        mounted: function () {
            this.GetDataList();
        },
        created() {
            this.initFormatter(); // 为Date 对象添加Format方法
        },
        methods: {
            GetDataList() {
                var data1 = [];

                var currentpage = this.currentPage;
                if (!currentpage) {
                    currentpage = 1;
                }
                var pagesize = this.pageSize;
                if (!pagesize) {
                    pagesize = 20;
                }

                var applicationState = this.ApplicationState;
                if (!applicationState) {
                    applicationState = 4;
                }
                var applicationName = this.ApplicationName;
                if (!applicationName) {
                    applicationName = '';
                }
                var phone = this.Phone;
                if (!phone) {
                    phone = '';
                }
                var createDateTime = this.CreateDateTime;
                if (!createDateTime) {
                    createDateTime = '';
                } else {
                    createDateTime = new Date().Format(createDateTime);
                }
                var postData = {
                    pageIndex: currentpage,
                    pageSize: pagesize,
                    applicationState: applicationState,
                    applicationName: applicationName,
                    phone: phone,
                    createDateTime: createDateTime
                };
                $.ajax({
                    url: "/RewardApplication/GetDate",
                    type: "post",
                    async: false,
                    data: postData,
                    success: function (data) {
                        if (data != null) {
                            $(data.Item2).each(function (i, e) {
                                data1.push({
                                    CreateDateTime: e.CreateDateTime,
                                    ApplicationName: e.ApplicationName,
                                    Phone: e.Phone,
                                    ImageUrl1: e.ImageUrl1,
                                    ImageUrl2: e.ImageUrl2,
                                    ImageUrl3: e.ImageUrl3,
                                    LastUpdateDateTime: e.LastUpdateDateTime,
                                    ApplicationState: e.ApplicationState == 1 ? "待审核" : e.ApplicationState == 2 ? "已审核" : "已驳回",
                                    Auditor: e.Auditor,
                                    Phones: e.Phones
                                });
                            });
                            total = data.Item1;
                        }
                    },
                    error: function () {
                        alert("服务端异常！");
                    }
                });
                this.totalCount = total;
                return data1;
            },
            changePage(page) {
                // The simulated data is changed directly here, and the actual usage scenario should fetch the data from the server
                this.currentPage = page;
                this.tableData1 = this.GetDataList();
            },
            initFormatter() {
                Date.prototype.Format = function (e) { //
                    if (e == null)
                        return null;
                    var time = e instanceof Date ? e : eval('new ' + e.toString().replace(/\//g, ""));
                    var year = time.getFullYear();
                    var day = time.getDate();
                    var month = time.getMonth() + 1;
                    var hours = time.getHours();
                    var minutes = time.getMinutes();
                    var seconds = time.getSeconds();
                    return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
                }
            },
            searchPage() {
                this.tableData1 = this.GetDataList();
            },
            edit(index) {
                //this.$Modal.info({
                //    title: '审核',
                //    content: `Name：${this.tableData1[index].ApplicationName}<br>`
                //})
                $('#ruleModel').modal('show');
                vm2.Image1 = this.tableData1[index].ImageUrl1;
                vm2.Image2 = this.tableData1[index].ImageUrl2;
                vm2.Image3 = this.tableData1[index].ImageUrl3;
                vm2.ApplicationName = this.tableData1[index].ApplicationName;
                vm2.Phone = this.tableData1[index].Phone;
                vm2.CreateDateTime = new Date().Format(this.tableData1[index].CreateDateTime);
                vm2.ApplicationState = this.tableData1[index].ApplicationState;
                vm2.Phones = this.tableData1[index].Phones
            }
        },

    })
</script>
