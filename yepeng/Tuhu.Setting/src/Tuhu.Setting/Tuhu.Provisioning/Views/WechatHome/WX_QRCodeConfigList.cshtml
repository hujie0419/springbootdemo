
@{
    ViewBag.Title = "WechatSubscribeQRCode";
    Layout = "~/Views/Shared/_Index.cshtml";
}
<div class="topPanel">
    <div class="search">
        <table>
            <tr>
                <th class="formTitle">选择公众号</th>
                <td class="formValue" style="padding-left:10px;">
                    <div class="input-group">
                        <select id="WeChatOfficialAccounts" name="WeChatOfficialAccounts" class="form-control" style="width:200px;"></select>
                    </div>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="topPanel">
    <div class="toolbar">
        <div class="btn-group">
            <a class="btn btn-primary" onclick="$.reload()"><span class="glyphicon glyphicon-refresh"></span></a>
        </div>
        <div class="btn-group">
            <a class="btn btn-primary" onclick="betn_searchlog()">
                <span class="fa fa-search">查看日志</span>
            </a>
        </div>
        <div class="btn-group">

            <a class="btn btn-primary" style="margin-right:10px;" onclick="btn_add();"><span class="fa fa-pencil-square-o">新 增</span></a>
        </div>
        <div class="operate">
            <ul class="nav nav-pills">
                <li class="first">已选中<span>1</span>项</li>
                <li><a id="NF-edit" onclick="btn_update();"><i class="fa fa-pencil-square-o"></i>修 改</a></li>
            </ul>
            <a href="javascript:;" class="close"></a>
        </div>
    </div>
</div>
<div class="gridPanel">
    <table id="gridList"></table>
    <div id="gridPager"></div>
</div>


<script type="text/javascript">

    function download(that) {
        var url = $(that).attr('url');
        //DownLoadReportIMG(url);
        window.open(url, "_bank")
        //window.location.href = url;
        //$('<form method="post" target="_blank" role="form" action="' + url + '" hidden="hidden"></form>').appendTo('body').submit().remove();

        //var alink = document.createElement("a");
        //alink.href = url;
        //alink.download = "testImg.jpg";
        //alink.click();

        //$.modalMsg(url, "warning");
        //$.modalOpen({
        //    id: url,
        //    title: "二维码",
        //    url: url,
        //    width: "800px",
        //    height: "800px",
        //    callBack: function (iframeId) {
        //        //top.frames[iframeId].submitForm();
        //    }
        //});
    }
        function DownLoadReportIMG(imgPathURL) {
            //debugger
            //如果隐藏IFRAME不存在，则添加
            if (!document.getElementById("IframeReportImg"))
                $('<iframe style="display:none;" id="IframeReportImg" name="IframeReportImg" onload="DoSaveAsIMG();" width="0" height="0" src="about:blank"></iframe>').appendTo("body");
            if (document.all.IframeReportImg.src != imgPathURL) {
                //加载图片
                document.all.IframeReportImg.src = imgPathURL;
            }
            else {
                //图片直接另存为
                DoSaveAsIMG();
            }
        }
        function DoSaveAsIMG() {
            if (document.all.IframeReportImg.src != "about:blank")
                document.getElementById('IframeReportImg').contentWindow.document.execCommand("SaveAs");
                //document.frames("IframeReportImg").document.execCommand("SaveAs");
        }


    function gridList() {
        var $gridList = $('#gridList');
        var originalId = $("#WeChatOfficialAccounts").val();
        $gridList.dataGrid({
            treeGrid: true,
            treeGridModel: "adjacency",
            ExpandColumn: "Name",
            height: $(window).height() - 128,
            url: "/WechatHome/GetWX_QRCodeConfigList",
            postData: { originalId, originalId },
            colModel: [
                { label: "PKID", name: "PKID", width: 50, key: true, },
                { label: "推广场景", name: "Title", width: 80, align: "center" },
                {
                    label: "场景值类型", name: "Type", width: 120, align: "left",
                    formatter: function (cellValue) {
                        if (cellValue == "scene_id")
                            return "整 型"
                        else if (cellValue == "scene_str")
                            return "字符串";
                        else
                            return "";
                    }
                },
                {
                    label: "场景值", name: "Scene", width: 120, align: "left",
                },
                {
                    label: "临时或永久", name: "action_name", width: 120, align: "left",
                    formatter: function (cellValue) {
                        //debugger
                        if (cellValue == "QR_STR_SCENE")
                            return "临时"
                        else if (cellValue == "QR_LIMIT_STR_SCENE")
                            return "永久";
                        else
                            return "";
                    }
                },
                {
                    label: "有效期", name: "Expire_DateFormate", width: 120, align: "left",
                },
                { label: "创建人", name: "Userid", width: 120, align: "left" },
                { label: "创建时间", name: "CreateDateTimeFormat", width: 120, align: "left" },
                {
                    label: "操作", name: "URL", width: 80, align: "center",
                    formatter: function (cellvalue) {
                        return "<button class='download' url='" + cellvalue + "'  onclick='download(this);' >下载</button>";
                    }
                }
            ],
            rowNum: 1000
        });
        //切换公众号
        $("#WeChatOfficialAccounts").change(function () {
            var originalId = $("#WeChatOfficialAccounts").val();
            $gridList.jqGrid('setGridParam', {
                postData: { originalId: originalId },
            }).trigger('reloadGrid');
        });
    }

    function btn_add() {
        var originalId = $("#WeChatOfficialAccounts").val();
        $.modalOpen({
            id: "SubNumberForm",
            title: "新增二维码",
            url: "/WechatHome/WX_QRCodeConfigForm?originalId=" + originalId,
            width: "800px",
            height: "800px",
            callBack: function (iframeId) {
                top.frames[iframeId].submitForm();
            }
        });
    }


    function btn_update() {
        var keyValue = $("#gridList").jqGridRowValue().PKID;
        var originalId = $("#WeChatOfficialAccounts").val();
        if (keyValue) {
            $.modalOpen({
                id: "SubNumberForm",
                title: "编辑二维码",
                url: "/WechatHome/WX_QRCodeConfigForm?keyValue=" + keyValue + "&originalId=" + originalId,
                width: "800px",
                height: "800px",
                callBack: function (iframeId) {
                    top.frames[iframeId].submitForm();
                }
            });
        }
    }

    //同步公众号菜单到微信平台
    function reload() {
        var originalId = $("#WeChatOfficialAccounts").val();
        $.confirmForm({
            prompt: "您确定更新公众号菜单吗？",
            loading: "正在更新请稍后......",
            url: "/WechatHome/ReloadWechatMenu?originalId=" + originalId,
            success: function () {
            }
        })
    }

    //获取所有公众号
    function getWeChatOfficialAccounts() {
        var weChatOfficialAccounts = '';
        $.ajax({
            async: false,
            url: "/WechatHome/GetWeChatOfficialAccounts",
            dataType: 'json',
            success: function (res) {
                $.map(res, function (key) {
                    weChatOfficialAccounts += '<option value=' + key.OriginalId + '>' + key.name + '</option>';
                })
                $("#WeChatOfficialAccounts").empty().append(weChatOfficialAccounts);
            }
        });
    }

    function betn_searchlog() {
        $.modalOpen({
            id: "Form",
            title: "查看日志",
            url: "/CommonConfigLog/ListLoger?objectType=WX_QRCodeConfig",
            width: "1500px",
            height: "600px",
            btn: null
        });
    }


    $(function () {
        //获取公众号
        getWeChatOfficialAccounts();
        //加载列表数据
        gridList();
    });
</script>

